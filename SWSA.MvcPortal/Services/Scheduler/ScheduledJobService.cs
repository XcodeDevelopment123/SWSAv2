using SWSA.MvcPortal.Repositories.Interfaces;
using Microsoft.Extensions.Caching.Memory;
using SWSA.MvcPortal.Commons.Quartz.Services.Interfaces;
using Serilog;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Extensions;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Commons.Helpers;
using SWSA.MvcPortal.Commons.Quartz.Requests;
using SWSA.MvcPortal.Dtos.Requests.SchedulerJobs;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.ScheduledJobs;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using AutoMapper;
using Force.DeepCloner;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.Scheduler;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;

namespace SWSA.MvcPortal.Services.Scheduler;

// <auto-generated />
public class ScheduledJobService(
IMapper mapper,
IUserContext userContext,
IUserRepository userRepo,
IScheduledJobRepository repo,
IJobSchedulerService schedulerService,
ISystemAuditLogService sysAuditService
) : IScheduledJobService
{
    #region VM/DTO Query Method 
    public async Task<List<ScheduledJobVM>> GetAllScheduledJobs()
    {
        Guard.AgainstNotSuperAdmin(userContext);
        var data = await repo.GetAllAsync();
        return mapper.Map<List<ScheduledJobVM>>(data);
    }

    public async Task<ScheduledJobVM> GetScheduledJobByJobKey(string jobKey)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var data = await repo.GetScheduledByJobKeyAsync(jobKey);
        return mapper.Map<ScheduledJobVM>(data);
    }
    #endregion

    public async Task<string> CreateScheduleJob(CreateScheduleJobRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var user = await userRepo.GetByStaffIdAsync(userContext.StaffId);
        Guard.AgainstNullData(user, "User not found");

        string cronExpression = CronExpressionBuilder.BuildCronExpression(req.CronFields, req.CronExpression, req.ScheduleType);
        var triggerTime = req.ScheduleType == ScheduleType.Once ? req.TriggerTime : null;

        var request = BaseJobRequest.Create(triggerTime, cronExpression, true);
        var jobKey = await schedulerService.ScheduleJob(request, req.JobType);

        var jobEntity = new ScheduledJob()
        {
            JobKey = jobKey.Name,
            JobGroup = jobKey.Group,
            JobType = req.JobType,
            ScheduleType = req.ScheduleType,
            TriggerTime = triggerTime,
            CronExpression = cronExpression,
            IsEnabled = false,
            IsCustom = true,
            RequestPayloadJson = null, //Default empty , the job must be enalbe at update
            CreatedBy = userContext.Name,
            CreatedAt = DateTime.Now,
            UserId = user.Id,
        };
        repo.Add(jobEntity);
        await repo.SaveChangesAsync();
        var log = SystemAuditLogEntry.Create(Commons.Enums.SystemAuditModule.ScheduleJob, jobEntity.JobKey.ToString(), $"Schedule Job: {jobEntity.JobType.GetDisplayName()}", jobEntity);
        sysAuditService.LogInBackground(log);
        return jobEntity.JobKey;
    }

    public async Task<bool> UpdateScheduleJob(UpdateScheduleJobRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var data = await repo.GetScheduledByJobKeyAsync(req.JobKey);
        Guard.AgainstNullData(data, "Job Not Found");
        var oldData = data.DeepClone();

        if (req.ExecuteNow)
        {
            var executeRequest = BaseJobRequest.ExecuteNowRequest();
            await schedulerService.ScheduleJob(executeRequest, data.JobType);
            data.LastExecuteAt = DateTime.Now;
        }
        string cronExpression = CronExpressionBuilder.BuildCronExpression(req.CronFields, req.CronExpression, req.ScheduleType);
        var triggerTime = req.ScheduleType == ScheduleType.Once ? req.TriggerTime : null;

        data.IsEnabled = req.IsEnabled;
        data.ScheduleType = req.ScheduleType;
        data.CronExpression = cronExpression;
        data.UpdatedAt = DateTime.Now;
        data.TriggerTime = triggerTime;

        var request = BaseJobRequest.Create(triggerTime, cronExpression, data.IsCustom);

        repo.Update(data);
        await repo.SaveChangesAsync();

        if (data.IsEnabled)
        {
            //If job was enable, require to remove job and trigger - re-schedule
            await schedulerService.ClearSpecificJobByKey(req.JobKey);
            await schedulerService.ScheduleJob(request, data.JobType);
        }
        else
        {
            //Only clear the trigger key, next time enable will re-schedule
            await schedulerService.ClearTriggersByJobkey(req.JobKey);
        }

        var log = SystemAuditLogEntry.Update(Commons.Enums.SystemAuditModule.ScheduleJob, data.JobKey.ToString(), $"Schedule Job: {data.JobType.GetDisplayName()}", oldData, data);
        sysAuditService.LogInBackground(log);

        return true;
    }

    public async Task<bool> ExecuteByJobKey(string jobKey)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var data = await repo.GetScheduledByJobKeyAsync(jobKey);
        Guard.AgainstNullData(data, "Job Not Found");

        var request = new BaseJobRequest()
        {
            StartTime = DateTime.Now,
        };
        await schedulerService.ScheduleJob(request, data.JobType);

        data.LastExecuteAt = DateTime.Now;
        repo.Update(data);
        await repo.SaveChangesAsync();


        var log = SystemAuditLogEntry.Execute(Commons.Enums.SystemAuditModule.ScheduleJob, data!.JobKey.ToString(), $"Schedule Job: {data.JobType.GetDisplayName()}");
        sysAuditService.LogInBackground(log);
        return true;
    }

    public async Task<bool> DeleteByJobKey(string jobKey)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var data = await repo.GetScheduledByJobKeyAsync(jobKey);
        Guard.AgainstNullData(data, "Job Not Found");

        repo.Remove(data);
        await repo.SaveChangesAsync();

        await schedulerService.ClearSpecificJobByKey(jobKey);

        var log = SystemAuditLogEntry.Delete(Commons.Enums.SystemAuditModule.CommunicationContact, data!.JobKey.ToString(), $"Schedule Job: {data.JobType.GetDisplayName()}", data);
        sysAuditService.LogInBackground(log);
        return true;
    }

    //For logging use, no need check access permission
    public async Task UpdateExecuteTimeAsync(string jobkey)
    {
        var job = await repo.GetScheduledByJobKeyAsync(jobkey);
        if (job == null)
        {
            Log.Error($"[Job] job key not found, update failed :{jobkey}");
            return;
        }

        job.LastExecuteAt = DateTime.Now;
        repo.Update(job);
        await repo.SaveChangesAsync();
    }

}