

using AutoMapper;
using Microsoft.Extensions.Caching.Memory;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.DocumentRecords;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.DocumentRecords;
using SWSA.MvcPortal.Repositories.Interfaces;
using SWSA.MvcPortal.Services.Interfaces;

namespace SWSA.MvcPortal.Services;
// <auto-generated />
public class DocumentRecordService(
IMemoryCache cache,
MemoryCacheEntryOptions cacheOptions,
IMapper mapper,
IDocumentRecordRepository repo,
IUserRepository userRepo
    ) : IDocumentRecordService
{

    public async Task<List<DocumentRecordVM>> GetDocumentRecords()
    {
        var data = (await repo.GetAllAsync()).ToList();
        return mapper.Map<List<DocumentRecordVM>>(data);
    }

    public async Task<DocumentRecordVM> GetDocumentRecordById(int id)
    {
        var data = await repo.GetByIdAsync(id);
        Guard.AgainstNullData(data, "DocumentRecord not found");
        return mapper.Map<DocumentRecordVM>(data!);
    }

    public async Task<List<DocumentRecordVM>> GetDocumentRecordByCompanyId(int companyId)
    {
        var data = await repo.GetDocumentRecordsByCompanyId(companyId);
        return mapper.Map<List<DocumentRecordVM>>(data);
    }

    public async Task<List<DocumentRecordVM>> GetDocumentRecordByCompanyDepartmentId(int companyDepartmentId)
    {
        var data = await repo.GetDocumentRecordsByCompanyDepartmentId(companyDepartmentId);
        return mapper.Map<List<DocumentRecordVM>>(data);
    }

    public async Task<bool> CreateDocument(CreateDocumentRecordRequest doc)
    {
        var staff = await userRepo.GetByStaffIdAsync(doc.HandledByStaffId);
        Guard.AgainstNullData(staff, "Staff not found");

        var data = mapper.Map<DocumentRecord>(doc);

        data.HandledByStaffId = staff.Id;

        repo.Add(data);

        await repo.SaveChangesAsync();
        return true;
    }

    public async Task<DocumentRecordVM> DeleteDocumentById(int docId)
    {
        var doc = await repo.GetByIdAsync(docId);
        Guard.AgainstNullData(doc, "Document not found");

        repo.Remove(doc!);
        await repo.SaveChangesAsync();
        return mapper.Map<DocumentRecordVM>(doc);
    }
}
