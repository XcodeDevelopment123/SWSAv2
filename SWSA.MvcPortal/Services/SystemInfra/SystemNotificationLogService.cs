using SWSA.MvcPortal.Commons.Services.Messaging;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;
using SWSA.MvcPortal.Persistence;
using Microsoft.EntityFrameworkCore;

namespace SWSA.MvcPortal.Services.SystemInfra;

// <auto-generated />
public class SystemNotificationLogService(
    AppDbContext db
    ) : ISystemNotificationLogService
{
    private readonly DbSet<SystemNotificationLog> notificationLogs = db.Set<SystemNotificationLog>();

    #region VM/DTO Query Method 
    public async Task<List<SystemNotificationLog>> GetLogs()
    {
        var data = await notificationLogs.ToListAsync();
        return [.. data];
    }
    #endregion

    public async Task AddLog(MessagingResult result)
    {
        var log = new SystemNotificationLog
        {
            Channel = result.MessageEnvelope.Channel,
            Recipient = result.MessageEnvelope.Recipient,
            TemplateCode = result.MessageEnvelope.TemplateCode,
            IsSuccess = result.IsSuccess,
            ResultMessage = result.Message,
            Reason = result.MessageEnvelope.Reason,
        };

        db.Add(log);
        await db.SaveChangesAsync();
    }
}