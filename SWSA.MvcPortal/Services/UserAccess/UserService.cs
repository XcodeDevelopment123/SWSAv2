using SWSA.MvcPortal.Commons.Exceptions;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.Users;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Models.Users;
using AutoMapper;
using Force.DeepCloner;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;
using SWSA.MvcPortal.Services.Interfaces.UserAccess;
using SWSA.MvcPortal.Persistence;
using Microsoft.EntityFrameworkCore;
using SWSA.MvcPortal.Persistence.QueryExtensions;
using Mapster;

namespace SWSA.MvcPortal.Services.UserAccess;

// <auto-generated />
public class UserService(
IMapper mapper,
ISystemAuditLogService sysAuditService,
AppDbContext db,
IUserContext userContext) : IUserService
{
    private readonly DbSet<User> users = db.Set<User>();

    #region VM/DTO Query Method 
    public async Task<List<UserListVM>> GetUsersAsync()
    {
        var data = await users.ToListAsync();

        return mapper.Map<List<UserListVM>>(data);
    }

    public async Task<List<UserSelectionVM>> GetUserSelectionAsync()
    {
        var data = userContext.IsSuperAdmin
             ? await users.GetActive().ProjectToType<UserSelectionVM>().ToListAsync()
             : await users.Where(c => c.Id == userContext.EntityId).ProjectToType<UserSelectionVM>().ToListAsync();

        return data;
    }

    public async Task<UserOverviewVM> GetUserOverviewVMAsync(string staffId)
    {
        var data = await users.Where(c => c.StaffId == staffId).ProjectToType<UserOverviewVM>().FirstOrDefaultAsync();
        Guard.AgainstNullData(data, "User not found");
        return data!;
    }

    public async Task<UserVM> GetUserByIdAsync(string staffId)
    {
        var data = await users.FirstOrDefaultAsync(c => c.StaffId == staffId);
        Guard.AgainstNullData(data, "User not found");

        return mapper.Map<UserVM>(data);
    }
    #endregion

    public async Task<string> Create(CreateUserRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        if (await users.ExistUsernameAsync(req.Username))
        {
            throw new BusinessLogicException("Username already exists");
        }

        var user = mapper.Map<User>(req);
        user.SetAndHashPassword(req.Password);

        db.Add(user);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(Commons.Enums.SystemAuditModule.User, user.StaffId.ToString(), $"User: {user.FullName}", user);
        sysAuditService.LogInBackground(log);
        return user.StaffId;
    }

    public async Task<bool> Edit(EditUserRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var user = await users.FirstOrDefaultAsync(c => c.StaffId == req.StaffId);
        Guard.AgainstNullData(user, "User not found");

        //User cannot edit own role
        if (user!.StaffId == userContext.StaffId && req.Role != user.Role)
            throw new BusinessLogicException("You cannot edit your own role");

        var oldData = user.DeepClone();

        user.FullName = req.FullName;
        user.Email = req.Email;
        user.PhoneNumber = req.PhoneNumber;
        user.IsActive = req.IsActive;
        user.Role = req.Role;

        if (!string.IsNullOrEmpty(req.Password))
        {
            user.SetAndHashPassword(req.Password);
        }

        db.Update(user);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Update(Commons.Enums.SystemAuditModule.User, user.StaffId.ToString(), $"User: {user.FullName}", oldData, user);
        sysAuditService.LogInBackground(log);

        return true;
    }

    public async Task<UserVM> DeleteUserByIdAsync(string staffId)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var data = await users.FirstOrDefaultAsync(c => c.StaffId == staffId);
        Guard.AgainstNullData(data, "User not found");

        if (data!.StaffId == userContext.StaffId)
            throw new BusinessLogicException("You cannot delete yourself");

        db.Remove(data!);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Delete(Commons.Enums.SystemAuditModule.User, data!.StaffId.ToString(), $"User: {data.FullName}", data);
        sysAuditService.LogInBackground(log);

        return mapper.Map<UserVM>(data);
    }
}