using AutoMapper;
using Force.DeepCloner;
using Microsoft.EntityFrameworkCore;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Extensions;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.CompanyWorks;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Entities.Clients;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Persistence;
using SWSA.MvcPortal.Persistence.QueryExtensions;
using SWSA.MvcPortal.Services.Interfaces.Auths;
using SWSA.MvcPortal.Services.Interfaces.Systems;
using SWSA.MvcPortal.Services.Interfaces.WorkAssignments;

namespace SWSA.MvcPortal.Services.WorkAssignments;

// <auto-generated />
public class CompanyWorkAssignmentService(
IMapper mapper,
IUserContext userContext,
ISystemAuditLogService sysAuditService,
IWorkAssignmentFactory workAssignmentFactory,
AppDbContext db
) : ICompanyWorkAssignmentService
{
    private readonly DbSet<User> users = db.Set<User>();
    private readonly DbSet<WorkAssignment> workAssignments = db.Set<WorkAssignment>();
    private readonly DbSet<BaseClient> clients = db.Set<BaseClient>();
    #region VM/DTO Query Method 

    public async Task<List<T>> GetWorkAssignments<T>() where T : WorkAssignment
    {
        var data = await workAssignments.OfType<T>().ToListAsync();
        return data;
    }

    public async Task<T> GetWorkAssignmentById<T>(int taskId) where T : WorkAssignment
    {
        var data = await workAssignments.OfType<T>().FirstOrDefaultAsync(c => c.Id == taskId);
        Guard.AgainstNullData(data, "Company Work Assignment not found");

        return data!;
    }
    #endregion

    public async Task<int> Create(CreateCompanyWorkAssignmentRequest req)
    {
        var entity = mapper.Map<WorkAssignment>(req);

        entity.Progress = new WorkProgress();

        var allStaffIds = (req.AssignedUserIds ?? Enumerable.Empty<string>())
                    .Distinct()
                    .ToList();

        var staffIdToUserId = await users.GetUserIdDictionaryByStaffIdAsync(allStaffIds);
        var assignedUserEntities = WorkAssignedUsersMapper.ToEntities([.. staffIdToUserId.Values]);
        entity.AssignedUsers.AddRangeSafe(assignedUserEntities);
        db.Add(entity);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.CompanyWorkAssignment, entity.Id.ToString(), $"Company Work Assignment : {entity.WorkType.GetDisplayName()}", entity);
        sysAuditService.LogInBackground(log);
        return entity.Id;
    }

    public async Task<WorkAssignment> Delete(int taskId)
    {
        var data = await workAssignments.FirstOrDefaultAsync(c => c.Id == taskId);
        Guard.AgainstNullData(data, "Company Work Assignment not found");

        db.Remove(data!);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Delete(SystemAuditModule.CompanyWorkAssignment, data!.Id.ToString(), $"Company Work Assignment : {data.WorkType.GetDisplayName()}", data);
        sysAuditService.LogInBackground(log);
        return data!;
    }

    public async Task<int> RequestWorkAssignment(WorkAssignmentRequest req)
    {
        var client = await clients.FirstOrDefaultAsync(c => c.Id == req.ClientId);
        Guard.AgainstNullData(client, "Client not found");
        var entity = workAssignmentFactory.Create(req, client!);

        entity.Progress = new WorkProgress();

        var assignedUserEntities = WorkAssignedUsersMapper.ToEntities([userContext.EntityId]);
        entity.AssignedUsers.AddRangeSafe(assignedUserEntities);

        db.Add(entity);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.CompanyWorkAssignment, entity.Id.ToString(), $"Company Work Assignment : {entity.WorkType.GetDisplayName()}", entity);
        sysAuditService.LogInBackground(log);
        return entity.Id;
    }

    public async Task<bool> UpdateWork<TRequest, TEntity>(TRequest req)
       where TRequest : IWorkAssignmentUpdater<TEntity>
       where TEntity : Entities.WorkAssignment
    {
        var data = await GetWorkAssignmentById<TEntity>(req.TaskId);
        Guard.AgainstNullData(data, "Task not found");
        var oldData = data.DeepClone();

        req.ApplyTo(data);
        data.Progress?.UpdateProgress();

        db.Update(data);
        await db.SaveChangesAsync();

        //var cp = await companyRepo.GetByIdAsync(req.CompanyId);
        //var log = SystemAuditLogEntry.Update(SystemAuditModule.Company, cp!.Id.ToString(), $"Updated {cp.Name} {data.WorkType.GetDisplayName()} task", oldData, data);
        //sysAuditService.LogInBackground(log);

        return true;
    }
}