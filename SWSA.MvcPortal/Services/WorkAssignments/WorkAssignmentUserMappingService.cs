using Microsoft.EntityFrameworkCore;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.CompanyWorks;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Persistence;
using SWSA.MvcPortal.Persistence.QueryExtensions;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;
using SWSA.MvcPortal.Services.Interfaces.WorkAssignments;

namespace SWSA.MvcPortal.Services.WorkAssignments;

// <auto-generated />
public class WorkAssignmentUserMappingService(
IUserContext userContext,
ISystemAuditLogService sysAuditService,
AppDbContext db
    ) : IWorkAssignmentUserMappingService
{
    private readonly DbSet<User> users = db.Set<User>();
    private readonly DbSet<WorkAssignmentUserMapping> userMappings = db.Set<WorkAssignmentUserMapping>();

    #region VM/DTO Query Method 
    #endregion

    public async Task<int> AddUser(WorkUserRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);

        var user = await users.FirstOrDefaultAsync(c => c.StaffId == req.StaffId);
        Guard.AgainstNullData(user, "User not found");

        var mapUser = await userMappings.ExistAsyn(req.TaskId, user!.Id);
        if (mapUser)
            throw new BadHttpRequestException($"User already exists in work assignment");

        var entity = new WorkAssignmentUserMapping()
        {
            UserId = user.Id,
            WorkAssignmentId = req.TaskId,
        };

        db.Add(entity);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.CompanyWorkAssignment,
            user.StaffId.ToString(), $"Assign work to User: {user.FullName}", mapUser!);
        sysAuditService.LogInBackground(log);

        return entity.Id;
    }

    public async Task<bool> RemoveUser(WorkUserRequest req)
    {
        Guard.AgainstNotSuperAdmin(userContext);
        var user = await users.FirstOrDefaultAsync(c => c.StaffId == req.StaffId);
        Guard.AgainstNullData(user, "User not found");

        var userMap = await userMappings.GetByTaskIdAndUserId(req.TaskId, user!.Id);
        Guard.AgainstNullData(userMap, "User Mapping not found");

        db.Remove(userMap);
        await db.SaveChangesAsync();

        var log = SystemAuditLogEntry.Delete(SystemAuditModule.CompanyWorkAssignment,
            user.StaffId.ToString(), $"Remove User: {user.FullName} from work", userMap!);
        sysAuditService.LogInBackground(log);

        return true;
    }
}