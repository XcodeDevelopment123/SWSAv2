using AutoMapper;
using Force.DeepCloner;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.Submission;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.Submissions;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Repositories.Interfaces;
using SWSA.MvcPortal.Services.Interfaces.Submission;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;

namespace SWSA.MvcPortal.Services.Submission;

// <auto-generated />
public class LLPSubmissionService(
    ILLPSubmissionRepository repo,
    IMapper mapper,
    IUserContext userContext,
    ISystemAuditLogService sysLLPService,
    ICompanyRepository companyRepo,
    ICompanyWorkAssignmentRepository workAssignmentRepo
) : ILLPSubmissionService
{
    #region VM/DTO Query Method 
    public async Task<List<LLPSubmissionVM>> GetLLPSubmissionVMsAsync()
    {
        var data = await repo.GetListVMAsync();
        //For download /view link 
        return mapper.Map<List<LLPSubmissionVM>>(data);
    }

    public async Task<LLPSubmissionVM> GetLLPSubmissionVMByIdAsync(int submissionId)
    {
        var data = await repo.GetVMByIdAsync(submissionId);
        Guard.AgainstUnauthorizedCompanyAccess(data.GetCompanyId(), null, userContext);
        //For download /view link 

        return mapper.Map<LLPSubmissionVM>(data);
    }
    #endregion

    public async Task<int> RequestSubmissionForCompany(SubmissionRequest req)
    {
        Guard.AgainstUnauthorizedCompanyAccess(req.CompanyId, null, userContext);
        var cp = await companyRepo.GetWithIncludedByIdAsync(req.CompanyId);
        Guard.AgainstNullData(cp, "Company not found");

        var entity = new LLPSubmission()
        {
            ForYear = req.ForYear,
            Remarks = "Request for LLP submission",
        };

        List<WorkAssignmentUserMapping> assignedUser = userContext.IsSuperAdmin
            ? [..cp!.UserCompanyDepartments.Select(c => c.UserId).Distinct()
            .Select(c=> new WorkAssignmentUserMapping {
                UserId = c
            })] //Super admin assign to all handle user
                : [new WorkAssignmentUserMapping {
            UserId = userContext.EntityId,
          }]; //System user assign to self

        var task = new CompanyWorkAssignment
        {
            CompanyId = req.CompanyId,
            WorkType = WorkType.LLP,
            ServiceScope = ServiceScope.Other,
            CompanyActivityLevel = cp.CompanyActivityLevel,
            CompanyStatus = cp.CompanyStatus,
            LLPSubmission = entity,
            InternalNote = "Request for LLP submission",
            IsYearEndTask = false,
            AssignedUsers = assignedUser,
            Progress = new CompanyWorkProgress(),
        };

        workAssignmentRepo.Add(task);
        await repo.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.Company, req.CompanyId.ToString(), $"Requested {cp.Name} LLP submission", entity);
        sysLLPService.LogInBackground(log);
        return entity.Id;
    }


    public async Task<bool> UpdateSubmissionForCompany(EditLLPSubmissionRequest req)
    {
        Guard.AgainstUnauthorizedCompanyAccess(req.CompanyId, null, userContext);
        var data = await repo.GetByIdAsync(req.SubmissionId);
        Guard.AgainstNullData(data, "Submission not found");
        var task = await workAssignmentRepo.GetUpdateVMById(data!.WorkAssignmentId);
        Guard.AgainstNullData(task, "Task not found");
        var cp = await companyRepo.GetByIdAsync(req.CompanyId);
        Guard.AgainstNullData(cp, "Company not found");

        var oldData = data!.DeepClone();

        UpdateSubmissionFields(data, req);
        UpdateWorkAssignmentProgress(task, data);

        workAssignmentRepo.Update(task!);
        repo.Update(data);
        await repo.SaveChangesAsync();
        var log = SystemAuditLogEntry.Update(SystemAuditModule.Company, req.CompanyId.ToString(), $"Updated {cp.Name} LLP report submission", oldData, data);
        sysLLPService.LogInBackground(log);
        return true;
    }

    private void UpdateSubmissionFields(LLPSubmission data, EditLLPSubmissionRequest req)
    {
        data.SSMExtensionDateForAcc = req.SSMExtensionDateForAcc;
        data.ARDueDate = req.ARDueDate;
        data.AccountSubmitDate = req.AccountSubmitDate;
        data.ARSubmitDate = req.ARSubmitDate;
        data.DateSentToClient = req.DateSentToClient;
        data.DateReturnedByClient = req.DateReturnedByClient;
        data.Remarks = req.Remarks;
    }

    private void UpdateWorkAssignmentProgress(CompanyWorkAssignment task, LLPSubmission data)
    {
        if (task.Progress != null && task.Progress.Status == WorkProgressStatus.Pending)
        {
            //Some business logic checking for task complete
            if (data.IsSubmissionComplete())
            {
                task.Progress.Complete();
            }
            else
            {
                task.Progress.Processing();
            }
        }
    }
}