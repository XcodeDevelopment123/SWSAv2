
using AutoMapper;
using Force.DeepCloner;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Exceptions;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.Submission;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.Submissions;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Repositories.Interfaces;
using SWSA.MvcPortal.Services.Interfaces.Submission;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;

namespace SWSA.MvcPortal.Services.Submission;

// <auto-generated />
public class CompanyStrikeOffSubmissionService(
IMapper mapper,
IUserContext userContext,
ISystemAuditLogService sysAuditService,
ICompanyStrikeOffSubmissionRepository repo,
ICompanyRepository companyRepo,
ICompanyWorkAssignmentRepository workAssignmentRepo
) : ICompanyStrikeOffSubmissionService
{
    #region VM/DTO Query Method 
    public async Task<List<CompanyStrikeOffSubmissionVM>> GetStrikeOffSubmissionVMsAsync()
    {
        var data = await repo.GetListVMAsync();
        //For download /view link 
        return mapper.Map<List<CompanyStrikeOffSubmissionVM>>(data);
    }

    public async Task<CompanyStrikeOffSubmissionVM> GetStrikeOffSubmissionVMByIdAsync(int submissionId)
    {
        var data = await repo.GetVMByIdAsync(submissionId);
        Guard.AgainstUnauthorizedCompanyAccess(data.GetCompanyId(), null, userContext);
        //For download /view link 

        return mapper.Map<CompanyStrikeOffSubmissionVM>(data);
    }
    #endregion


    public async Task<int> RequestSubmissionForCompany(int companyId)
    {
        Guard.AgainstUnauthorizedCompanyAccess(companyId, null, userContext);
        var cp = await companyRepo.GetWithIncludedByIdAsync(companyId);
        Guard.AgainstNullData(cp, "Company not found");

        var submission = await repo.GetByCompanyId(companyId);
        if (submission != null)
        {
            throw new BusinessLogicException("Company already submitted for strike off");
        }

        var entity = new CompanyStrikeOffSubmission()
        {
            CompanyId = companyId,
            StartDate = DateTime.Today,
            Remarks = "Request for strike off submission",
        };

        List<WorkAssignmentUserMapping> assignedUser = userContext.IsSuperAdmin
            ? [..cp!.UserCompanyDepartments.Select(c => c.UserId).Distinct()
            .Select(c=> new WorkAssignmentUserMapping {
                UserId = c
            })] //Super admin assign to all handle user
                : [new WorkAssignmentUserMapping {
            UserId = userContext.EntityId,
          }]; //System user assign to self

        var task = new CompanyWorkAssignment
        {
            CompanyId = companyId,
            WorkType = WorkType.StrikeOff,
            ServiceScope = ServiceScope.Other,
            CompanyActivityLevel = cp.CompanyActivityLevel,
            CompanyStatus = cp.CompanyStatus,
            StrikeOffSubmission = entity,
            InternalNote = "Request for strike off submission",
            IsYearEndTask = false,
            AssignedUsers = assignedUser,
            Progress = new CompanyWorkProgress(),
        };

        cp!.StrikeOffStatus = StrikeOffStatus.Applying;
        companyRepo.Update(cp);

        workAssignmentRepo.Add(task);
        await repo.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.Company, companyId.ToString(), $"Requested {cp.Name} strike off submission", entity);
        sysAuditService.LogInBackground(log);
        return entity.Id;
    }

    public async Task<bool> UpdateSubmissionForCompany(EditCompanyStrikeOffSubmissionRequest req)
    {
        Guard.AgainstUnauthorizedCompanyAccess(req.CompanyId, null, userContext);
        var data = await repo.GetByIdAsync(req.SubmissionId);
        Guard.AgainstNullData(data, "Submission not found");
        var task = await workAssignmentRepo.GetUpdateVMById(data!.WorkAssignmentId);
        Guard.AgainstNullData(task, "Task not found");
        var cp = await companyRepo.GetByIdAsync(req.CompanyId);
        Guard.AgainstNullData(cp, "Company not found");

        var oldData = data!.DeepClone();

        UpdateSubmissionFields(data, req);
        UpdateCompanyStrikeOff(cp!, data, task);
        UpdateWorkAssignmentProgress(task);

        workAssignmentRepo.Update(task!);
        companyRepo.Update(cp!);
        repo.Update(data);
        await repo.SaveChangesAsync();
        var log = SystemAuditLogEntry.Update(SystemAuditModule.Company, req.CompanyId.ToString(), $"Updated {cp.Name} strike off submission", oldData, data);
        sysAuditService.LogInBackground(log);
        return true;
    }

    private void UpdateSubmissionFields(CompanyStrikeOffSubmission data, EditCompanyStrikeOffSubmissionRequest req)
    {
        data.CompleteDate = req.CompleteDate;
        data.SSMStrikeOffDate = req.SSMStrikeOffDate;
        data.SSMSubmissionDate = req.SSMSubmissionDate;
        data.IRBSubmissionDate = req.IRBSubmissionDate;
        data.Remarks = req.Remarks;
    }

    private void UpdateCompanyStrikeOff(Company cp, CompanyStrikeOffSubmission data, CompanyWorkAssignment task)
    {
        if (data.CompleteDate.HasValue && data.SSMStrikeOffDate.HasValue)
        {
            cp.StrikeOffStatus = StrikeOffStatus.Completed;
            cp.StrikeOffEffectiveDate = data.SSMStrikeOffDate;
            cp.IsStrikedOff = true;
            if (task.Progress != null && task.Progress.Status != WorkProgressStatus.Completed)
            {
                task.Progress.Complete();
            }
        }
        else
        {
            cp.StrikeOffStatus = StrikeOffStatus.Applying;
        }
    }

    private void UpdateWorkAssignmentProgress(CompanyWorkAssignment task)
    {
        if (task.Progress != null && task.Progress.Status == WorkProgressStatus.Pending)
        {
            task.Progress.Status = WorkProgressStatus.InProgress;
            task.Progress.StartDate = DateTime.Today;
            task.Progress.UpdatedAt = DateTime.Now;
        }
    }
}