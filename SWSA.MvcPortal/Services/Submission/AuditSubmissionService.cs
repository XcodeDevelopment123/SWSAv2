using AutoMapper;
using Force.DeepCloner;
using SWSA.MvcPortal.Commons.Enums;
using SWSA.MvcPortal.Commons.Guards;
using SWSA.MvcPortal.Dtos.Requests.Submission;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.Submissions;
using SWSA.MvcPortal.Models.SystemAuditLogs;
using SWSA.MvcPortal.Repositories.Interfaces;
using SWSA.MvcPortal.Services.Interfaces.Submission;
using SWSA.MvcPortal.Services.Interfaces.SystemCore;
using SWSA.MvcPortal.Services.Interfaces.SystemInfra;

namespace SWSA.MvcPortal.Services.Submission;

// <auto-generated />
public class AuditSubmissionService(
    IAuditSubmissionRepository repo,
    IMapper mapper,
    IUserContext userContext,
    ISystemAuditLogService sysAuditService,
    ICompanyRepository companyRepo,
    ICompanyWorkAssignmentRepository workAssignmentRepo
) : IAuditSubmissionService
{
    #region VM/DTO Query Method 
    public async Task<List<AuditSubmissionVM>> GetAuditSubmissionVMsAsync()
    {
        var data = await repo.GetListVMAsync();
        //For download /view link 
        return mapper.Map<List<AuditSubmissionVM>>(data);
    }

    public async Task<AuditSubmissionVM> GetAuditSubmissionVMByIdAsync(int submissionId)
    {
        var data = await repo.GetVMByIdAsync(submissionId);
        Guard.AgainstUnauthorizedCompanyAccess(data.GetCompanyId(), null, userContext);
        //For download /view link 

        return mapper.Map<AuditSubmissionVM>(data);
    }
    #endregion

    public async Task<int> RequestSubmissionForCompany(int companyId)
    {
        Guard.AgainstUnauthorizedCompanyAccess(companyId, null, userContext);
        var cp = await companyRepo.GetWithIncludedByIdAsync(companyId);
        Guard.AgainstNullData(cp, "Company not found");



        var entity = new AuditSubmission()
        {
            Remarks = "Request for audit report submission",
            FirstYearAccountStart = cp!.IncorporationDate?.AddMonths(17) ?? null,
        };

        entity.SetTargettedCirculation(cp.YearEndMonth);

        List<WorkAssignmentUserMapping> assignedUser = userContext.IsSuperAdmin
            ? [..cp!.UserCompanyDepartments.Select(c => c.UserId).Distinct()
            .Select(c=> new WorkAssignmentUserMapping {
                UserId = c
            })] //Super admin assign to all handle user
                : [new WorkAssignmentUserMapping {
            UserId = userContext.EntityId,
          }]; //System user assign to self

        var task = new CompanyWorkAssignment
        {
            CompanyId = companyId,
            WorkType = WorkType.Audit,
            ServiceScope = ServiceScope.Other,
            CompanyActivityLevel = cp.CompanyActivityLevel,
            CompanyStatus = cp.CompanyStatus,
            AuditSubmission = entity,
            InternalNote = "Request for audit report submission",
            IsYearEndTask = false,
            AssignedUsers = assignedUser,
            Progress = new CompanyWorkProgress(),
        };

        workAssignmentRepo.Add(task);
        await repo.SaveChangesAsync();

        var log = SystemAuditLogEntry.Create(SystemAuditModule.Company, companyId.ToString(), $"Requested {cp.Name} audit report submission", entity);
        sysAuditService.LogInBackground(log);
        return entity.Id;
    }


    public async Task<bool> UpdateSubmissionForCompany(EditAuditSubmissionRequest req)
    {
        Guard.AgainstUnauthorizedCompanyAccess(req.CompanyId, null, userContext);
        var data = await repo.GetByIdAsync(req.SubmissionId);
        Guard.AgainstNullData(data, "Submission not found");
        var task = await workAssignmentRepo.GetUpdateVMById(data!.WorkAssignmentId);
        Guard.AgainstNullData(task, "Task not found");
        var cp = await companyRepo.GetByIdAsync(req.CompanyId);
        Guard.AgainstNullData(cp, "Company not found");

        var oldData = data!.DeepClone();

        UpdateSubmissionFields(data, req);
        UpdateWorkAssignmentProgress(task, data);

        workAssignmentRepo.Update(task!);
        repo.Update(data);
        await repo.SaveChangesAsync();
        var log = SystemAuditLogEntry.Update(SystemAuditModule.Company, req.CompanyId.ToString(), $"Updated {cp.Name} audit report submission", oldData, data);
        sysAuditService.LogInBackground(log);
        return true;
    }

    private void UpdateSubmissionFields(AuditSubmission data, EditAuditSubmissionRequest req)
    {
        data.FirstYearAccountStart = req.FirstYearAccountStart;
        data.AccDueDate = req.AccDueDate;
        data.TargettedCirculation = req.TargettedCirculation;
        data.DateSubmitted = req.DateSubmitted;
        data.ReasonForLate = req.ReasonForLate;

        if (req.AccDueDate.HasValue && req.DateSubmitted.HasValue)
        {
            data.IsLate = req.DateSubmitted > req.AccDueDate;
        }
    }

    private void UpdateWorkAssignmentProgress(CompanyWorkAssignment task, AuditSubmission data)
    {
        if (task.Progress != null && task.Progress.Status == WorkProgressStatus.Pending)
        {
            task.Progress.Status = WorkProgressStatus.InProgress;
            task.Progress.StartDate = DateTime.Today;
            task.Progress.UpdatedAt = DateTime.Now;

            //Some business logic checking for task complete
            if (data.IsSubmissionComplete())
            {
                task.Progress.Complete();
            }
        }
    }

}