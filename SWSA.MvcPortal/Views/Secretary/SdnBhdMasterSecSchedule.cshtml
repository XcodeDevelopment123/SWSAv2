@{
    ViewData["Title"] = "SdnBhdMasterSecSchedule";
}

<h1>Sdn Bhd Master Sec Schedule</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="3">Admin</th>
                            <th colspan="3">Co Information</th>
                            <th colspan="11">Scheduling</th>
                            <th colspan="2">Actions</th>
                        </tr>


                        <tr>
                            <th rowspan="2">Grouping</th>
                            <th rowspan="2">Refferal</th>
                            <th rowspan="2">Sec file no</th>

                            <th rowspan="2">Co Name</th>
                            <th rowspan="2">Co Type</th>
                            <th rowspan="2">Year End</th>

                            <th colspan="5">Work Allocation</th>
                            <th colspan="3">SSM Due Dates</th>
                            <th colspan="3">SSM Submission</th>

                            <th rowspan="2">Edit</th>
                            <th rowspan="2">Delete</th>
                        </tr>

                        <tr>
                            <th>Co Status</th>
                            <th>Active Co:Activity size</th>
                            <th>YE to Do</th>
                            <th>ACC Mth to do</th>
                            <th>Audit Mth to do</th>
                            <th>1st yr 18 mths due date</th>
                            <th>Circulation & AFS due date</th>
                            <th>Ann Return (AR) Due date</th>
                            <th>AFS Submitted date</th>
                            <th>AR Submitted date</th>
                            <th>Job Completed/Backlog</th>
                        </tr>
                    </thead>
                    <tbody>
                  
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Sdn Bhd Master Sec Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Admin Information -->
                    <div class="form-info-label col-12">
                        <label>Admin Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Enter grouping" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="referral">Refferal</label>
                                <input type="text" id="referral" name="referral" class="form-control" placeholder="Enter referral" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="secFileNo">Sec file no</label>
                                <input type="text" id="secFileNo" name="secFileNo" class="form-control" placeholder="Enter sec file number" />
                            </div>
                        </div>
                    </div>

                    <!-- Source from AT21 / AEX41 -->
                    <div class="form-info-label col-12">
                        <label>Source (AT21 / AEX41)</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sourceOption">Link from 2.1 / 4.1</label>
                                <select id="sourceOption" name="sourceOption" class="form-control">
                                    <option value="">-- Select from AT21 / AEX41 --</option>
                                </select>
                                <small class="text-muted">
                                    Select a record from AT21 / AEX41 to auto-fill Year End, 18 mths due, AFS due, ACC & Audit month.
                                </small>
                            </div>
                        </div>
                    </div>


                    <!-- Company Information -->
                    <div class="form-info-label col-12">
                        <label>Company Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coName">Co Name</label>
                                <input type="text" id="coName" name="coName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coType">Co Type</label>
                                <select id="coType" name="coType" class="form-control">
                                    <option value="">Select Type</option>
                                    <option value="Sdn Bhd">Sdn Bhd</option>
                                    <option value="Bhd">Bhd</option>
                                    <option value="Enterprise">Enterprise</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Work Allocation -->
                    <div class="form-info-label col-12">
                        <label>Work Allocation</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="activitySize">Active Co:Activity size</label>
                                <select id="activitySize" name="activitySize" class="form-control">
                                    <option value="">Select Size</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="yeToDo">YE to Do</label>
                                <input type="text" id="yeToDo" name="yeToDo" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="accMthToDo">ACC Mth to do</label>
                                <input type="text" id="accMthToDo" name="accMthToDo" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="auditMthToDo">Audit Mth to do</label>
                                <input type="text" id="auditMthToDo" name="auditMthToDo" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- SSM Due Dates -->
                    <div class="form-info-label col-12">
                        <label>SSM Due Dates</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="firstYearDueDate">1st yr 18 mths due date</label>
                                <input type="text" id="firstYearDueDate" name="firstYearDueDate" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="circulationDueDate">Circulation & AFS due date</label>
                                <input type="text" id="circulationDueDate" name="circulationDueDate" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="arDueDate">Ann Return (AR) Due date</label>
                                <input type="text" id="arDueDate" name="arDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- SSM Submission -->
                    <div class="form-info-label col-12">
                        <label>SSM Submission</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="afsSubmittedDate">AFS Submitted date</label>
                                <input type="text" id="afsSubmittedDate" name="afsSubmittedDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="arSubmittedDate">AR Submitted date</label>
                                <input type="text" id="arSubmittedDate" name="arSubmittedDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="jobStatus">Job Completed/Backlog</label>
                                <select id="jobStatus" name="jobStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;

        let s13aSources = [];

        // 输入任何日期字串，先转成 dd/MM/yyyy，再加 N 个月，返回 MM/yyyy
        function addMonthsToDdMmYyyy(dateStr, monthsToAdd) {
            if (!dateStr) return '';

            // 先统一转 dd/MM/yyyy
            const s = formatDateForDisplay(dateStr);
            const parts = s.split('/');
            if (parts.length !== 3) return '';

            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // 0-11
            const year = parseInt(parts[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year)) return '';

            const d = new Date(year, month, day);
            d.setMonth(d.getMonth() + monthsToAdd);

            const m = String(d.getMonth() + 1).padStart(2, '0');
            const y = d.getFullYear();

            // ACC / Audit 只是月份，用 MM/yyyy
            return `${m}/${y}`;
        }

        // ---------- 载入 AT21 + AEX41 的 Source Options ----------
        function loadS13ASourceOptions() {
            $.ajax({
                url: 'get-s13a-source-options',   // 对应 [HttpGet("get-s13a-source-options")]
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        s13aSources = res.data || [];
                        const $select = $('#sourceOption');

                        $select.empty();
                        $select.append('<option value="">-- Select from AT21 / AEX41 --</option>');

                        s13aSources.forEach(function (item) {
                            const sourceType = item.sourceType || item.SourceType || '';
                            const sourceId = item.sourceId || item.SourceId || 0;
                            const companyName = item.companyName || item.CompanyName || '';
                            let yearEndRaw = item.yearEnd || item.YearEnd || '';
                            let yearEndDisplay = yearEndRaw || '';
                            const text = `${companyName} (${yearEndDisplay}) [${sourceType}]`;
                            const value = `${sourceType}|${sourceId}`;

                            $select.append(
                                `<option value="${value}">${text}</option>`
                            );
                        });
                    } else {
                        showAlert('Failed to load source options: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load source options: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- 当用户选择了一个 Source ----------
        function onSourceOptionChanged() {
            const val = $(this).val();
            if (!val) {
                // 如果用户清空选择，不做事
                return;
            }

            const parts = val.split('|');
            if (parts.length !== 2) return;

            const sourceType = parts[0];
            const sourceId = parseInt(parts[1], 10);

            const src = s13aSources.find(function (x) {
                const st = x.sourceType || x.SourceType;
                const sid = x.sourceId || x.SourceId;
                return st === sourceType && sid === sourceId;
            });

            if (!src) return;

            const companyName = src.companyName || src.CompanyName || '';
            const yearEndRaw = src.yearEnd || src.YearEnd || '';
            const first18Raw = src.first18MthsDue || src.First18MthsDue || '';
            const afsDueRaw = src.afsDueDate || src.AfsDueDate || '';

            // 统一转 dd/MM/yyyy
            const yearEndDisplay = (src.yearEnd || src.YearEnd || '').trim();       // 已经是 dd/MM/yyyy
            const first18Display = (src.first18MthsDue || src.First18MthsDue || '').trim();     // dd/MM/yyyy
            const afsDueDisplay = (src.afsDueDate || src.AfsDueDate || '').trim();       // dd/MM/yyyy


            // 1️⃣ 自动填 Company 信息 + Year End
            $('#coName').val(companyName);
            $('#yearEnd').val(yearEndDisplay);

            // 2️⃣ 自动填 YE to Do（直接取年份）
            let yeYear = '';
            if (yearEndDisplay && yearEndDisplay.split('/').length === 3) {
                yeYear = yearEndDisplay.split('/')[2]; // 27/02/2025 -> 2025
            }
            $('#yeToDo').val(yeYear);

            // 3️⃣ 自动填 1st yr 18 mths due date
            $('#firstYearDueDate').val(first18Display);

            // 4️⃣ 自动填 Circulation & AFS due date
            $('#circulationDueDate').val(afsDueDisplay);

            // 5️⃣ 自动计算 ACC Mth to do (YE + 4 mth)
            const accMonth = addMonthsToDdMmYyyy(yearEndDisplay, 4);
            $('#accMthToDo').val(accMonth);

            // 6️⃣ 自动计算 Audit Mth to do (YE + 6 mth)
            const auditMonth = addMonthsToDdMmYyyy(yearEndDisplay, 6);
            $('#auditMthToDo').val(auditMonth);
        }


        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }
        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }
        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }
        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert (outside modal) ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            if (typeof s !== 'string') s = String(s);
            s = s.trim();
            if (!s) return '';

            // 已经是 dd/MM/yyyy 了
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
                return s;
            }

            // /Date(1730006400000)/
            let m = /\/Date\((\d+)\)\//.exec(s);
            if (m) {
                const ticks = parseInt(m[1], 10);
                if (!isNaN(ticks)) {
                    const d = new Date(ticks);
                    return formatDateObjToDdMmYyyy(d);
                }
            }

            // ISO: 2025-02-27T00:00:00
            m = /^(\d{4})-(\d{2})-(\d{2})/.exec(s);
            if (m) {
                const y = parseInt(m[1], 10);
                const mo = parseInt(m[2], 10) - 1;
                const d = parseInt(m[3], 10);
                const dt = new Date(y, mo, d);
                return formatDateObjToDdMmYyyy(dt);
            }

            // 像 "Feb 27 2025 12:00AM" 这种，丢给 Date 解析
            const dt2 = new Date(s);
            if (!isNaN(dt2.getTime())) {
                return formatDateObjToDdMmYyyy(dt2);
            }

            // 实在不认识，就原样返回
            return s;
        }

        function formatDateObjToDdMmYyyy(d) {
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function getVal(obj, name) {
            if (!obj) return '';

            // 1) 完全一样的 key
            if (obj[name] !== undefined && obj[name] !== null) {
                return obj[name];
            }

            // 2) camelCase 版本
            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) {
                return obj[camel];
            }

            // 3) 忽略大小写，遍历一次所有 key
            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) {
                    return obj[key];
                }
            }
            return '';
        }


        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New Sdn Bhd Master Sec Record');
            hideModalAlert();
            clearFieldErrors();
        }

        // ---------- Init ----------
        $(document).ready(function () {

            loadS13ASourceOptions();

            $('#sourceOption').on('change', onSourceOptionChanged);

            // Datepicker：套在所有需要选日期的栏位
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return id.includes('Date') || id.includes('date') || id.includes('yearEnd');
            }).datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // DataTable - 对应 S13A 的列
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                ordering: true,
                autoWidth: false,
                pageLength: 10,
                order: [[3, 'asc']], // Co Name 排序
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No records found",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columns: [
                    { data: 0 },  // Grouping
                    { data: 1 },  // Referral
                    { data: 2 },  // Sec file no
                    { data: 3 },  // Co Name
                    { data: 4 },  // Co Type
                    { data: 5 },  // Year End
                    { data: 6 },  // Co Status
                    { data: 7 },  // Active Co:Activity size
                    { data: 8 },  // YE to Do
                    { data: 9 },  // ACC Mth to do
                    { data: 10 }, // Audit Mth to do
                    { data: 11 }, // 1st yr 18 mths due date
                    { data: 12 }, // Circulation & AFS due date
                    { data: 13 }, // Ann Return (AR) Due date
                    { data: 14 }, // AFS Submitted date
                    { data: 15 }, // AR Submitted date
                    { data: 16 }, // Job Completed/Backlog
                    { data: 17, orderable: false, searchable: false }, // Edit
                    { data: 18, orderable: false, searchable: false }  // Delete
                ]

            });
            dataTableInitialized = true;

            // 绑定按钮
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            // New Task 按钮（modal header 右上角那个）
            $('[data-bs-target="#taskModal"]').on('click', function () {
                clearForm();
            });

            // 第一次载入
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: 'api/s13a/get-all',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                        console.log('sample keys:', Object.keys((res.data || [])[0] || {}));

                    } else {
                        showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r) {
                    const id = getVal(r, 'Id');

                    dataTable.row.add([
                        getVal(r, 'Grouping'),                 // 0
                        getVal(r, 'Referral'),                 // 1
                        getVal(r, 'SecFileNo'),                // 2
                        getVal(r, 'CompanyName'),              // 3
                        getVal(r, 'CompanyType'),              // 4
                        formatDateForDisplay(getVal(r, 'YearEnd')),          // 5
                        getVal(r, 'CompanyStatus'),            // 6
                        getVal(r, 'ActiveCoActivitySize'),     // 7
                        getVal(r, 'YEtoDo'),                   // 8
                        getVal(r, 'ACCmthTodo'),               // 9
                        getVal(r, 'AuditMthTodo'),             // 10
                        formatDateForDisplay(getVal(r, 'YrMthDueDate')),     // 11
                        formatDateForDisplay(getVal(r, 'Circulation')),      // 12
                        formatDateForDisplay(getVal(r, 'ARdueDate')),        // 13
                        formatDateForDisplay(getVal(r, 'AFSSubmitDate')),    // 14
                        formatDateForDisplay(getVal(r, 'ARSubmitDate')),     // 15
                        getVal(r, 'JobCompleted'),             // 16
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                <i class="fas fa-edit"></i>
             </button>`,

                        // 18: Delete 按钮
                        `<button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                <i class="fas fa-trash"></i>
             </button>`
                    ]);
                });
            }

            dataTable.draw();
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                Grouping: ($('#grouping').val() || '').trim(),
                Referral: ($('#referral').val() || '').trim(),
                SecFileNo: ($('#secFileNo').val() || '').trim(),

                CompanyName: ($('#coName').val() || '').trim(),
                CompanyType: ($('#coType').val() || '').trim(),
                YearEnd: ($('#yearEnd').val() || '').trim(),

                CompanyStatus: ($('#coStatus').val() || '').trim(),
                ActiveCoActivitySize: ($('#activitySize').val() || '').trim(),
                YEtoDo: ($('#yeToDo').val() || '').trim(),
                ACCmthTodo: ($('#accMthToDo').val() || '').trim(),
                AuditMthTodo: ($('#auditMthToDo').val() || '').trim(),

                YrMthDueDate: ($('#firstYearDueDate').val() || '').trim(),
                Circulation: ($('#circulationDueDate').val() || '').trim(),
                ARdueDate: ($('#arDueDate').val() || '').trim(),

                AFSSubmitDate: ($('#afsSubmittedDate').val() || '').trim(),
                ARSubmitDate: ($('#arSubmittedDate').val() || '').trim(),
                JobCompleted: ($('#jobStatus').val() || '').trim()
            };

            // 简单必填验证（你可以再调整）
            let hasError = false;
            if (!formData.Grouping) {
                setFieldError('#grouping', 'Required');
                hasError = true;
            }
            if (!formData.Referral) {
                setFieldError('#referral', 'Required');
                hasError = true;
            }
            if (!formData.SecFileNo) {
                setFieldError('#secFileNo', 'Required');
                hasError = true;
            }
            if (!formData.CompanyName) {
                setFieldError('#coName', 'Required');
                hasError = true;
            }
            if (!formData.CompanyType) {
                setFieldError('#coType', 'Required');
                hasError = true;
            }
            if (!formData.YearEnd) {
                setFieldError('#yearEnd', 'Required');
                hasError = true;
            }

            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? 'api/s13a/update' : 'api/s13a/create';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');

                        if (res.s14bAction === 'created') {
                            showAlert('Related S1.4B record has been CREATED.', 'info');
                        } else if (res.s14bAction === 'updated') {
                            showAlert('Related S1.4B record has been UPDATED.', 'info');
                        }
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ------------ Edit -------------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: 'api/s13a/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Sdn Bhd Master Sec Record');
                    if (res && res.success) {
                        const d = res.data || {};

                        $('#editIndex').val(getVal(d, 'Id'));

                        $('#grouping').val(getVal(d, 'Grouping'));
                        $('#referral').val(getVal(d, 'Referral'));
                        $('#secFileNo').val(getVal(d, 'SecFileNo'));

                        $('#coName').val(getVal(d, 'CompanyName'));
                        $('#coType').val(getVal(d, 'CompanyType'));
                        $('#yearEnd').val(formatDateForDisplay(getVal(d, 'YearEnd')));

                        $('#coStatus').val(getVal(d, 'CompanyStatus'));
                        $('#activitySize').val(getVal(d, 'ActiveCoActivitySize'));
                        $('#yeToDo').val(getVal(d, 'YEtoDo'));
                        $('#accMthToDo').val(getVal(d, 'ACCmthTodo'));
                        $('#auditMthToDo').val(getVal(d, 'AuditMthTodo'));

                        $('#firstYearDueDate').val(formatDateForDisplay(getVal(d, 'YrMthDueDate')));
                        $('#circulationDueDate').val(formatDateForDisplay(getVal(d, 'Circulation')));
                        $('#arDueDate').val(formatDateForDisplay(getVal(d, 'ARdueDate')));

                        $('#afsSubmittedDate').val(formatDateForDisplay(getVal(d, 'AFSSubmitDate')));
                        $('#arSubmittedDate').val(formatDateForDisplay(getVal(d, 'ARSubmitDate')));
                        $('#jobStatus').val(getVal(d, 'JobCompleted'));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Sdn Bhd Master Sec Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;
            $.ajax({
                url: 'api/s13a/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}
