@{
    ViewData["Title"] = "LLPSubmissionReport";
}

<h1>LLP Submission Report</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">Sec File No</th>
                            <th rowspan="2">Co Name</th>
                            <th rowspan="2">Year End</th>

                            <th colspan="2">Registration</th>
                            <th colspan="2">Work Allocation Info</th>
                            <th colspan="2">SSM Due Dates</th>
                            <th colspan="1">AD Submission Date</th>
                            <th colspan="2">Annual Declaration Client Monitoring</th>

                            <th rowspan="2">Job Completed/Backlog</th>
                            <th colspan="2">Actions</th>

                        </tr>

                        <tr>
                            <th>Incorp Date</th>
                            <th>Co #</th>
                            <th>Co Status</th>
                            <th>Active Co:Activity size</th>
                            <th>SSM Extension date for acc</th>
                            <th>Annual Declaration (AD) Due date</th>
                            <th>AD Submitted date</th>
                            <th>Date send to Client</th>
                            <th>Date Returned</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New LLP Submission Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="secFileNo">Sec File No</label>
                                <input type="text" id="secFileNo" name="secFileNo" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the LLP Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Registration -->
                    <div class="form-info-label col-12">
                        <label>Registration</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="incorpDate">Incorp Date</label>
                                <input type="text" id="incorpDate" name="incorpDate" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="coNumber">Co #</label>
                                <input type="text" id="coNumber" name="coNumber" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Work Allocation Info -->
                    <div class="form-info-label col-12">
                        <label>Work Allocation Info</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                    <option value="In Liquidation">In Liquidation</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="activitySize">Active Co:Activity size</label>
                                <select id="activitySize" name="activitySize" class="form-control">
                                    <option value="">Select Size</option>
                                    <option value="D">D</option>
                                    <option value="SD">SD</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SSM Due Dates -->
                    <div class="form-info-label col-12">
                        <label>SSM Due Dates</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssmExtensionDate">SSM Extension date for acc</label>
                                <input type="text" id="ssmExtensionDate" name="ssmExtensionDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="adDueDate">Annual Declaration (AD) Due date</label>
                                <small class="text-muted">(auto = Year end + 90 days)</small>
                                <input type="text"
                                       id="adDueDate"
                                       name="adDueDate"
                                       class="form-control"
                                       placeholder="Auto calculated"
                                       readonly />
                            </div>
                        </div>

                    </div>

                    <!-- AD Submission Date -->
                    <div class="form-info-label col-12">
                        <label>AD Submission Date</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="adSubmittedDate">AD Submitted date</label>
                                <input type="text" id="adSubmittedDate" name="adSubmittedDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Annual Declaration Client Monitoring -->
                    <div class="form-info-label col-12">
                        <label>Annual Declaration Client Monitoring</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSendToClient">Date send to Client</label>
                                <input type="text" id="dateSendToClient" name="dateSendToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReturned">Date Returned</label>
                                <input type="text" id="dateReturned" name="dateReturned" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Status -->
                    <div class="form-info-label col-12">
                        <label>Completion Status</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobStatus">Job Completed/Backlog</label>
                                <select id="jobStatus" name="jobStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
    // ==========================================
    // 🔴 全局变量
    // ==========================================
    let dataTable;
    let dataTableInitialized = false;
    let llpOptionsList = []; // 存 LLP 的数据

    // ==========================================
    // 🟢 工具函数 (计算与格式化)
    // ==========================================

    // 1. 获取对象属性 (忽略大小写 - 核心防错函数)
    function getVal(obj, name) {
        if (!obj) return '';
        if (obj[name] !== undefined && obj[name] !== null) return obj[name];
        const camel = name.charAt(0).toLowerCase() + name.slice(1);
        if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];
        const targetLower = name.toLowerCase();
        for (const key in obj) {
            if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
            if (key.toLowerCase() === targetLower) return obj[key];
        }
        return '';
    }

    // 2. 格式化 ISO 日期 (2023-01-01T00:00:00 -> 01/01/2023)
    function formatIsoDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return isoString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // 3. 格式化普通日期对象 (Date -> dd/mm/yyyy)
    function formatJsDate(date) {
        if (!date) return '';
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
    }

    // 4. 解析 dd/mm/yyyy 为 Date 对象
    function parseDdMmYyyy(str) {
        if (!str) return null;
        const parts = str.split('/');
        if (parts.length !== 3) return null;
        const d = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const y = parseInt(parts[2], 10);
        if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
        return new Date(y, m, d);
    }

    // 5. 计算 Year End (Month Name -> dd/mm/yyyy)
    function calculateYearEndDate(monthName) {
        if (!monthName) return '';
        const months = {
            "january": 0, "february": 1, "march": 2, "april": 3, "may": 4, "june": 5,
            "july": 6, "august": 7, "september": 8, "october": 9, "november": 10, "december": 11
        };
        const monthIndex = months[monthName.toLowerCase().trim()];
        if (monthIndex === undefined) return '';
        
        const currentYear = new Date().getFullYear();
        const date = new Date(currentYear, monthIndex + 1, 0); // 月末
        return formatJsDate(date);
    }

    // 6. 🟢 核心计算：根据 Year End 算 AD Due Date (+90天)
    function calculateLlpDates() {
        const yearEndStr = $('#yearEnd').val();
        
        if (!yearEndStr) {
            $('#adDueDate').val('');
            return;
        }

        const yearEndDate = parseDdMmYyyy(yearEndStr);
        if (yearEndDate) {
            // Annual Declaration is due 90 days after financial year end
            yearEndDate.setDate(yearEndDate.getDate() + 90);
            $('#adDueDate').val(formatJsDate(yearEndDate));
        }
    }

    // ==========================================
    // 🟢 主逻辑 (Document Ready)
    // ==========================================
    $(document).ready(function () {

        // 1. 初始化 Datepickers
        $('input[type="text"]').filter(function () {
            const id = $(this).attr('id') || '';
            return id.includes('Date') || id.includes('date') || id.includes('yearEnd');
        }).datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true,
            todayHighlight: true
        });

        // 2. 监听手动修改 Year End -> 触发 AD Date 计算
        $('#yearEnd').on('change blur', calculateLlpDates);

        // 3. 加载 LLP 列表
        loadLlpOptions();

        // 4. 🟢 监听 Client 下拉菜单变化 (核心逻辑)
        $('#clientSelect').on('change', function() {
            const selectedId = $(this).val();

            // 清空旧数据
            $('#secFileNo').val('');
            $('#coNumber').val('');
            $('#incorpDate').val('');
            $('#yearEnd').val('');
            $('#client').val('');
            $('#clientId').val('');
            $('#adDueDate').val(''); // 清空计算结果

            if (!selectedId) return;

            // 查找选中的 LLP
            const selectedClient = llpOptionsList.find(c => String(getVal(c, 'Id')) === String(selectedId));

            if (selectedClient) {
                // 填入 ID 和 Name
                $('#clientId').val(getVal(selectedClient, 'Id'));
                $('#client').val(getVal(selectedClient, 'CompanyName')); // Hidden Field

                // 填入 Sec File No 和 Co #
                $('#secFileNo').val(getVal(selectedClient, 'FileNo'));
                $('#coNumber').val(getVal(selectedClient, 'CompanyNo')); // 也就是 Co #

                // 填入并格式化 Incorp Date
                const formattedIncorp = formatIsoDate(getVal(selectedClient, 'IncorporationDate'));
                $('#incorpDate').val(formattedIncorp);

                // 填入并转换 Year End (例如 "December" -> "31/12/2025")
                const formattedYearEnd = calculateYearEndDate(getVal(selectedClient, 'YearEndMonth'));
                $('#yearEnd').val(formattedYearEnd);

                // 刷新 Datepicker 显示
                $('#incorpDate, #yearEnd').datepicker('update');

                // 🔥 触发计算：算 AD Due Date
                calculateLlpDates();
            }
        });

        // 5. DataTable 初始化
        dataTable = $('#taskDatatable').DataTable({
            responsive: true,
            ordering: true,
            autoWidth: false,
            pageLength: 10,
            order: [[1, 'asc']], // Company Name 排序
            columns: [
                { data: 0 }, { data: 1 }, { data: 2 }, { data: 3 }, { data: 4 }, 
                { data: 5 }, { data: 6 }, { data: 7 }, { data: 8 }, { data: 9 }, 
                { data: 10 }, { data: 11 }, { data: 12 },
                { data: 13, orderable: false, searchable: false },
                { data: 14, orderable: false, searchable: false }
            ]
        });
        dataTableInitialized = true;

        // 6. 绑定按钮事件
        $('#saveBtn').click(saveRecord);
        $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
        $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });
        $('#taskModal').on('hidden.bs.modal', clearForm);
        $('[data-bs-target="#taskModal"]').on('click', function () { clearForm(); });

        // 7. 首次加载表格数据
        loadRecordsFromDatabase();
    });

    // ==========================================
    // 🟢 AJAX 函数
    // ==========================================

    function loadLlpOptions() {
        $.ajax({
            url: '/api/get/llp-company-options', // 🟢 你的新 API
            type: 'GET',
            success: function (res) {
                if (res && res.success) {
                    llpOptionsList = res.data || [];
                    const $sel = $('#clientSelect');
                    $sel.empty();
                    $sel.append('<option value="">-- Select client --</option>');
                    
                    llpOptionsList.forEach(function (c) {
                        // 使用 getVal 确保大小写兼容
                        const id = getVal(c, 'Id');
                        const name = getVal(c, 'CompanyName');
                        $sel.append(`<option value="${id}">${name}</option>`);
                    });
                } else {
                    console.error('Failed to load LLP options:', res?.message);
                }
            },
            error: function(xhr) {
                console.error('Network error loading LLP options');
            }
        });
    }

    function loadRecordsFromDatabase() {
        $.ajax({
            url: 'api/s15/get-all',
            type: 'GET',
            success: function (res) {
                if (res && res.success) {
                    populateTable(res.data || []);
                    showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                } else {
                    showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                }
            },
            error: function (xhr) {
                showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
            }
        });
    }

    function populateTable(records) {
        if (!dataTableInitialized) return;
        dataTable.clear();
        if (records && records.length) {
            records.forEach(function (r) {
                const id = getVal(r, 'Id');
                dataTable.row.add([
                    getVal(r, 'SecFileNo'),
                    getVal(r, 'CompanyName'),
                    formatDateForDisplay(getVal(r, 'YearEnd')),
                    formatDateForDisplay(getVal(r, 'IncorpDate')),
                    getVal(r, 'Co'),
                    getVal(r, 'CompanyStatus'),
                    getVal(r, 'ActiveCoActivitySize'),
                    formatDateForDisplay(getVal(r, 'SSMextensionDateforAcc')),
                    formatDateForDisplay(getVal(r, 'ADdueDate')),
                    formatDateForDisplay(getVal(r, 'ADsubmitDate')),
                    formatDateForDisplay(getVal(r, 'DateSendToClient')),
                    formatDateForDisplay(getVal(r, 'DateReturned')),
                    getVal(r, 'JobCompleted'),
                    `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>`,
                    `<button class="btn btn-sm btn-danger delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>`
                ]);
            });
        }
        dataTable.draw();
    }

    function saveRecord() {
        hideModalAlert();
        clearFieldErrors();

        const formData = {
            Id: ($('#editIndex').val() || '0').trim(),
            SecFileNo: ($('#secFileNo').val() || '').trim(),
            CompanyName: ($('#client').val() || '').trim(), // Hidden field
            YearEnd: ($('#yearEnd').val() || '').trim(),
            IncorpDate: ($('#incorpDate').val() || '').trim(),
            Co: ($('#coNumber').val() || '').trim(),
            CompanyStatus: ($('#coStatus').val() || '').trim(),
            ActiveCoActivitySize: ($('#activitySize').val() || '').trim(),
            SSMextensionDateforAcc: ($('#ssmExtensionDate').val() || '').trim(),
            ADdueDate: ($('#adDueDate').val() || '').trim(),
            ADsubmitDate: ($('#adSubmittedDate').val() || '').trim(),
            DateSendToClient: ($('#dateSendToClient').val() || '').trim(),
            DateReturned: ($('#dateReturned').val() || '').trim(),
            JobCompleted: ($('#jobStatus').val() || '').trim()
        };

        let hasError = false;
        // 简单校验
        if (!formData.SecFileNo) { setFieldError('#secFileNo', 'Required'); hasError = true; }
        if (!formData.CompanyName) { setFieldError('#clientSelect', 'Required'); hasError = true; }
        if (!formData.YearEnd) { setFieldError('#yearEnd', 'Required'); hasError = true; }
        if (!formData.IncorpDate) { setFieldError('#incorpDate', 'Required'); hasError = true; }
        if (!formData.Co) { setFieldError('#coNumber', 'Required'); hasError = true; }
        // 其他字段按需校验

        if (hasError) {
            showModalAlert('Please fix the highlighted fields.', 'error');
            return;
        }

        const isUpdate = Number(formData.Id) > 0;
        const url = isUpdate ? 'api/s15/update' : 'api/s15/create';
        const method = isUpdate ? 'PUT' : 'POST';
        const $btn = $('#saveBtn');
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (res) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                if (res && res.success) {
                    $('#taskModal').modal('hide');
                    showAlert('Record saved successfully.', 'success');
                    loadRecordsFromDatabase();
                } else {
                    const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                    showModalAlert('Error: ' + msg, 'error');
                }
            },
            error: function (xhr) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                showModalAlert('Error: ' + (xhr.statusText || 'Network error'), 'error');
            }
        });
    }

    function editRecord(id) {
        $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
        hideModalAlert();
        clearFieldErrors();
        $.ajax({
            url: 'api/s15/get/' + id,
            type: 'GET',
            success: function (res) {
                $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit LLP Submission Record');
                if (res && res.success) {
                    const d = res.data || {};
                    $('#editIndex').val(getVal(d, 'Id'));
                    $('#secFileNo').val(getVal(d, 'SecFileNo'));
                    
                    // Edit 回显 Client
                    const name = getVal(d, 'CompanyName');
                    if(name){
                        $('#client').val(name);
                        // 尝试在 dropdown 中选中
                        $("#clientSelect option").filter(function() {
                            return $(this).text() == name; 
                        }).prop('selected', true);
                    }

                    $('#yearEnd').val(formatDateForDisplay(getVal(d, 'YearEnd')));
                    $('#incorpDate').val(formatDateForDisplay(getVal(d, 'IncorpDate')));
                    $('#coNumber').val(getVal(d, 'Co'));
                    $('#coStatus').val(getVal(d, 'CompanyStatus'));
                    $('#activitySize').val(getVal(d, 'ActiveCoActivitySize'));
                    $('#ssmExtensionDate').val(formatDateForDisplay(getVal(d, 'SSMextensionDateforAcc')));
                    $('#adDueDate').val(formatDateForDisplay(getVal(d, 'ADdueDate')));
                    $('#adSubmittedDate').val(formatDateForDisplay(getVal(d, 'ADsubmitDate')));
                    $('#dateSendToClient').val(formatDateForDisplay(getVal(d, 'DateSendToClient')));
                    $('#dateReturned').val(formatDateForDisplay(getVal(d, 'DateReturned')));
                    $('#jobStatus').val(getVal(d, 'JobCompleted'));

                    $('#taskModal').modal('show');
                } else {
                    showAlert('Error loading: ' + (res?.message || 'Unknown'), 'error');
                }
            },
            error: function (xhr) {
                showAlert('Error loading: ' + xhr.statusText, 'error');
            }
        });
    }

    function deleteRecord(id) {
        if (!confirm('Are you sure?')) return;
        $.ajax({
            url: 'api/s15/delete/' + id,
            type: 'DELETE',
            success: function (res) {
                if (res && res.success) {
                    showAlert('Deleted.', 'success');
                    loadRecordsFromDatabase();
                } else {
                    showAlert('Error: ' + res.message, 'error');
                }
            },
            error: function (xhr) { showAlert('Error: ' + xhr.statusText, 'error'); }
        });
    }

    // UI Helpers
    function formatDateForDisplay(s) { return s || ''; }
    function showModalAlert(msg, type) {
        const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
        const $box = $('#modalAlert');
        if ($box.length) {
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info').html(msg);
            $('#taskModal .modal-body').stop(true).animate({ scrollTop: 0 }, 200);
        } else if(type === 'error') { alert(msg); }
    }
    function hideModalAlert() { $('#modalAlert').addClass('d-none').empty(); }
    function clearFieldErrors() {
        $('#taskForm .is-invalid').removeClass('is-invalid');
        $('#taskForm .invalid-feedback').remove();
    }
    function setFieldError(selector, message) {
        const $f = $(selector);
        if (!$f.length) return;
        $f.addClass('is-invalid');
        if ($f.next('.invalid-feedback').length === 0) {
            $f.after('<div class="invalid-feedback"></div>');
        }
        $f.next('.invalid-feedback').text(message);
    }
    function showAlert(message, type) {
        const cls = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
        const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>`;
        $('.card-header').after(html);
        setTimeout(() => $('.alert').alert('close'), 4000);
    }
    function clearForm() {
        $('#taskForm')[0].reset();
        $('#editIndex').val('');
        $('#modalTitle').text('Add New LLP Submission Record');
        hideModalAlert();
        clearFieldErrors();
    }
</script>
}

