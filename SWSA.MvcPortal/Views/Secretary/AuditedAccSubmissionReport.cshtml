@{
    ViewData["Title"] = "AuditedAccSubmissionReport";
}

<h1>Audited Account Submission Report</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">File No</th>
                            <th rowspan="2">Company Name</th>
                            <th rowspan="2">Company No</th>
                            <th rowspan="2">Incorp Date</th>
                            <th rowspan="2">Year End</th>
                            <th rowspan="2">Co Status</th>

                            <th colspan="3">Audit Fin Stmt (AFS) Due Date</th>
                            <th colspan="2">Result</th>

                            <th rowspan="2">Job Completed/Backlog</th>
                            <th colspan="2">Actions</th>

                        </tr>

                        <tr>
                            <th>1st 18mths due date</th>
                            <th>Circulation & AFS due date</th>
                            <th>MBRS received date</th>

                            <th>On time/late</th>
                            <th>Reason for late</th>

                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            </div>
        </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audited Account Submission Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="fileNo">File No</label>
                                <input type="text" id="fileNo" name="fileNo" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyNo">Company No</label>
                                <input type="text" id="companyNo" name="companyNo" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="incorpDate">Incorp Date</label>
                                <input type="text" id="incorpDate" name="incorpDate" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                    <option value="In Liquidation">In Liquidation</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Audit Fin Stmt (AFS) Due Date</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="first18MonthsDueDate">1st 18mths due date</label>
                                <input type="text" id="first18MonthsDueDate" name="first18MonthsDueDate" class="form-control" placeholder="Auto calculate" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="circulationAFSDueDate">Circulation & AFS due date</label>
                                <input type="text" id="circulationAFSDueDate" name="circulationAFSDueDate" class="form-control" placeholder="Auto calculate" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="mbrsReceivedDate">MBRS received date</label>

                                <select id="mbrsSourceSelect" class="form-control mb-2">
                                    <option value="">-- Link from AT3.1 Audit Logbook --</option>
                                </select>
                                <small class="text-muted">
                                    Select a record from AT3.1 to auto-fill MBRS received date.
                                </small>

                                <input type="text"
                                       id="mbrsReceivedDate"
                                       name="mbrsReceivedDate"
                                       class="form-control mt-2"
                                       placeholder="Select date or choose from AT3.1" />
                            </div>
                        </div>

                    </div>

                    <div class="form-info-label col-12">
                        <label>Result</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="submissionStatus">On time/late</label>
                                <select id="submissionStatus" name="submissionStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="On time">On time</option>
                                    <option value="Late">Late</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reasonForLate">Reason for late</label>
                                <input type="text" id="reasonForLate" name="reasonForLate" class="form-control" placeholder="Enter reason for late submission" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Completion Status</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobStatus">Job Completed/Backlog</label>
                                <select id="jobStatus" name="jobStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    // ==========================================
    // 🔴 全局变量 (放在最外面，确保到处都能用)
    // ==========================================
    let dataTable;
    let dataTableInitialized = false;
    let companyOptionsList = [];
    let mbrsSourceOptions = [];

    // ==========================================
    // 🟢 工具函数 (计算逻辑)
    // ==========================================

    // 1. 获取对象属性 (忽略大小写)
    function getVal(obj, name) {
        if (!obj) return '';
        if (obj[name] !== undefined && obj[name] !== null) return obj[name];
        const camel = name.charAt(0).toLowerCase() + name.slice(1);
        if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];
        const targetLower = name.toLowerCase();
        for (const key in obj) {
            if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
            if (key.toLowerCase() === targetLower) return obj[key];
        }
        return '';
    }

    // 2. 格式化 ISO 日期 -> dd/mm/yyyy
    function formatIsoDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return isoString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // 3. 计算 Year End (Month Name -> dd/mm/yyyy)
    function calculateYearEndDate(monthName) {
        if (!monthName) return '';
        const months = {
            "january": 0, "february": 1, "march": 2, "april": 3, "may": 4, "june": 5,
            "july": 6, "august": 7, "september": 8, "october": 9, "november": 10, "december": 11
        };
        const monthIndex = months[monthName.toLowerCase().trim()];
        if (monthIndex === undefined) return '';
        
        const currentYear = new Date().getFullYear();
        const date = new Date(currentYear, monthIndex + 1, 0); // 下个月第0天 = 本月最后一天
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // 4. 日期加月计算器 (dd/mm/yyyy + months)
    function addMonths(dateStr, monthsToAdd) {
        if (!dateStr) return '';
        const parts = dateStr.split('/'); // 假设格式是 dd/mm/yyyy
        if (parts.length < 3) return '';

        // 注意：JS月份是0-11
        const originalDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        
        // 复制日期进行计算
        const newDate = new Date(originalDate);
        newDate.setMonth(originalDate.getMonth() + monthsToAdd);

        // 处理月底溢出 (例如 31 Jan + 1 month = 28 Feb)
        if (newDate.getDate() !== originalDate.getDate()) {
            newDate.setDate(0);
        }

        const d = String(newDate.getDate()).padStart(2, '0');
        const m = String(newDate.getMonth() + 1).padStart(2, '0');
        const y = newDate.getFullYear();
        return `${d}/${m}/${y}`;
    }

    // 5. 🟢 核心：触发 Due Date 计算
    function calculateDueDates() {
        console.log("正在计算 Due Dates..."); // 调试用：F12看控制台有没有这句话

        // 获取当前输入框的值
        const incorpDate = $('#incorpDate').val();
        const yearEnd = $('#yearEnd').val();

        console.log("Incorp Date:", incorpDate, "Year End:", yearEnd);

        // 1. 计算 1st 18mths due date (Incorp Date + 17个月)
        if (incorpDate) {
            const result = addMonths(incorpDate, 17);
            $('#first18MonthsDueDate').val(result);
            console.log("算出 18mths:", result);
        } else {
            $('#first18MonthsDueDate').val('');
        }

        // 2. 计算 Circulation & AFS due date (Year End + 7个月)
        if (yearEnd) {
            const result = addMonths(yearEnd, 7);
            $('#circulationAFSDueDate').val(result);
            console.log("算出 Circulation:", result);
        } else {
            $('#circulationAFSDueDate').val('');
        }
    }

    // ==========================================
    // 🟢 主逻辑 (Document Ready)
    // ==========================================
    $(document).ready(function () {
        
        // 1. 初始化 Datepickers
        $('input[type="text"]').filter(function () {
            const id = $(this).attr('id') || '';
            return id.includes('Date') || id.includes('date') || id.includes('yearEnd');
        }).datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true,
            todayHighlight: true
        });

        // 2. 监听手动修改日期 -> 重新计算
        $('#incorpDate, #yearEnd').on('change', function() {
            calculateDueDates();
        });

        // 3. 加载下拉菜单数据
        loadCompanyOptions();
        loadMbrsSourceOptions();

        // 4. 监听 Client 下拉菜单选择
        $('#clientSelect').on('change', function() {
            const selectedId = $(this).val();
            
            // 清空旧数据
            $('#fileNo').val('');
            $('#companyNo').val('');
            $('#incorpDate').val('');
            $('#yearEnd').val('');
            $('#client').val('');
            $('#clientId').val('');
            $('#first18MonthsDueDate').val('');
            $('#circulationAFSDueDate').val('');

            if (!selectedId) return;

            // 查找选中公司
            const selectedClient = companyOptionsList.find(c => String(getVal(c, 'Id')) === String(selectedId));

            if (selectedClient) {
                // 填入基本信息
                $('#clientId').val(getVal(selectedClient, 'Id'));
                $('#client').val(getVal(selectedClient, 'CompanyName'));
                $('#fileNo').val(getVal(selectedClient, 'FileNo'));
                $('#companyNo').val(getVal(selectedClient, 'CompanyNo'));

                // 填入日期
                const formattedIncorp = formatIsoDate(getVal(selectedClient, 'IncorporationDate'));
                const formattedYearEnd = calculateYearEndDate(getVal(selectedClient, 'YearEndMonth'));

                $('#incorpDate').val(formattedIncorp);
                $('#yearEnd').val(formattedYearEnd);

                // 更新 Datepicker UI 状态
                $('#incorpDate').datepicker('update');
                $('#yearEnd').datepicker('update');

                // 🔥 重点：数据填完后，立即触发计算 🔥
                calculateDueDates();
            }
        });

        // 5. 监听 MBRS Source
        $('#mbrsSourceSelect').on('change', function () {
            const selectedId = $(this).val();
            if (!selectedId) return;
            const item = mbrsSourceOptions.find(x => String(getVal(x, 'SourceId')) === String(selectedId));
            if (item) {
                $('#mbrsReceivedDate').val(getVal(item, 'MbrsReceivedDate') || '');
            }
        });

        // 6. 初始化 DataTable
        dataTable = $('#taskDatatable').DataTable({
            responsive: true,
            ordering: true,
            autoWidth: false,
            pageLength: 10,
            order: [[1, 'asc']],
            columns: [
                { data: 0 }, { data: 1 }, { data: 2 }, { data: 3 }, { data: 4 }, { data: 5 },
                { data: 6 }, { data: 7 }, { data: 8 }, { data: 9 }, { data: 10 }, { data: 11 },
                { data: 12, orderable: false, searchable: false },
                { data: 13, orderable: false, searchable: false }
            ]
        });
        dataTableInitialized = true;

        // 7. 绑定按钮事件
        $('#saveBtn').click(saveRecord);
        $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
        $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });
        $('#taskModal').on('hidden.bs.modal', clearForm);
        $('[data-bs-target="#taskModal"]').on('click', function () { clearForm(); });

        // 8. 首次加载表格数据
        loadRecordsFromDatabase();
    });

    // ==========================================
    // 🟢 AJAX 函数 (放在 Ready 外面更整洁)
    // ==========================================

    function loadCompanyOptions() {
        $.ajax({
            url: 'api/get/company-options',
            type: 'GET',
            success: function (res) {
                if (res && res.success) {
                    companyOptionsList = res.data || [];
                    const $sel = $('#clientSelect');
                    $sel.empty();
                    $sel.append('<option value="">-- Select client --</option>');
                    companyOptionsList.forEach(function (c) {
                        $sel.append(`<option value="${getVal(c, 'Id')}">${getVal(c, 'CompanyName')}</option>`);
                    });
                }
            }
        });
    }

    function loadMbrsSourceOptions() {
        $.ajax({
            url: 'get-s14b-mbrs-source-options',
            type: 'GET',
            success: function (res) {
                if (res && res.success) {
                    mbrsSourceOptions = res.data || [];
                    const $sel = $('#mbrsSourceSelect');
                    $sel.empty();
                    $sel.append('<option value="">-- Link from AT3.1 Audit Logbook --</option>');
                    mbrsSourceOptions.forEach(function (x) {
                        const text = getVal(x, 'CompanyName') + (getVal(x, 'MbrsReceivedDate') ? ' (' + getVal(x, 'MbrsReceivedDate') + ')' : '');
                        $sel.append(`<option value="${getVal(x, 'SourceId')}">${text}</option>`);
                    });
                }
            }
        });
    }

    function loadRecordsFromDatabase() {
        $.ajax({
            url: 'api/s14b/get-all',
            type: 'GET',
            success: function (res) {
                if (res && res.success) {
                    populateTable(res.data || []);
                    showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                }
            }
        });
    }

    function populateTable(records) {
        if (!dataTableInitialized) return;
        dataTable.clear();
        if (records && records.length) {
            records.forEach(function (r) {
                const id = getVal(r, 'Id');
                dataTable.row.add([
                    getVal(r, 'FileNo'),
                    getVal(r, 'CompanyName'),
                    getVal(r, 'CompanyNo'),
                    formatDateForDisplay(getVal(r, 'IncorpDate')),
                    formatDateForDisplay(getVal(r, 'YearEnd')),
                    getVal(r, 'CompanyStatus'),
                    formatDateForDisplay(getVal(r, 'YrMthdueDate')),
                    formatDateForDisplay(getVal(r, 'CirculationAFSduedate')),
                    formatDateForDisplay(getVal(r, 'MBRSreceivedDate')),
                    getVal(r, 'OntimeLate'),
                    getVal(r, 'ReasonForLate'),
                    getVal(r, 'JobCompleted'),
                    `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>`,
                    `<button class="btn btn-sm btn-danger delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>`
                ]);
            });
        }
        dataTable.draw();
    }

    function saveRecord() {
        hideModalAlert();
        clearFieldErrors();

        const formData = {
            Id: ($('#editIndex').val() || '0').trim(),
            FileNo: ($('#fileNo').val() || '').trim(),
            CompanyName: ($('#client').val() || '').trim(),
            CompanyNo: ($('#companyNo').val() || '').trim(),
            IncorpDate: ($('#incorpDate').val() || '').trim(),
            YearEnd: ($('#yearEnd').val() || '').trim(),
            CompanyStatus: ($('#coStatus').val() || '').trim(),
            YrMthdueDate: ($('#first18MonthsDueDate').val() || '').trim(),
            CirculationAFSduedate: ($('#circulationAFSDueDate').val() || '').trim(),
            MBRSreceivedDate: ($('#mbrsReceivedDate').val() || '').trim(),
            OntimeLate: ($('#submissionStatus').val() || '').trim(),
            ReasonForLate: ($('#reasonForLate').val() || '').trim(),
            JobCompleted: ($('#jobStatus').val() || '').trim()
        };

        let hasError = false;
        if (!formData.FileNo) { setFieldError('#fileNo', 'Required'); hasError = true; }
        if (!formData.CompanyName) { setFieldError('#clientSelect', 'Required'); hasError = true; }
        if (!formData.CompanyNo) { setFieldError('#companyNo', 'Required'); hasError = true; }
        if (!formData.IncorpDate) { setFieldError('#incorpDate', 'Required'); hasError = true; }
        if (!formData.YearEnd) { setFieldError('#yearEnd', 'Required'); hasError = true; }
        if (!formData.YrMthdueDate) { setFieldError('#first18MonthsDueDate', 'Required'); hasError = true; }
        if (!formData.CirculationAFSduedate) { setFieldError('#circulationAFSDueDate', 'Required'); hasError = true; }

        if (hasError) {
            showModalAlert('Please fix the highlighted fields.', 'error');
            return;
        }

        const isUpdate = Number(formData.Id) > 0;
        const url = isUpdate ? 'api/s14b/update' : 'api/s14b/create';
        const method = isUpdate ? 'PUT' : 'POST';
        const $btn = $('#saveBtn');
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (res) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                if (res && res.success) {
                    $('#taskModal').modal('hide');
                    showAlert('Record saved successfully.', 'success');
                    loadRecordsFromDatabase();
                } else {
                    const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                    showModalAlert('Error: ' + msg, 'error');
                }
            },
            error: function (xhr) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                showModalAlert('Error: ' + (xhr.statusText || 'Network error'), 'error');
            }
        });
    }

    function editRecord(id) {
        $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
        hideModalAlert();
        clearFieldErrors();
        $.ajax({
            url: 'api/s14b/get/' + id,
            type: 'GET',
            success: function (res) {
                $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Record');
                if (res && res.success) {
                    const d = res.data || {};
                    $('#editIndex').val(getVal(d, 'Id'));
                    $('#fileNo').val(getVal(d, 'FileNo'));
                    $('#companyNo').val(getVal(d, 'CompanyNo'));
                    $('#incorpDate').val(formatDateForDisplay(getVal(d, 'IncorpDate')));
                    $('#yearEnd').val(formatDateForDisplay(getVal(d, 'YearEnd')));
                    $('#coStatus').val(getVal(d, 'CompanyStatus'));
                    $('#first18MonthsDueDate').val(formatDateForDisplay(getVal(d, 'YrMthdueDate')));
                    $('#circulationAFSDueDate').val(formatDateForDisplay(getVal(d, 'CirculationAFSduedate')));
                    $('#mbrsReceivedDate').val(formatDateForDisplay(getVal(d, 'MBRSreceivedDate')));
                    $('#submissionStatus').val(getVal(d, 'OntimeLate'));
                    $('#reasonForLate').val(getVal(d, 'ReasonForLate'));
                    $('#jobStatus').val(getVal(d, 'JobCompleted'));
                    
                    const name = getVal(d, 'CompanyName');
                    if(name){
                         $('#client').val(name);
                         $("#clientSelect option").filter(function() {
                            return $(this).text() == name; 
                         }).prop('selected', true);
                    }
                    $('#taskModal').modal('show');
                } else {
                    showAlert('Error loading: ' + (res?.message || 'Unknown'), 'error');
                }
            },
            error: function (xhr) {
                showAlert('Error loading: ' + xhr.statusText, 'error');
            }
        });
    }

    function deleteRecord(id) {
        if (!confirm('Are you sure?')) return;
        $.ajax({
            url: 'api/s14b/delete/' + id,
            type: 'DELETE',
            success: function (res) {
                if (res && res.success) {
                    showAlert('Deleted.', 'success');
                    loadRecordsFromDatabase();
                } else {
                    showAlert('Error: ' + res.message, 'error');
                }
            },
            error: function (xhr) { showAlert('Error: ' + xhr.statusText, 'error'); }
        });
    }

    // UI Helpers
    function formatDateForDisplay(s) { return s || ''; }
    function showModalAlert(msg, type) {
        const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
        const $box = $('#modalAlert');
        if ($box.length) {
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info').html(msg);
            $('#taskModal .modal-body').stop(true).animate({ scrollTop: 0 }, 200);
        } else if(type === 'error') { alert(msg); }
    }
    function hideModalAlert() { $('#modalAlert').addClass('d-none').empty(); }
    function clearFieldErrors() {
        $('#taskForm .is-invalid').removeClass('is-invalid');
        $('#taskForm .invalid-feedback').remove();
    }
    function setFieldError(selector, message) {
        const $f = $(selector);
        if (!$f.length) return;
        $f.addClass('is-invalid');
        if ($f.next('.invalid-feedback').length === 0) {
            $f.after('<div class="invalid-feedback"></div>');
        }
        $f.next('.invalid-feedback').text(message);
    }
    function showAlert(message, type) {
        const cls = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
        const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>`;
        $('.card-header').after(html);
        setTimeout(() => $('.alert').alert('close'), 4000);
    }
    function clearForm() {
        $('#taskForm')[0].reset();
        $('#editIndex').val('');
        $('#modalTitle').text('Add New Audited Account Submission Record');
        hideModalAlert();
        clearFieldErrors();
    }
</script>
}