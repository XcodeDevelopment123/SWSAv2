@{
    ViewData["Title"] = "AuditedAccSubmissionReport";
}

<h1>Audited Account Submission Report</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">File No</th>
                            <th rowspan="2">Company Name</th>
                            <th rowspan="2">Company No</th>
                            <th rowspan="2">Incorp Date</th>
                            <th rowspan="2">Year End</th>
                            <th rowspan="2">Co Status</th>

                            <th colspan="3">Audit Fin Stmt (AFS) Due Date</th>
                            <th colspan="2">Result</th>

                            <th rowspan="2">Job Completed/Backlog</th>
                            <th colspan="2">Actions</th>

                        </tr>

                        <tr>
                            <th>1st 18mths due date</th>
                            <th>Circulation & AFS due date</th>
                            <th>MBRS received date</th>

                            <th>On time/late</th>
                            <th>Reason for late</th>

                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                     
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audited Account Submission Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="fileNo">File No</label>
                                <input type="text" id="fileNo" name="fileNo" class="form-control" placeholder="Enter file number" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                                <small class="text-muted">
                                    This field should be linked from the Client List.
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyNo">Company No</label>
                                <input type="text" id="companyNo" name="companyNo" class="form-control" placeholder="Enter company number" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="incorpDate">Incorp Date</label>
                                <input type="text" id="incorpDate" name="incorpDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                    <option value="In Liquidation">In Liquidation</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Fin Stmt (AFS) Due Date -->
                    <div class="form-info-label col-12">
                        <label>Audit Fin Stmt (AFS) Due Date</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="first18MonthsDueDate">1st 18mths due date</label>
                                <input type="text" id="first18MonthsDueDate" name="first18MonthsDueDate" class="form-control" placeholder="Auto calculate" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="circulationAFSDueDate">Circulation & AFS due date</label>
                                <input type="text" id="circulationAFSDueDate" name="circulationAFSDueDate" class="form-control" placeholder="Auto calculate" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="mbrsReceivedDate">MBRS received date</label>

                                <!-- 🔵 来自 AT3.1 的列表 -->
                                <select id="mbrsSourceSelect" class="form-control mb-2">
                                    <option value="">-- Link from AT3.1 Audit Logbook --</option>
                                </select>
                                <small class="text-muted">
                                    Select a record from AT3.1 to auto-fill MBRS received date.
                                </small>

                                <!-- 真实保存到 S14B 的日期（仍然可以手动改） -->
                                <input type="text"
                                       id="mbrsReceivedDate"
                                       name="mbrsReceivedDate"
                                       class="form-control mt-2"
                                       placeholder="Select date or choose from AT3.1" />
                            </div>
                        </div>

                    </div>

                    <!-- Result -->
                    <div class="form-info-label col-12">
                        <label>Result</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="submissionStatus">On time/late</label>
                                <select id="submissionStatus" name="submissionStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="On time">On time</option>
                                    <option value="Late">Late</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reasonForLate">Reason for late</label>
                                <input type="text" id="reasonForLate" name="reasonForLate" class="form-control" placeholder="Enter reason for late submission" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Status -->
                    <div class="form-info-label col-12">
                        <label>Completion Status</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobStatus">Job Completed/Backlog</label>
                                <select id="jobStatus" name="jobStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        let dataTable;
        let dataTableInitialized = false;

        let mbrsSourceOptions = [];   // 存 AT3.1 的 list
        // ---------- Load MBRS source list from AT3.1 ----------
        function loadMbrsSourceOptions() {
            $.ajax({
                url: 'get-s14b-mbrs-source-options',   // 就是你刚才加的后端 API 路径
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        mbrsSourceOptions = res.data || [];

                        const $sel = $('#mbrsSourceSelect');
                        $sel.empty();
                        $sel.append('<option value="">-- Link from AT3.1 Audit Logbook --</option>');

                        mbrsSourceOptions.forEach(function (x) {
                            const id = getVal(x, 'SourceId');
                            const coName = getVal(x, 'CompanyName');
                            const date = getVal(x, 'MbrsReceivedDate');

                            const text = coName + (date ? ' (' + date + ')' : '');
                            $sel.append(`<option value="${id}">${text}</option>`);
                        });
                    } else {
                        console.error('Failed to load AT3.1 MBRS source list:', res?.message || 'Unknown error');
                    }
                },
                error: function (xhr) {
                    console.error('Failed to load AT3.1 MBRS source list:', xhr.statusText || 'Network error');
                }
            });
        }

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            const map = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }
        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }
        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }
        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            return s; // 先原样显示，有需要再改格式
        }

        function getVal(obj, name) {
            if (!obj) return '';

            if (obj[name] !== undefined && obj[name] !== null) return obj[name];

            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];

            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New Audited Account Submission Record');
            hideModalAlert();
            clearFieldErrors();
        }

        // ---------- Init ----------
        $(document).ready(function () {

            loadMbrsSourceOptions();

            // 🔵 当用户选择一个 AT3.1 记录时，自动填充 MBRS received date
            $('#mbrsSourceSelect').on('change', function () {
                const selectedId = $(this).val();
                if (!selectedId) {
                    return;
                }

                const item = mbrsSourceOptions.find(x =>
                    String(getVal(x, 'SourceId')) === String(selectedId)
                );

                if (!item) {
                    return;
                }

                const date = getVal(item, 'MbrsReceivedDate');
                $('#mbrsReceivedDate').val(date || '');
            });

            // 所有和 date 相关的 text input 套 datepicker（包含 yearEnd）
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return id.includes('Date') || id.includes('date') || id.includes('yearEnd');
            }).datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // DataTable：对应 S14B 所有列
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                ordering: true,
                autoWidth: false,
                pageLength: 10,
                order: [[1, 'asc']], // 以 Company Name 排序
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No records found",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columns: [
                    { data: 0 },  // File No
                    { data: 1 },  // Company Name
                    { data: 2 },  // Company No
                    { data: 3 },  // Incorp Date
                    { data: 4 },  // Year End
                    { data: 5 },  // Co Status
                    { data: 6 },  // YrMthdueDate
                    { data: 7 },  // CirculationAFSduedate
                    { data: 8 },  // MBRSreceivedDate
                    { data: 9 },  // OntimeLate
                    { data: 10 }, // ReasonForLate
                    { data: 11 }, // JobCompleted
                    { data: 12, orderable: false, searchable: false }, // Edit
                    { data: 13, orderable: false, searchable: false }  // Delete
                ]
            });
            dataTableInitialized = true;

            // 绑定按钮
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            $('[data-bs-target="#taskModal"]').on('click', function () {
                clearForm();
            });

            // 首次载入
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: 'api/s14b/get-all',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                        console.log('S14B sample keys:', Object.keys((res.data || [])[0] || {}));
                    } else {
                        showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r) {
                    const id = getVal(r, 'Id');

                    dataTable.row.add([
                        getVal(r, 'FileNo'),                             // 0
                        getVal(r, 'CompanyName'),                        // 1
                        getVal(r, 'CompanyNo'),                          // 2
                        formatDateForDisplay(getVal(r, 'IncorpDate')),   // 3
                        formatDateForDisplay(getVal(r, 'YearEnd')),      // 4
                        getVal(r, 'CompanyStatus'),                      // 5
                        formatDateForDisplay(getVal(r, 'YrMthdueDate')),       // 6
                        formatDateForDisplay(getVal(r, 'CirculationAFSduedate')), // 7
                        formatDateForDisplay(getVal(r, 'MBRSreceivedDate')),    // 8
                        getVal(r, 'OntimeLate'),                        // 9
                        getVal(r, 'ReasonForLate'),                     // 10
                        getVal(r, 'JobCompleted'),                      // 11

                        // Edit
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                 </button>`,

                        // Delete
                        `<button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                 </button>`
                    ]);
                });
            }

            dataTable.draw();
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                FileNo: ($('#fileNo').val() || '').trim(),
                CompanyName: ($('#companyName').val() || '').trim(),
                CompanyNo: ($('#companyNo').val() || '').trim(),
                IncorpDate: ($('#incorpDate').val() || '').trim(),
                YearEnd: ($('#yearEnd').val() || '').trim(),
                CompanyStatus: ($('#coStatus').val() || '').trim(),

                YrMthdueDate: ($('#first18MonthsDueDate').val() || '').trim(),
                CirculationAFSduedate: ($('#circulationAFSDueDate').val() || '').trim(),
                MBRSreceivedDate: ($('#mbrsReceivedDate').val() || '').trim(),

                OntimeLate: ($('#submissionStatus').val() || '').trim(),
                ReasonForLate: ($('#reasonForLate').val() || '').trim(),

                JobCompleted: ($('#jobStatus').val() || '').trim()
            };

            // 简单必填验证
            let hasError = false;
            if (!formData.FileNo) { setFieldError('#fileNo', 'Required'); hasError = true; }
            if (!formData.CompanyName) { setFieldError('#companyName', 'Required'); hasError = true; }
            if (!formData.CompanyNo) { setFieldError('#companyNo', 'Required'); hasError = true; }
            if (!formData.IncorpDate) { setFieldError('#incorpDate', 'Required'); hasError = true; }
            if (!formData.YearEnd) { setFieldError('#yearEnd', 'Required'); hasError = true; }
            if (!formData.CompanyStatus) { setFieldError('#coStatus', 'Please select a Status'); hasError = true; }
            if (!formData.YrMthdueDate) { setFieldError('#first18MonthsDueDate', 'Required'); hasError = true; }
            if (!formData.CirculationAFSduedate) { setFieldError('#circulationAFSDueDate', 'Required'); hasError = true; }
            if (!formData.MBRSreceivedDate) { setFieldError('#mbrsReceivedDate', 'Required'); hasError = true; }


            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? 'api/s14b/update' : 'api/s14b/create';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: 'api/s14b/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Audited Account Submission Record');
                    if (res && res.success) {
                        const d = res.data || {};

                        $('#editIndex').val(getVal(d, 'Id'));

                        $('#fileNo').val(getVal(d, 'FileNo'));
                        $('#companyName').val(getVal(d, 'CompanyName'));
                        $('#companyNo').val(getVal(d, 'CompanyNo'));
                        $('#incorpDate').val(formatDateForDisplay(getVal(d, 'IncorpDate')));
                        $('#yearEnd').val(formatDateForDisplay(getVal(d, 'YearEnd')));
                        $('#coStatus').val(getVal(d, 'CompanyStatus'));

                        $('#first18MonthsDueDate').val(formatDateForDisplay(getVal(d, 'YrMthdueDate')));
                        $('#circulationAFSDueDate').val(formatDateForDisplay(getVal(d, 'CirculationAFSduedate')));
                        $('#mbrsReceivedDate').val(formatDateForDisplay(getVal(d, 'MBRSreceivedDate')));

                        $('#submissionStatus').val(getVal(d, 'OntimeLate'));
                        $('#reasonForLate').val(getVal(d, 'ReasonForLate'));

                        $('#jobStatus').val(getVal(d, 'JobCompleted'));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Audited Account Submission Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;

            $.ajax({
                url: 'api/s14b/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}
