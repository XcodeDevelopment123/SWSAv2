@{
    ViewData["Title"] = "ARSubmisionReport";
}

<h1>Annual Return Submission Report</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">File No</th>
                            <th rowspan="2">Company Name</th>
                            <th rowspan="2">Company No.</th>
                            <th rowspan="2">Incorp Date</th>
                            <th rowspan="2">Co Status</th>

                            <th colspan="3">SSM AR Due Dates</th>
                            <th colspan="2">Actual AR Submission Dates</th>
                            <th colspan="2">Client's Sign & Return</th>

                            <th rowspan="2">Job Completed/Backlog</th>
                            <th rowspan="2">Remarks</th>
                            <th colspan="2">Actions</th>
                        </tr>

                        <tr>
                            <th>Annivesary date (1st Yr Only)</th>
                            <th>AR due date</th>
                            <th>Reminder Date</th>

                            <th>Date of Annual Return</th>
                            <th>AR Submitted Date</th>

                            <th>Date send to Client</th>
                            <th>Date Returned</th>

                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Annual Return Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="fileNo">File No</label>
                                <input type="text" id="fileNo" name="fileNo" class="form-control" placeholder="Enter file number" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                                <small class="text-muted">
                                    This field should be linked from the Client List.
                                </small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="companyNo">Company No.</label>
                                <input type="text" id="companyNo" name="companyNo" class="form-control" placeholder="Enter company number" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="incorpDate">Incorp Date</label>
                                <input type="text" id="incorpDate" name="incorpDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="AEX">AEX</option>
                                   @*   <option value="">Select Status</option>
                                     <option value="Active">Active</option>
                                     <option value="Dormant">Dormant</option>
                                     <option value="Strike Off">Strike Off</option>
                                     <option value="In Liquidation">In Liquidation</option> *@
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SSM AR Due Dates -->
                    <div class="form-info-label col-12">
                        <label>SSM AR Due Dates</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="anniversaryDate">Anniversary date (1st Yr Only)</label>
                                <small class="text-muted">(auto = month of Incorp Date)</small>
                                <input type="text" id="anniversaryDate" name="anniversaryDate"
                                       class="form-control" placeholder="Auto from Incorp Date" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="arDueDate">AR due date</label>
                                <small class="text-muted">
                                    (auto = same month as Incorp; year = this year or next year)
                                </small>
                                <input type="text" id="arDueDate" name="arDueDate"
                                       class="form-control" placeholder="Auto from Incorp Date & today" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="reminderDate">Reminder Date</label>
                                <input type="text" id="reminderDate" name="reminderDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Actual AR Submission Dates -->
                    <div class="form-info-label col-12">
                        <label>Actual AR Submission Dates</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateOfAnnualReturn">Date of Annual Return</label>
                                <small class="text-muted">(auto = anniversary day of this/next year)</small>
                                <input type="text" id="dateOfAnnualReturn" name="dateOfAnnualReturn"
                                       class="form-control" placeholder="Auto from Incorp Date" readonly />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="arSubmittedDate">AR Submitted Date</label>
                                <input type="text" id="arSubmittedDate" name="arSubmittedDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Client's Sign & Return -->
                    <div class="form-info-label col-12">
                        <label>Client's Sign & Return</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSendToClient">Date send to Client</label>
                                <input type="text" id="dateSendToClient" name="dateSendToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReturned">Date Returned</label>
                                <input type="text" id="dateReturned" name="dateReturned" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Status -->
                    <div class="form-info-label col-12">
                        <label>Completion Status</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobStatus">Job Completed/Backlog</label>
                                <select id="jobStatus" name="jobStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remarks">Remarks</label>
                                <input type="text" id="remarks" name="remarks" class="form-control" placeholder="Enter remarks" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        let dataTable;
        let dataTableInitialized = false;

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            const map = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }
        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }
        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }
        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                            aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        // ========== Helpers for AR calculation based on Incorp Date ==========

        // 把 dd/mm/yyyy 变成 JS Date
        function parseDdMmYyyy(str) {
            if (!str) return null;
            const parts = str.split('/');
            if (parts.length !== 3) return null;

            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // 0-11
            const year = parseInt(parts[2], 10);

            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

            const d = new Date(year, month, day);
            if (d.getFullYear() !== year || d.getMonth() !== month || d.getDate() !== day) {
                return null;
            }
            return d;
        }

        // 输出 dd/mm/yyyy
        function formatDdMmYyyy(date) {
            if (!date) return '';
            const dd = ('0' + date.getDate()).slice(-2);
            const mm = ('0' + (date.getMonth() + 1)).slice(-2);
            const yyyy = date.getFullYear();
            return dd + '/' + mm + '/' + yyyy;
        }

        // 英文月份简称
        const MONTH_NAMES_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
        ];

        // 根据 Incorp Date 自动计算 Anniversary / AR due / DateOfAR
        function recalcFromIncorp() {
            const incorpStr = ($('#incorpDate').val() || '').trim();
            const incorp = parseDdMmYyyy(incorpStr);

            if (!incorp) {
                // 没有合法成立日就清空自动栏位
                $('#anniversaryDate').val('');
                $('#arDueDate').val('');
                $('#dateOfAnnualReturn').val('');
                return;
            }

            const today = new Date();
            const incorpMonthIndex = incorp.getMonth(); // 0-11
            const incorpDay = incorp.getDate();
            const monthName = MONTH_NAMES_SHORT[incorpMonthIndex];

            // 1) Anniversary：只要月份
            $('#anniversaryDate').val(monthName);

            // 2) 决定今年还是明年的周年年份
            let targetYear = today.getFullYear();
            const thisYearAnniv = new Date(targetYear, incorpMonthIndex, incorpDay);

            // 如果今天已经超过今年的 Incorp 日 → 用明年的
            if (today > thisYearAnniv) {
                targetYear++;
            }

            // 3) AR due：显示 月份 + 年份，例如 "Sep-2025"
            const arDueText = monthName + '-' + targetYear;
            $('#arDueDate').val(arDueText);

            // 4) Date of Annual Return：用真正的日/月/年（当天的周年日）
            const arDate = new Date(targetYear, incorpMonthIndex, incorpDay);
            $('#dateOfAnnualReturn').val(formatDdMmYyyy(arDate));

            // 🔸 你如果想顺便把 AR Submitted Date 先预填同一天（可改可不改）
            // $('#arSubmittedDate').val(formatDdMmYyyy(arDate));
        }

        function formatDateForDisplay(s) {
            if (!s) return '';
            // 现在先直接原样显示，有需要再做真正格式转换
            return s;
        }

        function getVal(obj, name) {
            if (!obj) return '';

            if (obj[name] !== undefined && obj[name] !== null) return obj[name];

            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];

            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New Annual Return Record');
            hideModalAlert();
            clearFieldErrors();
        }

        // ---------- Init ----------
        $(document).ready(function () {

            // 当 Incorp Date 选择/修改时，自动重算三个栏位
            $('#incorpDate')
                .on('changeDate', function () {
                    recalcFromIncorp();
                })
                .on('change blur', function () {
                    recalcFromIncorp();
                });

            // 所有和 date 相关的 text input 套 datepicker
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return (id.includes('Date') || id.includes('date'));
            }).not('#anniversaryDate, #arDueDate, #dateOfAnnualReturn')
                .datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });


            // DataTable：对应 S14A 所有列
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                ordering: true,
                autoWidth: false,
                pageLength: 10,
                order: [[1, 'asc']], // 以 Company Name 排序
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No records found",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columns: [
                    { data: 0 },  // File No
                    { data: 1 },  // Company Name
                    { data: 2 },  // Company No
                    { data: 3 },  // Incorp Date
                    { data: 4 },  // Co Status
                    { data: 5 },  // AnniversaryDate
                    { data: 6 },  // ARdueDate
                    { data: 7 },  // ReminderDate
                    { data: 8 },  // DateOfAR
                    { data: 9 },  // ARsubmitDate
                    { data: 10 }, // DateSendtoClient
                    { data: 11 }, // DateReturned
                    { data: 12 }, // JobCompleted
                    { data: 13 }, // Remarks
                    { data: 14, orderable: false, searchable: false }, // Edit
                    { data: 15, orderable: false, searchable: false }  // Delete
                ]
            });
            dataTableInitialized = true;

            // 绑定按钮
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            $('[data-bs-target="#taskModal"]').on('click', function () {
                clearForm();
            });

            // 首次载入
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: 'api/s14a/get-all',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                        console.log('S14A sample keys:', Object.keys((res.data || [])[0] || {}));
                    } else {
                        showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r) {
                    const id = getVal(r, 'Id');

                    dataTable.row.add([
                        getVal(r, 'FileNo'),                               // 0
                        getVal(r, 'CompanyName'),                          // 1
                        getVal(r, 'CompanyNo'),                            // 2
                        formatDateForDisplay(getVal(r, 'IncorpDate')),     // 3
                        getVal(r, 'CompanyStatus'),                        // 4
                        formatDateForDisplay(getVal(r, 'AnniversaryDate')),// 5
                        formatDateForDisplay(getVal(r, 'ARdueDate')),      // 6
                        formatDateForDisplay(getVal(r, 'ReminderDate')),   // 7
                        formatDateForDisplay(getVal(r, 'DateOfAR')),       // 8
                        formatDateForDisplay(getVal(r, 'ARsubmitDate')),   // 9
                        formatDateForDisplay(getVal(r, 'DateSendToClient')),// 10
                        formatDateForDisplay(getVal(r, 'DateReturned')),   // 11
                        getVal(r, 'JobCompleted'),                         // 12
                        getVal(r, 'Remarks'),                              // 13

                        // Edit
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                 </button>`,

                        // Delete
                        `<button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                 </button>`
                    ]);
                });
            }

            dataTable.draw();
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                FileNo: ($('#fileNo').val() || '').trim(),
                CompanyName: ($('#companyName').val() || '').trim(),
                CompanyNo: ($('#companyNo').val() || '').trim(),
                IncorpDate: ($('#incorpDate').val() || '').trim(),
                CompanyStatus: ($('#coStatus').val() || '').trim(),

                AnniversaryDate: ($('#anniversaryDate').val() || '').trim(),
                ARdueDate: ($('#arDueDate').val() || '').trim(),
                ReminderDate: ($('#reminderDate').val() || '').trim(),

                DateOfAR: ($('#dateOfAnnualReturn').val() || '').trim(),
                ARsubmitDate: ($('#arSubmittedDate').val() || '').trim(),

                DateSendToClient: ($('#dateSendToClient').val() || '').trim(),
                DateReturned: ($('#dateReturned').val() || '').trim(),

                JobCompleted: ($('#jobStatus').val() || '').trim(),
                Remarks: ($('#remarks').val() || '').trim()
            };

            // 简单必填
            let hasError = false;
            if (!formData.FileNo) { setFieldError('#fileNo', 'Required'); hasError = true; }
            if (!formData.CompanyName) { setFieldError('#companyName', 'Required'); hasError = true; }
            if (!formData.CompanyNo) { setFieldError('#companyNo', 'Required'); hasError = true; }
            if (!formData.IncorpDate) { setFieldError('#incorpDate', 'Required'); hasError = true; }
            if (!formData.CompanyStatus) { setFieldError('#coStatus', 'Please select a Status'); hasError = true; }
            if (!formData.AnniversaryDate) { setFieldError('#anniversaryDate', 'Required'); hasError = true; }
            if (!formData.ARdueDate) { setFieldError('#arDueDate', 'Required'); hasError = true; }
            if (!formData.ReminderDate) { setFieldError('#reminderDate', 'Required'); hasError = true; }


            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? 'api/s14a/update' : 'api/s14a/create';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: 'api/s14a/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Annual Return Record');
                    if (res && res.success) {
                        const d = res.data || {};

                        $('#editIndex').val(getVal(d, 'Id'));

                        $('#fileNo').val(getVal(d, 'FileNo'));
                        $('#companyName').val(getVal(d, 'CompanyName'));
                        $('#companyNo').val(getVal(d, 'CompanyNo'));
                        $('#incorpDate').val(formatDateForDisplay(getVal(d, 'IncorpDate')));
                        $('#coStatus').val(getVal(d, 'CompanyStatus'));

                        $('#anniversaryDate').val(formatDateForDisplay(getVal(d, 'AnniversaryDate')));
                        $('#arDueDate').val(formatDateForDisplay(getVal(d, 'ARdueDate')));
                        $('#reminderDate').val(formatDateForDisplay(getVal(d, 'ReminderDate')));

                        $('#dateOfAnnualReturn').val(formatDateForDisplay(getVal(d, 'DateOfAR')));
                        $('#arSubmittedDate').val(formatDateForDisplay(getVal(d, 'ARsubmitDate')));

                        $('#dateSendToClient').val(formatDateForDisplay(getVal(d, 'DateSendToClient')));
                        $('#dateReturned').val(formatDateForDisplay(getVal(d, 'DateReturned')));

                        $('#jobStatus').val(getVal(d, 'JobCompleted'));
                        $('#remarks').val(getVal(d, 'Remarks'));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Annual Return Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;

            $.ajax({
                url: 'api/s14a/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}