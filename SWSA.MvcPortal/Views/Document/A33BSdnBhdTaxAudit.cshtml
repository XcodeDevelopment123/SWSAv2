@{
    ViewData["Title"] = "A33BSdnBhdTaxAudit";
}

<h1>A33B Sdn Bhd Tax Audit</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>A33B Sdn Bhd Tax Audit Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="clearForm()">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>

            <!-- 状态显示区域 -->
            <div id="connectionStatus" class="mt-2 mx-3"></div>

            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">CaseNo</th>
                            <th rowspan="2">Date received</th>
                            <th rowspan="2">Client</th>
                            <th colspan="2">IRB</th>
                            <th rowspan="2">Year of Assessment</th>
                            <th rowspan="2">Date-IRB email/letter</th>
                            <th rowspan="2">Details of correpondence</th>
                            <th rowspan="2">PIC</th>
                            <th colspan="2">Action Taken</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Officer in charge</th>
                            <th>Tel/Extension</th>
                            <th>Date</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTable 会动态填充数据 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Tax Audit Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="caseNo">CaseNo</label>
                                <input type="text" id="caseNo" name="caseNo" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceived">Date received</label>
                                <input type="text" id="dateReceived" name="dateReceived" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Client Information -->
                    <div class="form-info-label col-12">
                        <label>Client Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="client">Client</label>
                                <input type="text" id="client" name="client" class="form-control" placeholder="Enter client name" />
                            </div>
                        </div>
                    </div>

                    <!-- IRB Information -->
                    <div class="form-info-label col-12">
                        <label>IRB Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbOfficer">Officer in charge</label>
                                <input type="text" id="irbOfficer" name="irbOfficer" class="form-control" placeholder="Enter officer name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbContact">Tel/Extension</label>
                                <input type="text" id="irbContact" name="irbContact" class="form-control" placeholder="Enter contact number" />
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Details -->
                    <div class="form-info-label col-12">
                        <label>Assessment Details</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearOfAssessment">Year of Assessment</label>
                                <input type="text" id="yearOfAssessment" name="yearOfAssessment" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbEmailDate">Date-IRB email/letter</label>
                                <input type="text" id="irbEmailDate" name="irbEmailDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Correspondence Details -->
                    <div class="form-info-label col-12">
                        <label>Correspondence Details</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="details">Details of correspondence</label>
                                <textarea id="details" name="details" class="form-control" placeholder="Enter correspondence details" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- PIC Information -->
                    <div class="form-info-label col-12">
                        <label>PIC Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                    </div>

                    <!-- Action Taken -->
                    <div class="form-info-label col-12">
                        <label>Action Taken</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionDate">Date</label>
                                <input type="text" id="actionDate" name="actionDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionNote">Note</label>
                                <input type="text" id="actionNote" name="actionNote" class="form-control" placeholder="Enter action note" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        // 防止 DataTables 重复初始化
        let dataTableInitialized = false;
        let dataTable;

        $(document).ready(function() {
            console.log('A33B Page loaded, initializing...');

            // 先销毁已存在的 DataTable 实例
            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }

            // 初始化 DataTable
            dataTable = $('#taskDatatable').DataTable({
                "responsive": true,
                "autoWidth": false,
                "pageLength": 10,
                "data": [], // 初始为空数组
                "columns": [
                    {
                        title: "CaseNo",
                        data: "caseNo",
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Date received",
                        data: "dateReceived",
                        render: function(data) {
                            return formatDateForDisplay(data) || '-';
                        }
                    },
                    {
                        title: "Client",
                        data: "client",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Officer in charge",
                        data: "officerInchrage",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Tel/Extension",
                        data: "telExtension",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Year of Assessment",
                        data: "yearAssessment",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Date-IRB email/letter",
                        data: "dateIRBemailLetter",
                        render: function(data) {
                            return formatDateForDisplay(data) || '-';
                        }
                    },
                    {
                        title: "Details of correspondence",
                        data: "detailsCorrepondence",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "PIC",
                        data: "pic",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Date",
                        data: "date",
                        render: function(data) {
                            return formatDateForDisplay(data) || '-';
                        }
                    },
                    {
                        title: "Note",
                        data: "note",
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        title: "Actions",
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            if (!row || !row.id) return '<span class="text-muted">No actions</span>';

                            return '<button class="btn btn-sm btn-warning edit-btn me-1" data-id="' + row.id + '" title="Edit">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button class="btn btn-sm btn-danger delete-btn" data-id="' + row.id + '" title="Delete">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>';
                        }
                    }
                ],
                "language": {
                    "emptyTable": "No records found",
                    "search": "Search:",
                    "lengthMenu": "Show _MENU_ entries",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "Showing 0 to 0 of 0 entries",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Previous"
                    }
                }
            });
            dataTableInitialized = true;

            // 初始化日期选择器
            $('.datepicker').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // 为所有日期字段添加日期选择器
            $('#dateReceived, #irbEmailDate, #actionDate').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // 保存按钮点击事件
            $('#saveBtn').click(function() {
                console.log('Save button clicked!');
                saveRecord();
            });

            // 编辑按钮事件
            $(document).on('click', '.edit-btn', function() {
                var id = $(this).data('id');
                editRecord(id);
            });

            // 删除按钮事件
            $(document).on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                deleteRecord(id);
            });

            // 模态框关闭时清除表单
            $('#taskModal').on('hidden.bs.modal', function() {
                clearForm();
            });

            // 页面加载时自动加载数据
            loadRecordsFromDatabase();
        });

        function loadRecordsFromDatabase() {
            showAlert('🔄 Loading A33B records...', 'info');

            $.ajax({
                url: '/documents/get-a33b-records',
                type: 'GET',
                success: function(response) {
                    console.log('Load A33B records response:', response);
                    if (response.success) {
                        if (response.data && response.data.length > 0) {
                            showAlert('✅ Loaded ' + response.data.length + ' A33B records', 'success');
                            populateTable(response.data);
                        } else {
                            showAlert('ℹ️ No A33B records found in database', 'info');
                            populateTable([]);
                        }
                    } else {
                        showAlert('❌ Error: ' + response.message, 'error');
                        populateTable([]);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showAlert('❌ Failed to load A33B records: ' + error, 'error');
                    populateTable([]);
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;

            console.log('Populating table with records:', records);

            // 清除现有数据并重新绘制
            dataTable.clear();

            if (records && records.length > 0) {
                console.log('Adding', records.length, 'records to DataTable');

                // 检查第一条记录的字段结构
                if (records.length > 0) {
                    console.log('First record structure:', records[0]);
                }

                dataTable.rows.add(records).draw();
            } else {
                console.log('No records to display');
                dataTable.draw();
            }
        }

        function clearForm() {
            $('#editIndex').val('');
            $('#taskForm')[0].reset();
            $('#modalTitle').text('Add New Tax Audit Record');
        }

        function saveRecord() {
            // 获取表单数据 - 根据实际数据库字段名
            var formData = {
                Id: $('#editIndex').val() || 0,
                CaseNo: $('#caseNo').val(),
                DateReceived: $('#dateReceived').val(),
                Client: $('#client').val(),
                OfficerInchrage: $('#irbOfficer').val(),
                TelExtension: $('#irbContact').val(),
                YearAssessment: $('#yearOfAssessment').val(),
                DateIRBemailLetter: $('#irbEmailDate').val(),
                DetailsCorrepondence: $('#details').val(),
                PIC: $('#pic').val(),
                Date: $('#actionDate').val(),
                Note: $('#actionNote').val()
            };

            console.log('A33B Form Data:', formData);

            // 基本验证
            if (!formData.DateReceived || !formData.Client) {
                showAlert('Please fill in required fields: Date Received and Client', 'error');
                return;
            }

            var url = formData.Id > 0 ? '/documents/update-a33b' : '/documents/create-a33b';
            var method = formData.Id > 0 ? 'PUT' : 'POST';

            console.log('Sending to:', url, 'Method:', method);

            // 显示加载状态
            var saveBtn = $('#saveBtn');
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    console.log('Save response:', response);
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');

                    if (response.success) {
                        $('#taskModal').modal('hide');
                        showAlert('A33B record saved successfully!', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        var errorMessage = response.errors ? response.errors.join(', ') : response.message;
                        showAlert('Error saving A33B record: ' + errorMessage, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Save error details:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });

                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showAlert('Error saving A33B record: ' + error, 'error');
                }
            });
        }

        function editRecord(id) {
            // 显示加载状态
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');

            $.ajax({
                url: '/documents/get-a33b-record/' + id,
                type: 'GET',
                success: function(response) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Tax Audit Record');

                    if (response.success) {
                        var data = response.data;
                        $('#editIndex').val(data.id);
                        $('#caseNo').val(data.caseNo || '');
                        $('#dateReceived').val(data.dateReceived);
                        $('#client').val(data.client);
                        $('#irbOfficer').val(data.officerInchrage);
                        $('#irbContact').val(data.telExtension);
                        $('#yearOfAssessment').val(data.yearAssessment);
                        $('#irbEmailDate').val(data.dateIRBemailLetter);
                        $('#details').val(data.detailsCorrepondence);
                        $('#pic').val(data.pic);
                        $('#actionDate').val(data.date);
                        $('#actionNote').val(data.note);

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading A33B record: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Tax Audit Record');
                    showAlert('Error loading A33B record: ' + error, 'error');
                    console.error('Edit error:', error);
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this A33B record? This action cannot be undone.')) {
                $.ajax({
                    url: '/documents/delete-a33b/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('A33B record deleted successfully!', 'success');
                            loadRecordsFromDatabase();
                        } else {
                            showAlert('Error deleting A33B record: ' + response.message, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error deleting A33B record: ' + error, 'error');
                        console.error('Delete error:', error);
                    }
                });
            }
        }

        // 格式化日期显示
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // 如果日期已经是 dd/mm/yyyy 格式，直接返回
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateString;
            }
            return dateString;
        }

        // 显示提示消息
        function showAlert(message, type) {
            var alertClass = type === 'success' ? 'alert-success' :
                           type === 'error' ? 'alert-danger' :
                           type === 'warning' ? 'alert-warning' : 'alert-info';

            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                '<strong>' + message + '</strong>' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            // 在状态区域显示提示
            $('#connectionStatus').html(alertHtml);

            // 3秒后自动消失（错误消息保持更久）
            var timeout = type === 'error' ? 5000 : 3000;
            setTimeout(function() {
                $('.alert').alert('close');
            }, timeout);
        }
    </script>
}