@{
    ViewData["Title"] = "A31BDocControl";
}

<h1>A31B Doc Control</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Document Control Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">Client</th>
                            <th rowspan="2">Year End</th>
                            <th rowspan="2">Co Status</th>
                            <th colspan="3">Receipt of Documents</th>
                            <th colspan="2">Acknowledgement</th>
                            <th rowspan="2">Remark</th>
                            <th colspan="5">Return of Documents</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Date Doc fr Acc dept</th>
                            <th>Date Received</th>
                            <th># of bags/box</th>
                            <th>By Whom</th>
                            <th>Upload letter</th>
                            <th>Date</th>
                            <th># of bags/box</th>
                            <th>By Whom</th>
                            <th>Upload letter</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <!-- Records will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New A31B Doc Control Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="clientId">Client</label>
                                <select id="clientId" name="clientId" class="form-control" required>
                                    <option value="">Select Client</option>
                                    <!-- Clients will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Year end will auto-fill when client is selected" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <select id="coStatus" name="coStatus" class="form-control" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt of Documents -->
                    <div class="form-info-label col-12">
                        <label>Receipt of Documents</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateDocFr">Date Doc fr Acc dept</label>
                                <input type="text" id="dateDocFr" name="dateDocFr" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateReceived">Date Received</label>
                                <input type="text" id="dateReceived" name="dateReceived" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="noOfBoxBag"># of bags/box</label>
                                <input type="number" id="noOfBoxBag" name="noOfBoxBag" class="form-control" placeholder="Enter number" min="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Acknowledgement -->
                    <div class="form-info-label col-12">
                        <label>Acknowledgement</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="byWhom">By Whom</label>
                                <input type="text" id="byWhom" name="byWhom" class="form-control" placeholder="Enter name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="uploadLetter">Upload letter</label>
                                <select id="uploadLetter" name="uploadLetter" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Remark -->
                    <div class="form-info-label col-12">
                        <label>Receipt Remark</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="remark">Remark</label>
                                <textarea id="remark" name="remark" class="form-control" placeholder="Enter remarks" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Return of Documents -->
                    <div class="form-info-label col-12">
                        <label>Return of Documents</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="date">Date</label>
                                <input type="text" id="date" name="date" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="noOfbox"># of bags/box</label>
                                <input type="number" id="noOfbox" name="noOfbox" class="form-control" placeholder="Enter number" min="0" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="byWhom2">By Whom</label>
                                <input type="text" id="byWhom2" name="byWhom2" class="form-control" placeholder="Enter name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="uploadLetter2">Upload letter</label>
                                <select id="uploadLetter2" name="uploadLetter2" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remark2">Return Remark</label>
                                <textarea id="remark2" name="remark2" class="form-control" placeholder="Enter return remarks" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            // Load records and clients on page load
            loadA31BRecords();
            loadClients();

            // Initialize datepicker
            $('.datepicker').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true
            });

            // Client selection change event
            $('#clientId').change(function() {
                var selectedClientId = $(this).val();
                if (selectedClientId) {
                    loadClientDetails(selectedClientId);
                } else {
                    $('#yearEnd').val('');
                }
            });

            // Save button click event
            $('#saveBtn').click(function() {
                saveA31BRecord();
            });

            // Form reset when modal is closed
            $('#taskModal').on('hidden.bs.modal', function () {
                $('#taskForm')[0].reset();
                $('#editId').val('');
                $('#modalTitle').text('Add New A31B Doc Control Record');
            });
        });

        // Load clients from database
        function loadClients() {
            $.ajax({
                url: '/documents/get-clients',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateClientDropdown(response.data);
                    } else {
                        console.error('Failed to load clients:', response.message);
                        showError('Failed to load clients list');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading clients:', error);
                    showError('Error loading clients list');
                }
            });
        }

        // Load client details including year end
        function loadClientDetails(clientId) {
            $.ajax({
                url: '/documents/get-client-details/' + clientId,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        // Auto-fill year end based on client's YearEndMonth
                        if (response.data.yearEndMonth) {
                            var currentYear = new Date().getFullYear();
                            var yearEnd = '31 ' + getMonthName(response.data.yearEndMonth) + ' ' + currentYear;
                            $('#yearEnd').val(yearEnd);
                        }
                    } else {
                        console.error('Failed to load client details:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading client details:', error);
                }
            });
        }

        // Helper function to convert month number to month name
        function getMonthName(monthNumber) {
            const months = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            return months[monthNumber - 1] || 'Dec';
        }

        // Populate client dropdown
        function populateClientDropdown(clients) {
            var dropdown = $('#clientId');
            dropdown.empty();
            dropdown.append('<option value="">Select Client</option>');

            if (clients && clients.length > 0) {
                clients.forEach(function(client) {
                    dropdown.append('<option value="' + client.id + '">' + client.name + '</option>');
                });
            } else {
                dropdown.append('<option value="" disabled>No clients available</option>');
            }
        }

        // Load A31B records from database
        function loadA31BRecords() {
            $.ajax({
                url: '/documents/get-a31b-records',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateTable(response.data);
                    } else {
                        console.error('Failed to load records:', response.message);
                        showError('Failed to load records: ' + response.message);
                        $('#recordsTableBody').html('<tr><td colspan="15" class="text-center text-muted py-4">Error loading records</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading records:', error);
                    showError('Error loading records: ' + error);
                    $('#recordsTableBody').html('<tr><td colspan="15" class="text-center text-muted py-4">Error loading records</td></tr>');
                }
            });
        }

        // Populate table with records
        function populateTable(records) {
            var tbody = $('#recordsTableBody');
            tbody.empty();

            if (records.length === 0) {
                tbody.append('<tr><td colspan="15" class="text-center text-muted py-4">No records found. Click "New Record" to create one.</td></tr>');
                return;
            }

            records.forEach(function(record) {
                var row = '<tr>' +
                    '<td>' + (record.clients || 'N/A') + '</td>' +
                    '<td>' + (record.yearEnded || 'N/A') + '</td>' +
                    '<td>' + (record.coStatus || 'N/A') + '</td>' +
                    '<td>' + (record.dateDocFr || 'N/A') + '</td>' +
                    '<td>' + (record.dateReceived || 'N/A') + '</td>' +
                    '<td>' + (record.noOfBoxBag || 'N/A') + '</td>' +
                    '<td>' + (record.byWhom || 'N/A') + '</td>' +
                    '<td>' + (record.uploadLetter || 'N/A') + '</td>' +
                    '<td>' + (record.remark || 'N/A') + '</td>' +
                    '<td>' + (record.date || 'N/A') + '</td>' +
                    '<td>' + (record.noOfbox || 'N/A') + '</td>' +
                    '<td>' + (record.byWhom2 || 'N/A') + '</td>' +
                    '<td>' + (record.uploadLetter2 || 'N/A') + '</td>' +
                    '<td>' + (record.remark2 || 'N/A') + '</td>' +
                    '<td class="text-nowrap">' +
                    '<button class="btn btn-sm btn-warning me-1" onclick="editRecord(' + record.id + ')" title="Edit">' +
                    '<i class="fas fa-edit"></i>' +
                    '</button>' +
                    '<button class="btn btn-sm btn-danger" onclick="deleteRecord(' + record.id + ')" title="Delete">' +
                    '<i class="fas fa-trash"></i>' +
                    '</button>' +
                    '</td>' +
                    '</tr>';

                tbody.append(row);
            });
        }

        // Save A31B record
        function saveA31BRecord() {
            var selectedClientId = $('#clientId').val();
            var selectedClientName = $('#clientId option:selected').text();

            var formData = {
                Id: $('#editId').val() ? parseInt($('#editId').val()) : 0,
                Clients: selectedClientName,
                YearEnded: $('#yearEnd').val(),
                CoStatus: $('#coStatus').val(),
                DateDocFr: $('#dateDocFr').val(),
                DateReceived: $('#dateReceived').val(),
                NoOfBoxBag: $('#noOfBoxBag').val() ? parseInt($('#noOfBoxBag').val()) : null,
                ByWhom: $('#byWhom').val(),
                UploadLetter: $('#uploadLetter').val(),
                Remark: $('#remark').val(),
                Date: $('#date').val(),
                NoOfbox: $('#noOfbox').val() ? parseInt($('#noOfbox').val()) : null,
                ByWhom2: $('#byWhom2').val(),
                UploadLetter2: $('#uploadLetter2').val(),
                Remark2: $('#remark2').val()
            };

            // Validate required fields
            if (!formData.Clients || formData.Clients === 'Select Client') {
                alert('Please select a client from the dropdown');
                return;
            }

            if (!formData.YearEnded) {
                alert('Please ensure Year End is filled (it should auto-fill when client is selected)');
                return;
            }

            if (!formData.CoStatus) {
                alert('Please select Company Status');
                return;
            }

            // Show loading
            $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            var url = formData.Id ? '/documents/update-a31b' : '/documents/create-a31b';

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');

                    if (response.success) {
                        $('#taskModal').modal('hide');
                        showSuccess('Record saved successfully!');
                        loadA31BRecords();
                    } else {
                        showError('Save failed: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showError('Error during save: ' + error);
                    console.error('Error details:', xhr.responseText);
                }
            });
        }

        // Edit record
        function editRecord(id) {
            $.ajax({
                url: '/documents/get-a31b-record/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var record = response.data;
                        $('#editId').val(record.id);

                        // Set client value
                        var clientDropdown = $('#clientId');
                        var clientExists = false;

                        if (record.clients) {
                            clientDropdown.find('option').each(function() {
                                if ($(this).text() === record.clients) {
                                    clientExists = true;
                                    $(this).prop('selected', true);
                                    // Load client details to populate year end
                                    loadClientDetails($(this).val());
                                    return false;
                                }
                            });

                            if (!clientExists) {
                                // If client doesn't exist in dropdown, just set the year end
                                $('#yearEnd').val(record.yearEnded);
                            }
                        }

                        $('#coStatus').val(record.coStatus);
                        $('#dateDocFr').val(record.dateDocFr);
                        $('#dateReceived').val(record.dateReceived);
                        $('#noOfBoxBag').val(record.noOfBoxBag);
                        $('#byWhom').val(record.byWhom);
                        $('#uploadLetter').val(record.uploadLetter);
                        $('#remark').val(record.remark);
                        $('#date').val(record.date);
                        $('#noOfbox').val(record.noOfbox);
                        $('#byWhom2').val(record.byWhom2);
                        $('#uploadLetter2').val(record.uploadLetter2);
                        $('#remark2').val(record.remark2);

                        $('#modalTitle').text('Edit A31B Record');
                        $('#taskModal').modal('show');
                    } else {
                        showError('Failed to load record: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    showError('Error loading record: ' + error);
                }
            });
        }

        // Delete record
        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
                $.ajax({
                    url: '/documents/delete-a31b/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showSuccess('Record deleted successfully!');
                            loadA31BRecords();
                        } else {
                            showError('Delete failed: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        showError('Error during delete: ' + error);
                    }
                });
            }
        }

        // Utility functions
        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }
    </script>
}