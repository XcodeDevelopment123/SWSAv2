@model List<SWSA.MvcPortal.Models.Clients.A32a>
@{
    ViewData["Title"] = "A32BForm";
}

<h1>A32B Account Dept Form B&P, LLP Tax audit</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>A32B Tax Audit Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="clearForm()">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>

            <div id="connectionStatus" class="mt-2 mx-3"></div>

            <div class="card-body">
                <div class="table-responsive">
                    <table id="taskDatatable" class="table table-bordered table-striped" style="width:100%">
                        <thead>
                            <tr>
                                <th rowspan="2">CaseNo</th>                  <th rowspan="2">Date received</th>           <th rowspan="2">Client</th>                  <th colspan="2">IRB</th>                     <th rowspan="2">Year of Assessment</th>      <th rowspan="2">Date-IRB email/letter</th>   <th rowspan="2">Details of correpondence</th><th rowspan="2">PIC</th>                     <th colspan="2">Action Taken</th>            <th rowspan="2">Actions</th>                 </tr>
                            <tr>
                                <th>Officer in charge</th>                   <th>Tel/Extension</th>                       <th>Date</th>                                <th>Note</th>                                </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Tax Audit Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="0">

                    <div class="form-info-label col-12"><label>Basic Information</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="caseNo">CaseNo</label>
                                <input type="text" id="caseNo" name="caseNo" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceived">Date received</label>
                                <input type="text" id="dateReceived" name="dateReceived" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Client Information</label></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="companySelect">Client (LLP & Enterprise)</label>
                                <select id="companySelect" name="companySelect" class="form-control" required>
                                    <option value="">-- Select company --</option>
                                </select>
                                <small class="text-muted">Options are filtered for LLP & Enterprise clients.</small>
                                <input type="hidden" id="client" name="client" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>IRB Information</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbOfficer">Officer in charge</label>
                                <input type="text" id="irbOfficer" name="irbOfficer" class="form-control" placeholder="Enter officer name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbContact">Tel/Extension</label>
                                <input type="text" id="irbContact" name="irbContact" class="form-control" placeholder="Enter contact number" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Assessment Details</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearOfAssessment">Year of Assessment</label>
                                <input type="text" id="yearOfAssessment" name="yearOfAssessment" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbEmailDate">Date-IRB email/letter</label>
                                <input type="text" id="irbEmailDate" name="irbEmailDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Correspondence Details</label></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="details">Details of correspondence</label>
                                <textarea id="details" name="details" class="form-control" placeholder="Enter correspondence details" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>PIC Information</label></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Action Taken</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionDate">Date</label>
                                <input type="text" id="actionDate" name="actionDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionNote">Note</label>
                                <input type="text" id="actionNote" name="actionNote" class="form-control" placeholder="Enter action note" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn"><i class="fas fa-save me-2"></i>Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTableInitialized = false;
        let dataTable;
        let clientOptionsMap = {};

        function loadClientOptions() {
            $.ajax({
                url: '/api/auditdept/clients/get-list',
                type: 'GET',
                success: function (res) {
                    if (!(res && res.success && Array.isArray(res.data))) return;
                    clientOptionsMap = {};
                    const $sel = $('#companySelect');
                    $sel.empty().append('<option value="">-- Select company --</option>');

                    res.data.forEach(o => {
                        const type = o.clientType || o.ClientType;
                        const name = o.companyName || o.CompanyName;
                        const id = o.id || o.Id;

                        if (type === 'LLP' || type === 'Enterprise') {
                            const display = `${name} (${type})`;
                            clientOptionsMap[id] = { id: id, text: name, type: type };
                            $sel.append(`<option value="${id}">${display}</option>`);
                        }
                    });
                },
                error: function (xhr) {
                    showAlert('❌ Failed to load client list.', 'error');
                }
            });
        }

        $(document).ready(function() {
            loadClientOptions();

            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }

            // 【修复2】DataTable 初始化配置
            // responsive: false (防止复杂表头错误)
            // 显式定义 12 列 (防止 Incorrect column count)
            dataTable = $('#taskDatatable').DataTable({
                "responsive": false,
                "scrollX": true,
                "autoWidth": false,
                "pageLength": 10,
                "columns": [
                    { width: "10%" }, // 0 CaseNo
                    { width: "10%" }, // 1 Date received
                    { width: "15%" }, // 2 Client
                    { width: "10%" }, // 3 Officer
                    { width: "10%" }, // 4 Tel
                    { width: "10%" }, // 5 Year
                    { width: "10%" }, // 6 Date-IRB
                    { width: "15%" }, // 7 Details
                    { width: "10%" }, // 8 PIC
                    { width: "10%" }, // 9 Date Action
                    { width: "15%" }, // 10 Note
                    { width: "10%", orderable: false } // 11 Actions
                ],
                "language": {
                    "search": "Search:",
                    "lengthMenu": "Show _MENU_ entries",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "Showing 0 to 0 of 0 entries",
                    "emptyTable": "No records found",
                    "paginate": { "first": "First", "last": "Last", "next": "Next", "previous": "Previous" }
                }
            });
            dataTableInitialized = true;

            $('.datepicker').datepicker({ format: 'dd/mm/yyyy', autoclose: true, todayHighlight: true });

            $('#companySelect').on('change', function () {
                const id = $(this).val();
                const selectedOption = clientOptionsMap[id];
                $('#client').val(selectedOption ? selectedOption.text : '');
            });

            $('#saveBtn').click(function() { saveRecord(); });
            $(document).on('click', '.edit-btn', function() { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function() { deleteRecord($(this).data('id')); });
            $('#taskModal').on('hidden.bs.modal', function() { clearForm(); });

            loadRecordsFromDatabase();
        });

        function loadRecordsFromDatabase() {
            $.ajax({
                url: '/documents/get-a32b-records',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateTable(response.data);
                        showAlert('✅ Loaded ' + response.data.length + ' A32B records', 'success');
                    } else {
                        showAlert('❌ Error: ' + response.message, 'error');
                    }
                },
                error: function() { showAlert('❌ Failed to load A32B records.', 'error'); }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();
            if (records && records.length > 0) {
                records.forEach(function(record) {
                    // 【修复3】确保这里的数据项严格等于 12 个
                    dataTable.row.add([
                        record.caseNo || '',                    
                        formatDateForDisplay(record.dateReceived), 
                        record.client, 
                        record.officerInCharge || '',
                        record.telExtension || '',
                        record.yearAssessment || '',
                        formatDateForDisplay(record.dateIRBemailLetter), 
                        record.detailsCorrepondence || '',
                        record.pic || '',
                        formatDateForDisplay(record.date),      
                        record.note || '',
                        '<div class="btn-group">' +
                        '<button class="btn btn-sm btn-warning edit-btn" data-id="' + record.id + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
                        '<button class="btn btn-sm btn-danger delete-btn" data-id="' + record.id + '" title="Delete"><i class="fas fa-trash"></i></button>' +
                        '</div>'
                    ]);
                });
            }
            dataTable.draw();
        }

        function clearForm() {
            $('#editIndex').val('0'); // 重置为 0，确保下次是 Create
            $('#taskForm')[0].reset();
            $('#modalTitle').text('Add New Tax Audit Record');
            $('#companySelect').val('');
            $('#client').val('');
        }

        // 【修复1】Save Record：补全 AJAX 并处理 Id 逻辑
        function saveRecord() {
            var clientName = $('#client').val();
            // 确保 Id 是数字，如果空字符串则为 0
            var idVal = $('#editIndex').val();
            var id = (idVal && idVal !== '') ? parseInt(idVal) : 0;

            var formData = {
                Id: id,
                CaseNo: $('#caseNo').val(),
                DateReceived: $('#dateReceived').val(),
                Client: clientName, 
                OfficerInCharge: $('#irbOfficer').val(),
                TelExtension: $('#irbContact').val(),
                YearAssessment: $('#yearOfAssessment').val(),
                DateIRBemailLetter: $('#irbEmailDate').val(),
                DetailsCorrepondence: $('#details').val(),
                PIC: $('#pic').val(),
                Date: $('#actionDate').val(),
                Note: $('#actionNote').val()
            };

            if (!formData.DateReceived || !formData.Client) {
                showAlert('Please select Date Received and Client.', 'error');
                return;
            }

            var isUpdate = id > 0;
            var url = isUpdate ? '/documents/update-a32b' : '/documents/create-a32b';
            var method = isUpdate ? 'PUT' : 'POST';

            var saveBtn = $('#saveBtn');
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (response.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully!', 'success');
                        loadRecordsFromDatabase(); 
                    } else {
                        showAlert('Error saving record: ' + (response.message || 'Unknown error'), 'error');
                    }
                },
                error: function(xhr) {
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showAlert('❌ Failed to save record.', 'error');
                }
            });
        }

        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            
            $.ajax({
                url: '/documents/get-a32b-record/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var data = response.data;
                        $('#modalTitle').text('Edit Tax Audit Record');
                        
                        // 1. 设置 ID，确保 Save 时知道是 Update
                        $('#editIndex').val(data.id);

                        // 2. 填充普通字段
                        $('#caseNo').val(data.caseNo || '');
                        $('#dateReceived').val(formatDateForDisplay(data.dateReceived));
                        $('#irbOfficer').val(data.officerInCharge);
                        $('#irbContact').val(data.telExtension);
                        $('#yearOfAssessment').val(data.yearAssessment);
                        $('#irbEmailDate').val(formatDateForDisplay(data.dateIRBemailLetter));
                        $('#details').val(data.detailsCorrepondence);
                        $('#pic').val(data.pic);
                        $('#actionDate').val(formatDateForDisplay(data.date));
                        $('#actionNote').val(data.note);

                        // 3. 处理 Dropdown 反选
                        const existingClientName = (data.client || '').trim();
                        let matchedId = null;
                        for (const [key, o] of Object.entries(clientOptionsMap)) {
                            if (o.text === existingClientName) {
                                matchedId = key;
                                break;
                            }
                        }
                        $('#client').val(existingClientName);
                        $('#companySelect').val(matchedId || '');

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record', 'error');
                    }
                },
                error: function() { showAlert('Error loading record', 'error'); }
            });
        }

        function deleteRecord(id) {
            if (confirm('Delete this record?')) {
                $.ajax({
                    url: '/documents/delete-a32b/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('Record deleted successfully!', 'success');
                            loadRecordsFromDatabase();
                        } else {
                            showAlert('Error: ' + response.message, 'error');
                        }
                    }
                });
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // 如果日期已经是 dd/mm/yyyy 格式，直接返回
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateString;
            
            // 尝试解析 ISO 格式 (yyyy-MM-dd)
            var isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(dateString);
            if (isoMatch) return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
            
            return dateString;
        }

        function showAlert(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var html = `<div class="alert ${alertClass} alert-dismissible fade show">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            $('#connectionStatus').html(html);
            setTimeout(function() { $('#connectionStatus .alert').fadeOut(function() { $(this).remove(); }); }, 3000);
        }
    </script>
}