@{
    ViewData["Title"] = "A33ATaxDeptcorrespondanceRecord";
}

<h1>A33A Tax Dept Correspondance Record</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>A33A Tax Dept Correspondence Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="clearForm()">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>

            <!-- 状态显示区域 -->
            <div id="connectionStatus" class="mt-2 mx-3"></div>

            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">Case No#</th>
                            <th colspan="2">Correspondence Received</th>
                            <th rowspan="2">Client</th>
                            <th rowspan="2">Year of Assessments</th>
                            <th rowspan="2">Details</th>
                            <th colspan="2">Action taken</th>
                            <th rowspan="2">PIC</th>
                            <th rowspan="2">Remark</th>
                            <th rowspan="2">Done on</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Date received</th>
                            <th>Type of Incoming</th>
                            <th>Date</th>
                            <th>Brief descritions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTable 会动态填充数据 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Correspondence Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Item No -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="itemNo">Case No#</label>
                                <input type="text" id="itemNo" name="itemNo" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbDateReceived">IRB Date received</label>
                                <input type="text" id="irbDateReceived" name="irbDateReceived" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Correspondence Received -->
                    <div class="form-info-label col-12">
                        <label>Correspondence Received</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="typeOfIncoming">Type of Incoming</label>
                                <select id="typeOfIncoming" name="typeOfIncoming" class="form-control">
                                    <option value="">Select Type</option>
                                    <option value="Tax Assessment">Tax Assessment</option>
                                    <option value="Audit Query">Audit Query</option>
                                    <option value="Notice">Notice</option>
                                    <option value="Letter">Letter</option>
                                    <option value="Email">Email</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Client Information -->
                    <div class="form-info-label col-12">
                        <label>Client Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="client">Client</label>
                                <input type="text" id="client" name="client" class="form-control" placeholder="Enter client name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearOfAssessments">Year of Assessments</label>
                                <input type="text" id="yearOfAssessments" name="yearOfAssessments" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="form-info-label col-12">
                        <label>Details</label>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="details">Details</label>
                                <textarea id="details" name="details" class="form-control" placeholder="Enter details" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Taken -->
                    <div class="form-info-label col-12">
                        <label>Action Taken</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionDate">Date</label>
                                <input type="text" id="actionDate" name="actionDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="briefDescriptions">Brief descriptions</label>
                                <input type="text" id="briefDescriptions" name="briefDescriptions" class="form-control" placeholder="Enter brief description" />
                            </div>
                        </div>
                    </div>

                    <!-- PIC and Remark -->
                    <div class="form-info-label col-12">
                        <label>PIC and Remark</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remark">Remark</label>
                                <input type="text" id="remark" name="remark" class="form-control" placeholder="Enter remark" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion -->
                    <div class="form-info-label col-12">
                        <label>Completion</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="doneOn">Done on</label>
                                <input type="text" id="doneOn" name="doneOn" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        // 防止 DataTables 重复初始化
        let dataTableInitialized = false;
        let dataTable;

        $(document).ready(function() {
            console.log('A33A Page loaded, initializing...');

            // 先销毁已存在的 DataTable 实例
            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }

                   dataTable = $('#taskDatatable').DataTable({
            "responsive": true,
            "autoWidth": false,
            "pageLength": 10,
            "columns": [
                {
                    title: "Case No#",
                    data: "caseNo",  // 直接使用 caseNo 数据
                    render: function(data, type, row) {
                        return data || '-';  // 如果 caseNo 为空显示 '-'
                    }
                },                    // 列1
                {
                    title: "Date received",
                    data: "dateReceived",
                    render: function(data) {
                        return formatDateForDisplay(data);
                    }
                },              // 列2
                {
                    title: "Type of Incoming",
                    data: "typeIncoming"
                },           // 列3
                {
                    title: "Client",
                    data: "client"
                },                     // 列4
                {
                    title: "Year of Assessments",
                    data: "yearAssessment"
                },        // 列5
                {
                    title: "Details",
                    data: "details"
                },                    // 列6
                {
                    title: "Date",
                    data: "date",
                    render: function(data) {
                        return formatDateForDisplay(data);
                    }
                },                       // 列7
                {
                    title: "Brief descriptions",
                    data: "briefDescritions"
                },         // 列8
                {
                    title: "PIC",
                    data: "pic"
                },                        // 列9
                {
                    title: "Remark",
                    data: "remark"
                },                     // 列10
                {
                    title: "Done on",
                    data: "doneOn",
                    render: function(data) {
                        return formatDateForDisplay(data);
                    }
                },                    // 列11
                {
                    title: "Actions",                    // 列12 - 操作列
                    orderable: false,
                    searchable: false,
                    render: function(data, type, row) {
                        return '<button class="btn btn-sm btn-warning edit-btn me-1" data-id="' + row.id + '" title="Edit">' +
                            '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button class="btn btn-sm btn-danger delete-btn" data-id="' + row.id + '" title="Delete">' +
                            '<i class="fas fa-trash"></i>' +
                            '</button>';
                    }
                }
            ],
            "language": {
                "search": "Search:",
                "lengthMenu": "Show _MENU_ entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                "infoEmpty": "Showing 0 to 0 of 0 entries",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            }
        });
            dataTableInitialized = true;

            // 初始化日期选择器
            $('.datepicker').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // 为所有日期字段添加日期选择器
            $('#irbDateReceived, #actionDate, #doneOn').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // 保存按钮点击事件
            $('#saveBtn').click(function() {
                console.log('Save button clicked!');
                saveRecord();
            });

            // 编辑按钮事件
            $(document).on('click', '.edit-btn', function() {
                var id = $(this).data('id');
                editRecord(id);
            });

            // 删除按钮事件
            $(document).on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                deleteRecord(id);
            });

            // 模态框关闭时清除表单
            $('#taskModal').on('hidden.bs.modal', function() {
                clearForm();
            });

            // 页面加载时自动加载数据
            loadRecordsFromDatabase();
        });

        function loadRecordsFromDatabase() {
            showAlert('🔄 Loading A33A records...', 'info');

            $.ajax({
                url: '/documents/get-a33a-records',
                type: 'GET',
                success: function(response) {
                    console.log('Load A33A records response:', response);
                    if (response.success) {
                        showAlert('✅ Loaded ' + response.data.length + ' A33A records', 'success');
                        populateTable(response.data);
                    } else {
                        showAlert('❌ Error: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showAlert('❌ Failed to load A33A records: ' + error, 'error');
                }
            });
        }

                function populateTable(records) {
            if (!dataTableInitialized) return;

            dataTable.clear();

            if (records && records.length > 0) {
                // 使用 DataTable 的 rows.add() 方法，让 DataTable 自动处理数据绑定
                dataTable.rows.add(records).draw();
            } else {
                // 处理空数据情况
                dataTable.row.add([
                    '', '', '', '', '', '', '', '', '', '', '',
                    '<span class="text-muted">No actions available</span>'
                ]).draw();
            }
        }

        function clearForm() {
            $('#editIndex').val('');
            $('#taskForm')[0].reset();
            $('#modalTitle').text('Add New Correspondence Record');
            $('#typeOfIncoming').val('');
        }

        function saveRecord() {
            // 获取表单数据 - 根据实际数据库字段名
            var formData = {
                Id: $('#editIndex').val() || 0,
                CaseNo: $('#itemNo').val() || '',                    // Item No
                DateReceived: $('#irbDateReceived').val(),
                TypeIncoming: $('#typeOfIncoming').val(),
                Client: $('#client').val(),
                YearAssessment: $('#yearOfAssessments').val(),
                Details: $('#details').val(),
                Date: $('#actionDate').val(),
                BriefDescritions: $('#briefDescriptions').val(),
                PIC: $('#pic').val(),
                Remark: $('#remark').val(),
                DoneOn: $('#doneOn').val()
            };

            console.log('A33A Form Data:', formData);

            // 基本验证
            if (!formData.DateReceived || !formData.Client) {
                showAlert('Please fill in required fields: Date Received and Client', 'error');
                return;
            }

            var url = formData.Id > 0 ? '/documents/update-a33a' : '/documents/create-a33a';
            var method = formData.Id > 0 ? 'PUT' : 'POST';

            console.log('Sending to:', url, 'Method:', method);

            // 显示加载状态
            var saveBtn = $('#saveBtn');
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    console.log('Save response:', response);
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');

                    if (response.success) {
                        $('#taskModal').modal('hide');
                        showAlert('A33A record saved successfully!', 'success');
                        loadRecordsFromDatabase(); // 重新加载数据
                    } else {
                        var errorMessage = response.errors ? response.errors.join(', ') : response.message;
                        showAlert('Error saving A33A record: ' + errorMessage, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Save error details:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });

                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showAlert('Error saving A33A record: ' + error, 'error');
                }
            });
        }

        function editRecord(id) {
            // 显示加载状态
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');

            $.ajax({
                url: '/documents/get-a33a-record/' + id,
                type: 'GET',
                success: function(response) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Correspondence Record');

                    if (response.success) {
                        var data = response.data;
                        $('#editIndex').val(data.id);
                        $('#itemNo').val(data.caseNo || '');
                        $('#irbDateReceived').val(data.dateReceived);
                        $('#typeOfIncoming').val(data.typeIncoming);
                        $('#client').val(data.client);
                        $('#yearOfAssessments').val(data.yearAssessment);
                        $('#details').val(data.details);
                        $('#actionDate').val(data.date);
                        $('#briefDescriptions').val(data.briefDescritions);
                        $('#pic').val(data.pic);
                        $('#remark').val(data.remark);
                        $('#doneOn').val(data.doneOn);

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading A33A record: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Correspondence Record');
                    showAlert('Error loading A33A record: ' + error, 'error');
                    console.error('Edit error:', error);
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this A33A record? This action cannot be undone.')) {
                $.ajax({
                    url: '/documents/delete-a33a/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('A33A record deleted successfully!', 'success');
                            loadRecordsFromDatabase(); // 重新加载数据
                        } else {
                            showAlert('Error deleting A33A record: ' + response.message, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error deleting A33A record: ' + error, 'error');
                        console.error('Delete error:', error);
                    }
                });
            }
        }

        // 格式化日期显示
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // 如果日期已经是 dd/mm/yyyy 格式，直接返回
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateString;
            }
            // 如果是其他格式，可以在这里转换
            return dateString;
        }

        // 显示提示消息
        function showAlert(message, type) {
            var alertClass = type === 'success' ? 'alert-success' :
                           type === 'error' ? 'alert-danger' :
                           type === 'warning' ? 'alert-warning' : 'alert-info';

            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                '<strong>' + message + '</strong>' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            // 在状态区域显示提示
            $('#connectionStatus').html(alertHtml);

            // 3秒后自动消失（错误消息保持更久）
            var timeout = type === 'error' ? 5000 : 3000;
            setTimeout(function() {
                $('.alert').alert('close');
            }, timeout);
        }

        // 自动生成 Item No (可选功能)
        function generateItemNo() {
            // 如果需要自动生成项目编号，可以在这里实现
            var date = new Date();
            var year = date.getFullYear();
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var itemNo = 'A33A-' + year + month + '-';

            // 这里可以添加逻辑来获取最新的编号
            $('#itemNo').val(itemNo + '001');
        }
    </script>
}