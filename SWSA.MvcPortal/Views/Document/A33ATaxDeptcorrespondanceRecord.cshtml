@model List<SWSA.MvcPortal.Models.Clients.A32a> // 这里假设 Model 类型可能复用，或者您有特定的 A33a 模型
@{
    ViewData["Title"] = "A33ATaxDeptcorrespondanceRecord";
}

<h1>A33A Tax Dept Correspondence Record</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>A33A Tax Dept Correspondence Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="clearForm()">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>

            <div id="connectionStatus" class="mt-2 mx-3"></div>

            <div class="card-body">
                <div class="table-responsive">
                    <table id="taskDatatable" class="table table-bordered table-striped" style="width:100%">
                        <thead>
                            <tr>
                                <th rowspan="2">Case No#</th>                  <th colspan="2">Correspondence Received</th>   <th rowspan="2">Client</th>                    <th rowspan="2">Year of Assessments</th>       <th rowspan="2">Details</th>                   <th colspan="2">Action taken</th>              <th rowspan="2">PIC</th>                       <th rowspan="2">Remark</th>                    <th rowspan="2">Done on</th>                   <th rowspan="2">Actions</th>                   </tr>
                            <tr>
                                <th>Date received</th>                         <th>Type of Incoming</th>                      <th>Date</th>                                  <th>Brief descriptions</th>                    </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Correspondence Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="0">

                    <div class="form-info-label col-12"><label>Basic Information</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="itemNo">Case No#</label>
                                <input type="text" id="itemNo" name="itemNo" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="irbDateReceived">IRB Date received</label>
                                <input type="text" id="irbDateReceived" name="irbDateReceived" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Correspondence Received</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="typeOfIncoming">Type of Incoming</label>
                                <select id="typeOfIncoming" name="typeOfIncoming" class="form-control">
                                    <option value="">Select Type</option>
                                    <option value="Tax Assessment">Tax Assessment</option>
                                    <option value="Audit Query">Audit Query</option>
                                    <option value="Notice">Notice</option>
                                    <option value="Letter">Letter</option>
                                    <option value="Email">Email</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Client Information</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearOfAssessments">Year of Assessments</label>
                                <input type="text" id="yearOfAssessments" name="yearOfAssessments" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Details</label></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="details">Details</label>
                                <textarea id="details" name="details" class="form-control" placeholder="Enter details" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Action Taken</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionDate">Date</label>
                                <input type="text" id="actionDate" name="actionDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="briefDescriptions">Brief descriptions</label>
                                <input type="text" id="briefDescriptions" name="briefDescriptions" class="form-control" placeholder="Enter brief description" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>PIC and Remark</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remark">Remark</label>
                                <input type="text" id="remark" name="remark" class="form-control" placeholder="Enter remark" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12"><label>Completion</label></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="doneOn">Done on</label>
                                <input type="text" id="doneOn" name="doneOn" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn"><i class="fas fa-save me-2"></i>Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTableInitialized = false;
        let dataTable;
        let clientOptionsMap = {};

        // 1. 加载 Sdn Bhd 客户选项
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options', // 使用 Sdn Bhd 的 API
                type: 'GET',
                success: function (res) {
                    if (!(res && res.success && Array.isArray(res.data))) return;
                    clientOptionsMap = {};
                    const $sel = $('#clientSelect');
                    $sel.empty().append('<option value="">-- Select client --</option>');

                    res.data.forEach(o => {
                        // 兼容大小写差异 (Value/value, Text/text)
                        const id = o.value || o.Value || o.id; 
                        const text = o.text || o.Text || o.companyName; 
                        if (id) {
                            clientOptionsMap[id] = { id: id, text: text };
                            $sel.append(`<option value="${id}">${text}</option>`);
                        }
                    });
                },
                error: function (xhr) {
                    console.error('Failed to load client options', xhr);
                    showAlert('❌ Failed to load client list.', 'error');
                }
            });
        }

        $(document).ready(function() {
            console.log('A33A Page loaded, initializing...');

            loadClientOptions();

            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }

            // 2. 初始化 DataTable
            dataTable = $('#taskDatatable').DataTable({
                "responsive": false, // 关闭 responsive 以避免复杂表头错误
                "scrollX": true,     // 开启横向滚动
                "autoWidth": false,
                "pageLength": 10,
                "columns": [
                    { width: "10%" }, // 0. Case No
                    { width: "10%" }, // 1. Date received
                    { width: "10%" }, // 2. Type
                    { width: "15%" }, // 3. Client
                    { width: "8%" },  // 4. Year
                    { width: "15%" }, // 5. Details
                    { width: "10%" }, // 6. Date (Action)
                    { width: "15%" }, // 7. Brief Desc
                    { width: "8%" },  // 8. PIC
                    { width: "10%" }, // 9. Remark
                    { width: "10%" }, // 10. Done On
                    { width: "10%", orderable: false } // 11. Actions
                ],
                "language": {
                    "search": "Search:",
                    "lengthMenu": "Show _MENU_ entries",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "Showing 0 to 0 of 0 entries",
                    "emptyTable": "No records found",
                    "paginate": { "first": "First", "last": "Last", "next": "Next", "previous": "Previous" }
                }
            });
            dataTableInitialized = true;

            $('.datepicker').datepicker({ format: 'dd/mm/yyyy', autoclose: true, todayHighlight: true });

            // 3. Dropdown 联动逻辑
            $('#clientSelect').on('change', function () {
                const id = $(this).val();
                const selectedOption = clientOptionsMap[id];
                if (selectedOption) {
                    $('#client').val(selectedOption.text);
                    $('#clientId').val(selectedOption.id);
                } else {
                    $('#client').val('');
                    $('#clientId').val('');
                }
            });

            $('#saveBtn').click(function() { saveRecord(); });
            $(document).on('click', '.edit-btn', function() { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function() { deleteRecord($(this).data('id')); });
            $('#taskModal').on('hidden.bs.modal', function() { clearForm(); });

            loadRecordsFromDatabase();
        });

        // ---------------- Data Logic ----------------

        function loadRecordsFromDatabase() {
            showAlert('🔄 Loading A33A records...', 'info');
            // 假设您的后端 API 路径为 /documents/get-a33a-records
            $.ajax({
                url: '/documents/get-a33a-records', 
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateTable(response.data);
                        showAlert('✅ Loaded ' + response.data.length + ' records', 'success');
                    } else {
                        showAlert('❌ Error: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showAlert('❌ Failed to load records.', 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();

            if (records && records.length > 0) {
                records.forEach(function(record) {
                    // 确保添加 12 个数据项，与 columns 定义一致
                    dataTable.row.add([
                        record.caseNo || '',
                        formatDateForDisplay(record.dateReceived),
                        record.typeIncoming || '',
                        record.client || '',
                        record.yearAssessment || '',
                        record.details || '',
                        formatDateForDisplay(record.date),
                        record.briefDescritions || '',
                        record.pic || '',
                        record.remark || '',
                        formatDateForDisplay(record.doneOn),
                        '<div class="btn-group">' +
                        '<button class="btn btn-sm btn-warning edit-btn" data-id="' + record.id + '" title="Edit"><i class="fas fa-edit"></i></button> ' +
                        '<button class="btn btn-sm btn-danger delete-btn" data-id="' + record.id + '" title="Delete"><i class="fas fa-trash"></i></button>' +
                        '</div>'
                    ]);
                });
            }
            dataTable.draw();
        }

        function clearForm() {
            $('#editIndex').val('0'); // 重置 ID 为 0
            $('#taskForm')[0].reset();
            $('#modalTitle').text('Add New Correspondence Record');
            $('#clientSelect').val('');
            $('#client').val('');
            $('#clientId').val('');
        }

        function saveRecord() {
            // 从隐藏字段获取 client name
            var clientName = $('#client').val();
            var idVal = $('#editIndex').val();
            var id = (idVal && idVal !== '') ? parseInt(idVal) : 0;

            var formData = {
                Id: id,
                CaseNo: $('#itemNo').val() || '', 
                DateReceived: $('#irbDateReceived').val(),
                TypeIncoming: $('#typeOfIncoming').val(),
                Client: clientName, 
                YearAssessment: $('#yearOfAssessments').val(),
                Details: $('#details').val(),
                Date: $('#actionDate').val(),
                BriefDescritions: $('#briefDescriptions').val(),
                Pic: $('#pic').val(),
                Remark: $('#remark').val(),
                DoneOn: $('#doneOn').val()
            };

            console.log('A33A Form Data:', formData);

            if (!formData.DateReceived || !formData.Client) {
                showAlert('Please fill in required fields: Date Received and Client', 'error');
                return;
            }

            var isUpdate = id > 0;
            // 假设您的后端 Create/Update 路径为 /documents/create-a33a 和 /documents/update-a33a
            var url = isUpdate ? '/documents/update-a33a' : '/documents/create-a33a';
            var method = isUpdate ? 'PUT' : 'POST';

            var saveBtn = $('#saveBtn');
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (response.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully!', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        var errorMessage = response.errors ? response.errors.join(', ') : response.message;
                        showAlert('Error saving record: ' + errorMessage, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    saveBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    console.error('Save error details:', xhr.responseText);
                    showAlert('❌ Failed to save record.', 'error');
                }
            });
        }

        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            
            // 假设您的后端 Get Record 路径为 /documents/get-a33a-record/{id}
            $.ajax({
                url: '/documents/get-a33a-record/' + id,
                type: 'GET',
                success: function(response) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Correspondence Record');

                    if (response.success) {
                        var data = response.data;
                        $('#editIndex').val(data.id);
                        $('#itemNo').val(data.caseNo || '');
                        $('#irbDateReceived').val(formatDateForDisplay(data.dateReceived));
                        $('#typeOfIncoming').val(data.typeIncoming);
                        
                        // 反选 Dropdown
                        const existingClientName = (data.client || '').trim();
                        let matchedId = null;
                        for (const [key, o] of Object.entries(clientOptionsMap)) {
                            if (o.text === existingClientName) {
                                matchedId = key;
                                break;
                            }
                        }
                        $('#client').val(existingClientName);
                        $('#clientId').val(matchedId || '');
                        $('#clientSelect').val(matchedId || '');

                        $('#yearOfAssessments').val(data.yearAssessment);
                        $('#details').val(data.details);
                        $('#actionDate').val(formatDateForDisplay(data.date));
                        $('#briefDescriptions').val(data.briefDescritions);
                        $('#pic').val(data.pic);
                        $('#remark').val(data.remark);
                        $('#doneOn').val(formatDateForDisplay(data.doneOn));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Correspondence Record');
                    showAlert('Error loading record.', 'error');
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Delete this record?')) {
                // 假设您的后端 Delete 路径为 /documents/delete-a33a/{id}
                $.ajax({
                    url: '/documents/delete-a33a/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('Record deleted successfully!', 'success');
                            loadRecordsFromDatabase();
                        } else {
                            showAlert('Error deleting record: ' + response.message, 'error');
                        }
                    },
                    error: function(xhr) {
                        showAlert('Error deleting record.', 'error');
                    }
                });
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateString;
            var isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(dateString);
            if (isoMatch) return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
            return dateString;
        }

        function showAlert(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var html = `<div class="alert ${alertClass} alert-dismissible fade show">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            $('#connectionStatus').html(html);
            setTimeout(function() { $('#connectionStatus .alert').fadeOut(function() { $(this).remove(); }); }, 3000);
        }
    </script>
}