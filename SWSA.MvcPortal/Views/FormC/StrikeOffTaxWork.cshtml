@{
    ViewData["Title"] = "StrikeOffTaxWork";
}

<h1>Strike Off Tax Work</h1>

<div class="row">
    <div class="col-md-12">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- /.card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Strike Off Tax Work
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" id="addNewBtn">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Year End</th>
                            <th colspan="3">Sec Dept</th>
                            <th colspan="11">Tax Dept</th>
                            <th rowspan="3">Actions</th>
                        </tr>

                        <tr>
                            <th rowspan="2">SSM Submission Date</th>
                            <th rowspan="2">Date S/Off</th>
                            <th rowspan="2">Date received fr Sec Dept</th>
                            <th colspan="3">Penalties</th>
                            <th colspan="2"></th>
                            <th colspan="2">IRB Submission Date</th>
                            <th colspan="2">Billing</th>
                            <th rowspan="2">Clients copy sent</th>
                            <th rowspan="2">Job completed date</th>
                        </tr>

                        <tr>
                            <th>IRB Penalties</th>
                            <th>Appeal Date</th>
                            <th>Payment Date</th>
                            <th>notes/Remark</th>
                            <th>Acc wk done?</th>
                            <th>Form C submitted date</th>
                            <th>Form E submitted date</th>
                            <th>Invoice Date</th>
                            <th>Amount RM</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Strike Off Tax Work Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name (Suppose Link From Client List)</label>
                                <select id="companyName" name="companyName" class="form-control" required>
                                    <option value="">-- Select company --</option>
                                    <!-- 选项用 JS 动态加载 -->
                                </select>
                                <small class="text-muted">* Company list is linked from the Client List</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Enter year end (e.g., Dec 2023)" />
                            </div>
                        </div>
                    </div>

                    <!-- Sec Dept Information -->
                    <div class="form-info-label col-12">
                        <label>Sec Dept Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ssmSubmissionDate">SSM Submission Date</label>
                                <input type="text" id="ssmSubmissionDate" name="ssmSubmissionDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSOff">Date S/Off</label>
                                <input type="text" id="dateSOff" name="dateSOff" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateReceiveFrSecDept">Date received fr Sec Dept</label>
                                <input type="text" id="dateReceiveFrSecDept" name="dateReceiveFrSecDept" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Penalties Information -->
                    <div class="form-info-label col-12">
                        <label>Penalties Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="irbPenalties">IRB Penalties (RM)</label>
                                <input type="number" id="irbPenalties" name="irbPenalties" class="form-control" placeholder="Enter amount" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="appealDate">Appeal Date</label>
                                <input type="text" id="appealDate" name="appealDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="paymentDate">Payment Date</label>
                                <input type="text" id="paymentDate" name="paymentDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-info-label col-12">
                        <label>Additional Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="noteRemark">Notes/Remark</label>
                                <input type="text" id="noteRemark" name="noteRemark" class="form-control" placeholder="Enter notes" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="accWkDone">Acc wk done?</label>
                                <select id="accWkDone" name="accWkDone" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- IRB Submission Date -->
                    <div class="form-info-label col-12">
                        <label>IRB Submission Date</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="formCsubmitDate">Form C submitted date</label>
                                <input type="text" id="formCsubmitDate" name="formCsubmitDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="formEsubmitDate">Form E submitted date</label>
                                <input type="text" id="formEsubmitDate" name="formEsubmitDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Billing Information -->
                    <div class="form-info-label col-12">
                        <label>Billing Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date</label>
                                <input type="text" id="invoiceDate" name="invoiceDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="amountRM">Amount RM</label>
                                <input type="number" id="amountRM" name="amountRM" class="form-control" placeholder="Enter amount" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Information -->
                    <div class="form-info-label col-12">
                        <label>Completion Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientCopySent">Clients copy sent</label>
                                <input type="text" id="clientCopySent" name="clientCopySent" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="jobCompletedDate">Job completed date</label>
                                <input type="text" id="jobCompletedDate" name="jobCompletedDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="referral" name="referral" />
                    <input type="hidden" id="companyNoHidden" name="companyNoHidden" />
                    <input type="hidden" id="incorporationDate" name="incorporationDate" />

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- Include DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Include Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            let dataTable;
            let currentEditId = null;

            loadClientOptionsForTx4();


            // 初始化 DataTable
            initializeDataTable();

            // 初始化日期选择器
            initializeDatePickers();

            // 保存按钮点击事件
            $('#saveBtn').click(function() {
                saveTX4Record();
            });

            // 选公司时自动带出 Year End，格式：MM/yyyy
            $('#companyName').on('change', function () {
                const $selected = $(this).find('option:selected');
                const yearEndMonth = parseInt($selected.data('yearendmonth'), 10);   // 1~12

                if (yearEndMonth && yearEndMonth >= 1 && yearEndMonth <= 12) {
                    const now = new Date();
                    const year = now.getFullYear();  // 还是用今年

                    const mm = yearEndMonth.toString().padStart(2, '0');
                    const formatted = `${mm}/${year}`;
                    $('#yearEnd').val(formatted);
                } else {
                    $('#yearEnd').val('');
                }

                // ★ 顺便把 Referral / CompanyNo / IncorporationDate 写到隐藏栏位
                $('#referral').val($selected.data('referral') || '');
                $('#companyNoHidden').val($selected.data('companyno') || '');
                $('#incorporationDate').val($selected.data('incorpdate') || '');
            });


    

            // 初始化 DataTable
            function initializeDataTable() {
                dataTable = $('#taskDatatable').DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "responsive": true,
                    "ajax": {
                        "url": "/api/tx4/get-all",
                        "type": "GET",
                        "dataSrc": function(response) {
                            if (response.success) {
                                return response.data;
                            } else {
                                console.error('Error loading data:', response.message);
                                showAlert('Error loading data: ' + response.message, 'danger');
                                return [];
                            }
                        }
                    },
                    "columns": [
                        {
                            "data": null,
                            "render": function(data, type, row, meta) {
                                return meta.row + 1;
                            }
                        },
                        { "data": "companyName" },
                        { "data": "yearEnd" },
                        { "data": "ssMsubmissionDate" },
                        { "data": "dateSOff" },
                        { "data": "dateReceiveFrSecDept" },
                        {
                            "data": "irbPenalties",
                            "render": function(data, type, row) {
                                return data ? 'RM ' + parseFloat(data).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                            }
                        },
                        { "data": "appealDate" },
                        { "data": "paymentDate" },
                        { "data": "noteRemark" },
                        {
                            "data": "accWkDone",
                            "render": function(data, type, row) {
                                return data || 'No';
                            }
                        },
                        { "data": "formCsubmitDate" },
                        { "data": "formEsubmitDate" },
                        { "data": "invoiceDate" },
                        {
                            "data": "amountRM",
                            "render": function(data, type, row) {
                                return data ? 'RM ' + parseFloat(data).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                            }
                        },
                        { "data": "clientCopySent" },
                        { "data": "jobCompletedDate" },
                        {
                            "data": "id",
                            "render": function(data, type, row) {
                                return `
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-warning edit-btn" data-id="${data}" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                            },
                            "orderable": false
                        }
                    ],
                    "language": {
                        "emptyTable": "No records available",
                        "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                        "infoEmpty": "Showing 0 to 0 of 0 entries",
                        "infoFiltered": "(filtered from _MAX_ total entries)",
                        "lengthMenu": "Show _MENU_ entries",
                        "loadingRecords": "Loading...",
                        "processing": "Processing...",
                        "search": "Search:",
                        "zeroRecords": "No matching records found"
                    }
                });
            }

            // 初始化日期选择器
            function initializeDatePickers() {
                $('.datepicker').datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });
            }

            // 保存 TX4 记录
            function saveTX4Record() {
                // 基本验证
                if (!$('#companyName').val()) {
                    showAlert('Please enter company name', 'warning');
                    return;
                }

                const formData = {
                    companyName: $('#companyName').val(),
                    yearEnd: $('#yearEnd').val(),
                    ssmSubmissionDate: $('#ssmSubmissionDate').val(),
                    dateSOff: $('#dateSOff').val(),
                    dateReceiveFrSecDept: $('#dateReceiveFrSecDept').val(),
                    irbPenalties: $('#irbPenalties').val(),
                    appealDate: $('#appealDate').val(),
                    paymentDate: $('#paymentDate').val(),
                    noteRemark: $('#noteRemark').val(),
                    accWkDone: $('#accWkDone').val(),
                    formCsubmitDate: $('#formCsubmitDate').val(),
                    formEsubmitDate: $('#formEsubmitDate').val(),
                    invoiceDate: $('#invoiceDate').val(),
                    amountRM: $('#amountRM').val(),
                    clientCopySent: $('#clientCopySent').val(),
                    jobCompletedDate: $('#jobCompletedDate').val(),

                    referral: $('#referral').val(),
                    companyNo: $('#companyNoHidden').val(),
                    incorporationDate: $('#incorporationDate').val()
                };

                const url = currentEditId ? '/api/tx4/update' : '/api/tx4/create';
                const method = currentEditId ? 'PUT' : 'POST';

                if (currentEditId) {
                    formData.id = currentEditId;
                }

                // 显示加载状态
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            $('#taskModal').modal('hide');
                            dataTable.ajax.reload();
                            resetForm();
                            showAlert('Record saved successfully! Data has been synced to Strike Off Schedule.', 'success');
                        } else {
                            showAlert('Error saving record: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error saving record: ' + error, 'danger');
                    },
                    complete: function() {
                        // 恢复保存按钮状态
                        $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    }
                });
            }

            // 编辑记录
            $(document).on('click', '.edit-btn', function() {
                const id = $(this).data('id');
                editRecord(id);
            });

            // 删除记录
            $(document).on('click', '.delete-btn', function() {
                const id = $(this).data('id');
                deleteRecord(id);
            });

            // 编辑记录
            function editRecord(id) {
                $.get(`/api/tx4/get/${id}`, function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditId = record.id;

                        // 填充表单
                        // ★ 先尝试在下拉中选中对应公司
                        const $ddl = $('#companyName');
                        // 如果下拉没有该公司名（可能是旧数据），就动态加一个 option
                        if ($ddl.find('option[value="' + record.companyName + '"]').length === 0 && record.companyName) {
                            $ddl.append(
                                $('<option>')
                                    .val(record.companyName)
                                    .text(record.companyName)
                                    .attr('data-yearendmonth', '')
                            );
                        }
                        $ddl.val(record.companyName);

                        // YearEnd 直接用记录里的值
                        $('#yearEnd').val(record.yearEnd);
                        $('#ssmSubmissionDate').val(record.ssmSubmissionDate);
                        $('#dateSOff').val(record.dateSOff);
                        $('#dateReceiveFrSecDept').val(record.dateReceiveFrSecDept);
                        $('#irbPenalties').val(record.irbPenalties);
                        $('#appealDate').val(record.appealDate);
                        $('#paymentDate').val(record.paymentDate);
                        $('#noteRemark').val(record.noteRemark);
                        $('#accWkDone').val(record.accWkDone);
                        $('#formCsubmitDate').val(record.formCsubmitDate);
                        $('#formEsubmitDate').val(record.formEsubmitDate);
                        $('#invoiceDate').val(record.invoiceDate);
                        $('#amountRM').val(record.amountRM);
                        $('#clientCopySent').val(record.clientCopySent);
                        $('#jobCompletedDate').val(record.jobCompletedDate);

                        $('#modalTitle').text('Edit Strike Off Tax Work Record');
                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                });
            }

            // 删除记录
            function deleteRecord(id) {
                if (confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
                    $.ajax({
                        url: `/api/tx4/delete/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                dataTable.ajax.reload();
                                showAlert('Record deleted successfully!', 'success');
                            } else {
                                showAlert('Error deleting record: ' + response.message, 'danger');
                            }
                        },
                        error: function(xhr, status, error) {
                            showAlert('Error deleting record: ' + error, 'danger');
                        }
                    });
                }
            }

            // ★ 用共用的 /api/get/company-options，并挂上 yearEndMonth + 3 个 data
            function loadClientOptionsForTx4() {
                $.get('/api/get/company-options', function (response) {
                    if (!response || !response.success) {
                        showAlert('Error loading clients: ' + (response?.message || ''), 'danger');
                        return;
                    }

                    const $ddl = $('#companyName');
                    $ddl.empty();
                    $ddl.append('<option value="">-- Select company --</option>');

                    (response.data || []).forEach(function (item) {
                        const name = item.companyName || item.CompanyName || '';
                        const yearEndMthRaw = item.yearEndMonth || item.YearEndMonth || '';
                        const referral = item.referral || item.Referral || '';
                        const companyNo = item.companyNo || item.CompanyNo || '';
                        const incorpRaw = item.incorporationDate || item.IncorporationDate || '';

                        // ★ 把英文月份转成数字 1~12
                        let yearEndMth = '';
                        if (yearEndMthRaw) {
                            const monthMap = {
                                'january': 1,
                                'february': 2,
                                'march': 3,
                                'april': 4,
                                'may': 5,
                                'june': 6,
                                'july': 7,
                                'august': 8,
                                'september': 9,
                                'october': 10,
                                'november': 11,
                                'december': 12
                            };
                            const key = yearEndMthRaw.toString().trim().toLowerCase();
                            yearEndMth = monthMap[key] || '';
                        }

                        const incorpDisplay = typeof formatDateForDisplay === 'function'
                            ? formatDateForDisplay(incorpRaw)
                            : incorpRaw;

                        const $opt = $('<option>')
                            .val(name)
                            .text(name)
                            .attr('data-yearendmonth', yearEndMth || '')   // 这里现在是 1~12
                            .attr('data-referral', referral || '')
                            .attr('data-companyno', companyNo || '')
                            .attr('data-incorpdate', incorpDisplay || '');

                        $ddl.append($opt);
                    });
                }).fail(function (xhr, status, error) {
                    showAlert('Error loading clients: ' + error, 'danger');
                });
            }





            // 重置表单
            function resetForm() {
                $('#taskForm')[0].reset();
                currentEditId = null;
                $('#modalTitle').text('Add New Strike Off Tax Work Record');
                $('.datepicker').datepicker('update', '');
            }

            // 显示提示信息
            function showAlert(message, type) {
                const alertClass = `alert alert-${type} alert-dismissible fade show`;
                const alertHtml = `
                    <div class="${alertClass}" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('#alertContainer').html(alertHtml);

                // 自动隐藏
                setTimeout(() => {
                    $('.alert').alert('close');
                }, 5000);
            }

            // 模态框关闭时重置表单
            $('#taskModal').on('hidden.bs.modal', function() {
                resetForm();
            });

            // 刷新数据按钮
            $('#refreshBtn').click(function() {
                dataTable.ajax.reload();
                showAlert('Data refreshed successfully!', 'info');
            });
        });
    </script>
}