@{
    ViewData["Title"] = "AT34AADSP";
}

<h1>AT3.4 Active Audit Directors Signing Pages</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Directors Signing Pages Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" id="addNewBtn">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <div id="loadingMessage" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
                <div id="tableContainer" style="display: none;">
                    <table id="taskDatatable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th colspan="6"></th>
                                <th colspan="5">Directors' signing pages</th>
                                <th colspan="1">Actions</th>
                            </tr>
                            <tr>
                                <th rowspan="2">No</th>
                                <th rowspan="2">Company Name</th>
                                <th rowspan="2">YE to do</th>
                                <th rowspan="2">PIC</th>
                                <th colspan="2">Activity</th>
                                <th rowspan="2">Date Sent</th>
                                <th rowspan="2">Follow up dates</th>
                                <th rowspan="2">First 18 mths date</th>
                                <th rowspan="2">Date received</th>
                                <th rowspan="2">Comm of Oaths Date</th>
                                <th rowspan="2">Actions</th>
                            </tr>
                            <tr>
                                <th>Active</th>
                                <th>AEX</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Directors Signing Pages Record</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Basic Information</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientSelect">Client <span class="text-danger">*</span></label>
                            <select id="clientSelect" name="clientSelect" class="form-control" required>
                                <option value="">-- Select client --</option>
                            </select>
                            <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                            <input type="hidden" id="client" name="client" />
                            <input type="hidden" id="clientId" name="clientId" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="yeToDo" class="form-label">YE to do</label>
                            <input type="text" id="yeToDo" class="form-control" placeholder="Enter year" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pic" class="form-label">PIC</label>
                            <input type="text" id="pic" class="form-control" placeholder="Enter PIC name" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="active" class="form-label">Active</label>
                            <select id="active" class="form-control">
                                <option value="">Select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="aex" class="form-label">AEX</label>
                            <select id="aex" class="form-control">
                                <option value="">Select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- Directors' Signing Pages -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Directors' Signing Pages</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateSent" class="form-label">Date Sent</label>
                            <input type="date" id="dateSent" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="followUpDates" class="form-label">Follow up dates</label>
                            <input type="text" id="followUpDates" class="form-control" placeholder="e.g., 03/02/2025, 10/02/2025" />
                            <small class="form-text text-muted">Enter multiple dates separated by commas</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="first18MonthsDate" class="form-label">First 18 mths date</label>
                            <input type="date" id="first18MonthsDate" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="dateReceived" class="form-label">Date received</label>
                            <input type="date" id="dateReceived" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="commOfOathsDate" class="form-label">Comm of Oaths Date</label>
                            <input type="date" id="commOfOathsDate" class="form-control" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isEditMode = false;
        let allRecords = [];

        $(document).ready(function() {
            console.log('Document ready, starting initialization...');

            // 1. Load Client Dropdown Options immediately
            loadClientOptions();

            // Load table data
            loadTableData();

            // Add new button click
            $('#addNewBtn').on('click', function() {
                openModal(false);
            });

            // Save button click
            $('#saveBtn').on('click', function() {
                saveRecord();
            });

            // Reset form when modal is hidden
            $('#taskModal').on('hidden.bs.modal', function() {
                resetForm();
            });

            // 2. Client Dropdown Change Listener (Update Hidden Fields)
            $('#clientSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var clientName = selectedOption.text();
                var clientId = $(this).val();

                if(clientId) {
                    $('#client').val(clientName); // Update hidden name
                    $('#clientId').val(clientId); // Update hidden ID
                } else {
                    $('#client').val('');
                    $('#clientId').val('');
                }
            });
        });

        // --- NEW FUNCTION: Load Client Options ---
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var options = '<option value="">-- Select client --</option>';
                        $.each(response.data, function(index, item) {
                            // 假设后端返回的对象包含 id 和 companyName (或者 name)
                            // 请根据实际 API 返回的字段名调整 item.id / item.companyName
                            var val = item.id || item.Id;
                            var text = item.companyName || item.name || item.Name;
                            options += `<option value="${val}">${text}</option>`;
                        });
                        $('#clientSelect').html(options);
                    } else {
                        console.error('Failed to load company options');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading company options:', error);
                }
            });
        }

        function loadTableData() {
            console.log('Starting to load table data...');
            $('#loadingMessage').show();
            $('#tableContainer').hide();

            $.ajax({
                url: '/api/auditdept/at34/get-all',
                type: 'GET',
                success: function(response) {
                    $('#loadingMessage').hide();
                    if (response.success) {
                        allRecords = response.data || [];
                        populateTable(allRecords);
                        $('#tableContainer').show();
                    } else {
                        showAlert('Error loading data: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingMessage').hide();
                    showAlert('Error loading data: ' + error, 'danger');
                }
            });
        }

        function populateTable(data) {
            const tbody = $('#tableBody');
            tbody.empty();

            if (data && data.length > 0) {
                data.forEach((record, index) => {
                    const dateSentDisplay = formatDateToDDMMYYYY(record.dateSent);
                    const first18mthDateDisplay = formatDateToDDMMYYYY(record.first18mthDate);
                    const dateReceivedDisplay = formatDateToDDMMYYYY(record.dateReceived);
                    const commofOathsDateDisplay = formatDateToDDMMYYYY(record.commofOathsDate);

                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(record.companyName || '')}</td>
                            <td>${escapeHtml(record.yEtodo || '')}</td>
                            <td>${escapeHtml(record.pic || '')}</td>
                            <td>${escapeHtml(record.active || '')}</td>
                            <td>${escapeHtml(record.aex || '')}</td>
                            <td>${dateSentDisplay}</td>
                            <td>${escapeHtml(record.flwUpDates || '')}</td>
                            <td>${first18mthDateDisplay}</td>
                            <td>${dateReceivedDisplay}</td>
                            <td>${commofOathsDateDisplay}</td>
                            <td style="white-space: nowrap;">
                                <button class="btn btn-sm btn-info" onclick="editRecord(${record.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${record.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="12" class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>No records found. Click "New Record" to add data.</td></tr>');
            }
        }

        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';
            try {
                if (typeof dateString === 'string' && dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateString.replace(/\//g, '-');
                if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = dateString.split('-');
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                if (dateString.includes('T')) {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return '';
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}-${month}-${year}`;
                }
                return dateString;
            } catch (e) {
                return dateString || '';
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) return dateString;
                if (typeof dateString === 'string' && (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/) || dateString.match(/^\d{2}-\d{2}-\d{4}$/))) {
                    const separator = dateString.includes('/') ? '/' : '-';
                    const parts = dateString.split(separator);
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return dateString;
            } catch (e) {
                return '';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        function openModal(editMode, recordId = null) {
            isEditMode = editMode;
            $('#modalTitle').text(editMode ? 'Edit Directors Signing Pages Record' : 'Add New Directors Signing Pages Record');

            if (editMode && recordId) {
                loadRecordForEdit(recordId);
            } else {
                resetForm();
            }

            $('#taskModal').modal('show');
        }

        function loadRecordForEdit(id) {
            $.ajax({
                url: `/api/auditdept/at34/get/${id}`,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        console.log('Loading record for edit:', record);

                        $('#recordId').val(record.id);

                        // --- CHANGED: Set Dropdown Logic ---
                        // 1. 尝试直接通过 Company Name 匹配 Dropdown Text
                        // 2. 如果你的 Record 里有 clientId，也可以用 clientId 匹配：$('#clientSelect').val(record.clientId);

                        if (record.companyName) {
                            // 遍历 dropdown 选项，找到文本(Text)和 companyName 一样的选项并选中
                            $("#clientSelect option").filter(function() {
                                return $(this).text().trim() === record.companyName.trim();
                            }).prop('selected', true);

                            // 触发 change 事件以更新 hidden fields
                            $('#clientSelect').trigger('change');
                        }

                        // 如果没有匹配到（比如新加的公司不在列表里），你可能需要手动处理或者保持默认
                        // ------------------------------------

                        $('#yeToDo').val(record.yEtodo || '');
                        $('#pic').val(record.pic || '');
                        $('#active').val(record.active || '');
                        $('#aex').val(record.aex || '');
                        $('#dateSent').val(formatDateForInput(record.dateSent));
                        $('#followUpDates').val(record.flwUpDates || '');
                        $('#first18MonthsDate').val(formatDateForInput(record.first18mthDate));
                        $('#dateReceived').val(formatDateForInput(record.dateReceived));
                        $('#commOfOathsDate').val(formatDateForInput(record.commofOathsDate));

                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading record: ' + error, 'danger');
                }
            });
        }

        function saveRecord() {
            // --- CHANGED: Validation Logic ---
            // 检查下拉框是否有选值
            if (!$('#clientSelect').val()) {
                showAlert('Please select a Client', 'warning');
                return;
            }

            // --- CHANGED: Get Company Name from Dropdown ---
            // 因为 input#companyName 已经不在了，我们需要从 dropdown 获取 Text
            const selectedCompanyName = $('#clientSelect option:selected').text();

            const formData = {
                companyName: selectedCompanyName, // 使用选中的公司名
                yEtodo: $('#yeToDo').val() || null,
                pic: $('#pic').val() || null,
                active: $('#active').val() || null,
                aex: $('#aex').val() || null,
                dateSent: $('#dateSent').val() || null,
                flwUpDates: $('#followUpDates').val() || null,
                first18mthDate: $('#first18MonthsDate').val() || null,
                dateReceived: $('#dateReceived').val() || null,
                commofOathsDate: $('#commOfOathsDate').val() || null
            };

            if (isEditMode) {
                formData.id = parseInt($('#recordId').val());
            }

            console.log('Saving record:', formData);

            const url = isEditMode ? '/api/auditdept/at34/update' : '/api/auditdept/at34/create';
            const method = isEditMode ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        $('#taskModal').modal('hide');
                        loadTableData();
                    } else {
                        showAlert('Error: ' + (response.message || 'Unknown error'), 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error saving record: ' + error, 'danger');
                }
            });
        }

        function editRecord(id) {
            openModal(true, id);
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: `/api/auditdept/at34/delete/${id}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert(response.message, 'success');
                            loadTableData();
                        } else {
                            showAlert('Error: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error deleting record: ' + error, 'danger');
                    }
                });
            }
        }

        function resetForm() {
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#clientSelect').val(''); // Reset dropdown
            $('#client').val('');
            $('#clientId').val('');
            isEditMode = false;
        }

        function showAlert(message, type) {
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <strong>${type === 'success' ? 'Success!' : type === 'danger' ? 'Error!' : 'Warning!'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            $('.card-body').prepend(alertHtml);
            setTimeout(function() {
                $('#' + alertId).fadeOut('slow', function() { $(this).remove(); });
            }, 5000);
        }
    </script>
}