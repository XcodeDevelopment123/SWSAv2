@{
    ViewData["Title"] = "TaxWorkLogbook";
}

<h1>Tax Work Logbook</h1>

<div class="row">
    <div class="col-md-12">
        <div id="alertContainer"></div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Tax Work Logbook
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" id="addNewBtn">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="2">No</th>
                            <th rowspan="2">Company Name</th>
                            <th colspan="2">Activity</th>
                            <th colspan="2">PIC</th>
                            <th rowspan="2">Year Ended</th>
                            <th rowspan="2">Tax Due Dates</th>
                            <th colspan="4">Tax WIP</th>
                            <th colspan="4">Tax Work Process</th>
                            <th colspan="2">Review by MC</th>
                            <th colspan="2">Draft to Client</th>
                            <th rowspan="2">Tax Payment Date</th>
                            <th rowspan="2">Form C Submitted Date</th>
                            <th colspan="2">Billing</th>
                            <th colspan="2">Binding</th>
                            <th rowspan="2">Actions</th>
                        </tr>

                        <tr>
                            <th>Active</th>
                            <th>AEX/OT</th>
                            <th>RAKC</th>
                            <th>BTM</th>
                            <th>a. Start Date</th>
                            <th>b. End Date</th>
                            <th>c. No of days</th>
                            <th>d. Completed</th>
                            <th>P & L Analyis</th>
                            <th>CA & Tax Compu</th>
                            <th>Draft Form C</th>
                            <th>Tax Payable</th>
                            <th>Tax comp/CA</th>
                            <th>Form C</th>
                            <th>Sent</th>
                            <th>Received</th>
                            <th>Inv Date</th>
                            <th>Fees</th>
                            <th>Printing</th>
                            <th>Despatch</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Tax Work Logbook Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="companyName" name="companyName" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="active">Active</label>
                                <select id="active" name="active" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="aexOt">AEX/OT</label>
                                <select id="aexOt" name="aexOt" class="form-control">
                                    <option value="">Select</option>
                                    <option value="AEX">AEX</option>
                                    <option value="OT">OT</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearEnd">Year Ended</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control datepicker" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>PIC Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rakc">RAKC</label>
                                <input type="text" id="rakc" name="rakc" class="form-control" placeholder="Enter RAKC name" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="btm">BTM</label>
                                <input type="text" id="btm" name="btm" class="form-control" placeholder="Enter BTM name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxDueDate">Tax Due Date</label>
                                <input type="text" id="taxDueDate" name="taxDueDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Tax WIP</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="startDate">a. Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="endDate">b. End Date</label>
                                <input type="text" id="endDate" name="endDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="noOfDays">c. No of days</label>
                                <input type="number" id="noOfDays" name="noOfDays" class="form-control" placeholder="Enter days" min="0" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="completed">d. Completed</label>
                                <select id="completed" name="completed" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Tax Work Process</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pnLAnalysis">P & L Analysis</label>
                                <input type="text" id="pnLAnalysis" name="pnLAnalysis" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="caTaxCompu">CA & Tax Compu</label>
                                <input type="text" id="caTaxCompu" name="caTaxCompu" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="draftForm">Draft Form C</label>
                                <input type="text" id="draftForm" name="draftForm" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxPayable">Tax Payable (RM)</label>
                                <input type="number" id="taxPayable" name="taxPayable" class="form-control" placeholder="Enter amount" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Review by MC</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxCompCA">Tax comp/CA</label>
                                <input type="text" id="taxCompCA" name="taxCompCA" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="formC">Form C</label>
                                <input type="text" id="formC" name="formC" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Draft to Client</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sent">Sent</label>
                                <input type="text" id="sent" name="sent" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="received">Received</label>
                                <input type="text" id="received" name="received" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Tax Submission</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxPaymentDate">Tax Payment Date</label>
                                <input type="text" id="taxPaymentDate" name="taxPaymentDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="formCSubmited">Form C Submitted Date</label>
                                <input type="text" id="formCSubmited" name="formCSubmited" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Billing</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="invDate">Inv Date</label>
                                <input type="text" id="invDate" name="invDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fees">Fees (RM)</label>
                                <input type="number" id="fees" name="fees" class="form-control" placeholder="Enter fees" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Binding</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="printing">Printing</label>
                                <input type="text" id="printing" name="printing" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="despatch">Despatch</label>
                                <input type="text" id="despatch" name="despatch" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            let dataTable;
            let currentEditId = null;

            // Load Companies for Dropdown first
            loadCompanyOptions();

            // Initialize DataTable
            initializeDataTable();

            // Initialize Datepickers
            initializeDatePickers();

            // Save Button Logic
            $('#saveBtn').click(function() {
                saveTX3Record();
            });

            // ---------- 1. DROPDOWN & DATE LOGIC (From Sample) ----------

            // Load company options from API
            function loadCompanyOptions() {
                $.ajax({
                    url: "/api/get/company-options", // 使用 Sample 中的 API 路径
                    type: "GET",
                    success: function (res) {
                        const $sel = $("#clientSelect");
                        $sel.empty().append('<option value="">-- Select client --</option>');

                        if (!(res && res.success && res.data)) return;

                        res.data.forEach(o => {
                            const name = o.companyName || o.name || "-";
                            // Store yearEndMonth in data attribute for auto-fill
                            const yeMonth = o.yearEndMonth || "";

                            $sel.append(`
                                <option value="${name}"
                                        data-yearendmonth="${yeMonth}">
                                    ${name}
                                </option>
                            `);
                        });
                    }
                });
            }

            // Monitor Dropdown Change to Auto-Fill Year End
            $('#clientSelect').on('change', function () {
                const $opt = $(this).find('option:selected');
                const companyName = $(this).val();

                // 1. Fill Hidden Company Name Input (for Saving)
                $('#companyName').val(companyName);

                // 2. Auto Fill Year End Date
                const yeMonth = $opt.data('yearendmonth') || '';   // e.g. "December"
                const yeDate = yearEndMonthToDateString(yeMonth); // Convert to dd/MM/yyyy

                // Only update Year End if it's empty or we are creating new
                // Remove if() check if you want it to always overwrite
                $('#yearEnd').val(yeDate).trigger('change');
            });

            // Helper: Convert Month Name to Date String
            function yearEndMonthToDateString(monthName) {
                if (!monthName) return '';

                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                const idx = months.indexOf(monthName);
                if (idx === -1) return monthName; // Unknown format

                const today = new Date();
                let year = today.getFullYear();

                // If this month has passed this year, assume next year (optional logic from sample)
                if (idx < today.getMonth()) {
                    year += 1;
                }

                // Last day of the month
                const dt = new Date(year, idx + 1, 0);
                return formatDdMMyyyy(dt);
            }

            // Helper: Format Date object to dd/MM/yyyy
            function formatDdMMyyyy(dt) {
                const dd = String(dt.getDate()).padStart(2, '0');
                const mm = String(dt.getMonth() + 1).padStart(2, '0');
                const yyyy = dt.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }


            // ---------- 2. DATATABLE LOGIC ----------

            function initializeDataTable() {
                dataTable = $('#taskDatatable').DataTable({
                    "paging": true,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "responsive": true,
                    "ajax": {
                        "url": "/api/tx3/get-all",
                        "type": "GET",
                        "dataSrc": function(response) {
                            if (response.success) {
                                return response.data;
                            } else {
                                showAlert('Error loading data: ' + response.message, 'danger');
                                return [];
                            }
                        }
                    },
                    "columns": [
                        {
                            "data": null,
                            "render": function(data, type, row, meta) { return meta.row + 1; }
                        },
                        { "data": "companyName" },
                        {
                            "data": "active",
                            "render": function(data) { return data || 'No'; }
                        },
                        {
                            "data": null,
                            "render": function(data, type, row) {
                                return row.aexOT || row.AEXOT || row.aexot || '-';
                            }
                        },
                        { "data": "rakc", "render": function(data) { return data || '-'; } },
                        { "data": "btm", "render": function(data) { return data || '-'; } },
                        { "data": "yearEnd", "render": function(data) { return data || '-'; } },
                        { "data": "taxDueDate", "render": function(data) { return data || '-'; } },
                        // ... (Other Tax WIP columns same as before) ...
                        { "data": "startDate", "render": function(data) { return data || '-'; } },
                        { "data": "endDate", "render": function(data) { return data || '-'; } },
                        { "data": "noOfDays", "render": function(data) { return data || '-'; } },
                        { "data": "completed", "render": function(data) { return data || 'No'; } },
                        { "data": "pnLAnalysis", "render": function(data) { return data || '-'; } },
                        { "data": "caTaxCompu", "render": function(data) { return data || '-'; } },
                        { "data": "draftForm", "render": function(data) { return data || '-'; } },
                        {
                            "data": "taxPayable",
                            "render": function(data) {
                                return data ? 'RM ' + parseFloat(data).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                            }
                        },
                        { "data": "taxCompCA", "render": function(data) { return data || '-'; } },
                        { "data": "formC", "render": function(data) { return data || '-'; } },
                        { "data": "sent", "render": function(data) { return data || '-'; } },
                        { "data": "received", "render": function(data) { return data || '-'; } },
                        { "data": "taxPaymentDate", "render": function(data) { return data || '-'; } },
                        { "data": "formCSubmited", "render": function(data) { return data || '-'; } },
                        { "data": "invDate", "render": function(data) { return data || '-'; } },
                        {
                            "data": "fees",
                            "render": function(data) {
                                return data ? 'RM ' + parseFloat(data).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                            }
                        },
                        { "data": "printing", "render": function(data) { return data || '-'; } },
                        { "data": "despatch", "render": function(data) { return data || '-'; } },
                        {
                            "data": "id",
                            "render": function(data) {
                                return `
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-warning edit-btn" data-id="${data}" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                            },
                            "orderable": false
                        }
                    ],
                    "language": {
                        "emptyTable": "No records available"
                    }
                });
            }

            function initializeDatePickers() {
                $('.datepicker').datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });
            }

            // ---------- 3. SAVE / EDIT / DELETE LOGIC ----------

            function saveTX3Record() {
                // Read from hidden field (populated by dropdown) OR direct from dropdown
                const coName = $('#companyName').val() || $('#clientSelect').val();

                if (!coName) {
                    showAlert('Please select a client', 'warning');
                    return;
                }

                const formData = {
                    companyName: coName, // Changed to use the logic above
                    active: $('#active').val(),
                    aexOT: $('#aexOt').val(),
                    rakc: $('#rakc').val(),
                    btm: $('#btm').val(),
                    yearEnd: $('#yearEnd').val(),
                    taxDueDate: $('#taxDueDate').val(),
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    noOfDays: $('#noOfDays').val(),
                    completed: $('#completed').val(),
                    pnLAnalysis: $('#pnLAnalysis').val(),
                    caTaxCompu: $('#caTaxCompu').val(),
                    draftForm: $('#draftForm').val(),
                    taxPayable: $('#taxPayable').val(),
                    taxCompCA: $('#taxCompCA').val(),
                    formC: $('#formC').val(),
                    sent: $('#sent').val(),
                    received: $('#received').val(),
                    taxPaymentDate: $('#taxPaymentDate').val(),
                    formCSubmited: $('#formCSubmited').val(),
                    invDate: $('#invDate').val(),
                    fees: $('#fees').val(),
                    printing: $('#printing').val(),
                    despatch: $('#despatch').val()
                };

                const url = currentEditId ? '/api/tx3/update' : '/api/tx3/create';
                const method = currentEditId ? 'PUT' : 'POST';

                if (currentEditId) {
                    formData.id = currentEditId;
                }

                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            $('#taskModal').modal('hide');
                            dataTable.ajax.reload();
                            resetForm();
                            showAlert('Record saved successfully!', 'success');
                        } else {
                            showAlert('Error saving record: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error saving record: ' + error, 'danger');
                    },
                    complete: function() {
                        $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    }
                });
            }

            $(document).on('click', '.edit-btn', function() {
                const id = $(this).data('id');
                editRecord(id);
            });

            $(document).on('click', '.delete-btn', function() {
                const id = $(this).data('id');
                deleteRecord(id);
            });

            function editRecord(id) {
                $.get(`/api/tx3/get/${id}`, function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditId = record.id;

                        // 1. Set Company Dropdown value
                        $('#clientSelect').val(record.companyName);
                        // 2. Set Hidden input
                        $('#companyName').val(record.companyName);

                        $('#active').val(record.active);
                        $('#aexOt').val(record.aexOT || record.AEXOT);
                        $('#rakc').val(record.rakc);
                        $('#btm').val(record.btm);
                        $('#yearEnd').val(record.yearEnd);
                        $('#taxDueDate').val(record.taxDueDate);
                        $('#startDate').val(record.startDate);
                        $('#endDate').val(record.endDate);
                        $('#noOfDays').val(record.noOfDays);
                        $('#completed').val(record.completed);
                        $('#pnLAnalysis').val(record.pnLAnalysis);
                        $('#caTaxCompu').val(record.caTaxCompu);
                        $('#draftForm').val(record.draftForm);
                        $('#taxPayable').val(record.taxPayable);
                        $('#taxCompCA').val(record.taxCompCA);
                        $('#formC').val(record.formC);
                        $('#sent').val(record.sent);
                        $('#received').val(record.received);
                        $('#taxPaymentDate').val(record.taxPaymentDate);
                        $('#formCSubmited').val(record.formCSubmited);
                        $('#invDate').val(record.invDate);
                        $('#fees').val(record.fees);
                        $('#printing').val(record.printing);
                        $('#despatch').val(record.despatch);

                        $('#modalTitle').text('Edit Tax Work Logbook Record');
                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                });
            }

            function deleteRecord(id) {
                if (confirm('Are you sure you want to delete this record?')) {
                    $.ajax({
                        url: `/api/tx3/delete/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                dataTable.ajax.reload();
                                showAlert('Record deleted successfully!', 'success');
                            } else {
                                showAlert('Error deleting record: ' + response.message, 'danger');
                            }
                        }
                    });
                }
            }

            function resetForm() {
                $('#taskForm')[0].reset();
                currentEditId = null;
                $('#clientSelect').val(''); // Reset dropdown
                $('#modalTitle').text('Add New Tax Work Logbook Record');
                $('.datepicker').datepicker('update', '');
            }

            function showAlert(message, type) {
                const alertClass = `alert alert-${type} alert-dismissible fade show`;
                const alertHtml = `
                    <div class="${alertClass}" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('#alertContainer').html(alertHtml);
                setTimeout(() => { $('.alert').alert('close'); }, 5000);
            }

            $('#taskModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        });
    </script>
}