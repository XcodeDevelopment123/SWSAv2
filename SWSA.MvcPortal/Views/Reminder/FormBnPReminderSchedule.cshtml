@model List<SWSA.MvcPortal.Models.Reminder.B34>
@{
    ViewData["Title"] = "FormBnPReminderSchedule";
}

<h1>Form B&P Reminder Schedule</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th rowspan="3">Grouping</th>
                            <th rowspan="3">Company Name</th>

                            <th colspan="6">Planing & Allocation</th>

                            <th colspan="6"></th>

                            <th colspan="2">Inward Doc</th>

                            <th colspan="2">Actions</th>

                        </tr>

                        <tr>
                            <th colspan="4">Acc Wk Type</th>

                            <th rowspan="2">PIC</th>

                            <th colspan="1"></th>

                            <th colspan="2">Mth 1 Email</th>
                            <th colspan="2">Mth 2 Reminder PIC</th>
                            <th colspan="2">Mth 3 Text PIC</th>

                            <th rowspan="2">Date Received</th>
                            <th rowspan="2">Note</th>
                            <th rowspan="2">Edit</th>
                            <th rowspan="2">Delete</th>
                        </tr>

                        <tr>
                            <th>Single entry</th>
                            <th>Full set</th>
                            <th>Review</th>
                            <th>Tax Only</th>

                            <th>Targeted to start Acc wk</th>

                            <th>Targeted Date</th>
                            <th>Date sent</th>
                            <th>Targeted call/text</th>
                            <th>Date Remind</th>
                            <th>Targeted Final Text</th>
                            <th>Date text</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var record in Model)
                            {
                                <tr data-id="@record.Id">
                                    <td>@record.Grouping</td>
                                    <td>@record.CompanyName</td>

                                    <td>@record.SingleEntry</td>
                                    <td>@record.FullSet</td>
                                    <td>@record.Reveiw</td>
                                    <td>@record.TaxOnly</td>

                                    <td>@record.PIC</td>

                                    <td>@record.T_startAccWk</td>

                                    <td>@record.T_Date</td>
                                    <td>@record.DateSent</td>

                                    <td>@record.T_Call</td>
                                    <td>@record.DateRemind</td>

                                    <td>@record.T_FinalText</td>
                                    <td>@record.DateText</td>

                                    <td>@record.DateReceived</td>
                                    <td>@record.Note</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning edit-btn" data-id="@record.Id" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="@record.Id" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Form B&P Reminder</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Enter grouping" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                    </div>

                    <!-- Planning & Allocation -->
                    <div class="form-info-label col-12">
                        <label>Planning & Allocation</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="singleEntry">Single entry</label>
                                <select id="singleEntry" name="singleEntry" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="fullSet">Full set</label>
                                <select id="fullSet" name="fullSet" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="review">Review</label>
                                <select id="review" name="review" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="taxOnly">Tax Only</label>
                                <select id="taxOnly" name="taxOnly" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <select id="pic" name="pic" class="form-control">
                                    <option value="">-- Select from AT21 / AEX41 --</option>
                                </select>
                                <small class="text-muted">
                                    Pulled from AT21 (AuditStaff) / AEX41 (Team)
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="targetedStartAcc">Targeted to start Acc wk</label>
                                <input type="text" id="targetedStartAcc" name="targetedStartAcc" class="form-control" placeholder="Fixed: March" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Month 1 Email -->
                    <div class="form-info-label col-12">
                        <label>Month 1 Email</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth1TargetedDate">Targeted Date</label>
                                <input type="text" id="mth1TargetedDate" name="mth1TargetedDate" class="form-control" placeholder="Fixed: Jan" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth1DateSent">Date sent</label>
                                <input type="text" id="mth1DateSent" name="mth1DateSent" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Month 2 Reminder PIC -->
                    <div class="form-info-label col-12">
                        <label>Month 2 Reminder PIC</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth2TargetedCall">Targeted call/text</label>
                                <input type="text" id="mth2TargetedCall" name="mth2TargetedCall" class="form-control" placeholder="Fixed: Feb" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth2DateRemind">Date Remind</label>
                                <input type="text" id="mth2DateRemind" name="mth2DateRemind" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Month 3 Text PIC -->
                    <div class="form-info-label col-12">
                        <label>Month 1 Text PIC</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth3TargetedFinal">Targeted Final Text</label>
                                <input type="text" id="mth3TargetedFinal" name="mth3TargetedFinal" class="form-control" placeholder="Fixed: March" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="mth3DateText">Date text</label>
                                <input type="text" id="mth3DateText" name="mth3DateText" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Inward Document -->
                    <div class="form-info-label col-12">
                        <label>Inward Document</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="inwardDateReceived">Date Received</label>
                                <select id="inwardDateReceived" name="inwardDateReceived" class="form-control">
                                    <option value="">-- Select from A31B (DateReceived) --</option>
                                </select>
                                <small class="text-muted">
                                    Pulled from A31B · DateReceived
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="inwardNote">Note</label>
                                <input type="text" id="inwardNote" name="inwardNote" class="form-control" placeholder="Enter note" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;

        // ========= 1) PIC 来源：AT21 / AEX41 =========
        function loadPicSourceListB34() {
            $.ajax({
                url: "/get-b34-pic-sources",
                type: "GET",
                success: function (res) {
                    const $sel = $("#pic");
                    $sel.empty().append(
                        '<option value="">-- Select from AT21 / AEX41 --</option>'
                    );

                    if (!(res && res.success && res.data)) return;

                    res.data.forEach(o => {
                        const company = o.companyName || "-";
                        const ye = formatDateForDisplay(o.yearEnd);
                        const pic = o.pic || "-";

                        // value = PIC 名字 → 存到 B34.PIC
                        $sel.append(`
                            <option value="${pic}">
                                ${o.sourceType} - ${company} - YE ${ye} - PIC ${pic}
                            </option>
                        `);
                    });
                }
            });
        }

        // ========= 2) Inward Date Received 来源：A31B.DateReceived =========
        function loadInwardSourceListB34() {
            $.ajax({
                url: "/get-b34-inward-sources",
                type: "GET",
                success: function (res) {
                    const $sel = $("#inwardDateReceived");
                    $sel.empty().append(
                        '<option value="">-- Select from A31B (DateReceived) --</option>'
                    );

                    if (!(res && res.success && res.data)) return;

                    res.data.forEach(o => {
                        const company = o.companyName || "-";
                        const ye = formatDateForDisplay(o.yearEnd);
                        const dr = formatDateForDisplay(o.dateReceived);

                        // value = 日期字串 → 存到 B34.DateReceived
                        $sel.append(`
                            <option value="${dr}">
                                ${o.sourceType} - ${company} - YE ${ye} - Date ${dr}
                            </option>
                        `);
                    });
                }
            });
        }

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            // scroll modal body to top so the alert is visible
            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () { $box.attr('tabindex', -1).focus(); });
        }
        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }
        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }
        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert (outside modal) ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
            return s;
        }


        // ------------ 固定 4 个 Targeted 月份（核心逻辑） -------------
        function setFixedTargetMonths() {
            // 这 4 个位置是固定月份，不跟公司 / year end 变化
            $('#targetedStartAcc').val('March'); // Targeted to start Acc wk
            $('#mth1TargetedDate').val('Jan');   // Mth 1 Email Targeted Date
            $('#mth2TargetedCall').val('Feb');   // Mth 2 Reminder Targeted call/text
            $('#mth3TargetedFinal').val('March'); // Mth 3 Text Targeted Final Text
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New Account Document Reminder');
            hideModalAlert();
            clearFieldErrors();

            setFixedTargetMonths();
        }

        // ---------- Init ----------
        $(document).ready(function () {
            setFixedTargetMonths();

            // ★ 载入 PIC & DateReceived 下拉
            loadPicSourceListB34();
            loadInwardSourceListB34();

            // 只有真正需要选 date 的字段用 datepicker（Targeted 月份已经固定，不用 picker）
            ['#mth1DateSent', '#mth2DateRemind', '#mth1DateText']
                .forEach(function (id) {
                    $(id).datepicker({
                        format: 'dd/mm/yyyy',
                        autoclose: true,
                        todayHighlight: true
                    });
                });


            // Datepickers (exclude read-only #circulationAfsDue)
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return (id.includes('Date') || id.includes('date') || id.includes('yearEnd')) && id !== 'circulationAfsDue';
            }).datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });


            // DataTable 映射 B34 的列
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                ordering: true,
                autoWidth: false,
                pageLength: 10,
                order: [[1, 'asc']], // 公司名排序
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No records found",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columns: [
                    { data: 0 },  // Grouping / No
                    { data: 1 },  // Company Name
                    { data: 2 },  // SingleEntry
                    { data: 3 },  // FullSet
                    { data: 4 },  // Review
                    { data: 5 },  // TaxOnly
                    { data: 6 },  // PIC
                    { data: 7 },  // T_startAccWk
                    { data: 8 },  // T_Date (Mth1 Targeted)
                    { data: 9 },  // DateSent
                    { data: 10 }, // T_Call (Mth2 Targeted)
                    { data: 11 }, // DateRemind
                    { data: 12 }, // T_FinalText (Mth3 Targeted)
                    { data: 13 }, // DateText
                    { data: 14 }, // DateReceived
                    { data: 15 }, // Note
                    { data: 16, orderable: false, searchable: false }, // Edit
                    { data: 17, orderable: false, searchable: false }  // Delete
                ]
            });
            dataTableInitialized = true;

            // Bindings
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });
            $('#taskModal').on('show.bs.modal', function () {
                if (!$('#editIndex').val()) {  // 没有 Id = 新增
                    setFixedTargetMonths();
                }
            });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            // First load
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: '/get-b34-records',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                        console.log('sample keys:', Object.keys((res.data || [])[0] || {}));

                    } else {
                        showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r) {
                    dataTable.row.add([
                        r.grouping || '',        // 0 Grouping / No
                        r.companyName || '',  // 1 Company Name
                        r.singleEntry  || '',  // 2 Single entry
                        r.fullSet || '',          // 3 Full set
                        r.reveiw  || '',            // 4 Review
                        r.taxOnly || '',          // 5 Tax only
                        r.pic || '',                  // 6 PIC
                        r.t_startAccWk || '',// 7 Targeted to start Acc wk (March)
                        r.t_Date || '',            // 8 Mth1 Targeted Date (Jan)
                        formatDateForDisplay(r.dateSent),        // 9 Date sent
                        r.t_Call || '',            // 10 Mth2 Targeted call/text (Feb)
                        formatDateForDisplay(r.dateRemind),    // 11 Date Remind
                        r.t_FinalText || '',  // 12 Targeted Final Text (March)
                        formatDateForDisplay(r.dateText),        // 13 Date text
                        formatDateForDisplay(r.dateReceived), // 14 Date Received
                        r.note || '',                // 15 Note
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${r.id || r.Id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                 </button>`,
                        `<button class="btn btn-sm btn-danger delete-btn" data-id="${r.id || r.Id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                 </button>`
                    ]);
                });
            }

            dataTable.draw();
        }

        // ------------ 保存（Create / Update） -------------
        function saveRecord() {
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                Grouping: ($('#grouping').val() || '').trim(),        // No → Grouping
                CompanyName: ($('#companyName').val() || '').trim(),

                SingleEntry: ($('#singleEntry').val() || '').trim(),
                FullSet: ($('#fullSet').val() || '').trim(),
                Reveiw: ($('#review').val() || '').trim(),
                TaxOnly: ($('#taxOnly').val() || '').trim(),

                PIC: ($('#pic').val() || '').trim(),

                // 4 个固定月份
                T_startAccWk: ($('#targetedStartAcc').val() || '').trim(),     // March
                T_Date: ($('#mth1TargetedDate').val() || '').trim(),           // Jan
                T_Call: ($('#mth2TargetedCall').val() || '').trim(),           // Feb
                T_FinalText: ($('#mth3TargetedFinal').val() || '').trim(),     // March

                // 实际日期（用 datepicker 选的）
                DateSent: ($('#mth1DateSent').val() || '').trim(),
                DateRemind: ($('#mth2DateRemind').val() || '').trim(),
                DateText: ($('#mth3DateText').val() || '').trim(),

                DateReceived: ($('#inwardDateReceived').val() || '').trim(),
                Note: ($('#inwardNote').val() || '').trim()
            };

            // ===== 简单验证：至少保证必填几个字段 =====
            let hasError = false;
            if (!formData.Grouping) {
                setFieldError('#grouping', 'Required');
                hasError = true;
            }

            if (!formData.CompanyName) {
                setFieldError('#companyName', 'Required');
                hasError = true;
            }
            if (!formData.PIC) {
                setFieldError('#pic', 'Required');
                hasError = true;
            }

            if (!formData.SingleEntry) {
                setFieldError('#singleEntry', 'Please select Yes or No');
                hasError = true;
            }

            if (!formData.FullSet) {
                setFieldError('#fullSet', 'Please select Yes or No');
                hasError = true;
            }

            if (!formData.Reveiw) {
                setFieldError('#review', 'Please select Yes or No');
                hasError = true;
            }

            if (!formData.TaxOnly) {
                setFieldError('#taxOnly', 'Please select Yes or No');
                hasError = true;
            }

            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/update-b34' : '/create-b34';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }


        // ------------ Edit -------------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: '/get-b34-record/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Form B&P Reminder');
                    if (res && res.success) {
                        const d = res.data || {};

                        $('#editIndex').val(d.id || d.Id || 0);

                        $('#grouping').val(d.grouping || d.Grouping || '');
                        $('#companyName').val(d.companyName || d.CompanyName || '');

                        $('#singleEntry').val(d.singleEntry || d.SingleEntry || '');
                        $('#fullSet').val(d.fullSet || d.FullSet || '');
                        $('#review').val(d.reveiw || d.Reveiw || '');
                        $('#taxOnly').val(d.taxOnly || d.TaxOnly || '');

                        $('#pic').val(d.pic || d.PIC || '');

                        $('#targetedStartAcc').val(d.t_startAccWk || d.T_startAccWk || 'March');
                        $('#mth1TargetedDate').val(d.t_Date || d.T_Date || 'Jan');
                        $('#mth2TargetedCall').val(d.t_Call || d.T_Call || 'Feb');
                        $('#mth1TargetedFinal').val(d.t_FinalText || d.T_FinalText || 'March');

                        $('#mth1DateSent').val(d.dateSent || d.DateSent || '');
                        $('#mth2DateRemind').val(d.dateRemind || d.DateRemind || '');
                        $('#mth1DateText').val(d.dateText || d.DateText || '');

                        $('#inwardDateReceived').val(d.dateReceived || d.DateReceived || '');
                        $('#inwardNote').val(d.note || d.Note || '');

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Form B&P Reminder');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;
            $.ajax({
                url: '/delete-b34/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}