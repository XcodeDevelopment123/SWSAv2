@{
    ViewData["Title"] = "SdnBhd18monthReminder";
}
<h1>Sdn Bhd first 18 months Reminder</h1>
<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bell me-2"></i>18 Months Reminder
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="2">Admin</th>
                            <th colspan="4">Co Information</th>
                            <th colspan="2">Due Dates</th>
                            <th colspan="3">Reminder</th>
                            <th colspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>Grouping</th>
                            <th>File</th>
                            <th>Company</th>
                            <th>Company Number</th>
                            <th>Incorporation Date</th>
                            <th>Year end</th>
                            <th>1st yr 18mths due date</th>
                            <th>Circulation & AFS due Date</th>
                            <th>Reminder date</th>
                            <th>Email Send</th>
                            <th>Date Send</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                       
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New 18 Months Reminder</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div id="modalAlert" class="alert d-none" role="alert"></div>

                    <input type="hidden" id="editIndex" value="">

                    <!-- Admin -->
                    <div class="form-info-label col-12">
                        <label>Admin</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Auto fill from company" readonly/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="file">File</label>
                                <input type="text" id="file" name="file" class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Co Information -->
                    <div class="form-info-label col-12">
                        <label>Company Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companySelect">Company</label>
                                <select id="companySelect" name="companySelect" class="form-control">
                                    <option value="">-- Select company --</option>
                                </select>
                                <small class="text-muted">
                                    Options are linked from the Sdn Bhd Client List.
                                </small>

                                <!-- 真正要存进 B11 的公司名、ClientId 用隐藏字段 -->
                                <input type="hidden" id="company" name="company" />
                                <input type="hidden" id="companyClientId" name="companyClientId" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyNumber">Company Number</label>
                                <input type="text" id="companyNumber" name="companyNumber"
                                       class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="incorporationDate">Incorporation Date</label>
                                <input type="text" id="incorporationDate" name="incorporationDate"
                                       class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year end</label>
                                <input type="text" id="yearEnd" name="yearEnd"
                                       class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Due Dates -->
                    <div class="form-info-label col-12">
                        <label>Due Dates</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="first18MonthsDue">1st yr 18mths due date</label>
                                <select id="first18MonthsDue" name="first18MonthsDue" class="form-control">
                                    <option value="">-- Select from AT2.1 / AEX4.1 --</option>
                                </select>
                                <small class="text-muted">Pulled from AT2.1 / AEX4.1</small>

                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="circulationAfsDue">
                                    Circulation & AFS due Date
                                    <small class="text-muted">(auto = Year end + 6 months)</small>
                                </label>
                                <input type="text" id="circulationAfsDue" name="circulationAfsDue"
                                       class="form-control" placeholder="Auto calculated" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Reminder -->
                    <div class="form-info-label col-12">
                        <label>Reminder</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="reminderDate">Reminder date</label>
                                 <small class="text-muted">30 days after annivesary date</small>
                                <input type="text" id="reminderDate" name="reminderDate" class="form-control" placeholder="Auto calculated"  readonly/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="emailSend">Email Send</label>
                                <select id="emailSend" name="emailSend" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSend">Date Send</label>
                                <input type="text" id="dateSend" name="dateSend" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        let dataTable;
        let dataTableInitialized = false;
        let companyOptionsMap = {};

        // 把 YearEndMonth ("December") 粗略转成 dd/MM/yyyy，方便你现有的 +6 months 逻辑工作
        function yearEndMonthToDateString(monthName) {
            if (!monthName) return '';

            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const idx = months.indexOf(monthName);
            if (idx === -1) return monthName; // 不认识就原样返回

            const today = new Date();
            let year = today.getFullYear();

            // 如果这个 month 已经过了，就当作明年的 year end
            if (idx < today.getMonth()) {
                year += 1;
            }

            // 取这个月的最后一天
            const dt = new Date(year, idx + 1, 0);
            return formatDdMMyyyy(dt); // 复用你已有的函数
        }

        function loadCompanyOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function (res) {
                    if (!(res && res.success && Array.isArray(res.data))) return;

                    companyOptionsMap = {};
                    const $sel = $('#companySelect');
                    $sel.empty().append('<option value="">-- Select company --</option>');

                    res.data.forEach(o => {
                        // 后端 B11CompanyOptionDto -> 前端是 camelCase：id, grouping, fileNo, companyName, companyNo, incorporationDate, yearEndMonth
                        companyOptionsMap[o.id] = o;

                        const display = o.companyNo
                            ? `${o.companyName} (${o.companyNo})`
                            : o.companyName;

                        $sel.append(`<option value="${o.id}">${display}</option>`);
                    });
                },
                error: function (xhr) {
                    console.error('Failed to load B11 company options', xhr);
                }
            });
        }

        function load18MthSourceList() {
            $.ajax({
                url: "/get-b11-sources",
                type: "GET",
                success: function (res) {
                    if (!(res && res.success)) return;
                    console.log(res.data);


                    const $sel = $("#first18MonthsDue");
                    $sel.empty().append(`<option value="">-- Select from AT2.1 / AEX4.1 --</option>`);

                    res.data.forEach(o => {
                        const company = o.companyName || "-";
                        const ye = formatDateForDisplay(o.yearEnd);
                        const d18 = formatDateForDisplay(o.first18MthDue);

                        $sel.append(`
                            <option value="${d18}">
                                ${o.sourceType} - ${company} - YE ${ye} - 18mth ${d18}
                            </option>
                        `);
                    });
                }
            });
        }


        // ---------- Date utils (dd/MM/yyyy) ----------
        function parseDdMMyyyy(s) {
            if (!s) return null;
            const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(s.trim());
            if (!m) return null;
            const d = +m[1], mo = +m[2] - 1, y = +m[3];
            const dt = new Date(y, mo, d);
            if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
            return dt;
        }
        function formatDdMMyyyy(dt) {
            const dd = String(dt.getDate()).padStart(2, '0');
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const yyyy = dt.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }
        function addMonthsKeepEnd(dt, months) {
            const y = dt.getFullYear(), m = dt.getMonth(), d = dt.getDate();
            const daysInTarget = new Date(y, m + months + 1, 0).getDate();
            const day = Math.min(d, daysInTarget);
            return new Date(y, m + months, day);
        }

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            // scroll modal body to top so the alert is visible
            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () { $box.attr('tabindex', -1).focus(); });
        }
        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }
        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }
        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert (outside modal) ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';

            s = String(s).trim();

            // 已经是 dd/MM/yyyy
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;

            // yyyy-MM-dd 或 yyyy-MM-ddTHH...
            var isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(s);
            if (isoMatch) {
                var y = parseInt(isoMatch[1], 10);
                var m = parseInt(isoMatch[2], 10) - 1;
                var d = parseInt(isoMatch[3], 10);
                var dt = new Date(y, m, d);
                if (!isNaN(dt.getTime())) return formatDdMMyyyy(dt);
            }

            // 例如 "Feb 27 2025", "Feb 27 2025 12:00AM", "Jan  9 2025 12:00AM"
            var m2 = /^([A-Za-z]{3}\s+\d{1,2}\s+\d{4})/.exec(s);
            if (m2) {
                var dt2 = new Date(m2[1]); // "Feb 27 2025"
                if (!isNaN(dt2.getTime())) return formatDdMMyyyy(dt2);
            }

            // 实在看不懂，就原样显示
            return s;
        }


        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#companySelect').val('');
            $('#companyClientId').val('');
            $('#modalTitle').text('Add New 18 Months Reminder');
            $('#dateSend').prop('disabled', false);
            hideModalAlert();
            clearFieldErrors();
        }

        // ---------- Init ----------
        $(document).ready(function () {
            loadCompanyOptions();
            load18MthSourceList();

            $('#companySelect').on('change', function () {
                const id = $(this).val();
                const o = companyOptionsMap[id];

                if (!o) {
                    // 清空自动字段
                    $('#companyClientId').val('');
                    $('#company').val('');
                    $('#grouping').val('');
                    $('#file').val('');
                    $('#companyNumber').val('');
                    $('#incorporationDate').val('');
                    $('#yearEnd').val('').trigger('change');
                    return;
                }

                // 1) 存 ClientId + 公司名（给后端用）
                $('#companyClientId').val(o.id);
                $('#company').val(o.companyName || '');

                // 2) Admin 部分：Grouping / File
                $('#grouping').val(o.grouping || '');
                $('#file').val(o.fileNo || '');

                // 3) Co info: Company No / Incorp Date / Year End
                $('#companyNumber').val(o.companyNo || '');
                $('#incorporationDate').val(formatDateForDisplay(o.incorporationDate));

                const yeStr = yearEndMonthToDateString(o.yearEndMonth);
                $('#yearEnd').val(yeStr).trigger('change'); // 触发原本的 YearEnd +6m 逻辑
            });

            // 你原来的绑定 / DataTable 初始化 / loadRecordsFromDatabase() 继续写在后面...

            // Year end -> Circulation & AFS due (auto = +6 months, read-only)
            $('#yearEnd').on('change', function () {
                const ye = parseDdMMyyyy($(this).val());
                $('#circulationAfsDue').val(ye ? formatDdMMyyyy(addMonthsKeepEnd(ye, 6)) : '');
            });

            // 自动计算 18个月 due + Reminder date
            $('#incorporationDate').on('change', function () {
                const inc = parseDdMMyyyy($(this).val());
                if (!inc) {
                    // $('#first18MonthsDue').val('');
                    $('#reminderDate').val('');
                    return;
                }

                // // 18个月后的日期
                // const due18 = addMonthsKeepEnd(inc, 18);
                // $('#first18MonthsDue').val(formatDdMMyyyy(due18));

                // 成立日 + 1年 + 30天
                const oneYearLater = addMonthsKeepEnd(inc, 12);
                const reminder = new Date(oneYearLater);
                reminder.setDate(reminder.getDate() + 30);
                $('#reminderDate').val(formatDdMMyyyy(reminder));
            });


            // Datepickers (exclude read-only #circulationAfsDue)
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return (id.includes('Date') || id.includes('date') || id.includes('yearEnd')) && id !== 'circulationAfsDue';
            }).datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

            // EmailSend toggle
            $('#emailSend').on('change', function () {
                if ($(this).val() === 'No') {
                    $('#dateSend').val('-').prop('disabled', true);
                } else {
                    $('#dateSend').prop('disabled', false);
                    if ($('#dateSend').val() === '-') $('#dateSend').val('');
                }
            });

            // DataTable (13 columns)
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                ordering: true,
                autoWidth: false,
                pageLength: 10,
                order: [[8, 'asc']],
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No records found",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    paginate: { first: "First", last: "Last", next: "Next", previous: "Previous" }
                },
                columns: [
                    { data: 0 },  // Grouping
                    { data: 1 },  // File
                    { data: 2 },  // Company
                    { data: 3 },  // Company Number
                    { data: 4 },  // Incorporation Date
                    { data: 5 },  // Year end
                    { data: 6 },  // 1st yr 18mths due date
                    { data: 7 },  // Circulation & AFS due Date
                    { data: 8 },  // Reminder date
                    { data: 9 },  // Email Send
                    { data: 10 }, // Date Send
                    { data: 11, orderable: false, searchable: false }, // Edit
                    { data: 12, orderable: false, searchable: false }  // Delete
                ],
                columnDefs: [
                    {
                        targets: 9,
                        render: function (data) {
                            if (data === 'Yes') return '<span class="badge bg-success">Yes</span>';
                            if (data === 'No') return '<span class="badge bg-warning">No</span>';
                            return data || '';
                        }
                    }
                ]
            });
            dataTableInitialized = true;

            // Bindings
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });
            $('#taskModal').on('show.bs.modal', function () {
            });

            // First load
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: '/get-b11-records',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                    } else {
                        showAlert('Failed to load: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();
            if (records && records.length) {
                records.forEach(function (r) {
                    dataTable.row.add([
                        r.grouping || '',
                        r.file || '',
                        r.company || '',
                        r.companyNo || '',
                        formatDateForDisplay(r.incorporationDate),
                        formatDateForDisplay(r.yearEnd),
                        formatDateForDisplay(r.ymDueDate),
                        formatDateForDisplay(r.circulationAFSDueDate),
                        formatDateForDisplay(r.reminderDate),
                        r.emailSend || '',
                        formatDateForDisplay(r.dateSent),
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${r.id}" title="Edit"><i class="fas fa-edit"></i></button>`,
                        `<button class="btn btn-sm btn-danger delete-btn" data-id="${r.id}" title="Delete"><i class="fas fa-trash"></i></button>`
                    ]);
                });
            }
            dataTable.draw();
        }

        // ---------- Save ----------
        function saveRecord() {
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),
                Grouping: ($('#grouping').val() || '').trim(),
                File: ($('#file').val() || '').trim(),
                Company: ($('#company').val() || '').trim(),
                CompanyNo: ($('#companyNumber').val() || '').trim(),
                IncorporationDate: ($('#incorporationDate').val() || '').trim(),
                YearEnd: ($('#yearEnd').val() || '').trim(),
                YMDueDate: ($('#first18MonthsDue').val() || '').trim(),
                CirculationAFSDueDate: ($('#circulationAfsDue').val() || '').trim(),
                ReminderDate: ($('#reminderDate').val() || '').trim(),
                EmailSend: ($('#emailSend').val() || '').trim(),
                DateSent: ($('#dateSend').val() || '').trim()
            };

            // Required validations + inline errors
            // === 表单验证 ===
            let hasError = false;

            // 清除旧的错误标记
            $('#taskForm .form-control').removeClass('is-invalid');
            $('.invalid-feedback').remove();

            // 工具函数：在某个字段下方显示错误提示
            function setFieldError(selector, message) {
                const $field = $(selector);
                $field.addClass('is-invalid');
                if ($field.next('.invalid-feedback').length === 0) {
                    $field.after(`<div class="invalid-feedback">${message}</div>`);
                }
            }

            // === 验证逻辑 ===
            // 1️⃣ 基础资料
            if (!formData.Grouping) { setFieldError('#grouping', 'Required'); hasError = true; }
            if (!formData.File) { setFieldError('#file', 'Required'); hasError = true; }
            if (!formData.Company) { setFieldError('#company', 'Required'); hasError = true; }
            if (!formData.CompanyNo) { setFieldError('#companyNumber', 'Required'); hasError = true; }
            if (!formData.IncorporationDate) { setFieldError('#incorporationDate', 'Required'); hasError = true; }
            if (!formData.YearEnd) { setFieldError('#yearEnd', 'Required'); hasError = true; }

            // 2️⃣ 自动计算的 readonly 字段不用检查：#first18MonthsDue, #circulationAfsDue, #reminderDate
            // 但如果由于异常为空（例如用户没选日期）也要提示
            if (!formData.YMDueDate) { setFieldError('#first18MonthsDue', 'Auto field missing — please reselect Incorporation Date'); hasError = true; }
            if (!formData.CirculationAFSDueDate) { setFieldError('#circulationAfsDue', 'Auto field missing — please reselect Year End'); hasError = true; }
            if (!formData.ReminderDate) { setFieldError('#reminderDate', 'Auto field missing — please reselect Incorporation Date'); hasError = true; }

            // 3️⃣ Email Send 必选
            if (!formData.EmailSend) {
                setFieldError('#emailSend', 'Please select Yes or No');
                hasError = true;
            }

            // 4️⃣ 如果选择 Yes 必须填 Date Sent
            if (formData.EmailSend === 'Yes' && (!formData.DateSent || formData.DateSent === '-')) {
                setFieldError('#dateSend', 'Required when Email Send = Yes');
                hasError = true;
            }

            // === 触发提示 ===
            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            if (formData.EmailSend === 'No') formData.DateSent = '-';

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/update-b11' : '/create-b11';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: '/get-b11-record/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit 18 Months Reminder');
                    if (res && res.success) {
                        const d = res.data || {};
                        $('#editIndex').val(d.id || 0);
                        $('#grouping').val(d.grouping || '');
                        $('#file').val(d.file || '');
                        $('#company').val(d.company || '');
                        $('#companyNumber').val(d.companyNo || d.companyNumber || '');
                        $('#incorporationDate').val(d.incorporationDate || '');
                        $('#yearEnd').val(d.yearEnd || '').trigger('change');

                        // 1st yr 18mths due date
                        const ym = d.ymDueDate || d.first18MonthsDue || '';
                        $('#first18MonthsDue').val(ym).trigger('change');

                        $('#circulationAfsDue').val(d.circulationAFSDueDate || '');
                        $('#reminderDate').val(d.reminderDate || '');
                        $('#emailSend').val(d.emailSend || '').trigger('change');
                        $('#dateSend').val(d.dateSent || '');
                        // === 根据 Company + Company Number 反选 dropdown ===
                        const existingCompanyName = (d.company || '').trim().toUpperCase();
                        const existingCompanyNo = (d.companyNo || d.companyNumber || '').trim().toUpperCase();

                        let matchedId = null;

                        for (const [id, o] of Object.entries(companyOptionsMap)) {
                            const optName = (o.companyName || '').trim().toUpperCase();
                            const optNo = (o.companyNo || '').trim().toUpperCase();

                            if (optName === existingCompanyName && optNo === existingCompanyNo) {
                                matchedId = id;
                                break;
                            }
                        }

                        if (matchedId) {
                            $('#companySelect').val(matchedId);
                            // 一般不用触发 change，避免把已经从 record 载入的值再覆盖一遍
                            // 如果你希望重新根据 dropdown 再算一遍，也可以加: $('#companySelect').trigger('change');
                        }

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit 18 Months Reminder');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;
            $.ajax({
                url: '/delete-b11/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}