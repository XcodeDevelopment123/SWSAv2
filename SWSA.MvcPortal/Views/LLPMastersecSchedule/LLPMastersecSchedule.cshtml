@{
    ViewData["Title"] = "LLPMastersecSchedule";
}

<h1>LLP Master sec Schedule</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <!-- Alert container for messages -->
                <div id="alertContainer"></div>

                <!-- 简化表格结构 -->
                <table id="taskDatatable" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Grouping</th>
                            <th>Referral</th>
                            <th>Sec File No</th>
                            <th>Co Name</th>
                            <th>Year End</th>
                            <th>Incorp Date</th>
                            <th>Co Status</th>
                            <th>Activity/size</th>
                            <th>YE to do</th>
                            <th>Acc Mth</th>
                            <th>Extension Date</th>
                            <th>AD Due Date</th>
                            <th>Acc Ready?</th>
                            <th>AD Submit Date</th>
                            <th>Job Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded from database -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="0">

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="referral">Referral</label>
                                <input type="text" id="referral" name="referral" class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="secFileNo">Sec File No</label>
                                <input type="text" id="secFileNo" name="secFileNo" class="form-control" placeholder="Auto fill from company" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name (Linked from Client List)</label>
                                <select id="companyName" name="companyName" class="form-control">
                                    <option value="">-- Select company --</option>
                                </select>
                                <small class="text-muted">
                                    Options are linked from the LLP Client List. Grouping, Referral, File No will be filled automatically.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="AutoFill" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Work Allocation Info</label>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="incorpDateDisplay">Incorp Date</label>
                                <input type="text" id="incorpDateDisplay" class="form-control" placeholder="AutoFill" readonly />
                                <input type="hidden" id="incorpDate" name="incorpDate" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyStatus">Co Status</label>
                                <select id="companyStatus" name="companyStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="activeCoActivitySize">Active Co: Activity/size</label>
                                <select id="activeCoActivitySize" name="activeCoActivitySize" class="form-control">
                                    <option value="">Select Size</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yEtodo">YE to do</label>
                                <select id="yEtodo" name="yEtodo" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="acCmthTodo">Acc Mth to do</label>
                                <select id="acCmthTodo" name="acCmthTodo" class="form-control">
                                    <option value="">Select month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>SSM Due Dates</label>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssMextensionDate">SSM Extension Date</label>
                                <input type="date" id="ssMextensionDate" name="ssMextensionDate" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="aDdueDate">Annual Declaration Due Date</label>
                                <input type="date" id="aDdueDate" name="aDdueDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="form-info-label col-12">
                        <label>Status</label>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="accReady">Acc Ready?</label>
                                <select id="accReady" name="accReady" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="aDsubmitDate">Annual Declaration Submitted Date</label>
                                <input type="date" id="aDsubmitDate" name="aDsubmitDate" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="jobCompleted">Job Completed/Backlog</label>
                                <select id="jobCompleted" name="jobCompleted" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_DatatablesScriptsPartial" />

    <style>
        .form-info-label {
            background-color: #f8f9fa;
            padding: 8px 12px;
            margin: 15px 0 10px 0;
            border-left: 4px solid #007bff;
            font-weight: bold;
            color: #495057;
        }

        .table th {
            background-color: #e9ecef;
            vertical-align: middle;
            text-align: center;
            white-space: nowrap;
        }

        .table td {
            white-space: nowrap;
            text-align: center;
            vertical-align: middle;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .card-body {
            padding: 1rem;
            overflow-x: auto;
        }

        #taskDatatable {
            width: 100%;
            min-width: 1400px;
        }

        .btn-group .btn {
            margin: 0 2px;
        }
    </style>
    <script>
        $(document).ready(function () {
            let table;
            let isEditMode = false;
            let companyOptionsPromise = null;

            function parseToDate(raw) {
                if (!raw) return null;
                if (raw instanceof Date) return isNaN(raw) ? null : raw;
                if (typeof raw === 'string') {
                    // ISO: yyyy-MM-dd 或 yyyy-MM-ddTHH:mm:ss...
                    if (/^\d{4}-\d{2}-\d{2}/.test(raw)) {
                        return new Date(raw.substring(0, 10) + 'T00:00:00');
                    }
                    // 欧式: dd/MM/yyyy
                    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
                        const [dd, mm, yyyy] = raw.split('/');
                        return new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
                    }
                }
                const d = new Date(raw);
                return isNaN(d) ? null : d;
            }
            // -------- 日期工具 --------
            function toIsoYYYYMMDD(d) {
                const date = (d instanceof Date) ? d : new Date(d);
                if (isNaN(date)) return "";
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }
            function toDisplayDDMMYYYY(d) {
                const date = parseToDate(d);
                if (!date) return "";
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yyyy = date.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }
            function monthNameToIndex(name) {
                if (!name) return null;
                const m = name.toLowerCase();
                const list = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
                const idx = list.indexOf(m);
                return idx >= 0 ? idx : null; // 0-based
            }
            function lastDayOfMonthForYear(monthIndex0, year) {
                if (monthIndex0 == null) return null;
                return new Date(year, monthIndex0 + 1, 0); // 下个月第0天=本月最后一天
            }
            function toDateInputValue(raw) {
                if (!raw) return "";
                try {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
                    const d = new Date(raw);
                    if (!isNaN(d.getTime())) return toIsoYYYYMMDD(d);
                    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
                        const [dd, mm, yyyy] = raw.split('/');
                        return `${yyyy}-${mm}-${dd}`;
                    }
                    return "";
                } catch { return ""; }
            }

            // YearEnd 显示为该月最后一天（dd/MM/yyyy）
            function formatYearEndText(yearEndMonth) {
                if (!yearEndMonth) return "";
                const mIdx = monthNameToIndex(yearEndMonth);
                if (mIdx == null) return yearEndMonth; // 兜底
                const today = new Date();
                const lastThisYear = lastDayOfMonthForYear(mIdx, today.getFullYear());
                const year = (today > lastThisYear) ? (today.getFullYear() + 1) : today.getFullYear();
                const lastDay = lastDayOfMonthForYear(mIdx, year);
                return toDisplayDDMMYYYY(lastDay);
            }

            // -------- 加载 LLP 公司下拉（返回 Promise）--------
            function loadLlpCompanyOptions() {
                if (companyOptionsPromise) return companyOptionsPromise; // 防重复
                companyOptionsPromise = $.ajax({
                    url: "/api/get/llp-company-options",
                    type: "GET"
                }).then(function (res) {
                    const $sel = $("#companyName");
                    $sel.empty().append('<option value="">-- Select company --</option>');
                    if (!(res && res.success && Array.isArray(res.data))) return;

                    res.data.forEach(o => {
                        const id = o.id ?? o.Id;
                        const grouping = o.grouping ?? o.Grouping ?? "";
                        const referral = o.referral ?? o.Referral ?? "";
                        const fileNo = o.fileNo ?? o.FileNo ?? "";
                        const companyName = o.companyName ?? o.CompanyName ?? "-";
                        const companyNo = o.companyNo ?? o.CompanyNo ?? "";
                        const incorpRaw = o.incorporationDate ?? o.IncorporationDate ?? "";
                        const yearEndMonth = o.yearEndMonth ?? o.YearEndMonth ?? "";
                        const textShown = companyNo ? `${companyName} (${companyNo})` : companyName;

                        $sel.append(
                            `<option value="${id}"
            data-companyname="${companyName}"
            data-grouping="${grouping}"
            data-referral="${referral}"
            data-fileno="${fileNo}"
            data-companyno="${companyNo}"
            data-incorpdate="${toDateInputValue(incorpRaw)}"
            data-yearendmonth="${yearEndMonth}">
            ${textShown}
        </option>`
                        );
                    });
                }).catch(function (xhr) {
                    console.error("loadLlpCompanyOptions error:", xhr.responseText);
                });
                return companyOptionsPromise;
            }

            // 选择公司 → 自动回填（仅新增或用户手动更改时生效）
            $("#companyName").on("change", function () {
                const $opt = $(this).find("option:selected");
                if (!$opt.val()) {
                    $("#grouping,#referral,#secFileNo,#yearEnd,#incorpDateDisplay").val("");
                    $("#incorpDate").val("");
                    return;
                }
                $("#grouping").val($opt.data("grouping") || "");
                $("#referral").val($opt.data("referral") || "");
                $("#secFileNo").val($opt.data("fileno") || "");

                const isoIncorp = $opt.data("incorpdate") || "";
                $("#incorpDate").val(isoIncorp);                           // 隐藏 ISO
                $("#incorpDateDisplay").val(toDisplayDDMMYYYY(isoIncorp)); // 显示 dd/MM/yyyy

                const yearEndMonth = $opt.data("yearendmonth") || "";
                $("#yearEnd").val(formatYearEndText(yearEndMonth));        // dd/MM/yyyy
            });

            // -------- Alert --------
            function showAlert(message, type) {
                const alertClass = `alert alert-${type} alert-dismissible fade show`;
                const alertHtml = `
                    <div class="${alertClass}" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                $('#alertContainer').html(alertHtml);
                setTimeout(() => {
                    const el = document.querySelector('#alertContainer .alert');
                    if (el) bootstrap.Alert.getOrCreateInstance(el).close();
                }, 5000);
            }
            function formatDate(dateString) {
                if (!dateString) return '-';
                try {
                    if (dateString.includes('/')) return dateString;
                    if (dateString.includes('T')) return new Date(dateString).toLocaleDateString('en-GB');
                    return dateString;
                } catch { return dateString; }
            }

            // -------- DataTable --------
            function initializeDataTable() {
                if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                    $('#taskDatatable').DataTable().destroy();
                    $('#taskDatatable tbody').empty();
                }
                table = $('#taskDatatable').DataTable({
                    processing: true,
                    serverSide: false,
                    ajax: {
                        url: "/LLPMastersecSchedule/GetAll",
                        type: "GET",
                        dataSrc: function (json) {
                            if (json.success) return json.data;
                            showAlert('Error loading data: ' + json.message, 'danger');
                            return [];
                        },
                        error: function (xhr) {
                            console.error('AJAX Error:', xhr.responseText);
                            showAlert('Failed to load data. Please check if the API endpoint is available.', 'danger');
                        }
                    },
                    columns: [
                        { data: "grouping", className: "text-center", defaultContent: "-" },
                        { data: "referral", className: "text-center", defaultContent: "-" },
                        { data: "secFileNo", className: "text-center", defaultContent: "-" },
                        { data: "companyName", className: "text-center", defaultContent: "-" },
                        { data: "yearEnd", className: "text-center", defaultContent: "-" },
                        {
                            data: "incorpDate",
                            className: "text-center",
                            defaultContent: "-",
                            render: d => formatDate(d)
                        },
                        { data: "companyStatus", className: "text-center", defaultContent: "-" },
                        { data: "activeCoActivitySize", className: "text-center", defaultContent: "-" },
                        { data: "yEtodo", className: "text-center", defaultContent: "-" },
                        { data: "accmthTodo", className: "text-center", defaultContent: "-" },
                        {
                            data: "ssMextensionDate",
                            className: "text-center",
                            defaultContent: "-",
                            render: d => formatDate(d)
                        },
                        {
                            data: "aDdueDate",
                            className: "text-center",
                            defaultContent: "-",
                            render: d => formatDate(d)
                        },
                        { data: "accReady", className: "text-center", defaultContent: "-" },
                        {
                            data: "aDsubmitDate",
                            className: "text-center",
                            defaultContent: "-",
                            render: d => formatDate(d)
                        },
                        { data: "jobCompleted", className: "text-center", defaultContent: "-" },
                        {
                            data: "id",
                            orderable: false,
                            className: "text-center",
                            render: (data) => `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${data}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${data}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>`
                        }
                    ],
                    paging: true, lengthChange: true, pageLength: 10, searching: true,
                    ordering: true, info: true, autoWidth: false, responsive: false, scrollX: false
                });
            }

            // -------- 表单工具 --------
            function resetForm() {
                $('#taskForm')[0].reset();
                $('#recordId').val('0');
                isEditMode = false;
                $('#modalTitle').text('Add New Record');
                // 清空显示/隐藏的并保持下拉可选
                $('#companyName').val('');
                $('#incorpDate').val('');
                $('#incorpDateDisplay').val('');
            }
            function getFormData() {
                const $opt = $('#companyName option:selected');
                return {
                    Id: $('#recordId').val() ? parseInt($('#recordId').val()) : 0,
                    Grouping: $('#grouping').val(),
                    Referral: $('#referral').val(),
                    SecFileNo: $('#secFileNo').val(),
                    CompanyId: $opt.val() ? parseInt($opt.val()) : null,
                    CompanyName: $opt.data('companyname') || $opt.text() || '',
                    YearEnd: $('#yearEnd').val(),
                    IncorpDate: $('#incorpDate').val(),
                    CompanyStatus: $('#companyStatus').val(),
                    ActiveCoActivitySize: $('#activeCoActivitySize').val(),
                    YEtodo: $('#yEtodo').val(),
                    ACCmthTodo: $('#acCmthTodo').val(),
                    SSMextensionDate: $('#ssMextensionDate').val(),
                    ADdueDate: $('#aDdueDate').val(),
                    AccReady: $('#accReady').val(),
                    ADsubmitDate: $('#aDsubmitDate').val(),
                    JobCompleted: $('#jobCompleted').val()
                };
            }
            function validateForm() {
                let isValid = true;
                const requiredFields = ['grouping', 'referral', 'secFileNo', 'companyName'];
                requiredFields.forEach(id => {
                    const $el = $('#' + id);
                    const val = $el.val() ? String($el.val()).trim() : '';
                    if (!val) { $el.addClass('is-invalid'); isValid = false; }
                    else { $el.removeClass('is-invalid'); }
                });
                return isValid;
            }

            // -------- 回填（Edit）--------
            function populateForm(data) {
                $('#recordId').val(data.id);
                $('#grouping').val(data.grouping || '');
                $('#referral').val(data.referral || '');
                $('#secFileNo').val(data.secFileNo || '');

                // 先按 CompanyId 选中；没有就按名称兜底（仅设值，不触发 change）
                if (data.companyId) {
                    $('#companyName').val(String(data.companyId));
                } else if (data.companyName) {
                    const $match = $('#companyName option').filter(function () {
                        return $(this).text() === data.companyName || $(this).data('companyname') === data.companyName;
                    }).first();
                    if ($match.length) $('#companyName').val($match.val());
                    else $('#companyName').val('');
                } else {
                    $('#companyName').val('');
                }

                // Year End：优先显示数据库值；支持 ISO 或 dd/MM/yyyy
                let yearEndDisplay = '';
                if (data.yearEnd) {
                    const parsed = parseToDate(data.yearEnd);
                    yearEndDisplay = parsed ? toDisplayDDMMYYYY(parsed) : data.yearEnd; // 解析失败就保持原样
                }
                $('#yearEnd').val(yearEndDisplay);


                // Incorp：显示 + 隐藏
                const isoIncorp = data.incorpDate
                    ? (data.incorpDate.includes('T') ? data.incorpDate.split('T')[0] : data.incorpDate)
                    : '';
                $('#incorpDate').val(isoIncorp);
                $('#incorpDateDisplay').val(toDisplayDDMMYYYY(isoIncorp));

                $('#companyStatus').val(data.companyStatus || '');
                $('#activeCoActivitySize').val(data.activeCoActivitySize || '');
                $('#yEtodo').val(data.yEtodo || '');
                $('#acCmthTodo').val(data.accmthTodo || '');

                const ssmExtIso = data.ssMextensionDate ? (data.ssMextensionDate.split('T')[0]) : '';
                const adDueIso = data.aDdueDate ? (data.aDdueDate.split('T')[0]) : '';
                $('#ssMextensionDate').val(ssmExtIso);
                $('#aDdueDate').val(adDueIso);

                $('#accReady').val(data.accReady || '');

                const adSubIso = data.aDsubmitDate ? (data.aDsubmitDate.split('T')[0]) : '';
                $('#aDsubmitDate').val(adSubIso);

                $('#jobCompleted').val(data.jobCompleted || '');
            }

            // -------- Save --------
            $('#saveBtn').click(function () {
                if (!validateForm()) {
                    showAlert('Please fill in all required fields', 'warning');
                    return;
                }
                const formData = getFormData();
                const isEdit = formData.Id && formData.Id !== 0;
                const url = isEdit ? '/LLPMastersecSchedule/Update' : '/LLPMastersecSchedule/Create';

                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (resp) {
                        if (resp.success) {
                            showAlert(resp.message, 'success');
                            $('#taskModal').modal('hide');
                            table.ajax.reload(null, false);
                        } else {
                            showAlert('Error: ' + resp.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Save error:', xhr.responseText);
                        showAlert('Error: ' + (xhr.responseJSON?.message || error), 'danger');
                    }
                });
            });

            // -------- Edit --------
            $('#taskDatatable').on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                isEditMode = true;
                $('#modalTitle').text('Edit Record');

                // 先保证下拉已加载，再取详情并回填（不禁用、不触发 change）
                loadLlpCompanyOptions().then(function () {
                    $.ajax({
                        url: '/LLPMastersecSchedule/GetById?id=' + id,
                        type: 'GET',
                        success: function (response) {
                            if (response.success) {
                                populateForm(response.data);
                                $('#taskModal').modal('show');
                            } else {
                                showAlert('Error: ' + response.message, 'danger');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Edit error:', xhr.responseText);
                            showAlert('Error: ' + error, 'danger');
                        }
                    });
                });
            });

            // -------- Delete --------
            $('#taskDatatable').on('click', '.delete-btn', function () {
                const id = $(this).data('id');
                if (!confirm('Are you sure you want to delete this record?')) return;

                $.ajax({
                    url: '/LLPMastersecSchedule/Delete?id=' + id,
                    type: 'POST',
                    success: function (response) {
                        if (response.success) {
                            showAlert(response.message, 'success');
                            table.ajax.reload(null, false);
                        } else {
                            showAlert('Error: ' + response.message, 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Delete error:', xhr.responseText);
                        showAlert('Error: ' + error, 'danger');
                    }
                });
            });

            // -------- Modal --------
            $('#taskModal').on('show.bs.modal', function () {
                if (!isEditMode) resetForm(); // 新增时清空并允许选择
            });
            $('#taskModal').on('hidden.bs.modal', function () {
                resetForm();
            });

            // 清除校验
            $('input, select').on('input change', function () {
                $(this).removeClass('is-invalid');
            });

            // 初始化
            initializeDataTable();
            loadLlpCompanyOptions();
        });
    </script>
}