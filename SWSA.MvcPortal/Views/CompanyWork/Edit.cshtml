@using Newtonsoft.Json
@using SWSA.MvcPortal.Commons.Constants
@using SWSA.MvcPortal.Commons.Enums
@using SWSA.MvcPortal.Commons.Extensions
@using SWSA.MvcPortal.Commons.Helpers
@using SWSA.MvcPortal.Models.CompnayWorks
@using SWSA.MvcPortal.Models.Users
@using SWSA.MvcPortal.Services.Interfaces
@model CompanyWorkAssignmentkEditPageVM
@inject IUserContext UserContext
@{
	ViewData["Title"] = "Edit";
	Layout = "~/Views/Shared/_Layout.cshtml";

	var workVM = Model.CompanyWork;

	var cp = workVM.Company;
	var progress = workVM.Progress;

	var workTypes = SelectHelper.GetEnumSelectList<WorkType>(workVM.WorkType);
	var serviceScopes = SelectHelper.GetEnumSelectList<ServiceScope>(workVM.ServiceScope);
	var companyActivityLevels = SelectHelper.GetEnumSelectList<CompanyActivityLevel>(workVM.ActivitySize);
	var workProgressStatus = SelectHelper.GetEnumSelectList<WorkProgressStatus>(progress.Status);
	var companyStatus = SelectHelper.GetEnumSelectList<CompanyStatus>(workVM.CompanyStatus);

	var isYearEndToDo = SelectHelper.GetYesNoSelection(workVM.IsYearEndTask);

	var monthOfYear = SelectHelper.GetEnumSelectList<MonthOfYear>(0);

	var currentYear = DateTime.Now.Year;
	var startYear = currentYear - 10;
	var endYear = currentYear + 20;

	<input type="hidden" id="taskId" value="@workVM.TaskId" />
	<input type="hidden" id="progressId" value="@progress.ProgressId" />
	<input type="hidden" id="isSuperAdmin" value="@UserContext.IsSuperAdmin.ToString()" />

}

<h3>Edit Task for @cp.Name (@cp.RegistrationNumber)</h3>
<div class="row">
	<div class="col-md-12">
		<form>
			<!-- jquery validation -->
			<div class="card card-primary">
				<div class="card-header">
					<a href="/companies/@cp.Id/overview">
						<h3 class="card-title">
							Company Info

						</h3>
					</a>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-minus"></i>
						</button>
					</div>
				</div>

				<!-- /.card-header -->
				<!-- form start -->
				<div class="card-body row">
					<div class="col-md-6">
						<div class="form-group">
							<label for="companyName">Company</label>
							<input readonly value="@($"{cp.Name} ({cp.RegistrationNumber})")" class="form-control " placeholder="xxx sdn.bhd." />
						</div>
					</div>
					<div class="col-md-6">
						<div class="form-group">
							<label for="incorpDate">Incorporation Date</label>
							<div class="input-group">
								<input disabled type="text" value="@cp.IncorporationDate.ToFormattedString()" id="incorpDate" name="incorpDate" class="form-control" placeholder="Select date" />
								<div class="input-group-append">
									<span class="input-group-text">
										<i class="fa fa-calendar"></i>
									</span>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="form-group">
							<label for="companyType">Company Type</label>
							<input readonly id="companyType" value="@cp.CompanyType.GetDisplayName()" class="form-control " />
						</div>
					</div>

					<div class="col-md-6">
						<div class="form-group">
							<label for="yearEndMonth">Year End Month</label>
							<div class="input-group">
								<input readonly type="text" id="yearEndMonth" value="@cp.YearEndMonth?.GetDisplayNameAndNumber()" name="yearEndMonth" class="form-control" placeholder="Select month" />
								<div class="input-group-append">
									<span class="input-group-text">
										<i class="fa fa-calendar"></i>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</form>
		<!-- /.card -->
	</div>

	<div class="col-md-12">
		<!-- jquery validation -->
		<form id="taskForm">
			<div class="card card-secondary">
				<div class="card-header">
					<h3 class="card-title">Task / Work</h3>
				</div>
				<!-- /.card-header -->
				<!-- form start -->

				<div class="card-body">
					<div class="form-info-label col-12">
						<label>Work Allocation Info</label>
					</div>

					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="companyStatus">Company Status</label>
								<select asp-items="companyStatus" id="companyStatus" name="companyStatus" class="form-control select2">
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="workType">Work Type</label>
								<select id="workType" name="workType" class="form-control select2">
									@Html.RenderOptions(workTypes)
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="isYearEndTask">Year End To Do</label>
								<select asp-items="isYearEndToDo" id="isYearEndTask" name="isYearEndTask" class="form-control select2">
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="serviceScope">Services Offer</label>
								<select id="serviceScope" name="serviceScope" class="form-control select2">
									@Html.RenderOptions(serviceScopes)
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="companyActivityLevel">Company Activity Level</label>
								<select id="companyActivityLevel" name="companyActivityLevel" class="form-control select2">
									@Html.RenderOptions(companyActivityLevels)
								</select>
							</div>
						</div>


						<div class="col-md-6">
							<div class="form-group">
								<label for="internalNote">Internal Note</label>
								<input type="text" id="internalNote" value="@workVM.InternalNote" name="internalNote" class="form-control" placeholder="(Optional)" />
							</div>
						</div>
						<div class="col-md-12">
							<div class="form-group">
								<label for="auditMonthToDo">
									Audit Month To Do
								</label>
								<select id="auditMonthToDo" name="auditMonths" class="form-control select2" multiple="multiple" style="max-width:95%">
									@foreach (var month in monthOfYear)
									{
										var isSelected = workVM.AuditPlannedMonths.Any(c => c.Month.ToString() == month.Value);
										<option value="@month.Value" selected="@(isSelected ? "selected" : null)">
											@month.Text
										</option>
									}
								</select>
							</div>
						</div>

						<div class="col-md-12">
							<div class="form-group">
								<label for="accountMonthToDo">
									Accounting Month To Do
								</label>
								<select id="accountMonthToDo" name="accountMonths" class="form-control select2" multiple="multiple" style="max-width:95%">
									@foreach (var month in monthOfYear)
									{
										var isSelected = workVM.AccountPlannedMonths.Any(c => c.Month.ToString() == month.Value);
										<option value="@month.Value" selected="@(isSelected ? "selected" : null)">
											@month.Text
										</option>
									}
								</select>
							</div>
						</div>

						<div class="form-info-label col-12">
							<label>
								SSM Due dates
								<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The date only apply to this work"></i>
							</label>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="ssmExtensionDate">
									SSM Extension Date
								</label>
								<div class="input-group">
									<input type="text" id="ssmExtensionDate" name="ssmExtensionDate" value="@workVM.SsmExtensionDate?.ToFormattedString()" class="form-control" placeholder="(Optional)" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="agmDate">
									AGM Date
									<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Annual General Meeting"></i>
								</label>
								<div class="input-group">
									<input type="text" id="agmDate" name="agmDate" value="@workVM.AGMDate?.ToFormattedString()" class="form-control" placeholder="(Optional)" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="SsmExtensionDate">
									AR Due Date
									<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Annual Return Due Date"></i>
								</label>
								<div class="input-group">
									<input type="text" id="arDueDate" name="arDueDate" value="@workVM.ARDueDate?.ToFormattedString()" class="form-control" placeholder="(Optional)" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="SsmExtensionDate">
									Reminder Date
									<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The system will send automatic reminders before the AGM Date or AR Due Date."></i>
								</label>
								<div class="input-group">
									<input type="text" id="reminderDate" name="reminderDate" value="@workVM.ReminderDate?.ToFormattedString()" class="form-control" placeholder="(Optional)" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>


					</div>
				</div>
				<!-- /.card-body -->
				<div class="card-footer ">
					<button id="btnSubmitRequest" class="btn btn-primary float-end">Save</button>
				</div>

				<!-- /.card -->
			</div>
		</form>
	</div>

	<div class="col-md-12">
		<!-- jquery validation -->
		<form id="auditUserForm">
			<div class="card card-warning collapsed-card">
				<div class="card-header">
					<h3 class="card-title">Audit Work Handle User</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-plus"></i>
						</button>
					</div>
				</div>
				<!-- /.card-header -->
				<!-- form start -->

				<div class="card-body" style="display:none">
					<div class="row">

						<table id="auditUserTable" class="table table-bordered table-hover">
							<thead>
								<tr>
									<th>User</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								@{
									var auditUsers = workVM.AssignedUsers.Where(c => c.IsAssignedToAudit);
									@foreach (var user in auditUsers)
									{
										<tr data-staff-id="@user.StaffId">
											<td>
												@user.StaffName (@user.Role.GetDisplayName()) @(UserContext.StaffId == user.StaffId ? "(You)" : "")
											</td>

											<td>

												<button type="button"
														class="@(UserContext.IsSuperAdmin?"btn-delete-user":"")  btn btn-sm btn-danger"
														data-bs-toggle="tooltip"
														data-bs-placement="top"
														value="@user.StaffId"
														data-department="Audit"
														data-name="@user.StaffName"
														title="Only super admin can remove">
													<i class="fa fa-trash"></i>
												</button>
											</td>
										</tr>
									}
								}
							</tbody>
						</table>

						@if (UserContext.IsSuperAdmin)
						{
							<div class="divider-line"></div>

							<div class="row">

								<div class="col-md-6">
									<div class="form-group">
										<label for="auditUserStaffId">
											User
											<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The system user assigned to handle this audit work."></i>
										</label>
										<select id="auditUserStaffId" name="staffId" class="form-control select2 ">
											@if (Model.AuditUserSelections.Count == 0)
											{
												<option disabled value="">No user are handling audit of this company</option>
											}
											else
											{
												<option value="">Please select</option>
											}

											@foreach (var user in Model.AuditUserSelections)
											{
												var isSelected = workVM.AssignedUsers.Any(c => c.StaffId == user.StaffId && c.IsAssignedToAudit);
												if (isSelected)
												{
													<option value="@user.StaffId" disabled>@user.FullName (@user.Role.GetDisplayName())</option>
												}
												else
												{
													<option value="@user.StaffId">@user.FullName (@user.Role.GetDisplayName())</option>
												}
											}

										</select>
									</div>
								</div>
							</div>
						}
					</div>
				</div>
				@if (UserContext.IsSuperAdmin)
				{
					<!-- /.card-body -->
					<div class="card-footer ">
						<button id="btnSubmitRequest" class="btn btn-primary float-end">Add</button>
					</div>
				}
				<!-- /.card -->
			</div>
		</form>
	</div>

	<div class="col-md-12">
		<!-- jquery validation -->
		<form id="accountUserForm">
			<div class="card card-warning collapsed-card">
				<div class="card-header">
					<h3 class="card-title">Account Work Handle User</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-plus"></i>
						</button>
					</div>
				</div>
				<!-- /.card-header -->
				<!-- form start -->

				<div class="card-body" style="display:none">
					<div class="row">

						<table id="accountUserTable" class="table table-bordered table-hover">
							<thead>
								<tr>
									<th>User</th>

									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								@{
									var accountUsers = workVM.AssignedUsers.Where(c => c.IsAssignedToAccount);
									@foreach (var user in accountUsers)
									{
										<tr data-staff-id="@user.StaffId">
											<td>
												@user.StaffName (@user.Role.GetDisplayName()) @(UserContext.StaffId == user.StaffId ? "(You)" : "")
											</td>

											<td>

												<button type="button" class="@(UserContext.IsSuperAdmin?"btn-delete-user":"") btn btn-sm btn-danger"
														data-bs-toggle="tooltip"
														data-bs-placement="top"
														data-department="Account"
														value="@user.StaffId"
														data-name="@user.StaffName">
													<i class="fa fa-trash"></i>
												</button>
											</td>
										</tr>
									}
								}
							</tbody>
						</table>

						@if (UserContext.IsSuperAdmin)
						{
							<div class="divider-line"></div>

							<div class="row">

								<div class="col-md-6">
									<div class="form-group">
										<label for="accountUserStaffId">
											User
											<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The system user assigned to handle this audit work."></i>
										</label>
										<select id="accountUserStaffId" name="staffId" class="form-control select2 ">
											@if (Model.AccountingUserSelections.Count == 0)
											{
												<option disabled value="">No user are handling account of this company</option>
											}
											else
											{
												<option value="">Please select</option>
											}

											@foreach (var user in Model.AccountingUserSelections)
											{
												var isSelected = workVM.AssignedUsers.Any(c => c.StaffId == user.StaffId && c.IsAssignedToAccount);
												if (isSelected)
												{
													<option value="@user.StaffId" disabled>@user.FullName (@user.Role.GetDisplayName())</option>
												}
												else
												{
													<option value="@user.StaffId">@user.FullName (@user.Role.GetDisplayName())</option>
												}
											})

										</select>
									</div>
								</div>
							</div>
						}
					</div>
				</div>
				@if (UserContext.IsSuperAdmin)
				{
					<!-- /.card-body -->
					<div class="card-footer ">
						<button id="btnSubmitRequest" class="btn btn-primary float-end">
							Add
						</button>
					</div>
				}
				<!-- /.card -->
			</div>
		</form>
	</div>

	<div class="col-md-12">
		<!-- jquery validation -->
		<form id="progressForm">
			<div class="card card-secondary">
				<div class="card-header">
					<h3 class="card-title">Progress</h3>
				</div>
				<!-- /.card-header -->
				<!-- form start -->

				<div class="card-body">

					<div class="row">

						<div class="col-md-5">
							<div class="form-group">
								<label for="startDate">Task Start At</label>
								<div class="input-group">
									<input type="text" id="startDate" value="@progress.StartDate.ToFormattedString()" name="startDate" class="form-control" placeholder="Select date" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-5">
							<div class="form-group">
								<label for="endDate">Task End At</label>
								<div class="input-group">
									<input type="text" id="endDate" value="@progress.EndDate.ToFormattedString()" name="endDate" class="form-control" placeholder="Select date" />
									<div class="input-group-append">
										<span class="input-group-text">
											<i class="fa fa-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-2">
							<div class="form-group">
								<label for="timeTakenInDays">
									Used Day
									<i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The total number of days includes the start date."></i>
								</label>
								<input type="text" readonly id="timeTakenInDays" value="@progress.TimeTakenInDays" name="timeTakenInDays" class="form-control" placeholder="(Auto calc)" />

							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="serviceScope">Progress Status</label>
								<select asp-items="workProgressStatus" id="status" name="status" class="form-control select2">
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="progressNote">Progress Note</label>
								<input type="text" id="progressNote" value="@progress.ProgressNote" name="progressNote" class="form-control" placeholder="(Optional)" />
							</div>
						</div>
					</div>
				</div>
				<!-- /.card-body -->
				<div class="card-footer ">
					<button id="btnSubmitRequest" class="btn btn-primary float-end">Save</button>
				</div>

				<!-- /.card -->
			</div>
		</form>
	</div>

</div>



@section Scripts {
	<partial name="_ValidationScriptsPartial" />
	<partial name="_DatatablesScriptsPartial" />

	<script src="~/js/companies/edit-work.js" asp-append-version="true"></script>
	<!-- date-range-picker -->
    }
