@{
    ViewData["Title"] = "AT32Audit";
}

<h1>AT32 Audit</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>AT32 Audit Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 添加表头说明 -->
                <div class="alert alert-info mb-3">
                    <strong>Table Structure:</strong>
                    <br>• Columns 1-9: Basic Information & Billing
                    <br>• Columns 10-14: Audit WIP (days)
                    <br>• Columns 15-20: Audit Work WIP %
                    <br>• Columns 21-27: Review
                </div>

                <table id="taskDatatable" class="table table-bordered table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Company Name</th>
                            <th>Activity</th>
                            <th>Year to do</th>
                            <th>Quarter to do</th>
                            <th>PIC</th>
                            <th>Status</th>
                            <th>Audit Fee</th>
                            <th>Date Billed</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>No of Days</th>
                            <th>Total Field Days</th>
                            <th>Final Result</th>
                            <th>Acc Setup %</th>
                            <th>Ac Summary %</th>
                            <th>Audit Planning %</th>
                            <th>Audit Execution %</th>
                            <th>Audit Completion %</th>
                            <th>Total %</th>
                            <th>1st Review Date</th>
                            <th>1st Review End</th>
                            <th>1st Review Days</th>
                            <th>2nd Review Date</th>
                            <th>2nd Review End</th>
                            <th>2nd Review Days</th>
                            <th>Total Review Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded by DataTable -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 模态框部分保持不变 -->
@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <style>
        /* 确保表格整体滚动 */
        .dataTables_wrapper {
            position: relative;
        }

        .dataTables_scroll {
            border: 1px solid #dee2e6;
        }

        .dataTables_scrollHead {
            background-color: #f8f9fa;
        }

            .dataTables_scrollHead thead th {
                border-bottom: 2px solid #dee2e6;
                font-weight: bold;
            }

        .dataTables_scrollBody {
            max-height: 500px !important;
        }

        /* 响应式调整 */
        @@media (max-width: 768px) {
            .dataTables_scrollBody {
                max-height: 400px !important;
            }
        }
    </style>

    <script>
        let currentEditingId = null;
        let dataTable = null;

        $(document).ready(function() {
            console.log('Document ready, initializing AT32...');
            initializeDataTable();
        });

        function initializeDataTable() {
            console.log('Initializing DataTable...');

            // 如果 DataTable 已经存在，先销毁
            if (dataTable) {
                dataTable.destroy();
            }

            // 初始化 DataTable - 恢复到原来的配置
            dataTable = $('#taskDatatable').DataTable({
                "ajax": {
                    "url": "/api/auditdept/at32/get-all",
                    "type": "GET",
                    "dataSrc": function(response) {
                        console.log('DataTable AJAX response:', response);
                        if (response.success) {
                            return response.data;
                        } else {
                            console.error('API error:', response.message);
                            showAlert('Error loading data: ' + response.message, 'danger');
                            return [];
                        }
                    },
                    "error": function(xhr, error, thrown) {
                        console.error('DataTable AJAX error:', error);
                        console.log('XHR status:', xhr.status);
                        console.log('XHR response:', xhr.responseText);
                        showAlert('Error loading data: ' + error, 'danger');
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "render": function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { "data": "companyName" },
                    { "data": "activity" },
                    { "data": "yeartoDo" },
                    { "data": "quartertodo" },
                    { "data": "pic" },
                    { "data": "status" },
                    {
                        "data": "auditFee",
                        "render": function(data) {
                            return formatNumber(data);
                        }
                    },
                    {
                        "data": "dateBilled",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    {
                        "data": "startDate",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    {
                        "data": "endDate",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    { "data": "noOfDays" },
                    { "data": "totalFieldwkDays" },
                    { "data": "finalResultOverUnder" },
                    {
                        "data": "accSetup",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "assummary",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "auditPlanning",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "auditExecution",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "auditCompleion",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "totalPercent",
                        "render": function(data) {
                            return formatPercentage(data);
                        }
                    },
                    {
                        "data": "reviewDateSent",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    {
                        "data": "reviewEndDate",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    { "data": "reviewOfDays" },
                    {
                        "data": "kKdateSent",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    {
                        "data": "kKendDate",
                        "render": function(data) {
                            return formatDate(data);
                        }
                    },
                    { "data": "kKofDate" },
                    { "data": "totalReviewDays" },
                    {
                        "data": "id",
                        "render": function(data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${data})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${data})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ],
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "scrollX": true,
                "scrollY": "500px",
                "scrollCollapse": true,
                "language": {
                    "emptyTable": "No AT32 audit records found",
                    "loadingRecords": "Loading AT32 records...",
                    "zeroRecords": "No matching records found",
                    "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                    "infoEmpty": "Showing 0 to 0 of 0 entries",
                    "infoFiltered": "(filtered from _MAX_ total entries)"
                },
                "initComplete": function(settings, json) {
                    console.log('DataTable initialization complete');
                }
            });

            console.log('DataTable initialized successfully');
        }

        // 其他函数保持不变...
        function reloadData() {
            console.log('Reloading AT32 data...');
            if (dataTable) {
                dataTable.ajax.reload(null, false);
            }
        }

        function openCreateModal() {
            console.log('Opening create modal for AT32');
            currentEditingId = null;
            $('#modalTitle').text('Add New AT32 Audit Record');
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#taskModal').modal('show');
        }

        function editRecord(id) {
            console.log('Editing AT32 record with ID:', id);

            $.ajax({
                url: '/api/auditdept/at32/get/' + id,
                type: 'GET',
                success: function(response) {
                    console.log('AT32 Edit API response:', response);

                    if (response.success) {
                        const record = response.data;
                        currentEditingId = record.id;

                        console.log('Loading AT32 record data:', record);

                        $('#modalTitle').text('Edit AT32 Audit Record');
                        $('#recordId').val(record.id);

                        // 填充表单字段
                        $('#companyName').val(record.companyName || '');
                        $('#activity').val(record.activity || '');
                        $('#yeartoDo').val(record.yeartoDo || '');
                        $('#quartertodo').val(record.quartertodo || '');
                        $('#pic').val(record.pic || '');
                        $('#status').val(record.status || '');
                        $('#auditFee').val(record.auditFee || '');
                        $('#dateBilled').val(formatDateForInput(record.dateBilled));
                        $('#startDate').val(formatDateForInput(record.startDate));
                        $('#endDate').val(formatDateForInput(record.endDate));
                        $('#noOfDays').val(record.noOfDays || '');
                        $('#totalFieldwkDays').val(record.totalFieldwkDays || '');
                        $('#finalResultOverUnder').val(record.finalResultOverUnder || '');
                        $('#accSetup').val(record.accSetup || '');
                        $('#assummary').val(record.assummary || '');
                        $('#auditPlanning').val(record.auditPlanning || '');
                        $('#auditExecution').val(record.auditExecution || '');
                        $('#auditCompleion').val(record.auditCompleion || '');
                        $('#totalPercent').val(record.totalPercent || '');
                        $('#reviewDateSent').val(formatDateForInput(record.reviewDateSent));
                        $('#reviewEndDate').val(formatDateForInput(record.reviewEndDate));
                        $('#reviewOfDays').val(record.reviewOfDays || '');
                        $('#kKdateSent').val(formatDateForInput(record.kKdateSent));
                        $('#kKendDate').val(formatDateForInput(record.kKendDate));
                        $('#kKofDate').val(record.kKofDate || '');
                        $('#totalReviewDays').val(record.totalReviewDays || '');

                        $('#taskModal').modal('show');
                    } else {
                        console.error('Error loading AT32 record:', response.message);
                        showAlert('Error loading AT32 record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading AT32 record:', error);
                    showAlert('Error loading AT32 record: ' + error, 'danger');
                }
            });
        }

        function saveRecord() {
            console.log('Saving AT32 record...');

            const formData = {
                companyName: $('#companyName').val(),
                activity: $('#activity').val(),
                yeartoDo: $('#yeartoDo').val(),
                quartertodo: $('#quartertodo').val(),
                pic: $('#pic').val(),
                status: $('#status').val(),
                auditFee: $('#auditFee').val() || null,
                dateBilled: $('#dateBilled').val() || null,
                startDate: $('#startDate').val() || null,
                endDate: $('#endDate').val() || null,
                noOfDays: $('#noOfDays').val() || null,
                totalFieldwkDays: $('#totalFieldwkDays').val() || null,
                finalResultOverUnder: $('#finalResultOverUnder').val(),
                accSetup: $('#accSetup').val() || null,
                assummary: $('#assummary').val() || null,
                auditPlanning: $('#auditPlanning').val() || null,
                auditExecution: $('#auditExecution').val() || null,
                auditCompleion: $('#auditCompleion').val() || null,
                totalPercent: $('#totalPercent').val() || null,
                reviewDateSent: $('#reviewDateSent').val() || null,
                reviewEndDate: $('#reviewEndDate').val() || null,
                reviewOfDays: $('#reviewOfDays').val() || null,
                kKdateSent: $('#kKdateSent').val() || null,
                kKendDate: $('#kKendDate').val() || null,
                kKofDate: $('#kKofDate').val() || null,
                totalReviewDays: $('#totalReviewDays').val() || null
            };

            // Add ID for update
            if (currentEditingId) {
                formData.id = currentEditingId;
            }

            console.log('AT32 Form data to save:', formData);

            // Basic validation
            if (!formData.companyName) {
                showAlert('Company Name is required', 'warning');
                return;
            }

            const url = currentEditingId ? '/api/auditdept/at32/update' : '/api/auditdept/at32/create';
            const method = currentEditingId ? 'PUT' : 'POST';

            console.log(`Making ${method} request to: ${url}`);

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    console.log('AT32 Save response:', response);

                    if (response.success) {
                        const message = `AT32 Record ${currentEditingId ? 'updated' : 'created'} successfully!`;
                        console.log(message);
                        showAlert(message, 'success');
                        $('#taskModal').modal('hide');

                        // 重新加载数据
                        console.log('Reloading AT32 data after save...');
                        reloadData();
                    } else {
                        console.error('AT32 Save failed:', response.message);
                        showAlert('Error saving AT32 record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AT32 Save error:', error);
                    console.log('XHR status:', xhr.status);
                    console.log('XHR response:', xhr.responseText);
                    showAlert('Error saving AT32 record: ' + error, 'danger');
                }
            });
        }

        function deleteRecord(id) {
            console.log('Deleting AT32 record with ID:', id);

            if (confirm('Are you sure you want to delete this AT32 record?')) {
                $.ajax({
                    url: '/api/auditdept/at32/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        console.log('AT32 Delete response:', response);

                        if (response.success) {
                            console.log('AT32 Record deleted successfully');
                            showAlert('AT32 Record deleted successfully!', 'success');
                            reloadData();
                        } else {
                            console.error('AT32 Delete failed:', response.message);
                            showAlert('Error deleting AT32 record: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AT32 Delete error:', error);
                        showAlert('Error deleting AT32 record: ' + error, 'danger');
                    }
                });
            }
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toLocaleDateString('en-GB');
            } catch (e) {
                console.warn('Date formatting error:', e);
                return '';
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
            } catch (e) {
                console.warn('Date input formatting error:', e);
                return '';
            }
        }

        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatPercentage(value) {
            if (value === null || value === undefined || value === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toFixed(1) + '%';
        }

        function showAlert(message, type) {
            console.log(`Showing alert: ${type} - ${message}`);

            const alertClass = `alert alert-${type} alert-dismissible fade show`;
            const alertHtml = `
                <div class="${alertClass}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Remove existing alerts
            $('.alert').remove();

            // Prepend alert to card body
            $('.card-body').prepend(alertHtml);

            // Auto remove after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }

        // 自动计算总百分比
        $('#accSetup, #assummary, #auditPlanning, #auditExecution, #auditCompleion').change(function() {
            var total = parseFloat($('#accSetup').val() || 0) +
                       parseFloat($('#assummary').val() || 0) +
                       parseFloat($('#auditPlanning').val() || 0) +
                       parseFloat($('#auditExecution').val() || 0) +
                       parseFloat($('#auditCompleion').val() || 0);
            $('#totalPercent').val(total.toFixed(1));
        });

        // 自动计算总审核天数
        $('#reviewOfDays, #kKofDate').change(function() {
            var total = parseInt($('#reviewOfDays').val() || 0) +
                       parseInt($('#kKofDate').val() || 0);
            $('#totalReviewDays').val(total);
        });
    </script>
}