@{
    ViewData["Title"] = "Audit Template";
}

<h1>Audit Template</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Audit Template Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <!-- 第一行：主标题 -->
                        <tr>
                            <th colspan="12"></th>
                            <th colspan="18">AT3.2 Audit Work done WIP</th>
                            <th colspan="14"></th>
                        </tr>

                        <tr>
                            <th colspan="12"></th>
                            <th colspan="5">Audit WIP (days)</th>
                            <th colspan="6">Audit Work WIP %</th>
                            <th colspan="7">Review</th>
                            <th colspan="4">AT3.3 Audit Reports from KK</th>
                            <th colspan="4">AT3.4 Directors' signing pages</th>
                            <th colspan="2">5. Tax Dept</th>
                            <th colspan="2">6. Sec Dept</th>
                            <th colspan="2">7. Post Audit Work</th>
                        </tr>

                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Activity</th>
                            <th rowspan="3">Which Database?</th>
                            <th rowspan="3">YE to do</th>
                            <th rowspan="3">Quarter to do</th>
                            <th rowspan="3">PIC</th>
                            <th rowspan="3">Status</th>

                            <th colspan="2">Est current yr result '000</th>
                            <th colspan="2">Billing</th>

                            <th rowspan="3">a. Start Date</th>
                            <th rowspan="3">b. As at</th>
                            <th rowspan="3">c. No of Days</th>
                            <th rowspan="3">Total Field wk days</th>
                            <th rowspan="3">Result Over/Under</th>

                            <th colspan="2">A. Prog tracker %</th>
                            <th colspan="2">B. Task</th>
                            <th colspan="2">A+B+C</th>

                            <th colspan="3">Kuching 1st Review</th>
                            <th colspan="3">2nd Review KK</th>

                            <th rowspan="3">2. Total # review days</th>

                            <th rowspan="3">Date Sent to KK</th>
                            <th rowspan="3">Date received AR</th>
                            <th rowspan="3">Date of Report</th>
                            <th rowspan="3">Date of Directors</th>

                            <th rowspan="3">Date Sent</th>
                            <th rowspan="3">Follow up dates</th>
                            <th rowspan="3">Date received</th>
                            <th rowspan="3">Comm of Oaths date</th>

                            <th rowspan="3">Tax Due Date</th>
                            <th rowspan="3">Pass to Tax Dept</th>

                            <th rowspan="3">SSM Due Date</th>
                            <th rowspan="3">Date pass to Sec Dept(MBRS)</th>

                            <th rowspan="3">Date Binded</th>
                            <th rowspan="3">Despatch Date to Client</th>
                        </tr>

                        <tr>
                            <th>Revenue</th>
                            <th>Profit/(loss)</th>

                            <th>Audit Fee</th>
                            <th>Date billed</th>

                            <th>a. Acc setup(J)</th>
                            <th>b. Ac summary(J)</th>

                            <th>c. Audit Planning(PIC)</th>
                            <th>d. Audit Execution</th>

                            <th>e. Audit Completion(PIC)</th>
                            <th>Total %</th>

                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>A. Result Over/Under</th>

                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>B. Result Over/Under</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audit Template Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name *</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="whichDB">Which Database?</label>
                                <input type="text" id="whichDB" name="whichDB" class="form-control" placeholder="Enter database" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yEtodo">YE to do</label>
                                <input type="text" id="yEtodo" name="yEtodo" class="form-control" placeholder="Enter year end" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quarterTodo">Quarter to do</label>
                                <input type="text" id="quarterTodo" name="quarterTodo" class="form-control" placeholder="Enter quarter" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <input type="text" id="status" name="status" class="form-control" placeholder="Enter status" />
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="form-info-label col-12">
                        <label>Financial Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="revenue">Revenue ('000)</label>
                                <input type="number" id="revenue" name="revenue" class="form-control" placeholder="Enter revenue" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profitLoss">Profit/(Loss) ('000)</label>
                                <input type="number" id="profitLoss" name="profitLoss" class="form-control" placeholder="Enter profit/loss" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="number" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBilled">Date Billed</label>
                                <input type="date" id="dateBilled" name="dateBilled" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit WIP -->
                    <div class="form-info-label col-12">
                        <label>Audit WIP (days)</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="startDate">a. Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="asAt">b. As at</label>
                                <input type="date" id="asAt" name="asAt" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="noOfDays">c. No of Days</label>
                                <input type="number" id="noOfDays" name="noOfDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="totalFieldWkDays">Total Field Work Days</label>
                                <input type="number" id="totalFieldWkDays" name="totalFieldWkDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit Work WIP % -->
                    <div class="form-info-label col-12">
                        <label>Audit Work WIP %</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="accSetup">a. Acc setup(J) %</label>
                                <input type="number" id="accSetup" name="accSetup" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="acSummary">b. Ac summary(J) %</label>
                                <input type="number" id="acSummary" name="acSummary" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditPlanning">c. Audit Planning(PIC) %</label>
                                <input type="number" id="auditPlanning" name="auditPlanning" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditExecution">d. Audit Execution %</label>
                                <input type="number" id="auditExecution" name="auditExecution" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditCompletion">e. Audit Completion(PIC) %</label>
                                <input type="number" id="auditCompletion" name="auditCompletion" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="totalPercent">Total %</label>
                                <input type="number" id="totalPercent" name="totalPercent" class="form-control" placeholder="Enter total percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <!-- Review Section -->
                    <div class="form-info-label col-12">
                        <label>Review</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSent">Date Sent</label>
                                <input type="date" id="dateSent" name="dateSent" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="resultOverUnderKuching">Result Over/Under Kuching</label>
                                <input type="text" id="resultOverUnderKuching" name="resultOverUnderKuching" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSentKK">Date Sent KK</label>
                                <input type="date" id="dateSentKK" name="dateSentKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="endDateKK">End Date KK</label>
                                <input type="date" id="endDateKK" name="endDateKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="resultOverUnderKK">Result Over/Under KK</label>
                                <input type="text" id="resultOverUnderKK" name="resultOverUnderKK" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="totalReviewDaysKK">Total # Review Days KK</label>
                                <input type="number" id="totalReviewDaysKK" name="totalReviewDaysKK" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                    </div>

                    <!-- Additional Sections -->
                    <div class="form-info-label col-12">
                        <label>Additional Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentToKK">Date Sent to KK</label>
                                <input type="date" id="dateSentToKK" name="dateSentToKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedAR">Date Received AR</label>
                                <input type="date" id="dateReceivedAR" name="dateReceivedAR" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateOfReport">Date of Report</label>
                                <input type="date" id="dateOfReport" name="dateOfReport" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateOfDirectorsRept">Date of Directors Report</label>
                                <input type="date" id="dateOfDirectorsRept" name="dateOfDirectorsRept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentSigning">Date Sent Signing</label>
                                <input type="date" id="dateSentSigning" name="dateSentSigning" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="flwUpDate">Follow up Date</label>
                                <input type="date" id="flwUpDate" name="flwUpDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedSigning">Date Received Signing</label>
                                <input type="date" id="dateReceivedSigning" name="dateReceivedSigning" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commOfOathsDate">Comm of Oaths Date</label>
                                <input type="date" id="commOfOathsDate" name="commOfOathsDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxDueDate">Tax Due Date</label>
                                <input type="date" id="taxDueDate" name="taxDueDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="passToTaxDept">Pass to Tax Dept</label>
                                <input type="date" id="passToTaxDept" name="passToTaxDept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssmDueDate">SSM Due Date</label>
                                <input type="date" id="ssmDueDate" name="ssmDueDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datePassToSecDept">Date Pass to Sec Dept</label>
                                <input type="date" id="datePassToSecDept" name="datePassToSecDept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBinded">Date Binded</label>
                                <input type="date" id="dateBinded" name="dateBinded" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="despatchDateToClient">Despatch Date to Client</label>
                                <input type="date" id="despatchDateToClient" name="despatchDateToClient" class="form-control" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            if ($('#modalAlert').length === 0) {
                $('#taskModal .modal-body').prepend('<div id="modalAlert" class="alert d-none"></div>');
            }

            const map = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }

        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }

        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }

        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            try {
                if (s instanceof Date) {
                    return s.toLocaleDateString('en-GB');
                }
                if (typeof s === 'string') {
                    const date = new Date(s);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-GB');
                    }
                }
                return s;
            } catch (e) {
                return s;
            }
        }

        function getVal(obj, name) {
            if (!obj) return '';

            if (obj[name] !== undefined && obj[name] !== null) return obj[name];

            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];

            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#modalTitle').text('Add New Audit Template Record');
            hideModalAlert();
            clearFieldErrors();
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '';
            try {
                return 'RM ' + parseFloat(amount).toLocaleString('en-MY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (e) {
                return amount || '';
            }
        }

        function formatPercentage(value) {
            if (!value && value !== 0) return '';
            try {
                return parseFloat(value) + '%';
            } catch (e) {
                return value || '';
            }
        }

        // ---------- Init ----------
        $(document).ready(function () {
            console.log('Document ready, initializing AT11...');

            // 初始化日期选择器
            try {
                // 将所有日期输入框转换为日期选择器
                $('input[type="date"]').each(function() {
                    const $input = $(this);
                    const currentVal = $input.val();

                    const $textInput = $('<input type="text" class="form-control datepicker">')
                        .val(currentVal ? formatDateForDisplay(currentVal) : '')
                        .attr('placeholder', 'DD/MM/YYYY')
                        .attr('name', $input.attr('name'))
                        .attr('id', $input.attr('id'));

                    $input.replaceWith($textInput);
                });

                $('.datepicker').datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });
                console.log('Datepicker initialized');
            } catch (e) {
                console.error('Datepicker init error:', e);
            }

            // 初始化 DataTable
            try {
                dataTable = $('#taskDatatable').DataTable({
                    responsive: true,
                    ordering: true,
                    autoWidth: true,
                    pageLength: 10,
                    order: [[1, 'asc']],
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        emptyTable: "No records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    columnDefs: [
                        {
                            targets: '_all',
                            defaultContent: ''
                        }
                    ],
                    scrollX: true
                });
                dataTableInitialized = true;
                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('DataTable initialization error:', error);
                $('#taskDatatable').addClass('table table-bordered table-striped');
                dataTableInitialized = false;
            }

            // 绑定按钮事件
            $('#saveBtn').click(saveRecord);

            // 使用事件委托绑定动态按钮
            $(document).on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                console.log('Edit clicked for ID:', id);
                editRecord(id);
            });

            $(document).on('click', '.delete-btn', function () {
                const id = $(this).data('id');
                console.log('Delete clicked for ID:', id);
                deleteRecord(id);
            });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            // 新建按钮点击事件
            $('[data-bs-target="#taskModal"]').on('click', function () {
                console.log('New Task button clicked');
                clearForm();
            });

            // 首次载入数据
            console.log('Loading initial data...');
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            console.log('Loading AT11 records from database...');

            $.ajax({
                url: '/api/auditdept/at11/get-all',
                type: 'GET',
                success: function (res) {
                    console.log('API response:', res);
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                    } else {
                        const errorMsg = res?.message || 'Unknown error';
                        console.error('API error:', errorMsg);
                        showAlert('Failed to load: ' + errorMsg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', error);
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            console.log('Populating table with records:', records);

            if (!dataTableInitialized) {
                console.log('DataTable not initialized, using manual table population');
                manualPopulateTable(records);
                return;
            }

            // 清除现有数据
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    console.log('Processing record:', r);

                    // 构建数据行 - 根据表格结构
                    const rowData = [
                        index + 1, // No
                        getVal(r, 'CompanyName'),                                // Company Name
                        getVal(r, 'Activity'),                                   // Activity
                        getVal(r, 'WhichDB'),                                    // Which Database?
                        getVal(r, 'YEtodo'),                                     // YE to do
                        getVal(r, 'QuarterTodo'),                                // Quarter to do
                        getVal(r, 'PIC'),                                        // PIC
                        getVal(r, 'Status'),                                     // Status
                        formatCurrency(getVal(r, 'Revenue')),                    // Revenue
                        formatCurrency(getVal(r, 'ProfitLoss')),                 // Profit/(loss)
                        formatCurrency(getVal(r, 'AuditFee')),                   // Audit Fee
                        formatDateForDisplay(getVal(r, 'DateBilled')),           // Date billed
                        formatDateForDisplay(getVal(r, 'StartDate')),            // Start Date
                        formatDateForDisplay(getVal(r, 'AsAt')),                 // As at
                        getVal(r, 'NoOfDays') || '',                             // No of Days
                        getVal(r, 'TotalFieldWkDays') || '',                     // Total Field wk days
                        getVal(r, 'ResultOverUnder'),                            // Result Over/Under
                        formatPercentage(getVal(r, 'AccSetup')),                 // Acc setup(J)
                        formatPercentage(getVal(r, 'AcSummary')),                // Ac summary(J)
                        formatPercentage(getVal(r, 'AuditPlanning')),            // Audit Planning(PIC)
                        formatPercentage(getVal(r, 'AuditExecution')),           // Audit Execution
                        formatPercentage(getVal(r, 'AuditCompletion')),          // Audit Completion(PIC)
                        formatPercentage(getVal(r, 'TotalPercent')),             // Total %
                        formatDateForDisplay(getVal(r, 'DateSent')),             // Kuching Review Date Sent
                        formatDateForDisplay(getVal(r, 'EndDate')),              // Kuching Review End Date
                        getVal(r, 'ResultOverUnderKuching'),                     // Kuching Review Result
                        formatDateForDisplay(getVal(r, 'DateSentKK')),           // KK Review Date Sent
                        formatDateForDisplay(getVal(r, 'EndDateKK')),            // KK Review End Date
                        getVal(r, 'ResultOverUnderKK'),                          // KK Review Result
                        getVal(r, 'TotalReviewDaysKK') || '',                    // Total # review days
                        formatDateForDisplay(getVal(r, 'DateSentToKK')),         // Date Sent to KK
                        formatDateForDisplay(getVal(r, 'DateReceivedAR')),       // Date received AR
                        formatDateForDisplay(getVal(r, 'DateOfReport')),         // Date of Report
                        formatDateForDisplay(getVal(r, 'DateOfDirectorsRept')),  // Date of Directors
                        formatDateForDisplay(getVal(r, 'DateSentSigning')),      // Date Sent
                        formatDateForDisplay(getVal(r, 'FlwUpDate')),            // Follow up dates
                        formatDateForDisplay(getVal(r, 'DateReceivedSigning')),  // Date received
                        formatDateForDisplay(getVal(r, 'CommOfOathsDate')),      // Comm of Oaths date
                        formatDateForDisplay(getVal(r, 'TaxDueDate')),           // Tax Due Date
                        formatDateForDisplay(getVal(r, 'PassToTaxDept')),        // Pass to Tax Dept
                        formatDateForDisplay(getVal(r, 'SSMDueDate')),           // SSM Due Date
                        formatDateForDisplay(getVal(r, 'DatePassToSecDept')),    // Date pass to Sec Dept
                        formatDateForDisplay(getVal(r, 'DateBinded')),           // Date Binded
                        formatDateForDisplay(getVal(r, 'DespatchDateToClient')), // Despatch Date to Client
                        // Edit & Delete buttons
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                            <i class="fas fa-edit"></i>
                         </button>
                         <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                            <i class="fas fa-trash"></i>
                         </button>`
                    ];

                    console.log('Adding row data:', rowData);
                    dataTable.row.add(rowData);
                });
            }

            dataTable.draw();
            console.log('Table populated successfully');
        }

        // 降级方案：手动填充表格
        function manualPopulateTable(records) {
            const tbody = $('#tableBody');
            tbody.empty();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${getVal(r, 'CompanyName') || ''}</td>
                            <td>${getVal(r, 'Activity') || ''}</td>
                            <td>${getVal(r, 'WhichDB') || ''}</td>
                            <td>${getVal(r, 'YEtodo') || ''}</td>
                            <td>${getVal(r, 'QuarterTodo') || ''}</td>
                            <td>${getVal(r, 'PIC') || ''}</td>
                            <td>${getVal(r, 'Status') || ''}</td>
                            <td>${formatCurrency(getVal(r, 'Revenue'))}</td>
                            <td>${formatCurrency(getVal(r, 'ProfitLoss'))}</td>
                            <td>${formatCurrency(getVal(r, 'AuditFee'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateBilled'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'StartDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'AsAt'))}</td>
                            <td>${getVal(r, 'NoOfDays') || ''}</td>
                            <td>${getVal(r, 'TotalFieldWkDays') || ''}</td>
                            <td>${getVal(r, 'ResultOverUnder') || ''}</td>
                            <td>${formatPercentage(getVal(r, 'AccSetup'))}</td>
                            <td>${formatPercentage(getVal(r, 'AcSummary'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditPlanning'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditExecution'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditCompletion'))}</td>
                            <td>${formatPercentage(getVal(r, 'TotalPercent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'EndDate'))}</td>
                            <td>${getVal(r, 'ResultOverUnderKuching') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSentKK'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'EndDateKK'))}</td>
                            <td>${getVal(r, 'ResultOverUnderKK') || ''}</td>
                            <td>${getVal(r, 'TotalReviewDaysKK') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSentToKK'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateReceivedAR'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateOfReport'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateOfDirectorsRept'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSentSigning'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'FlwUpDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateReceivedSigning'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'CommOfOathsDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'TaxDueDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'PassToTaxDept'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'SSMDueDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DatePassToSecDept'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateBinded'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DespatchDateToClient'))}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="48" class="text-center">No audit template records found</td></tr>');
            }
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            console.log('Save button clicked');
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#recordId').val() || '0').trim(),

                CompanyName: ($('#companyName').val() || '').trim(),
                Activity: ($('#activity').val() || '').trim(),
                WhichDB: ($('#whichDB').val() || '').trim(),
                YEtodo: ($('#yEtodo').val() || '').trim(),
                QuarterTodo: ($('#quarterTodo').val() || '').trim(),
                PIC: ($('#pic').val() || '').trim(),
                Status: ($('#status').val() || '').trim(),
                Revenue: ($('#revenue').val() || '').trim(),
                ProfitLoss: ($('#profitLoss').val() || '').trim(),
                AuditFee: ($('#auditFee').val() || '').trim(),
                DateBilled: ($('#dateBilled').val() || '').trim(),
                StartDate: ($('#startDate').val() || '').trim(),
                AsAt: ($('#asAt').val() || '').trim(),
                NoOfDays: ($('#noOfDays').val() || '').trim(),
                TotalFieldWkDays: ($('#totalFieldWkDays').val() || '').trim(),
                ResultOverUnder: ($('#resultOverUnder').val() || '').trim(),
                AccSetup: ($('#accSetup').val() || '').trim(),
                AcSummary: ($('#acSummary').val() || '').trim(),
                AuditPlanning: ($('#auditPlanning').val() || '').trim(),
                AuditExecution: ($('#auditExecution').val() || '').trim(),
                AuditCompletion: ($('#auditCompletion').val() || '').trim(),
                TotalPercent: ($('#totalPercent').val() || '').trim(),
                DateSent: ($('#dateSent').val() || '').trim(),
                EndDate: ($('#endDate').val() || '').trim(),
                ResultOverUnderKuching: ($('#resultOverUnderKuching').val() || '').trim(),
                DateSentKK: ($('#dateSentKK').val() || '').trim(),
                EndDateKK: ($('#endDateKK').val() || '').trim(),
                ResultOverUnderKK: ($('#resultOverUnderKK').val() || '').trim(),
                TotalReviewDaysKK: ($('#totalReviewDaysKK').val() || '').trim(),
                DateSentToKK: ($('#dateSentToKK').val() || '').trim(),
                DateReceivedAR: ($('#dateReceivedAR').val() || '').trim(),
                DateOfReport: ($('#dateOfReport').val() || '').trim(),
                DateOfDirectorsRept: ($('#dateOfDirectorsRept').val() || '').trim(),
                DateSentSigning: ($('#dateSentSigning').val() || '').trim(),
                FlwUpDate: ($('#flwUpDate').val() || '').trim(),
                DateReceivedSigning: ($('#dateReceivedSigning').val() || '').trim(),
                CommOfOathsDate: ($('#commOfOathsDate').val() || '').trim(),
                TaxDueDate: ($('#taxDueDate').val() || '').trim(),
                PassToTaxDept: ($('#passToTaxDept').val() || '').trim(),
                SSMDueDate: ($('#ssmDueDate').val() || '').trim(),
                DatePassToSecDept: ($('#datePassToSecDept').val() || '').trim(),
                DateBinded: ($('#dateBinded').val() || '').trim(),
                DespatchDateToClient: ($('#despatchDateToClient').val() || '').trim()
            };

            console.log('Form data:', formData);

            // 简单必填验证
            let hasError = false;
            if (!formData.CompanyName) {
                setFieldError('#companyName', 'Company Name is required');
                hasError = true;
            }

            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/api/auditdept/at11/update' : '/api/auditdept/at11/create';
            const method = isUpdate ? 'PUT' : 'POST';

            console.log('Saving via:', url, method);

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    console.log('Save response:', res);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Save error:', error);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            console.log('Editing record ID:', id);
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: '/api/auditdept/at11/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Audit Template Record');
                    if (res && res.success) {
                        const d = res.data || {};
                        console.log('Edit data loaded:', d);

                        $('#recordId').val(getVal(d, 'Id'));

                        // 填充表单字段
                        $('#companyName').val(getVal(d, 'CompanyName'));
                        $('#activity').val(getVal(d, 'Activity'));
                        $('#whichDB').val(getVal(d, 'WhichDB'));
                        $('#yEtodo').val(getVal(d, 'YEtodo'));
                        $('#quarterTodo').val(getVal(d, 'QuarterTodo'));
                        $('#pic').val(getVal(d, 'PIC'));
                        $('#status').val(getVal(d, 'Status'));
                        $('#revenue').val(getVal(d, 'Revenue'));
                        $('#profitLoss').val(getVal(d, 'ProfitLoss'));
                        $('#auditFee').val(getVal(d, 'AuditFee'));
                        $('#dateBilled').val(formatDateForInput(getVal(d, 'DateBilled')));
                        $('#startDate').val(formatDateForInput(getVal(d, 'StartDate')));
                        $('#asAt').val(formatDateForInput(getVal(d, 'AsAt')));
                        $('#noOfDays').val(getVal(d, 'NoOfDays'));
                        $('#totalFieldWkDays').val(getVal(d, 'TotalFieldWkDays'));
                        $('#resultOverUnder').val(getVal(d, 'ResultOverUnder'));
                        $('#accSetup').val(getVal(d, 'AccSetup'));
                        $('#acSummary').val(getVal(d, 'AcSummary'));
                        $('#auditPlanning').val(getVal(d, 'AuditPlanning'));
                        $('#auditExecution').val(getVal(d, 'AuditExecution'));
                        $('#auditCompletion').val(getVal(d, 'AuditCompletion'));
                        $('#totalPercent').val(getVal(d, 'TotalPercent'));
                        $('#dateSent').val(formatDateForInput(getVal(d, 'DateSent')));
                        $('#endDate').val(formatDateForInput(getVal(d, 'EndDate')));
                        $('#resultOverUnderKuching').val(getVal(d, 'ResultOverUnderKuching'));
                        $('#dateSentKK').val(formatDateForInput(getVal(d, 'DateSentKK')));
                        $('#endDateKK').val(formatDateForInput(getVal(d, 'EndDateKK')));
                        $('#resultOverUnderKK').val(getVal(d, 'ResultOverUnderKK'));
                        $('#totalReviewDaysKK').val(getVal(d, 'TotalReviewDaysKK'));
                        $('#dateSentToKK').val(formatDateForInput(getVal(d, 'DateSentToKK')));
                        $('#dateReceivedAR').val(formatDateForInput(getVal(d, 'DateReceivedAR')));
                        $('#dateOfReport').val(formatDateForInput(getVal(d, 'DateOfReport')));
                        $('#dateOfDirectorsRept').val(formatDateForInput(getVal(d, 'DateOfDirectorsRept')));
                        $('#dateSentSigning').val(formatDateForInput(getVal(d, 'DateSentSigning')));
                        $('#flwUpDate').val(formatDateForInput(getVal(d, 'FlwUpDate')));
                        $('#dateReceivedSigning').val(formatDateForInput(getVal(d, 'DateReceivedSigning')));
                        $('#commOfOathsDate').val(formatDateForInput(getVal(d, 'CommOfOathsDate')));
                        $('#taxDueDate').val(formatDateForInput(getVal(d, 'TaxDueDate')));
                        $('#passToTaxDept').val(formatDateForInput(getVal(d, 'PassToTaxDept')));
                        $('#ssmDueDate').val(formatDateForInput(getVal(d, 'SSMDueDate')));
                        $('#datePassToSecDept').val(formatDateForInput(getVal(d, 'DatePassToSecDept')));
                        $('#dateBinded').val(formatDateForInput(getVal(d, 'DateBinded')));
                        $('#despatchDateToClient').val(formatDateForInput(getVal(d, 'DespatchDateToClient')));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit Audit Template Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;

            $.ajax({
                url: '/api/auditdept/at11/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // 日期格式化辅助函数
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return '';
            }
        }

        // 打开创建模态框的函数
        function openCreateModal() {
            clearForm();
            $('#taskModal').modal('show');
        }
    </script>
}