@{
    ViewData["Title"] = "Audit Template";
}

<h1>Audit Template</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Audit Template Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <!-- 第一行：主标题 -->
                        <tr>
                            <th colspan="12"></th>
                            <th colspan="18">AT3.2 Audit Work done WIP</th>
                            <th colspan="14"></th>
                        </tr>

                        <tr>
                            <th colspan="12"></th>
                            <th colspan="5">Audit WIP (days)</th>
                            <th colspan="6">Audit Work WIP %</th>
                            <th colspan="7">Review</th>
                            <th colspan="4">AT3.3 Audit Reports from KK</th>
                            <th colspan="4">AT3.4 Directors' signing pages</th>
                            <th colspan="2">5. Tax Dept</th>
                            <th colspan="2">6. Sec Dept</th>
                            <th colspan="2">7. Post Audit Work</th>
                        </tr>

                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Activity</th>
                            <th rowspan="3">Which Database?</th>
                            <th rowspan="3">YE to do</th>
                            <th rowspan="3">Quarter to do</th>
                            <th rowspan="3">PIC</th>
                            <th rowspan="3">Status</th>

                            <th colspan="2">Est current yr result '000</th>
                            <th colspan="2">Billing</th>

                            <th rowspan="3">a. Start Date</th>
                            <th rowspan="3">b. As at</th>
                            <th rowspan="3">c. No of Days</th>
                            <th rowspan="3">Total Field wk days</th>
                            <th rowspan="3">Result Over/Under</th>

                            <th colspan="2">A. Prog tracker %</th>
                            <th colspan="2">B. Task</th>
                            <th colspan="2">A+B+C</th>

                            <th colspan="3">Kuching 1st Review</th>
                            <th colspan="3">2nd Review KK</th>

                            <th rowspan="3">2. Total # review days</th>

                            <th rowspan="3">Date Sent to KK</th>
                            <th rowspan="3">Date received AR</th>
                            <th rowspan="3">Date of Report</th>
                            <th rowspan="3">Date of Directors</th>

                            <th rowspan="3">Date Sent</th>
                            <th rowspan="3">Follow up dates</th>
                            <th rowspan="3">Date received</th>
                            <th rowspan="3">Comm of Oaths date</th>

                            <th rowspan="3">Tax Due Date</th>
                            <th rowspan="3">Pass to Tax Dept</th>

                            <th rowspan="3">SSM Due Date</th>
                            <th rowspan="3">Date pass to Sec Dept(MBRS)</th>

                            <th rowspan="3">Date Binded</th>
                            <th rowspan="3">Despatch Date to Client</th>
                        </tr>

                        <tr>
                            <th>Revenue</th>
                            <th>Profit/(loss)</th>

                            <th>Audit Fee</th>
                            <th>Date billed</th>

                            <th>a. Acc setup(J)</th>
                            <th>b. Ac summary(J)</th>

                            <th>c. Audit Planning(PIC)</th>
                            <th>d. Audit Execution</th>

                            <th>e. Audit Completion(PIC)</th>
                            <th>Total %</th>

                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>A. Result Over/Under</th>

                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>B. Result Over/Under</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audit Template Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name *</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="whichDB">Which Database?</label>
                                <input type="text" id="whichDB" name="whichDB" class="form-control" placeholder="Enter database" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yEtodo">YE to do</label>
                                <input type="text" id="yEtodo" name="yEtodo" class="form-control" placeholder="Enter year end" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quarterTodo">Quarter to do</label>
                                <input type="text" id="quarterTodo" name="quarterTodo" class="form-control" placeholder="Enter quarter" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <input type="text" id="status" name="status" class="form-control" placeholder="Enter status" />
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="form-info-label col-12">
                        <label>Financial Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="revenue">Revenue ('000)</label>
                                <input type="number" id="revenue" name="revenue" class="form-control" placeholder="Enter revenue" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profitLoss">Profit/(Loss) ('000)</label>
                                <input type="number" id="profitLoss" name="profitLoss" class="form-control" placeholder="Enter profit/loss" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="number" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBilled">Date Billed</label>
                                <input type="date" id="dateBilled" name="dateBilled" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit WIP -->
                    <div class="form-info-label col-12">
                        <label>Audit WIP (days)</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="startDate">a. Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="asAt">b. As at</label>
                                <input type="date" id="asAt" name="asAt" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="noOfDays">c. No of Days</label>
                                <input type="number" id="noOfDays" name="noOfDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="totalFieldWkDays">Total Field Work Days</label>
                                <input type="number" id="totalFieldWkDays" name="totalFieldWkDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit Work WIP % -->
                    <div class="form-info-label col-12">
                        <label>Audit Work WIP %</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="accSetup">a. Acc setup(J) %</label>
                                <input type="number" id="accSetup" name="accSetup" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="acSummary">b. Ac summary(J) %</label>
                                <input type="number" id="acSummary" name="acSummary" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditPlanning">c. Audit Planning(PIC) %</label>
                                <input type="number" id="auditPlanning" name="auditPlanning" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditExecution">d. Audit Execution %</label>
                                <input type="number" id="auditExecution" name="auditExecution" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditCompletion">e. Audit Completion(PIC) %</label>
                                <input type="number" id="auditCompletion" name="auditCompletion" class="form-control" placeholder="Enter percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="totalPercent">Total %</label>
                                <input type="number" id="totalPercent" name="totalPercent" class="form-control" placeholder="Enter total percentage" step="0.01" min="0" max="100" />
                            </div>
                        </div>
                    </div>

                    <!-- Review Section -->
                    <div class="form-info-label col-12">
                        <label>Review</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSent">Date Sent</label>
                                <input type="date" id="dateSent" name="dateSent" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="resultOverUnderKuching">Result Over/Under Kuching</label>
                                <input type="text" id="resultOverUnderKuching" name="resultOverUnderKuching" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateSentKK">Date Sent KK</label>
                                <input type="date" id="dateSentKK" name="dateSentKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="endDateKK">End Date KK</label>
                                <input type="date" id="endDateKK" name="endDateKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="resultOverUnderKK">Result Over/Under KK</label>
                                <input type="text" id="resultOverUnderKK" name="resultOverUnderKK" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="totalReviewDaysKK">Total # Review Days KK</label>
                                <input type="number" id="totalReviewDaysKK" name="totalReviewDaysKK" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                    </div>

                    <!-- Additional Sections -->
                    <div class="form-info-label col-12">
                        <label>Additional Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentToKK">Date Sent to KK</label>
                                <input type="date" id="dateSentToKK" name="dateSentToKK" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedAR">Date Received AR</label>
                                <input type="date" id="dateReceivedAR" name="dateReceivedAR" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateOfReport">Date of Report</label>
                                <input type="date" id="dateOfReport" name="dateOfReport" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateOfDirectorsRept">Date of Directors Report</label>
                                <input type="date" id="dateOfDirectorsRept" name="dateOfDirectorsRept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentSigning">Date Sent Signing</label>
                                <input type="date" id="dateSentSigning" name="dateSentSigning" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="flwUpDate">Follow up Date</label>
                                <input type="date" id="flwUpDate" name="flwUpDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedSigning">Date Received Signing</label>
                                <input type="date" id="dateReceivedSigning" name="dateReceivedSigning" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commOfOathsDate">Comm of Oaths Date</label>
                                <input type="date" id="commOfOathsDate" name="commOfOathsDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxDueDate">Tax Due Date</label>
                                <input type="date" id="taxDueDate" name="taxDueDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="passToTaxDept">Pass to Tax Dept</label>
                                <input type="date" id="passToTaxDept" name="passToTaxDept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssmDueDate">SSM Due Date</label>
                                <input type="date" id="ssmDueDate" name="ssmDueDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datePassToSecDept">Date Pass to Sec Dept</label>
                                <input type="date" id="datePassToSecDept" name="datePassToSecDept" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBinded">Date Binded</label>
                                <input type="date" id="dateBinded" name="dateBinded" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="despatchDateToClient">Despatch Date to Client</label>
                                <input type="date" id="despatchDateToClient" name="despatchDateToClient" class="form-control" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let currentEditingId = null;
        let dataTable = null;

        $(document).ready(function() {
            initializeDataTable();
            loadData();
        });

        function initializeDataTable() {
            dataTable = $('#taskDatatable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "scrollX": true,
                "language": {
                    "emptyTable": "No audit template records found",
                    "loadingRecords": "Loading...",
                    "zeroRecords": "No matching records found"
                }
            });
        }

        function loadData() {
            // 显示加载状态
            if (dataTable) {
                dataTable.clear().draw();
            }

            $.ajax({
                url: '/api/auditdept/at11/get-all',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateTable(response.data);
                    } else {
                        console.error('API response error:', response);
                        showAlert('Error loading data: ' + response.message, 'danger');
                        if (dataTable) {
                            dataTable.clear().draw();
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', error);
                    showAlert('Error loading data: ' + error, 'danger');
                    if (dataTable) {
                        dataTable.clear().draw();
                    }
                }
            });
        }

        function populateTable(data) {
            console.log('Populating table with data:', data);

            if (data && data.length > 0) {
                const formattedData = data.map(function(item, index) {
                    return {
                        id: item.id,
                        index: index + 1,
                        companyName: escapeHtml(item.companyName || ''),
                        activity: escapeHtml(item.activity || ''),
                        whichDB: escapeHtml(item.whichDB || ''),
                        yEtodo: escapeHtml(item.yEtodo || ''),
                        quarterTodo: escapeHtml(item.quarterTodo || ''),
                        pic: escapeHtml(item.pic || ''),
                        status: escapeHtml(item.status || ''),
                        revenue: formatNumber(item.revenue),
                        profitLoss: formatNumber(item.profitLoss),
                        auditFee: formatNumber(item.auditFee),
                        dateBilled: formatDate(item.dateBilled),
                        startDate: formatDate(item.startDate),
                        asAt: formatDate(item.asAt),
                        noOfDays: item.noOfDays || '',
                        totalFieldWkDays: item.totalFieldWkDays || '',
                        resultOverUnder: escapeHtml(item.resultOverUnder || ''),
                        accSetup: formatPercentage(item.accSetup),
                        acSummary: formatPercentage(item.acSummary),
                        auditPlanning: formatPercentage(item.auditPlanning),
                        auditExecution: formatPercentage(item.auditExecution),
                        auditCompletion: formatPercentage(item.auditCompletion),
                        totalPercent: formatPercentage(item.totalPercent),
                        dateSent: formatDate(item.dateSent),
                        endDate: formatDate(item.endDate),
                        resultOverUnderKuching: escapeHtml(item.resultOverUnderKuching || ''),
                        dateSentKK: formatDate(item.dateSentKK),
                        endDateKK: formatDate(item.endDateKK),
                        resultOverUnderKK: escapeHtml(item.resultOverUnderKK || ''),
                        totalReviewDaysKK: item.totalReviewDaysKK || '',
                        dateSentToKK: formatDate(item.dateSentToKK),
                        dateReceivedAR: formatDate(item.dateReceivedAR),
                        dateOfReport: formatDate(item.dateOfReport),
                        dateOfDirectorsRept: formatDate(item.dateOfDirectorsRept),
                        dateSentSigning: formatDate(item.dateSentSigning),
                        flwUpDate: formatDate(item.flwUpDate),
                        dateReceivedSigning: formatDate(item.dateReceivedSigning),
                        commOfOathsDate: formatDate(item.commOfOathsDate),
                        taxDueDate: formatDate(item.taxDueDate),
                        passToTaxDept: formatDate(item.passToTaxDept),
                        ssmDueDate: formatDate(item.ssmDueDate),
                        datePassToSecDept: formatDate(item.datePassToSecDept),
                        dateBinded: formatDate(item.dateBinded),
                        despatchDateToClient: formatDate(item.despatchDateToClient)
                    };
                });

                // 清空现有数据并重新绘制
                const tbody = $('#tableBody');
                tbody.empty();

                formattedData.forEach(function(item) {
                    const row = `
                        <tr>
                            <td>${item.index}</td>
                            <td>${item.companyName}</td>
                            <td>${item.activity}</td>
                            <td>${item.whichDB}</td>
                            <td>${item.yEtodo}</td>
                            <td>${item.quarterTodo}</td>
                            <td>${item.pic}</td>
                            <td>${item.status}</td>
                            <td>${item.revenue}</td>
                            <td>${item.profitLoss}</td>
                            <td>${item.auditFee}</td>
                            <td>${item.dateBilled}</td>
                            <td>${item.startDate}</td>
                            <td>${item.asAt}</td>
                            <td>${item.noOfDays}</td>
                            <td>${item.totalFieldWkDays}</td>
                            <td>${item.resultOverUnder}</td>
                            <td>${item.accSetup}</td>
                            <td>${item.acSummary}</td>
                            <td>${item.auditPlanning}</td>
                            <td>${item.auditExecution}</td>
                            <td>${item.auditCompletion}</td>
                            <td>${item.totalPercent}</td>
                            <td>${item.dateSent}</td>
                            <td>${item.endDate}</td>
                            <td>${item.resultOverUnderKuching}</td>
                            <td>${item.dateSentKK}</td>
                            <td>${item.endDateKK}</td>
                            <td>${item.resultOverUnderKK}</td>
                            <td>${item.totalReviewDaysKK}</td>
                            <td>${item.dateSentToKK}</td>
                            <td>${item.dateReceivedAR}</td>
                            <td>${item.dateOfReport}</td>
                            <td>${item.dateOfDirectorsRept}</td>
                            <td>${item.dateSentSigning}</td>
                            <td>${item.flwUpDate}</td>
                            <td>${item.dateReceivedSigning}</td>
                            <td>${item.commOfOathsDate}</td>
                            <td>${item.taxDueDate}</td>
                            <td>${item.passToTaxDept}</td>
                            <td>${item.ssmDueDate}</td>
                            <td>${item.datePassToSecDept}</td>
                            <td>${item.dateBinded}</td>
                            <td>${item.despatchDateToClient}</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${item.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${item.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                if (dataTable) {
                    dataTable.destroy();
                }
                initializeDataTable();
            } else {
                const tbody = $('#tableBody');
                tbody.empty();
                tbody.append('<tr><td colspan="48" class="text-center">No audit template records found</td></tr>');

                if (dataTable) {
                    dataTable.destroy();
                }
                initializeDataTable();
            }
        }

        function openCreateModal() {
            currentEditingId = null;
            $('#modalTitle').text('Add New Audit Template Record');
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#taskModal').modal('show');
        }

        function editRecord(id) {
            $.ajax({
                url: '/api/auditdept/at11/get/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditingId = record.id;

                        $('#modalTitle').text('Edit Audit Template Record');
                        $('#recordId').val(record.id);

                        // 填充表单字段
                        $('#companyName').val(record.companyName || '');
                        $('#activity').val(record.activity || '');
                        $('#whichDB').val(record.whichDB || '');
                        $('#yEtodo').val(record.yEtodo || '');
                        $('#quarterTodo').val(record.quarterTodo || '');
                        $('#pic').val(record.pic || '');
                        $('#status').val(record.status || '');
                        $('#revenue').val(record.revenue || '');
                        $('#profitLoss').val(record.profitLoss || '');
                        $('#auditFee').val(record.auditFee || '');
                        $('#dateBilled').val(formatDateForInput(record.dateBilled));
                        $('#startDate').val(formatDateForInput(record.startDate));
                        $('#asAt').val(formatDateForInput(record.asAt));
                        $('#noOfDays').val(record.noOfDays || '');
                        $('#totalFieldWkDays').val(record.totalFieldWkDays || '');
                        $('#resultOverUnder').val(record.resultOverUnder || '');
                        $('#accSetup').val(record.accSetup || '');
                        $('#acSummary').val(record.acSummary || '');
                        $('#auditPlanning').val(record.auditPlanning || '');
                        $('#auditExecution').val(record.auditExecution || '');
                        $('#auditCompletion').val(record.auditCompletion || '');
                        $('#totalPercent').val(record.totalPercent || '');
                        $('#dateSent').val(formatDateForInput(record.dateSent));
                        $('#endDate').val(formatDateForInput(record.endDate));
                        $('#resultOverUnderKuching').val(record.resultOverUnderKuching || '');
                        $('#dateSentKK').val(formatDateForInput(record.dateSentKK));
                        $('#endDateKK').val(formatDateForInput(record.endDateKK));
                        $('#resultOverUnderKK').val(record.resultOverUnderKK || '');
                        $('#totalReviewDaysKK').val(record.totalReviewDaysKK || '');
                        $('#dateSentToKK').val(formatDateForInput(record.dateSentToKK));
                        $('#dateReceivedAR').val(formatDateForInput(record.dateReceivedAR));
                        $('#dateOfReport').val(formatDateForInput(record.dateOfReport));
                        $('#dateOfDirectorsRept').val(formatDateForInput(record.dateOfDirectorsRept));
                        $('#dateSentSigning').val(formatDateForInput(record.dateSentSigning));
                        $('#flwUpDate').val(formatDateForInput(record.flwUpDate));
                        $('#dateReceivedSigning').val(formatDateForInput(record.dateReceivedSigning));
                        $('#commOfOathsDate').val(formatDateForInput(record.commOfOathsDate));
                        $('#taxDueDate').val(formatDateForInput(record.taxDueDate));
                        $('#passToTaxDept').val(formatDateForInput(record.passToTaxDept));
                        $('#ssmDueDate').val(formatDateForInput(record.ssmDueDate));
                        $('#datePassToSecDept').val(formatDateForInput(record.datePassToSecDept));
                        $('#dateBinded').val(formatDateForInput(record.dateBinded));
                        $('#despatchDateToClient').val(formatDateForInput(record.despatchDateToClient));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading record: ' + error, 'danger');
                }
            });
        }

        function saveRecord() {
            const formData = {
                companyName: $('#companyName').val(),
                activity: $('#activity').val(),
                whichDB: $('#whichDB').val(),
                yEtodo: $('#yEtodo').val(),
                quarterTodo: $('#quarterTodo').val(),
                pic: $('#pic').val(),
                status: $('#status').val(),
                revenue: $('#revenue').val() || null,
                profitLoss: $('#profitLoss').val() || null,
                auditFee: $('#auditFee').val() || null,
                dateBilled: $('#dateBilled').val() || null,
                startDate: $('#startDate').val() || null,
                asAt: $('#asAt').val() || null,
                noOfDays: $('#noOfDays').val() || null,
                totalFieldWkDays: $('#totalFieldWkDays').val() || null,
                resultOverUnder: $('#resultOverUnder').val(),
                accSetup: $('#accSetup').val() || null,
                acSummary: $('#acSummary').val() || null,
                auditPlanning: $('#auditPlanning').val() || null,
                auditExecution: $('#auditExecution').val() || null,
                auditCompletion: $('#auditCompletion').val() || null,
                totalPercent: $('#totalPercent').val() || null,
                dateSent: $('#dateSent').val() || null,
                endDate: $('#endDate').val() || null,
                resultOverUnderKuching: $('#resultOverUnderKuching').val(),
                dateSentKK: $('#dateSentKK').val() || null,
                endDateKK: $('#endDateKK').val() || null,
                resultOverUnderKK: $('#resultOverUnderKK').val(),
                totalReviewDaysKK: $('#totalReviewDaysKK').val() || null,
                dateSentToKK: $('#dateSentToKK').val() || null,
                dateReceivedAR: $('#dateReceivedAR').val() || null,
                dateOfReport: $('#dateOfReport').val() || null,
                dateOfDirectorsRept: $('#dateOfDirectorsRept').val() || null,
                dateSentSigning: $('#dateSentSigning').val() || null,
                flwUpDate: $('#flwUpDate').val() || null,
                dateReceivedSigning: $('#dateReceivedSigning').val() || null,
                commOfOathsDate: $('#commOfOathsDate').val() || null,
                taxDueDate: $('#taxDueDate').val() || null,
                passToTaxDept: $('#passToTaxDept').val() || null,
                ssmDueDate: $('#ssmDueDate').val() || null,
                datePassToSecDept: $('#datePassToSecDept').val() || null,
                dateBinded: $('#dateBinded').val() || null,
                despatchDateToClient: $('#despatchDateToClient').val() || null
            };

            // Add ID for update
            if (currentEditingId) {
                formData.id = currentEditingId;
            }

            // Basic validation
            if (!formData.companyName) {
                showAlert('Company Name is required', 'warning');
                return;
            }

            const url = currentEditingId ? '/api/auditdept/at11/update' : '/api/auditdept/at11/create';
            const method = currentEditingId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        showAlert(`Record ${currentEditingId ? 'updated' : 'created'} successfully!`, 'success');
                        $('#taskModal').modal('hide');
                        loadData();
                    } else {
                        showAlert('Error saving record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error saving record: ' + error, 'danger');
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '/api/auditdept/at11/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('Record deleted successfully!', 'success');
                            loadData();
                        } else {
                            showAlert('Error deleting record: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error deleting record: ' + error, 'danger');
                    }
                });
            }
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toLocaleDateString('en-GB');
            } catch (e) {
                return '';
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        }

        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatPercentage(value) {
            if (value === null || value === undefined || value === '') return '';
            const num = parseFloat(value);
            return isNaN(num) ? '' : num.toFixed(1) + '%';
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showAlert(message, type) {
            const alertClass = `alert alert-${type} alert-dismissible fade show`;
            const alertHtml = `
                <div class="${alertClass}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Remove existing alerts
            $('.alert').remove();

            // Prepend alert to card body
            $('.card-body').prepend(alertHtml);

            // Auto remove after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
}