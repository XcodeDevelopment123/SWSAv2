@{
    ViewData["Title"] = "AEX41S";
}

<h1>AEX Scheduling For Current Year</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openAddModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>Grouping</th>
                            <th>Company Name</th>
                            <th>Quarter to Audit</th>
                            <th>Activity</th>
                            <th>Year End</th>
                            <th>Year to do</th>
                            <th>Move to Active Sch</th>
                            <th>Move to Backlog</th>
                            <th>1st 18 mths due</th>
                            <th>Audited Acc due date</th>
                            <th>Co Sec?</th>
                            <th>Team</th>
                            <th>Date Doc in</th>
                            <th>Est Rev</th>
                            <th>Est Net Profit/(loss)'000</th>
                            <th>Acctng wk?</th>
                            <th>Job Completed</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AEX Schedule Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="quarterToAudit">Quarter to Audit</label>
                                <select id="quarterToAudit" name="quarterToAudit" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Options -->
                    <div class="form-info-label col-12">
                        <label>Schedule Options</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="moveToActiveSch">Move to Active Sch</label>
                                <select id="moveToActiveSch" name="moveToActiveSch" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="moveToBacklog">Move to Backlog</label>
                                <select id="moveToBacklog" name="moveToBacklog" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="first18MonthsDue">1st 18 mths due</label>
                                <input type="text" id="first18MonthsDue" name="first18MonthsDue" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Due Dates & Team -->
                    <div class="form-info-label col-12">
                        <label>Due Dates & Team</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditedAccDueDate">Audited Acc due date</label>
                                <input type="text" id="auditedAccDueDate" name="auditedAccDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coSec">Co Sec?</label>
                                <select id="coSec" name="coSec" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="team">Team</label>
                                <input type="text" id="team" name="team" class="form-control" placeholder="Enter team name" />
                            </div>
                        </div>
                    </div>

                    <!-- Document & Financial Information -->
                    <div class="form-info-label col-12">
                        <label>Document & Financial Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateDocIn">Date Doc in</label>
                                <input type="text" id="dateDocIn" name="dateDocIn" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="estRev">Est Rev</label>
                                <input type="number" id="estRev" name="estRev" class="form-control" placeholder="Enter estimated revenue" step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="estNetProfit">Est Net Profit/(loss)'000</label>
                                <input type="number" id="estNetProfit" name="estNetProfit" class="form-control" placeholder="Enter estimated net profit/loss" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Information -->
                    <div class="form-info-label col-12">
                        <label>Completion Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="acctngWk">Acctng wk?</label>
                                <select id="acctngWk" name="acctngWk" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="jobCompleted">Job Completed</label>
                                <select id="jobCompleted" name="jobCompleted" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="remark">Remark</label>
                                <input type="text" id="remark" name="remark" class="form-control" placeholder="Enter remark" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let clientNameMap = {};
        let clientDataMap = {};

        $(document).ready(function() {
            // 确保隐藏字段存在
            if ($('#companyName').length === 0) {
                $('#taskForm').append('<input type="hidden" id="companyName" name="companyName" />');
            }

            // 1. 初始化日期选择器 (重要：必须在所有逻辑之前)
            // 注意：yearEnd 虽然是只读，但如果初始化了datepicker，就要用它的API赋值
            $('#first18MonthsDue, #auditedAccDueDate, #dateDocIn, #yearEnd').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true,
                enableOnReadonly: false // 确保 readonly 字段也能显示但不可选(视需求而定)
            });

            // 2. 加载数据和 Dropdown
            loadClientOptions();
            initializeDataTable();
            loadData();

            // 3. 绑定 Dropdown 变动事件
            $('#clientSelect').on('change', function() {
                handleClientChange($(this).val());
            });

            $('#saveBtn').click(function() { saveRecord(); });
        });

        // --- 核心修复：自动计算与赋值 ---
        function handleClientChange(selectedId) {
            const clientData = clientDataMap[selectedId];

            if (clientData) {
                $('#grouping').val(clientData.grouping || '');

                // 填充隐藏字段
                $('#companyName').val(clientData.companyName);
                $('#clientId').val(clientData.id);
                $('#client').val(clientData.companyName);

                // 计算 Year End
                if (clientData.yearEndMonth) {
                    const calculatedDate = calculateYearEndDate(clientData.yearEndMonth);

                    // 【修复点】：使用 datepicker('update') 方法赋值
                    // 这样既能更新 input 的 value，也能更新 datepicker 的内部状态
                    $('#yearEnd').datepicker('update', calculatedDate);
                } else {
                    $('#yearEnd').val('').datepicker('update', '');
                }
            } else {
                // 清空
                $('#grouping').val('');
                $('#companyName').val('');
                $('#clientId').val('');
                $('#client').val('');
                $('#yearEnd').val('').datepicker('update', '');
            }
        }

        // --- 你的日期计算逻辑 ---
        function formatJsDate(date) {
            if (!date) return '';
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function calculateYearEndDate(monthName) {
            if (!monthName) return '';
            const months = {
                "january": 0, "february": 1, "march": 2, "april": 3, "may": 4, "june": 5,
                "july": 6, "august": 7, "september": 8, "october": 9, "november": 10, "december": 11
            };
            const cleanName = monthName.trim().toLowerCase();
            const monthIndex = months[cleanName];

            if (monthIndex === undefined) return '';

            const currentYear = new Date().getFullYear();
            // 获取该月最后一天 (下个月的第0天 = 本月最后一天)
            const date = new Date(currentYear, monthIndex + 1, 0);

            return formatJsDate(date);
        }

        // --- 其他 Dropdown 加载逻辑 (保持不变) ---
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const select = $('#clientSelect');
                        select.empty();
                        select.append('<option value="">-- Select client --</option>');

                        clientNameMap = {};
                        clientDataMap = {};

                        response.data.forEach(client => {
                            if(client.companyName) {
                                clientNameMap[client.companyName.trim()] = client.id;
                            }
                            clientDataMap[client.id] = client;
                            select.append(`<option value="${client.id}">${client.companyName}</option>`);
                        });
                    }
                }
            });
        }

        // --- DataTable & CRUD (保持不变) ---
        function initializeDataTable() {
            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }
            dataTable = $('#taskDatatable').DataTable({
                responsive: true,
                autoWidth: false,
                pageLength: 10,
                columnDefs: [{ "orderable": false, "targets": 0 }]
            });
        }

        function loadData() {
            if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                $('#taskDatatable').DataTable().destroy();
            }
            $.ajax({
                url: '/api/auditdept/aex41/get-all',
                type: 'GET',
                cache: false,
                success: function(response) {
                    if (response.success) {
                        displayData(response.data);
                    } else {
                        alert('Error: ' + response.message);
                        displayData([]);
                    }
                },
                error: function(xhr) { alert('Error loading data'); }
            });
        }

        function displayData(data) {
            const tbody = $('#taskDatatable tbody');
            tbody.empty();
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    const row = `
                        <tr>
                            <td>${createActionButtons(item.id)}</td>
                            <td>${escapeHtml(item.grouping)}</td>
                            <td>${escapeHtml(item.companyName)}</td>
                            <td>${escapeHtml(item.quartertoAudit)}</td>
                            <td>${escapeHtml(item.activity)}</td>
                            <td>${formatDate(item.yearEnd)}</td>
                            <td>${escapeHtml(item.yeattodo)}</td>
                            <td>${escapeHtml(item.movetoActiveSch)}</td>
                            <td>${escapeHtml(item.movetoBacklog)}</td>
                            <td>${formatDate(item.first18mthsdue)}</td>
                            <td>${formatDate(item.auditedAccDueDate)}</td>
                            <td>${escapeHtml(item.coSec)}</td>
                            <td>${escapeHtml(item.team)}</td>
                            <td>${formatDate(item.dateDocIn)}</td>
                            <td>${formatNumber(item.estRev)}</td>
                            <td>${formatNumber(item.estNetProfit)}</td>
                            <td>${escapeHtml(item.acctngWk)}</td>
                            <td>${escapeHtml(item.jobCompleted)}</td>
                            <td>${escapeHtml(item.remark)}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
            $('#taskDatatable').DataTable({ responsive: true, autoWidth: false });
        }

        function createActionButtons(id) {
            return `<div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="editRecord(${id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord(${id})"><i class="fas fa-trash"></i></button>
                    </div>`;
        }

        function openAddModal() {
            $('#modalTitle').text('Add New AEX Schedule Record');
            $('#recordId').val('');
            $('#taskForm')[0].reset();
            $('#clientSelect').val('');
            $('.datepicker').datepicker('update', ''); // 重置所有日期选择器
            $('#taskModal').modal('show');
        }

        function editRecord(id) {
            $.ajax({
                url: `/api/auditdept/aex41/get/${id}`,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const data = response.data;
                        $('#modalTitle').text('Edit AEX Schedule Record');
                        $('#recordId').val(data.id);

                        // Dropdown 回显
                        $('#companyName').val(data.companyName || '');
                        if (data.clientId && clientDataMap[data.clientId]) {
                            $('#clientSelect').val(data.clientId);
                        } else if (data.companyName && clientNameMap[data.companyName.trim()]) {
                            $('#clientSelect').val(clientNameMap[data.companyName.trim()]);
                        }

                        // 填充其他字段
                        $('#grouping').val(data.grouping || '');
                        $('#quarterToAudit').val(data.quartertoAudit || '');
                        $('#activity').val(data.activity || '');

                        // 【重要】日期字段用 datepicker('update')
                        $('#yearEnd').datepicker('update', formatDate(data.yearEnd));
                        $('#first18MonthsDue').datepicker('update', formatDate(data.first18mthsdue));
                        $('#auditedAccDueDate').datepicker('update', formatDate(data.auditedAccDueDate));
                        $('#dateDocIn').datepicker('update', formatDate(data.dateDocIn));

                        $('#yearToDo').val(data.yeattodo || '');
                        $('#moveToActiveSch').val(data.movetoActiveSch || '');
                        $('#moveToBacklog').val(data.movetoBacklog || '');
                        $('#coSec').val(data.coSec || '');
                        $('#team').val(data.team || '');
                        $('#estRev').val(data.estRev || '');
                        $('#estNetProfit').val(data.estNetProfit || '');
                        $('#acctngWk').val(data.acctngWk || '');
                        $('#jobCompleted').val(data.jobCompleted || '');
                        $('#remark').val(data.remark || '');

                        $('#taskModal').modal('show');
                    } else { alert(response.message); }
                }
            });
        }

        function saveRecord() {
            const id = $('#recordId').val();
            const isEdit = id !== '';
            const companyName = $('#companyName').val(); // 从隐藏字段取值

            if (!companyName) { alert('Client is required'); return; }

            const btn = $('#saveBtn');
            btn.prop('disabled', true).html('Saving...');

            const data = {
                id: isEdit ? parseInt(id) : 0,
                grouping: $('#grouping').val(),
                companyName: companyName,
                quartertoAudit: $('#quarterToAudit').val(),
                activity: $('#activity').val(),
                // YearEnd 是自动计算并显示的，也要提交回去
                yearEnd: convertDateToISO($('#yearEnd').val()),
                yeattodo: $('#yearToDo').val(),
                movetoActiveSch: $('#moveToActiveSch').val(),
                movetoBacklog: $('#moveToBacklog').val(),
                first18mthsdue: convertDateToISO($('#first18MonthsDue').val()),
                auditedAccDueDate: convertDateToISO($('#auditedAccDueDate').val()),
                coSec: $('#coSec').val(),
                team: $('#team').val(),
                dateDocIn: convertDateToISO($('#dateDocIn').val()),
                estRev: $('#estRev').val(),
                estNetProfit: $('#estNetProfit').val(),
                acctngWk: $('#acctngWk').val(),
                jobCompleted: $('#jobCompleted').val(),
                remark: $('#remark').val()
            };

            const url = isEdit ? '/api/auditdept/aex41/update' : '/api/auditdept/aex41/create';
            const method = isEdit ? 'PUT' : 'POST';

            $.ajax({
                url: url, type: method, contentType: 'application/json', data: JSON.stringify(data),
                success: function(res) {
                    btn.prop('disabled', false).html('Save');
                    if (res.success) {
                        alert('Saved successfully');
                        $('#taskModal').modal('hide');
                        loadData();
                    } else { alert('Error: ' + res.message); }
                },
                error: function(err) {
                    btn.prop('disabled', false).html('Save');
                    alert('Save error');
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Delete record?')) {
                $.ajax({
                    url: `/api/auditdept/aex41/delete/${id}`, type: 'DELETE',
                    success: function(res) {
                        if (res.success) { loadData(); }
                        else { alert(res.message); }
                    }
                });
            }
        }

        // --- Format Helpers ---
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        }

        function convertDateToISO(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : null;
        }

        function formatNumber(n) { return n ? parseFloat(n).toLocaleString('en-US', {minimumFractionDigits:2}) : ''; }
        function escapeHtml(t) { return t ? t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ''; }
    </script>

    <style>
        .form-info-label {
            background-color: #f8f9fa;
            padding: 8px 15px;
            margin: 15px 0 10px 0;
            border-left: 4px solid #007bff;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .btn-group .btn {
            margin-right: 5px;
        }
    </style>
}