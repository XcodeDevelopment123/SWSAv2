@{
    ViewData["Title"] = "AT21AuditMasterSchedule";
}

<h1>AT 2.1 Audit Master Schedule</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Audit Master Schedule
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Grouping</th>
                            <th>Company Name</th>
                            <th>Quarter to Audit</th>
                            <th>Activity</th>
                            <th>Year End</th>
                            <th>Year to do</th>
                            <th>Co Status</th>
                            <th>Audit Status</th>
                            <th>Move to AEX Sch</th>
                            <th>Move to Backlog</th>
                            <th>1st 18mths due</th>
                            <th>AFS due date</th>
                            <th>Co Sec?</th>
                            <th>Audit Staff</th>
                            <th>Date Doc in</th>
                            <th>EST Rev/NP('000)</th>
                            <th>Acctng wk?</th>
                            <th>Job Completed</th>
                            <th>Remark</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audit Master Schedule Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grouping">Grouping</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                               <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit Details -->
                    <div class="form-info-label col-12">
                        <label>Audit Details</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="quartertoAudit">Quarter to Audit</label>
                                <select id="quartertoAudit" name="quartertoAudit" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="date" id="yearEnd" name="yearEnd" class="form-control" placeholder="Auto Fill" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- Company Information -->
                    <div class="form-info-label col-12">
                        <label>Company Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="companyStatus">Co Status</label>
                                <select id="companyStatus" name="companyStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Dormant">Dormant</option>
                                    <option value="Strike Off">Strike Off</option>
                                    <option value="In Liquidation">In Liquidation</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditStatus">Audit Status</label>
                                <select id="auditStatus" name="auditStatus" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Information -->
                    <div class="form-info-label col-12">
                        <label>Schedule Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="movetoAEX">Move to AEX Sch</label>
                                <select id="movetoAEX" name="movetoAEX" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="movetoBacklog">Move to Backlog</label>
                                <select id="movetoBacklog" name="movetoBacklog" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="first18mthdue">1st 18mths due</label>
                                <input type="date" id="first18mthdue" name="first18mthdue" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="aFSdueDate">AFS due date</label>
                                <input type="date" id="aFSdueDate" name="aFSdueDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Staff and Financial Information -->
                    <div class="form-info-label col-12">
                        <label>Staff and Financial Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="coSec">Co Sec?</label>
                                <select id="coSec" name="coSec" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="auditStaff">Audit Staff</label>
                                <input type="text" id="auditStaff" name="auditStaff" class="form-control" placeholder="Enter staff name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="dateDocIn">Date Doc in</label>
                                <input type="date" id="dateDocIn" name="dateDocIn" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="estRev">EST Rev/NP('000)</label>
                                <input type="text" id="estRev" name="estRev" class="form-control" placeholder="e.g., 2,500 / 350" />
                            </div>
                        </div>
                    </div>

                    <!-- Completion Information -->
                    <div class="form-info-label col-12">
                        <label>Completion Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="acctngWk">Acctng wk?</label>
                                <select id="acctngWk" name="acctngWk" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="jobCompleted">Job Completed</label>
                                <select id="jobCompleted" name="jobCompleted" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="remark">Remark</label>
                                <input type="text" id="remark" name="remark" class="form-control" placeholder="Enter remark" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let currentEditingId = null;
        let dataTable = null;
        let currentData = [];

        // 1. 数据映射表
        let clientOptionsMap = {}; // ID -> Client Data (用于自动填 Grouping/YearEnd)
        let clientNameMap = {};    // Company Name -> ID (用于 Edit 时的反向查找)

        $(document).ready(function() {
            console.log('Document ready, initializing...');

            // 确保页面上有 companyName 这个 input
            if ($('#companyName').length === 0) {
                $('#taskForm').append('<input type="hidden" id="companyName" name="companyName" />');
            }

            // 先加载 Dropdown，再加载数据
            loadClientOptions();
            loadData();
        });

        // ---------------------------------------------------------
        //  1. Load Client Options (构建反向查找表)
        // ---------------------------------------------------------
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const select = $('#clientSelect');
                        select.empty();
                        select.append('<option value="">-- Select client --</option>');

                        // 重置映射表
                        clientOptionsMap = {};
                        clientNameMap = {};

                        response.data.forEach(client => {
                            // 1. ID -> Data 映射 (用于 Dropdown Change 事件)
                            clientOptionsMap[client.id] = client;

                            // 2. Name -> ID 映射 (用于 Edit 时只有名字的情况)
                            if (client.companyName) {
                                // 使用 trim() 去除可能的空格，确保匹配准确
                                clientNameMap[client.companyName.trim()] = client.id;
                            }

                            select.append(`<option value="${client.id}">${client.companyName}</option>`);
                        });
                    }
                }
            });
        }

        // ---------------------------------------------------------
        //  2. Dropdown Change Event (自动填充逻辑)
        // ---------------------------------------------------------
        $('#clientSelect').on('change', function() {
            const selectedId = $(this).val();
            const clientData = clientOptionsMap[selectedId];

            if (clientData) {
                // A. 自动填入 Grouping
                $('#grouping').val(clientData.grouping || '');

                // B. 自动填入 Company Name (隐藏字段，用于 Save)
                $('#companyName').val(clientData.companyName);
                $('#client').val(clientData.companyName);
                $('#clientId').val(clientData.id);

                // C. 自动计算 Year End Date
                if (clientData.yearEndMonth) {
                    const yearEndDate = calculateYearEndDateForInput(clientData.yearEndMonth);
                    $('#yearEnd').val(yearEndDate);
                }
            } else {
                // 清空逻辑
                $('#grouping').val('');
                $('#yearEnd').val('');
                $('#companyName').val('');
                $('#client').val('');
                $('#clientId').val('');
            }
        });

        // ---------------------------------------------------------
        //  3. Edit Record (核心：反向查找逻辑)
        // ---------------------------------------------------------
        function editRecord(id) {
            $.ajax({
                url: '/api/auditdept/at21/get/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditingId = record.id;
                        $('#modalTitle').text('Edit Audit Master Schedule Record');
                        $('#recordId').val(record.id);

                        // === 关键逻辑开始：设置 Dropdown ===

                        // 1. 先把名字填入隐藏字段，防止用户不改动直接保存时名字丢失
                        $('#companyName').val(record.companyName || '');

                        // 2. 尝试选中 Dropdown
                        // 情况 A: 记录里有 ClientID，直接用
                        if (record.clientId && clientOptionsMap[record.clientId]) {
                            $('#clientSelect').val(record.clientId);
                        }
                        // 情况 B: 记录里没 ID (或 ID 对不上)，但有名字 -> 反向查找
                        else if (record.companyName) {
                            const cleanName = record.companyName.trim();
                            const foundId = clientNameMap[cleanName]; // 在 Name->ID 表里找

                            if (foundId) {
                                $('#clientSelect').val(foundId); // 找到了！选中它
                                // 同时把 ID 补全到隐藏字段，保证数据完整性
                                $('#clientId').val(foundId);
                            } else {
                                console.warn('Edit Error: Client name found but not in dropdown list:', record.companyName);
                                // 可选：如果找不到，保留为 "Select client" 或者不做处理
                            }
                        }
                        // === 关键逻辑结束 ===

                        // 填充其他字段
                        $('#grouping').val(record.grouping || '');
                        $('#quartertoAudit').val(record.quartertoAudit || '');
                        $('#activity').val(record.activity || '');
                        $('#yearEnd').val(formatDateForInput(record.yearEnd));
                        $('#yearToDo').val(record.yearTodo || '');
                        $('#companyStatus').val(record.companyStatus || '');
                        $('#auditStatus').val(record.auditStatus || '');
                        $('#movetoAEX').val(record.movetoAEX || '');
                        $('#movetoBacklog').val(record.movetoBacklog || '');
                        $('#first18mthdue').val(formatDateForInput(record.first18mthdue));
                        $('#aFSdueDate').val(formatDateForInput(record.afSdueDate));
                        $('#coSec').val(record.coSec || '');
                        $('#auditStaff').val(record.auditStaff || '');
                        $('#dateDocIn').val(formatDateForInput(record.dateDocIn));
                        $('#estRev').val(record.estRev || '');
                        $('#acctngWk').val(record.acctngWk || '');
                        $('#jobCompleted').val(record.jobCompleted || '');
                        $('#remark').val(record.remark || '');

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading record: ' + error, 'danger');
                }
            });
        }

        // ---------------------------------------------------------
        //  4. Save & Other Logic (保持不变)
        // ---------------------------------------------------------
        function saveRecord() {
            const formData = {
                grouping: $('#grouping').val(),
                // 这里的 companyName 由 Dropdown change 事件或 Edit 回显填充
                companyName: $('#companyName').val(),
                quartertoAudit: $('#quartertoAudit').val(),
                activity: $('#activity').val(),
                yearEnd: $('#yearEnd').val() || null,
                yearToDo: $('#yearToDo').val(),
                companyStatus: $('#companyStatus').val(),
                auditStatus: $('#auditStatus').val(),
                movetoAEX: $('#movetoAEX').val(),
                movetoBacklog: $('#movetoBacklog').val(),
                first18mthdue: $('#first18mthdue').val() || null,
                aFSdueDate: $('#aFSdueDate').val() || null,
                coSec: $('#coSec').val(),
                auditStaff: $('#auditStaff').val(),
                dateDocIn: $('#dateDocIn').val() || null,
                estRev: $('#estRev').val(),
                acctngWk: $('#acctngWk').val(),
                jobCompleted: $('#jobCompleted').val(),
                remark: $('#remark').val()
            };

            if (currentEditingId) {
                formData.id = currentEditingId;
            }

            if (!formData.companyName) {
                showAlert('Company Name is required (Please select a client)', 'warning');
                return;
            }

            const url = currentEditingId ? '/api/auditdept/at21/update' : '/api/auditdept/at21/create';
            const method = currentEditingId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        const message = `Record ${currentEditingId ? 'updated' : 'created'} successfully!`;
                        showAlert(message, 'success');
                        $('#taskModal').modal('hide');
                        loadData();
                    } else {
                        showAlert('Error saving record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error saving record: ' + error, 'danger');
                }
            });
        }

        // --- Helper Functions ---

        function formatJsDateForInput(date) {
            if (!date) return '';
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${yyyy}-${mm}-${dd}`;
        }

        function calculateYearEndDateForInput(monthName) {
            if (!monthName) return '';
            const months = {
                "january": 0, "february": 1, "march": 2, "april": 3, "may": 4, "june": 5,
                "july": 6, "august": 7, "september": 8, "october": 9, "november": 10, "december": 11
            };
            const cleanName = monthName.trim().toLowerCase();
            const monthIndex = months[cleanName];
            if (monthIndex === undefined) return '';
            const currentYear = new Date().getFullYear();
            const date = new Date(currentYear, monthIndex + 1, 0);
            return formatJsDateForInput(date);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toLocaleDateString('en-GB');
            } catch (e) { return ''; }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
            } catch (e) { return ''; }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showAlert(message, type) {
            const alertClass = `alert alert-${type} alert-dismissible fade show`;
            const alertHtml = `
                <div class="${alertClass}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            $('.alert').remove();
            $('.card-body').prepend(alertHtml);
            setTimeout(() => { $('.alert').alert('close'); }, 5000);
        }

        // DataTable Logic (Standard)
        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
                $('#taskDatatable').empty();
            }
            const tableHtml = `
                <thead>
                    <tr>
                        <th>Grouping</th>
                        <th>Company Name</th>
                        <th>Quarter to Audit</th>
                        <th>Activity</th>
                        <th>Year End</th>
                        <th>Year to do</th>
                        <th>Co Status</th>
                        <th>Audit Status</th>
                        <th>Move to AEX Sch</th>
                        <th>Move to Backlog</th>
                        <th>1st 18mths due</th>
                        <th>AFS due date</th>
                        <th>Co Sec?</th>
                        <th>Audit Staff</th>
                        <th>Date Doc in</th>
                        <th>EST Rev/NP('000)</th>
                        <th>Acctng wk?</th>
                        <th>Job Completed</th>
                        <th>Remark</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            `;
            $('#taskDatatable').html(tableHtml);
            populateTableBody(currentData);

            dataTable = $('#taskDatatable').DataTable({
                "paging": true, "lengthChange": true, "searching": true, "ordering": true,
                "info": true, "autoWidth": false, "responsive": true,
                "language": { "emptyTable": "No records found", "zeroRecords": "No matching records found" }
            });
        }

        function populateTableBody(data) {
            const tbody = $('#tableBody');
            tbody.empty();
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    const row = `
                        <tr>
                            <td>${escapeHtml(item.grouping || '')}</td>
                            <td>${escapeHtml(item.companyName || '')}</td>
                            <td>${escapeHtml(item.quartertoAudit || '')}</td>
                            <td>${escapeHtml(item.activity || '')}</td>
                            <td>${formatDate(item.yearEnd)}</td>
                            <td>${escapeHtml(item.yearTodo || '')}</td>
                            <td>${escapeHtml(item.companyStatus || '')}</td>
                            <td>${escapeHtml(item.auditStatus || '')}</td>
                            <td>${escapeHtml(item.movetoAEX || '')}</td>
                            <td>${escapeHtml(item.movetoBacklog || '')}</td>
                            <td>${formatDate(item.first18mthdue)}</td>
                            <td>${formatDate(item.afSdueDate)}</td>
                            <td>${escapeHtml(item.coSec || '')}</td>
                            <td>${escapeHtml(item.auditStaff || '')}</td>
                            <td>${formatDate(item.dateDocIn)}</td>
                            <td>${escapeHtml(item.estRev || '')}</td>
                            <td>${escapeHtml(item.acctngWk || '')}</td>
                            <td>${escapeHtml(item.jobCompleted || '')}</td>
                            <td>${escapeHtml(item.remark || '')}</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${item.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${item.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    tbody.append(row);
                });
            }
        }

        function loadData() {
            const tbody = $('#tableBody');
            tbody.html('<tr><td colspan="20" class="text-center">Loading...</td></tr>');
            $.ajax({
                url: '/api/auditdept/at21/get-all', type: 'GET',
                success: function(response) {
                    if (response.success) {
                        currentData = response.data || [];
                        initializeDataTable();
                    } else {
                        currentData = []; initializeDataTable();
                    }
                },
                error: function() { currentData = []; initializeDataTable(); }
            });
        }

        function deleteRecord(id) {
            if (confirm('Delete this record?')) {
                $.ajax({
                    url: '/api/auditdept/at21/delete/' + id, type: 'DELETE',
                    success: function(res) { if(res.success) { loadData(); showAlert('Deleted', 'success'); } }
                });
            }
        }

        function openCreateModal() {
            currentEditingId = null;
            $('#modalTitle').text('Add New Audit Master Schedule Record');
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#clientSelect').val('');
            $('#taskModal').modal('show');
        }
    </script>
}