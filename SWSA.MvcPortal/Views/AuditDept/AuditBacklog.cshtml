@{
    ViewData["Title"] = "AuditBacklog";
}

<h1>Audit Backlog</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Audit Backlog Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Group</th>
                            <th>Company Name</th>
                            <th>Quarter to Do Audit</th>
                            <th>Activity</th>
                            <th>Year End</th>
                            <th>Year to do</th>
                            <th>Move to Active/AEX Sch</th>
                            <th>Date Doc in</th>
                            <th>Acctng wk?</th>
                            <th>Reason why backlog</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audit Backlog Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grouping">Group</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Enter group" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <select id="companyName" name="companyName" class="form-select form-control" required>
                                    <option value="">-- Select Company --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quarterToDoAudit">Quarter to Do Audit</label>
                                <select id="quarterToDoAudit" name="quarterToDoAudit" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="date" id="yearEnd" name="yearEnd" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="Enter year to do" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="moveToActiveAexSch">Move to Active/AEX Sch</label>
                                <select id="moveToActiveAexSch" name="moveToActiveAexSch" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateDocIn">Date Doc in</label>
                                <input type="date" id="dateDocIn" name="dateDocIn" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="acctngWk">Acctng wk?</label>
                                <select id="acctngWk" name="acctngWk" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reasonWhyBacklog">Reason why backlog</label>
                                <input type="text" id="reasonWhyBacklog" name="reasonWhyBacklog" class="form-control" placeholder="Enter reason" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let currentEditingId = null;
        let dataTable = null;
        let isInitialLoad = true;

        $(document).ready(function() {
            // ⭐⭐ 1. Load Client List into Dropdown
            loadClientOptions();

            // 先初始化 DataTable，然后再加载数据
            initializeDataTable();
            loadData();
        });

        // ⭐⭐ 新增：加载客户列表函数
        function loadClientOptions() {
            $.ajax({
                url: '/api/auditdept/clients/get-list', // 确保 Controller 有这个 API
                type: 'GET',
                success: function (res) {
                    if (res && res.success && res.data) {
                        const $select = $('#companyName');
                        // 保留第一项 "-- Select Company --"，清空后面的
                        $select.find('option:not(:first)').remove();

                        res.data.forEach(client => {
                            // 兼容属性名大小写
                            const name = client.CompanyName || client.companyName || client.Name || client.name;
                            // 获取客户类型
                            const type = client.ClientType || client.clientType || '';

                            if (name) {
                                let displayText = name;
                                if (type) {
                                    displayText = `${name} (${type})`;
                                }
                                $select.append(`<option value="${name}">${displayText}</option>`);
                            }
                        });
                    }
                },
                error: function (err) {
                    console.error('Failed to load client list', err);
                }
            });
        }

        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }

            dataTable = $('#taskDatatable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "language": {
                    "emptyTable": "No audit backlog records found",
                    "loadingRecords": "Loading...",
                    "zeroRecords": "No matching records found"
                },
                "columns": [
                    { "data": "grouping" },
                    { "data": "companyName" },
                    { "data": "quarterToDoAudit" },
                    { "data": "activity" },
                    {
                        "data": "yearEnd",
                        "render": function(data) { return formatDate(data); }
                    },
                    { "data": "yearToDo" },
                    { "data": "moveToActiveAexSch" },
                    {
                        "data": "dateDocIn",
                        "render": function(data) { return formatDate(data); }
                    },
                    { "data": "acctngWk" },
                    { "data": "reasonWhyBacklog" },
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${row.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${row.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ]
            });
        }

        function loadData() {
            // 显示加载状态 (如果需要可以加 spinner，这里直接依赖 DataTable 的 loading)
            // dataTable.clear().draw(); // 不需要 clear，ajax reload 会处理

            $.ajax({
                url: '/api/auditdept/at22/get-all',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        populateTable(response.data);
                    } else {
                        console.error('API response error:', response);
                        dataTable.clear().draw();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', error);
                    showAlert('Error loading data: ' + error, 'danger');
                    dataTable.clear().draw();
                }
            });
        }

        function populateTable(data) {
            console.log('Populating table with data:', data);

            if (data && data.length > 0) {
                // DataTables 可以直接吃 JSON 数组，只要 key 对应 columns 定义
                // 这里做一层简单的 map 确保 null 值变空字符串
                const formattedData = data.map(function(item) {
                    return {
                        id: item.id || item.Id,
                        grouping: escapeHtml(item.grouping || item.Grouping || ''),
                        companyName: escapeHtml(item.companyName || item.CompanyName || ''),
                        quarterToDoAudit: escapeHtml(item.quarterToDoAudit || item.QuarterToDoAudit || ''),
                        activity: escapeHtml(item.activity || item.Activity || ''),
                        yearEnd: item.yearEnd || item.YearEnd, // 保持原始值，交给 render 处理
                        yearToDo: escapeHtml(item.yearToDo || item.YearToDo || ''),
                        moveToActiveAexSch: escapeHtml(item.moveToActiveAexSch || item.MoveToActiveAexSch || ''),
                        dateDocIn: item.dateDocIn || item.DateDocIn, // 保持原始值
                        acctngWk: escapeHtml(item.acctngWk || item.AcctngWk || ''),
                        reasonWhyBacklog: escapeHtml(item.reasonWhyBacklog || item.ReasonWhyBacklog || '')
                    };
                });

                dataTable.clear();
                dataTable.rows.add(formattedData).draw();
            } else {
                dataTable.clear().draw();
            }
        }

        function openCreateModal() {
            currentEditingId = null;
            $('#modalTitle').text('Add New Audit Backlog Record');
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#taskModal').modal('show');
        }

        function editRecord(id) {
            $.ajax({
                url: '/api/auditdept/at22/get/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditingId = record.id;

                        $('#modalTitle').text('Edit Audit Backlog Record');
                        $('#recordId').val(record.id);
                        $('#grouping').val(record.grouping || '');

                        // ⭐⭐ 修改：下拉菜单回显逻辑 ⭐⭐
                        const existingCompany = record.companyName || '';
                        const $select = $('#companyName');
                        $select.val(existingCompany);
                        // 如果下拉框没有这个值（已归档），临时添加
                        if (!$select.val() && existingCompany) {
                            $select.append(`<option value="${existingCompany}" selected>${existingCompany} (Archived)</option>`);
                            $select.val(existingCompany);
                        }

                        $('#quarterToDoAudit').val(record.quarterToDoAudit || '');
                        $('#activity').val(record.activity || '');
                        $('#yearEnd').val(formatDateForInput(record.yearEnd));
                        $('#yearToDo').val(record.yearToDo || '');
                        $('#moveToActiveAexSch').val(record.moveToActiveAexSch || '');
                        $('#dateDocIn').val(formatDateForInput(record.dateDocIn));
                        $('#acctngWk').val(record.acctngWk || '');
                        $('#reasonWhyBacklog').val(record.reasonWhyBacklog || '');

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading record: ' + error, 'danger');
                }
            });
        }

        function saveRecord() {
            const formData = {
                grouping: $('#grouping').val(),
                companyName: $('#companyName').val(), // Select 的值
                quarterToDoAudit: $('#quarterToDoAudit').val(),
                activity: $('#activity').val(),
                yearEnd: $('#yearEnd').val() || null,
                yearToDo: $('#yearToDo').val(),
                moveToActiveAexSch: $('#moveToActiveAexSch').val(),
                dateDocIn: $('#dateDocIn').val() || null,
                acctngWk: $('#acctngWk').val(),
                reasonWhyBacklog: $('#reasonWhyBacklog').val()
            };

            // Add ID for update
            if (currentEditingId) {
                formData.id = currentEditingId;
            }

            // Basic validation
            if (!formData.companyName) {
                showAlert('Company Name is required', 'warning');
                return;
            }

            const url = currentEditingId ? '/api/auditdept/at22/update' : '/api/auditdept/at22/create';
            const method = currentEditingId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        showAlert(`Record ${currentEditingId ? 'updated' : 'created'} successfully!`, 'success');
                        $('#taskModal').modal('hide');
                        loadData(); // 重新加载数据
                    } else {
                        showAlert('Error saving record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Error saving record: ' + error, 'danger');
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '/api/auditdept/at22/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('Record deleted successfully!', 'success');
                            loadData(); // 重新加载数据
                        } else {
                            showAlert('Error deleting record: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Error deleting record: ' + error, 'danger');
                    }
                });
            }
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            } catch (e) {
                return '';
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                return date.toISOString().split('T')[0]; // YYYY-MM-DD
            } catch (e) {
                return '';
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showAlert(message, type) {
            const alertClass = `alert alert-${type} alert-dismissible fade show`;
            const alertHtml = `
                <div class="${alertClass}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Remove existing alerts
            $('.alert').remove();

            // Prepend alert to card body
            $('.card-body').prepend(alertHtml);

            // Auto remove after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
}