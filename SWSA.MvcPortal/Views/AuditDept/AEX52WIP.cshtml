@{
    ViewData["Title"] = "AEX52WIP";
}

<h1>AEX 5.2 AEX WIP</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="9"></th>
                            <th colspan="4">Audit WIP(days)</th>
                            <th colspan="6">Audit work WIP%</th>
                            <th colspan="7">Review</th>
                            <th rowspan="3">Action</th>
                        </tr>

                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Activity</th>

                            <th colspan="2">Schedule to do</th>
                            <th rowspan="3">PIC</th>
                            <th rowspan="3">Status</th>
                            <th colspan="2">Billing</th>

                            <th rowspan="2">a. Start Date</th>
                            <th rowspan="2">b. As at</th>
                            <th rowspan="2">c. No of Days</th>
                            <th rowspan="2">Result Over/Under</th>

                            <th colspan="2">A. prog tracker%</th>
                            <th colspan="3">B. Task%</th>
                            <th colspan="1">A+B+C</th>

                            <th colspan="3">Kuching 1st Review</th>
                            <th colspan="4">2nd Review KK</th>
                        </tr>

                        <tr>
                            <th>Year to do</th>
                            <th>Quarter to do</th>
                            <th>Audit Fee</th>
                            <th>Date billed</th>
                            <th>a. Acc setup(J) 20%</th>
                            <th>b. Ac summary(J) 20%</th>
                            <th>c. Audit Planning(PIC) 20%</th>
                            <th>d. Audit Execution 20%</th>
                            <th>e. Audit Completion(PIC) 20%</th>
                            <th>Total 100%</th>
                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>A. Result Over/Under</th>
                            <th>Date Sent</th>
                            <th>End Date</th>
                            <th>B. Result Over/Under</th>
                            <th>Final</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AEX WIP Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="number">No</label>
                                <input type="text" id="number" name="number" class="form-control" placeholder="Enter number" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="companyName">Company Name (Suppose Link From Client List)</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="quarterToDo">Quarter to do</label>
                                <select id="quarterToDo" name="quarterToDo" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Billing -->
                    <div class="form-info-label col-12">
                        <label>Billing</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="text" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBilled">Date billed</label>
                                <input type="text" id="dateBilled" name="dateBilled" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit WIP (days) -->
                    <div class="form-info-label col-12">
                        <label>Audit WIP (days)</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="startDate">a. Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="asAtDate">b. As at</label>
                                <input type="text" id="asAtDate" name="asAtDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="noOfDays">c. No of Days</label>
                                <input type="number" id="noOfDays" name="noOfDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit work WIP% -->
                    <div class="form-info-label col-12">
                        <label>Audit work WIP%</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="accSetupPercent">a. Acc setup(J) 20%</label>
                                <input type="text" id="accSetupPercent" name="accSetupPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="acSummaryPercent">b. Ac summary(J) 20%</label>
                                <input type="text" id="acSummaryPercent" name="acSummaryPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditPlanningPercent">c. Audit Planning(PIC) 20%</label>
                                <input type="text" id="auditPlanningPercent" name="auditPlanningPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditExecutionPercent">d. Audit Execution 20%</label>
                                <input type="text" id="auditExecutionPercent" name="auditExecutionPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditCompletionPercent">e. Audit Completion(PIC) 20%</label>
                                <input type="text" id="auditCompletionPercent" name="auditCompletionPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="totalPercent">Total 100%</label>
                                <input type="text" id="totalPercent" name="totalPercent" class="form-control" placeholder="Enter total percentage" />
                            </div>
                        </div>
                    </div>

                    <!-- Review -->
                    <div class="form-info-label col-12">
                        <label>Review</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingDateSent">Kuching 1st Review - Date Sent</label>
                                <input type="text" id="kuchingDateSent" name="kuchingDateSent" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingEndDate">Kuching 1st Review - End Date</label>
                                <input type="text" id="kuchingEndDate" name="kuchingEndDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingResult">Kuching 1st Review - A. Result Over/Under</label>
                                <input type="text" id="kuchingResult" name="kuchingResult" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkDateSent">2nd Review KK - Date Sent</label>
                                <input type="text" id="kkDateSent" name="kkDateSent" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkEndDate">2nd Review KK - End Date</label>
                                <input type="text" id="kkEndDate" name="kkEndDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkResult">2nd Review KK - B. Result Over/Under</label>
                                <input type="text" id="kkResult" name="kkResult" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="finalResult">Final</label>
                                <input type="text" id="finalResult" name="finalResult" class="form-control" placeholder="Enter final result" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            // 先创建 alert 容器如果不存在
            if ($('#modalAlert').length === 0) {
                $('#taskModal .modal-body').prepend('<div id="modalAlert" class="alert d-none"></div>');
            }

            const map = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }

        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }

        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }

        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            try {
                // 如果是日期对象或字符串，尝试格式化
                if (s instanceof Date) {
                    return s.toLocaleDateString('en-GB');
                }
                if (typeof s === 'string') {
                    const date = new Date(s);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-GB');
                    }
                }
                return s;
            } catch (e) {
                return s;
            }
        }

        function getVal(obj, name) {
            if (!obj) return '';

            if (obj[name] !== undefined && obj[name] !== null) return obj[name];

            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];

            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New AEX WIP Record');
            hideModalAlert();
            clearFieldErrors();
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '';
            try {
                return 'RM ' + parseFloat(amount).toLocaleString('en-MY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (e) {
                return amount || '';
            }
        }

        function formatPercentage(value) {
            if (!value && value !== 0) return '';
            try {
                return parseFloat(value) + '%';
            } catch (e) {
                return value || '';
            }
        }

        // ---------- Init ----------
        $(document).ready(function () {
            console.log('Document ready, initializing AEX52...');

            // 初始化日期选择器
            try {
                $('input[type="text"]').filter(function () {
                    const id = $(this).attr('id') || '';
                    return id.includes('Date') || id.includes('date');
                }).datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });
                console.log('Datepicker initialized');
            } catch (e) {
                console.error('Datepicker init error:', e);
            }

            // 初始化 DataTable - 简化配置
            try {
                dataTable = $('#taskDatatable').DataTable({
                    responsive: true,
                    ordering: true,
                    autoWidth: true,
                    pageLength: 10,
                    order: [[1, 'asc']], // 以 Company Name 排序
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        emptyTable: "No records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    columnDefs: [
                        {
                            targets: '_all',
                            defaultContent: '' // 防止 undefined 错误
                        }
                    ]
                });
                dataTableInitialized = true;
                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('DataTable initialization error:', error);
                $('#taskDatatable').addClass('table table-bordered table-striped');
                dataTableInitialized = false;
            }

            // 绑定按钮事件
            $('#saveBtn').click(saveRecord);

            // 使用事件委托绑定动态按钮
            $(document).on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                console.log('Edit clicked for ID:', id);
                editRecord(id);
            });

            $(document).on('click', '.delete-btn', function () {
                const id = $(this).data('id');
                console.log('Delete clicked for ID:', id);
                deleteRecord(id);
            });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            // 新建按钮点击事件
            $('[data-bs-target="#taskModal"]').on('click', function () {
                console.log('New Task button clicked');
                clearForm();
            });

            // 首次载入数据
            console.log('Loading initial data...');
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            console.log('Loading AEX52 records from database...');

            $.ajax({
                url: '/api/auditdept/aex52/get-all',
                type: 'GET',
                success: function (res) {
                    console.log('API response:', res);
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                    } else {
                        const errorMsg = res?.message || 'Unknown error';
                        console.error('API error:', errorMsg);
                        showAlert('Failed to load: ' + errorMsg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', error);
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            console.log('Populating table with records:', records);

            if (!dataTableInitialized) {
                console.log('DataTable not initialized, using manual table population');
                manualPopulateTable(records);
                return;
            }

            // 清除现有数据
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    console.log('Processing record:', r);

                    // 构建数据行 - 根据表格结构
                    const rowData = [
                        index + 1, // No
                        getVal(r, 'CompanyName'),                                // Company Name
                        getVal(r, 'Activity'),                                   // Activity
                        getVal(r, 'Yeartodo'),                                   // Year to do
                        getVal(r, 'Quartertodo'),                                // Quarter to do
                        getVal(r, 'PIC'),                                        // PIC
                        getVal(r, 'Status'),                                     // Status
                        formatCurrency(getVal(r, 'AuditFee')),                   // Audit Fee
                        formatDateForDisplay(getVal(r, 'DateBilled')),           // Date billed
                        formatDateForDisplay(getVal(r, 'StartDate')),            // Start Date
                        formatDateForDisplay(getVal(r, 'EndDate')),              // As at (使用 EndDate)
                        getVal(r, 'NoofDays') || '',                             // No of Days
                        getVal(r, 'ResultOverUnder'),                            // Result Over/Under
                        formatPercentage(getVal(r, 'AccSetup')),                 // Acc setup 20%
                        formatPercentage(getVal(r, 'AccSummary')),               // Ac summary 20%
                        formatPercentage(getVal(r, 'AuditPlanning')),            // Audit Planning 20%
                        formatPercentage(getVal(r, 'AuditExecution')),           // Audit Execution 20%
                        formatPercentage(getVal(r, 'AuditCompletion')),          // Audit Completion 20%
                        formatPercentage(getVal(r, 'TotalPercent')),             // Total 100%
                        formatDateForDisplay(getVal(r, 'ReviewDateSent')),       // Kuching Review Date Sent
                        formatDateForDisplay(getVal(r, 'ReviewEndDate')),        // Kuching Review End Date
                        getVal(r, 'ReviewResultOverUnder'),                      // Kuching Review Result
                        formatDateForDisplay(getVal(r, 'KKDateSent')),           // KK Review Date Sent
                        formatDateForDisplay(getVal(r, 'KKEndDate')),            // KK Review End Date
                        getVal(r, 'KKResultOverUnder'),                          // KK Review Result
                        getVal(r, 'Final'),                                      // Final
                        // Edit & Delete buttons
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                            <i class="fas fa-edit"></i>
                         </button>
                         <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                            <i class="fas fa-trash"></i>
                         </button>`
                    ];

                    console.log('Adding row data:', rowData);
                    dataTable.row.add(rowData);
                });
            }

            dataTable.draw();
            console.log('Table populated successfully');
        }

        // 降级方案：手动填充表格
        function manualPopulateTable(records) {
            const tbody = $('#taskDatatable tbody');
            tbody.empty();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${getVal(r, 'CompanyName') || ''}</td>
                            <td>${getVal(r, 'Activity') || ''}</td>
                            <td>${getVal(r, 'Yeartodo') || ''}</td>
                            <td>${getVal(r, 'Quartertodo') || ''}</td>
                            <td>${getVal(r, 'PIC') || ''}</td>
                            <td>${getVal(r, 'Status') || ''}</td>
                            <td>${formatCurrency(getVal(r, 'AuditFee'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateBilled'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'StartDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'EndDate'))}</td>
                            <td>${getVal(r, 'NoofDays') || ''}</td>
                            <td>${getVal(r, 'ResultOverUnder') || ''}</td>
                            <td>${formatPercentage(getVal(r, 'AccSetup'))}</td>
                            <td>${formatPercentage(getVal(r, 'AccSummary'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditPlanning'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditExecution'))}</td>
                            <td>${formatPercentage(getVal(r, 'AuditCompletion'))}</td>
                            <td>${formatPercentage(getVal(r, 'TotalPercent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'ReviewDateSent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'ReviewEndDate'))}</td>
                            <td>${getVal(r, 'ReviewResultOverUnder') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'KKDateSent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'KKEndDate'))}</td>
                            <td>${getVal(r, 'KKResultOverUnder') || ''}</td>
                            <td>${getVal(r, 'Final') || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="27" class="text-center">No records found</td></tr>');
            }
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            console.log('Save button clicked');
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                CompanyName: ($('#companyName').val() || '').trim(),
                Activity: ($('#activity').val() || '').trim(),
                Yeartodo: ($('#yearToDo').val() || '').trim(),
                Quartertodo: ($('#quarterToDo').val() || '').trim(),
                PIC: ($('#pic').val() || '').trim(),
                Status: ($('#status').val() || '').trim(),
                AuditFee: ($('#auditFee').val() || '').trim(),
                DateBilled: ($('#dateBilled').val() || '').trim(),
                StartDate: ($('#startDate').val() || '').trim(),
                EndDate: ($('#asAtDate').val() || '').trim(), // 注意：这里使用 asAtDate 对应 EndDate
                NoofDays: ($('#noOfDays').val() || '').trim(),
                ResultOverUnder: ($('#resultOverUnder').val() || '').trim(),
                AccSetup: ($('#accSetupPercent').val() || '').trim(),
                AccSummary: ($('#acSummaryPercent').val() || '').trim(),
                AuditPlanning: ($('#auditPlanningPercent').val() || '').trim(),
                AuditExecution: ($('#auditExecutionPercent').val() || '').trim(),
                AuditCompletion: ($('#auditCompletionPercent').val() || '').trim(),
                TotalPercent: ($('#totalPercent').val() || '').trim(),
                ReviewDateSent: ($('#kuchingDateSent').val() || '').trim(),
                ReviewEndDate: ($('#kuchingEndDate').val() || '').trim(),
                ReviewResultOverUnder: ($('#kuchingResult').val() || '').trim(),
                KKDateSent: ($('#kkDateSent').val() || '').trim(),
                KKEndDate: ($('#kkEndDate').val() || '').trim(),
                KKResultOverUnder: ($('#kkResult').val() || '').trim(),
                Final: ($('#finalResult').val() || '').trim()
            };

            console.log('Form data:', formData);

            // 简单必填验证
            let hasError = false;
            if (!formData.CompanyName) { setFieldError('#companyName', 'Required'); hasError = true; }
            if (!formData.Activity) { setFieldError('#activity', 'Required'); hasError = true; }

            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/api/auditdept/aex52/update' : '/api/auditdept/aex52/create';
            const method = isUpdate ? 'PUT' : 'POST';

            console.log('Saving via:', url, method);

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    console.log('Save response:', res);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Save error:', error);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            console.log('Editing record ID:', id);
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: '/api/auditdept/aex52/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit AEX WIP Record');
                    if (res && res.success) {
                        const d = res.data || {};
                        console.log('Edit data loaded:', d);

                        $('#editIndex').val(getVal(d, 'Id'));

                        // 填充表单字段
                        $('#companyName').val(getVal(d, 'CompanyName'));
                        $('#activity').val(getVal(d, 'Activity'));
                        $('#yearToDo').val(getVal(d, 'Yeartodo'));
                        $('#quarterToDo').val(getVal(d, 'Quartertodo'));
                        $('#pic').val(getVal(d, 'PIC'));
                        $('#status').val(getVal(d, 'Status'));
                        $('#auditFee').val(getVal(d, 'AuditFee'));
                        $('#dateBilled').val(formatDateForDisplay(getVal(d, 'DateBilled')));
                        $('#startDate').val(formatDateForDisplay(getVal(d, 'StartDate')));
                        $('#asAtDate').val(formatDateForDisplay(getVal(d, 'EndDate'))); // 注意：EndDate 对应 asAtDate
                        $('#noOfDays').val(getVal(d, 'NoofDays'));
                        $('#resultOverUnder').val(getVal(d, 'ResultOverUnder'));
                        $('#accSetupPercent').val(getVal(d, 'AccSetup'));
                        $('#acSummaryPercent').val(getVal(d, 'AccSummary'));
                        $('#auditPlanningPercent').val(getVal(d, 'AuditPlanning'));
                        $('#auditExecutionPercent').val(getVal(d, 'AuditExecution'));
                        $('#auditCompletionPercent').val(getVal(d, 'AuditCompletion'));
                        $('#totalPercent').val(getVal(d, 'TotalPercent'));
                        $('#kuchingDateSent').val(formatDateForDisplay(getVal(d, 'ReviewDateSent')));
                        $('#kuchingEndDate').val(formatDateForDisplay(getVal(d, 'ReviewEndDate')));
                        $('#kuchingResult').val(getVal(d, 'ReviewResultOverUnder'));
                        $('#kkDateSent').val(formatDateForDisplay(getVal(d, 'KKDateSent')));
                        $('#kkEndDate').val(formatDateForDisplay(getVal(d, 'KKEndDate')));
                        $('#kkResult').val(getVal(d, 'KKResultOverUnder'));
                        $('#finalResult').val(getVal(d, 'Final'));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit AEX WIP Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;

            $.ajax({
                url: '/api/auditdept/aex52/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}