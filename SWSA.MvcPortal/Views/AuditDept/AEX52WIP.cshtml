@{
    ViewData["Title"] = "AEX52WIP";
}

<h1>AEX 5.2 AEX WIP</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <table id="taskDatatable" class="table table-bordered table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th colspan="7" class="text-center">Basic Information</th>

                            <th colspan="2" class="text-center">Billing</th>

                            <th colspan="4" class="text-center">Audit WIP (Days)</th>

                            <th colspan="6" class="text-center">Audit Work WIP %</th>

                            <th colspan="7" class="text-center">Review (Kuching & KK)</th>

                            <th rowspan="2" style="vertical-align: middle; min-width: 80px;">Action</th>
                        </tr>

                        <tr>
                            <th>No</th>
                            <th>Company Name</th>
                            <th>Activity</th>
                            <th>Year to do</th>
                            <th>Quarter to do</th>
                            <th>PIC</th>
                            <th>Status</th>

                            <th>Audit Fee</th>
                            <th>Date billed</th>

                            <th>Start Date</th>
                            <th>As at</th>
                            <th>No of Days</th>
                            <th>Result O/U</th>

                            <th>Acc setup</th>
                            <th>Ac summary</th>
                            <th>Planning</th>
                            <th>Execution</th>
                            <th>Completion</th>
                            <th>Total %</th>

                            <th>KCH Date</th>
                            <th>KCH End</th>
                            <th>KCH Res</th>
                            <th>KK Date</th>
                            <th>KK End</th>
                            <th>KK Res</th>
                            <th>Final</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AEX WIP Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">                  
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="clientSelect">Client <span class="text-danger">*</span></label>
                                <select id="clientSelect" name="clientSelect" class="form-control" required>
                                    <option value="">-- Select client --</option>
                                </select>
                                <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                                <input type="hidden" id="client" name="client" />
                                <input type="hidden" id="clientId" name="clientId" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="quarterToDo">Quarter to do</label>
                                <select id="quarterToDo" name="quarterToDo" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Billing -->
                    <div class="form-info-label col-12">
                        <label>Billing</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="text" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateBilled">Date billed</label>
                                <input type="text" id="dateBilled" name="dateBilled" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit WIP (days) -->
                    <div class="form-info-label col-12">
                        <label>Audit WIP (days)</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="startDate">a. Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="asAtDate">b. As at</label>
                                <input type="text" id="asAtDate" name="asAtDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="noOfDays">c. No of Days</label>
                                <input type="number" id="noOfDays" name="noOfDays" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>

                    <!-- Audit work WIP% -->
                    <div class="form-info-label col-12">
                        <label>Audit work WIP%</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="accSetupPercent">a. Acc setup(J) 20%</label>
                                <input type="text" id="accSetupPercent" name="accSetupPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="acSummaryPercent">b. Ac summary(J) 20%</label>
                                <input type="text" id="acSummaryPercent" name="acSummaryPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditPlanningPercent">c. Audit Planning(PIC) 20%</label>
                                <input type="text" id="auditPlanningPercent" name="auditPlanningPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditExecutionPercent">d. Audit Execution 20%</label>
                                <input type="text" id="auditExecutionPercent" name="auditExecutionPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="auditCompletionPercent">e. Audit Completion(PIC) 20%</label>
                                <input type="text" id="auditCompletionPercent" name="auditCompletionPercent" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="totalPercent">Total 100%</label>
                                <input type="text" id="totalPercent" name="totalPercent" class="form-control" placeholder="Enter total percentage" />
                            </div>
                        </div>
                    </div>

                    <!-- Review -->
                    <div class="form-info-label col-12">
                        <label>Review</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingDateSent">Kuching 1st Review - Date Sent</label>
                                <input type="text" id="kuchingDateSent" name="kuchingDateSent" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingEndDate">Kuching 1st Review - End Date</label>
                                <input type="text" id="kuchingEndDate" name="kuchingEndDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kuchingResult">Kuching 1st Review - A. Result Over/Under</label>
                                <input type="text" id="kuchingResult" name="kuchingResult" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkDateSent">2nd Review KK - Date Sent</label>
                                <input type="text" id="kkDateSent" name="kkDateSent" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkEndDate">2nd Review KK - End Date</label>
                                <input type="text" id="kkEndDate" name="kkEndDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="kkResult">2nd Review KK - B. Result Over/Under</label>
                                <input type="text" id="kkResult" name="kkResult" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="finalResult">Final</label>
                                <input type="text" id="finalResult" name="finalResult" class="form-control" placeholder="Enter final result" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;
        // [新增] 用于存储 Client 数据的 Map，方便 Edit 时候回填
        let clientNameMap = {};
        let clientDataMap = {};

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            if ($('#modalAlert').length === 0) {
                $('#taskModal .modal-body').prepend('<div id="modalAlert" class="alert d-none"></div>');
            }
            const map = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);
            $('#taskModal .modal-body').stop(true).animate({ scrollTop: 0 }, 200);
        }

        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }

        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }

        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            try {
                const date = new Date(s);
                return isNaN(date.getTime()) ? '' : date.toLocaleDateString('en-GB');
            } catch (e) { return s; }
        }

        function getVal(obj, name) {
            if (!obj) return '';
            // 尝试直接获取
            if (obj[name] !== undefined && obj[name] !== null) return obj[name];
            // 尝试首字母小写
            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];
            // 尝试全小写匹配
            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#clientSelect').val(''); // 重置下拉框
            $('#companyName').val('');  // 重置隐藏域
            $('#clientId').val('');     // 重置隐藏域
            $('#modalTitle').text('Add New AEX WIP Record');
            hideModalAlert();
            clearFieldErrors();
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '';
            return 'RM ' + parseFloat(amount).toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatPercentage(value) {
            if (!value && value !== 0) return '';
            return parseFloat(value) + '%';
        }

        // ---------- [新增] 加载 Client Dropdown ----------
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const select = $('#clientSelect');
                        select.empty();
                        select.append('<option value="">-- Select client --</option>');

                        clientNameMap = {};
                        clientDataMap = {};

                        // 假设 API 返回的数据结构包含 id 和 companyName
                        response.data.forEach(client => {
                            // 兼容大小写
                            const cName = client.companyName || client.CompanyName;
                            const cId = client.id || client.Id;

                            if(cName) {
                                clientNameMap[cName.trim()] = cId;
                            }
                            clientDataMap[cId] = client;

                            select.append(`<option value="${cId}">${cName}</option>`);
                        });
                        console.log("Client options loaded.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading client options:', error);
                }
            });
        }

        // ---------- Init ----------
        $(document).ready(function () {
            console.log('Document ready...');

            // [新增] 页面加载时获取 Dropdown 数据
            loadClientOptions();

            // [新增] Dropdown 变动时，回填隐藏的 input
            $('#clientSelect').on('change', function() {
                const selectedId = $(this).val();
                const clientData = clientDataMap[selectedId];

                if (clientData) {
                    const cName = clientData.companyName || clientData.CompanyName;
                    const cId = clientData.id || clientData.Id;

                    $('#companyName').val(cName);
                    $('#clientId').val(cId);
                    // 你的 HTML 里还有一个 id="client"
                    $('#client').val(cName);
                } else {
                    $('#companyName').val('');
                    $('#clientId').val('');
                    $('#client').val('');
                }
            });

            // Datepicker
            $('input[type="text"]').filter(function () {
                const id = $(this).attr('id') || '';
                return id.toLowerCase().includes('date');
            }).datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true
            });

        // 在 $(document).ready 内部，找到初始化 DataTable 的部分，替换为：

                try {
                    if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                        $('#taskDatatable').DataTable().destroy();
                    }

                    dataTable = $('#taskDatatable').DataTable({
                        "responsive": false, // 关闭响应式，使用 scrollX
                        "scrollX": true,     // 开启横向滚动
                        "autoWidth": false,  // 禁止自动计算宽度，防止报错
                        "paging": true,
                        "ordering": true,
                        "pageLength": 10,
                        "stateSave": false,  // 关键：禁止保存状态，防止加载旧的列配置导致报错
                        "order": [[1, 'asc']],
                        "language": {
                            "search": "Search:",
                            "lengthMenu": "Show _MENU_ entries",
                            "emptyTable": "No records found",
                            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                            "paginate": { "first": "First", "last": "Last", "next": "Next", "previous": "Previous" }
                        },
                        // 显式定义列宽，防止表头挤在一起
                        "columnDefs": [
                            { "width": "50px", "targets": 0 },  // No
                            { "width": "200px", "targets": 1 }, // Company Name
                            { "width": "100px", "targets": 2 }, // Activity
                            { "width": "80px", "targets": 26 }  // Action
                        ]
                    });
                    dataTableInitialized = true;
                    console.log('DataTable initialized successfully');

                    // 强制调整表头对齐
                    setTimeout(function(){
                        dataTable.columns.adjust().draw();
                    }, 200);

                } catch (error) {
                    console.error('DataTable initialization error:', error);
                    dataTableInitialized = false;
                }

            // Buttons
            $('#saveBtn').click(saveRecord);
            $(document).on('click', '.edit-btn', function () { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function () { deleteRecord($(this).data('id')); });
            $('#taskModal').on('hidden.bs.modal', clearForm);
            $('[data-bs-target="#taskModal"]').on('click', function () { clearForm(); });

            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            $.ajax({
                url: '/api/auditdept/aex52/get-all',
                type: 'GET',
                success: function (res) {
                    if (res && res.success) {
                        populateTable(res.data || []);
                    } else {
                        showAlert('Failed to load data', 'error');
                    }
                },
                error: function (xhr) { showAlert('Network error', 'error'); }
            });
        }

        function populateTable(records) {
            if (!dataTableInitialized) return;
            dataTable.clear();
            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    const rowData = [
                        index + 1,
                        getVal(r, 'CompanyName'),
                        getVal(r, 'Activity'),
                        getVal(r, 'Yeartodo'),
                        getVal(r, 'Quartertodo'),
                        getVal(r, 'PIC'),
                        getVal(r, 'Status'),
                        formatCurrency(getVal(r, 'AuditFee')),
                        formatDateForDisplay(getVal(r, 'DateBilled')),
                        formatDateForDisplay(getVal(r, 'StartDate')),
                        formatDateForDisplay(getVal(r, 'EndDate')),
                        getVal(r, 'NoofDays'),
                        getVal(r, 'ResultOverUnder'),
                        formatPercentage(getVal(r, 'AccSetup')),
                        formatPercentage(getVal(r, 'AccSummary')),
                        formatPercentage(getVal(r, 'AuditPlanning')),
                        formatPercentage(getVal(r, 'AuditExecution')),
                        formatPercentage(getVal(r, 'AuditCompletion')),
                        formatPercentage(getVal(r, 'TotalPercent')),
                        formatDateForDisplay(getVal(r, 'ReviewDateSent')),
                        formatDateForDisplay(getVal(r, 'ReviewEndDate')),
                        getVal(r, 'ReviewResultOverUnder'),
                        formatDateForDisplay(getVal(r, 'KKDateSent')),
                        formatDateForDisplay(getVal(r, 'KKEndDate')),
                        getVal(r, 'KKResultOverUnder'),
                        getVal(r, 'Final'),
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                         <button class="btn btn-sm btn-danger delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>`
                    ];
                    dataTable.row.add(rowData);
                });
            }
            dataTable.draw();
        }

        // ---------- Save ----------
        function saveRecord() {
                    console.log('Save button clicked');
                    hideModalAlert();
                    clearFieldErrors();

                    // [关键修复] 直接获取 Dropdown 选中的文本作为 CompanyName
                    // 如果 dropdown 有值，就取 text；否则取 hidden input 里的值作为保底
                    let selectedText = $('#clientSelect option:selected').text();
                    const selectedVal = $('#clientSelect').val();

                    // 如果选的是 "-- Select client --" 或者空，就置空
                    if (!selectedVal) {
                        selectedText = "";
                    }

                    const formData = {
                        Id: ($('#editIndex').val() || '0').trim(),

                        // 优先使用 Dropdown 显示的名字，确保所见即所得
                        CompanyName: selectedText.trim() || ($('#companyName').val() || '').trim(),

                        Activity: ($('#activity').val() || '').trim(),
                        Yeartodo: ($('#yearToDo').val() || '').trim(),
                        Quartertodo: ($('#quarterToDo').val() || '').trim(),
                        PIC: ($('#pic').val() || '').trim(),
                        Status: ($('#status').val() || '').trim(),
                        AuditFee: ($('#auditFee').val() || '').trim(),
                        DateBilled: ($('#dateBilled').val() || '').trim(),
                        StartDate: ($('#startDate').val() || '').trim(),
                        EndDate: ($('#asAtDate').val() || '').trim(),
                        NoofDays: ($('#noOfDays').val() || '').trim(),
                        ResultOverUnder: ($('#resultOverUnder').val() || '').trim(),
                        AccSetup: ($('#accSetupPercent').val() || '').trim(),
                        AccSummary: ($('#acSummaryPercent').val() || '').trim(),
                        AuditPlanning: ($('#auditPlanningPercent').val() || '').trim(),
                        AuditExecution: ($('#auditExecutionPercent').val() || '').trim(),
                        AuditCompletion: ($('#auditCompletionPercent').val() || '').trim(),
                        TotalPercent: ($('#totalPercent').val() || '').trim(),
                        ReviewDateSent: ($('#kuchingDateSent').val() || '').trim(),
                        ReviewEndDate: ($('#kuchingEndDate').val() || '').trim(),
                        ReviewResultOverUnder: ($('#kuchingResult').val() || '').trim(),
                        KKDateSent: ($('#kkDateSent').val() || '').trim(),
                        KKEndDate: ($('#kkEndDate').val() || '').trim(),
                        KKResultOverUnder: ($('#kkResult').val() || '').trim(),
                        Final: ($('#finalResult').val() || '').trim()
                    };

                    // [验证] 必须选择 Client
                    if (!selectedVal && !formData.CompanyName) {
                         setFieldError('#clientSelect', 'Please select a client');
                         showModalAlert('Please select a client.', 'error');
                         return;
                    }
            if (!formData.Activity) {
                setFieldError('#activity', 'Required');
                showModalAlert('Activity is required.', 'error');
                return;
            }

           const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/api/auditdept/aex52/update' : '/api/auditdept/aex52/create';
            const method = isUpdate ? 'PUT' : 'POST';

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin"></i> Loading...');
            clearFieldErrors();

            $.ajax({
                url: '/api/auditdept/aex52/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit"></i> Edit AEX WIP Record');
                    if (res && res.success) {
                        const d = res.data || {};
                        $('#editIndex').val(getVal(d, 'Id'));

                        // 1. 获取后端存的名字
                        const cName = getVal(d, 'CompanyName');
                        $('#companyName').val(cName); // 填入 hidden 用于保底

                        // 2. [关键] 尝试在 Dropdown 中自动选中这个公司
                        // 需要用到之前定义的 clientNameMap
                        if (cName && clientNameMap[cName.trim()]) {
                            // 如果找到了对应的 ID，直接赋值给 Select
                            $('#clientSelect').val(clientNameMap[cName.trim()]);
                        } else {
                            // 如果没找到（比如名字改了），至少在控制台报个警
                            console.warn('Could not match company name to ID:', cName);
                            $('#clientSelect').val('');
                        }

                        // 填充其他字段
                        $('#activity').val(getVal(d, 'Activity'));
                        $('#yearToDo').val(getVal(d, 'Yeartodo'));
                        $('#quarterToDo').val(getVal(d, 'Quartertodo'));
                        $('#pic').val(getVal(d, 'PIC'));
                        $('#status').val(getVal(d, 'Status'));
                        $('#auditFee').val(getVal(d, 'AuditFee'));
                        $('#dateBilled').val(formatDateForDisplay(getVal(d, 'DateBilled')));
                        $('#startDate').val(formatDateForDisplay(getVal(d, 'StartDate')));
                        $('#asAtDate').val(formatDateForDisplay(getVal(d, 'EndDate')));
                        $('#noOfDays').val(getVal(d, 'NoofDays'));
                        $('#resultOverUnder').val(getVal(d, 'ResultOverUnder'));
                        $('#accSetupPercent').val(getVal(d, 'AccSetup'));
                        $('#acSummaryPercent').val(getVal(d, 'AccSummary'));
                        $('#auditPlanningPercent').val(getVal(d, 'AuditPlanning'));
                        $('#auditExecutionPercent').val(getVal(d, 'AuditExecution'));
                        $('#auditCompletionPercent').val(getVal(d, 'AuditCompletion'));
                        $('#totalPercent').val(getVal(d, 'TotalPercent'));
                        $('#kuchingDateSent').val(formatDateForDisplay(getVal(d, 'ReviewDateSent')));
                        $('#kuchingEndDate').val(formatDateForDisplay(getVal(d, 'ReviewEndDate')));
                        $('#kuchingResult').val(getVal(d, 'ReviewResultOverUnder'));
                        $('#kkDateSent').val(formatDateForDisplay(getVal(d, 'KKDateSent')));
                        $('#kkEndDate').val(formatDateForDisplay(getVal(d, 'KKEndDate')));
                        $('#kkResult').val(getVal(d, 'KKResultOverUnder'));
                        $('#finalResult').val(getVal(d, 'Final'));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record', 'error');
                    }
                },
                error: function () { showAlert('Network error', 'error'); }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure?')) return;
            $.ajax({
                url: '/api/auditdept/aex52/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Deleted successfully', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Delete failed', 'error');
                    }
                },
                error: function () { showAlert('Network error', 'error'); }
            });
        }
    </script>
}