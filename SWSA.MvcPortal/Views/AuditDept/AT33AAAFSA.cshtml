@{
    ViewData["Title"] = "AT33AAAFSA";
}

<h1>AT3.3 Active & AEX Audited Financial Statement AFS</h1>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>AFS Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" id="addNewBtn">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <div class="card-body" style="overflow:auto">
                <div id="loadingMessage" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
                <div id="tableContainer" style="display: none;">
                    <table id="taskDatatable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th colspan="6"></th>
                                <th colspan="2">KK Review</th>
                                <th colspan="5">AFS from KK</th>
                                <th rowspan="3">Remark</th>
                                <th rowspan="3">Actions</th>
                            </tr>
                            <tr>
                                <th rowspan="2">No</th>
                                <th rowspan="2">Company Name</th>
                                <th rowspan="2">YE to do</th>
                                <th rowspan="2">PIC</th>
                                <th colspan="2">Activity</th>
                                <th rowspan="2">Date sent</th>
                                <th rowspan="2">Date Reviewed</th>
                                <th rowspan="2">Date sent to KK</th>
                                <th rowspan="2">Date received AFS</th>
                                <th rowspan="2">Date of AFS</th>
                                <th rowspan="2">Date of Directors Rept</th>
                                <th rowspan="2">MBRS generated</th>
                            </tr>
                            <tr>
                                <th>Active</th>
                                <th>AEX</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AFS Record</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Basic Information</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientSelect">Client <span class="text-danger">*</span></label>
                            <select id="clientSelect" name="clientSelect" class="form-control" required>
                                <option value="">-- Select client --</option>
                            </select>
                            <small class="text-muted">Options are linked from the Sdn Bhd Client List.</small>
                            <input type="hidden" id="client" name="client" />
                            <input type="hidden" id="clientId" name="clientId" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="yeToDo" class="form-label">YE to do</label>
                            <input type="text" id="yeToDo" class="form-control" placeholder="Enter year" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pic" class="form-label">PIC</label>
                            <input type="text" id="pic" class="form-control" placeholder="Enter PIC name" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="active" class="form-label">Active</label>
                            <select id="active" class="form-control">
                                <option value="">Select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="aex" class="form-label">AEX</label>
                            <select id="aex" class="form-control">
                                <option value="">Select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- KK Review -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">KK Review</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateSent" class="form-label">Date sent</label>
                            <input type="date" id="dateSent" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dateReviewed" class="form-label">Date Reviewed</label>
                            <input type="date" id="dateReviewed" class="form-control" />
                        </div>
                    </div>

                    <!-- AFS from KK -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">AFS from KK</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="dateSentToKK" class="form-label">Date sent to KK</label>
                            <input type="date" id="dateSentToKK" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="dateReceivedAFS" class="form-label">Date received AFS</label>
                            <input type="date" id="dateReceivedAFS" class="form-control" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="dateOfAFS" class="form-label">Date of AFS</label>
                            <input type="date" id="dateOfAFS" class="form-control" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateOfDirectorsRept" class="form-label">Date of Directors Rept</label>
                            <input type="date" id="dateOfDirectorsRept" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mbrsGenerated" class="form-label">MBRS generated</label>
                            <select id="mbrsGenerated" class="form-control">
                                <option value="">Select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- Remark -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Remark</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="remark" class="form-label">Remark</label>
                            <textarea id="remark" class="form-control" placeholder="Enter remark" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let isEditMode = false;
        let allRecords = [];

        // 1. 定义全局 Map 用于反向查找
        let clientNameMap = {};    // Key: CompanyName, Value: ID
        let clientDataMap = {};    // Key: ID, Value: Data object

        $(document).ready(function() {
            console.log('Document ready, starting initialization...');

            // 0. 确保页面有 hidden input
            if ($('#companyName').length === 0) {
                $('#taskForm').append('<input type="hidden" id="companyName" name="companyName" />');
            }

            // 1. 先加载 Dropdown (构建 Map)
            loadClientOptions();

            // 2. 加载表格数据
            loadTableData();

            // 3. 绑定按钮事件
            $('#addNewBtn').on('click', function() { openModal(false); });
            $('#saveBtn').on('click', function() { saveRecord(); });
            $('#taskModal').on('hidden.bs.modal', function() { resetForm(); });
        });

        // ---------------------------------------------------------
        //  1. 加载 Dropdown 并构建查找表
        // ---------------------------------------------------------
        function loadClientOptions() {
            $.ajax({
                url: '/api/get/company-options',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const select = $('#clientSelect');
                        select.empty();
                        select.append('<option value="">-- Select client --</option>');

                        // 重置 Map
                        clientNameMap = {};
                        clientDataMap = {};

                        response.data.forEach(client => {
                            // 存入 Map：Key=公司名(去空格), Value=ID
                            if(client.companyName) {
                                clientNameMap[client.companyName.trim()] = client.id;
                            }
                            clientDataMap[client.id] = client;

                            select.append(`<option value="${client.id}">${client.companyName}</option>`);
                        });
                        console.log('Client options loaded and maps built.');
                    }
                }
            });
        }

        // Dropdown 改变时，同步隐藏字段
        $('#clientSelect').on('change', function() {
            const selectedId = $(this).val();
            const clientData = clientDataMap[selectedId];

            if (clientData) {
                $('#companyName').val(clientData.companyName);
                $('#clientId').val(clientData.id);
                $('#client').val(clientData.companyName);
            } else {
                $('#companyName').val('');
                $('#clientId').val('');
                $('#client').val('');
            }
        });

        // ---------------------------------------------------------
        //  2. 表格加载逻辑 (保持你原有的风格)
        // ---------------------------------------------------------
        function loadTableData() {
                    console.log('Starting to load table data...');

                    // 1. 在隐藏表格前，先销毁现有的 DataTable 实例
                    // 这样才能彻底清除旧数据缓存，允许我们手动修改 HTML
                    if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                        $('#taskDatatable').DataTable().destroy();
                    }

                    $('#loadingMessage').show();
                    $('#tableContainer').hide();

                    $.ajax({
                        url: '/api/auditdept/at33/get-all',
                        type: 'GET',
                        cache: false, // 2. 禁止浏览器缓存，确保拿到最新数据
                        success: function(response) {
                            $('#loadingMessage').hide();

                            if (response.success && response.data) {
                                allRecords = response.data;

                                // 3. 手动填充 HTML
                                populateTable(allRecords);

                                $('#tableContainer').show();

                                // 4. 数据填充完毕后，重新初始化 DataTable
                                $('#taskDatatable').DataTable({
                                    "responsive": true,
                                    "autoWidth": false,
                                    "order": [[0, 'asc']], // 默认按第一列排序
                                    "destroy": true // 确保没有残留实例
                                });

                            } else {
                                showAlert('Error loading data: ' + (response.message || 'No data available'), 'warning');
                                populateTable([]);
                                $('#tableContainer').show();
                            }
                        },
                        error: function(xhr, status, error) {
                            $('#loadingMessage').hide();
                            console.error('Ajax error:', error);
                            showAlert('Error loading data: ' + error, 'danger');
                        }
                    });
                }

        function populateTable(data) {
            const tbody = $('#tableBody');
            tbody.empty();

            if (data && data.length > 0) {
                data.forEach((record, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(record.CompanyName || record.companyName || '')}</td>
                            <td>${escapeHtml(record.YEtodo || record.yEtodo || '')}</td>
                            <td>${escapeHtml(record.PIC || record.pic || '')}</td>
                            <td>${escapeHtml(record.Active || record.active || '')}</td>
                            <td>${escapeHtml(record.AEX || record.aex || '')}</td>
                            <td>${formatDateForDisplay(record.DateSent || record.dateSent)}</td>
                            <td>${formatDateForDisplay(record.DateReviewed || record.dateReviewed)}</td>
                            <td>${formatDateForDisplay(record.DateSentToKK || record.dateSentToKK)}</td>
                            <td>${formatDateForDisplay(record.DateReceivedAFS || record.dateReceivedAFS)}</td>
                            <td>${formatDateForDisplay(record.DateofAFS || record.dateofAFS)}</td>
                            <td>${formatDateForDisplay(record.DateofDirectorsRept || record.dateofDirectorsRept)}</td>
                            <td>${escapeHtml(record.MBRSgenerated || record.mbrsgenerated || '')}</td>
                            <td>${escapeHtml(record.Remark || record.remark || '')}</td>
                            <td style="white-space: nowrap;">
                                <button class="btn btn-sm btn-info me-1" onclick="editRecord(${record.Id || record.id})" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${record.Id || record.id})" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        }

        // ---------------------------------------------------------
        //  3. Edit Logic (核心：反向查找回显)
        // ---------------------------------------------------------
        function editRecord(id) {
            console.log('Editing record:', id);

            $.ajax({
                url: `/api/auditdept/at33/get/${id}`,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        isEditMode = true;
                        $('#modalTitle').text('Edit AFS Record');
                        $('#recordId').val(record.id);

                        // === 关键 Dropdown 回显逻辑 ===
                        $('#companyName').val(record.companyName || '');

                        // A. 优先尝试用 ID 匹配
                        if (record.clientId && clientDataMap[record.clientId]) {
                            $('#clientSelect').val(record.clientId);
                        }
                        // B. 如果没 ID，用名字反向查找
                        else if (record.companyName) {
                            const foundId = clientNameMap[record.companyName.trim()];
                            if (foundId) {
                                $('#clientSelect').val(foundId);
                                $('#clientId').val(foundId); // 补全 ID
                            }
                        }
                        // === 逻辑结束 ===

                        // 填充其他字段
                        $('#yeToDo').val(record.yEtodo || '');
                        $('#pic').val(record.pic || '');
                        $('#active').val(record.active || '');
                        $('#aex').val(record.aex || '');
                        $('#dateSent').val(formatDateForInput(record.dateSent));
                        $('#dateReviewed').val(formatDateForInput(record.dateReviewed));
                        $('#dateSentToKK').val(formatDateForInput(record.dateSentToKK));
                        $('#dateReceivedAFS').val(formatDateForInput(record.dateReceivedAFS));
                        $('#dateOfAFS').val(formatDateForInput(record.dateofAFS));
                        $('#dateOfDirectorsRept').val(formatDateForInput(record.dateofDirectorsRept));
                        $('#mbrsGenerated').val(record.mbrsgenerated || '');
                        $('#remark').val(record.remark || '');

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + response.message, 'danger');
                    }
                },
                error: function(xhr) {
                    showAlert('Error loading record', 'danger');
                }
            });
        }

        // ---------------------------------------------------------
        //  4. Save Logic
        // ---------------------------------------------------------
        function saveRecord() {
            // 确保从隐藏字段取名字 (Dropdown change 事件会更新它)
            // 如果是 Edit 回显，也会预先填入这个字段
            const companyName = $('#companyName').val();

            if (!companyName) {
                showAlert('Company Name is required (Please select a client)', 'warning');
                return;
            }

            const formData = {
                companyName: companyName,
                yEtodo: $('#yeToDo').val() || null,
                pic: $('#pic').val() || null,
                active: $('#active').val() || null,
                aex: $('#aex').val() || null,
                dateSent: $('#dateSent').val() || null,
                dateReviewed: $('#dateReviewed').val() || null,
                dateSentToKK: $('#dateSentToKK').val() || null,
                dateReceivedAFS: $('#dateReceivedAFS').val() || null,
                dateofAFS: $('#dateOfAFS').val() || null,
                dateofDirectorsRept: $('#dateOfDirectorsRept').val() || null,
                mbrsgenerated: $('#mbrsGenerated').val() || null,
                remark: $('#remark').val() || null
            };

            if (isEditMode) {
                formData.id = parseInt($('#recordId').val());
            }

            const url = isEditMode ? '/api/auditdept/at33/update' : '/api/auditdept/at33/create';
            const method = isEditMode ? 'PUT' : 'POST';

            $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (response.success) {
                        showAlert('Saved successfully!', 'success');
                        $('#taskModal').modal('hide');
                        loadTableData();
                    } else {
                        showAlert('Error: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showAlert('Error saving: ' + error, 'danger');
                }
            });
        }

        // ---------------------------------------------------------
        //  Helpers
        // ---------------------------------------------------------
        function openModal(editMode) {
            isEditMode = editMode;
            $('#modalTitle').text(editMode ? 'Edit AFS Record' : 'Add New AFS Record');
            if (!editMode) { resetForm(); }
            $('#taskModal').modal('show');
        }

        function resetForm() {
            $('#taskForm')[0].reset();
            $('#recordId').val('');
            $('#clientSelect').val('');
            $('#companyName').val(''); // 清空隐藏字段
            isEditMode = false;
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: `/api/auditdept/at33/delete/${id}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            showAlert('Deleted successfully!', 'success');
                            loadTableData();
                        } else {
                            showAlert('Error: ' + response.message, 'danger');
                        }
                    }
                });
            }
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}/${date.getFullYear()}`;
            } catch (e) { return ''; }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                return date.toISOString().split('T')[0];
            } catch (e) { return ''; }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showAlert(message, type) {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                <strong>${type === 'success' ? 'Success' : 'Notice'}:</strong> ${message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                               </div>`;
            $('.alert').remove();
            $('.card-body').prepend(alertHtml);
            setTimeout(() => { $('.alert').alert('close'); }, 5000);
        }
    </script>
}