@{
    ViewData["Title"] = "Audit Aex Backlog";
}

<h1>Audit Aex Backlog</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>Audit AEX Backlog Records
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="clearForm()">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Actions</th>
                            <th>Group</th>
                            <th>Company Name</th>
                            <th>Quarter to Do Audit</th>
                            <th>Activity</th>
                            <th>Year End</th>
                            <th>Year to do</th>
                            <th>Move to Active Sch</th>
                            <th>Date Doc in</th>
                            <th>Acctng wk?</th>
                            <th>Reason why backlog</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New Audit AEX Backlog Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grouping">Group</label>
                                <input type="text" id="grouping" name="grouping" class="form-control" placeholder="Enter group" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name (Suppose Link From Client List)</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quarterToDoAudit">Quarter to Do Audit</label>
                                <select id="quarterToDoAudit" name="quarterToDoAudit" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="e.g., Dec 2024" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="yearToDo">Year to do</label>
                                <input type="text" id="yearToDo" name="yearToDo" class="form-control" placeholder="e.g., 2024" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="moveToActiveSch">Move to Active Sch</label>
                                <select id="moveToActiveSch" name="moveToActiveSch" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateDocIn">Date Doc in</label>
                                <input type="date" id="dateDocIn" name="dateDocIn" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="acctngWk">Acctng wk?</label>
                                <select id="acctngWk" name="acctngWk" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reasonWhyBacklog">Reason why backlog</label>
                                <input type="text" id="reasonWhyBacklog" name="reasonWhyBacklog" class="form-control" placeholder="Enter reason" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script>
        let currentEditId = null;

        $(document).ready(function() {
            loadData();

            // 保存按钮点击事件
            $('#saveBtn').click(function() {
                saveRecord();
            });
        });

        function loadData() {
            $.ajax({
                url: '/api/auditdept/aex42/get-all',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        populateTable(response.data);
                    } else {
                        console.error('Error loading data:', response.message);
                        alert('Error loading data: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading data:', error);
                    alert('Error loading data: ' + error);
                }
            });
        }

        function populateTable(data) {
            const tbody = $('#taskDatatable tbody');
            tbody.empty();

            if (data && data.length > 0) {
                data.forEach(function(item) {
                    const row = `
                        <tr>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                            <td>${escapeHtml(item.grouping) || ''}</td>
                            <td>${escapeHtml(item.companyName) || ''}</td>
                            <td>${escapeHtml(item.quarterToDoAudit) || ''}</td>
                            <td>${escapeHtml(item.activity) || ''}</td>
                            <td>${escapeHtml(item.yearEnd) || ''}</td>
                            <td>${escapeHtml(item.yearToDo) || ''}</td>
                            <td>${escapeHtml(item.moveToActiveSch) || ''}</td>
                            <td>${item.dateDocIn ? new Date(item.dateDocIn).toLocaleDateString() : ''}</td>
                            <td>${escapeHtml(item.acctngWk) || ''}</td>
                            <td>${escapeHtml(item.reasonWhyBacklog) || ''}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="11" class="text-center">No records found</td></tr>');
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function clearForm() {
            currentEditId = null;
            $('#recordId').val('');
            $('#taskForm')[0].reset();
            $('#modalTitle').text('Add New Audit AEX Backlog Record');
        }

        function editRecord(id) {
            $.ajax({
                url: '/api/auditdept/aex42/get/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditId = record.id;
                        $('#recordId').val(record.id);

                        // Populate form fields
                        $('#grouping').val(record.grouping || '');
                        $('#companyName').val(record.companyName || '');
                        $('#quarterToDoAudit').val(record.quarterToDoAudit || '');
                        $('#activity').val(record.activity || '');
                        $('#yearEnd').val(record.yearEnd || '');
                        $('#yearToDo').val(record.yearToDo || '');
                        $('#moveToActiveSch').val(record.moveToActiveSch || '');

                        // Format date for date input
                        if (record.dateDocIn) {
                            const date = new Date(record.dateDocIn);
                            const formattedDate = date.toISOString().split('T')[0];
                            $('#dateDocIn').val(formattedDate);
                        } else {
                            $('#dateDocIn').val('');
                        }

                        $('#acctngWk').val(record.acctngWk || '');
                        $('#reasonWhyBacklog').val(record.reasonWhyBacklog || '');

                        $('#modalTitle').text('Edit Audit AEX Backlog Record');
                        $('#taskModal').modal('show');
                    } else {
                        alert('Error loading record: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error loading record: ' + error);
                }
            });
        }

        function saveRecord() {
            const formData = {
                Id: $('#recordId').val() || 0,
                Grouping: $('#grouping').val(),
                CompanyName: $('#companyName').val(),
                QuarterToDoAudit: $('#quarterToDoAudit').val(),
                Activity: $('#activity').val(),
                YearEnd: $('#yearEnd').val(),
                YearToDo: $('#yearToDo').val(),
                MoveToActiveSch: $('#moveToActiveSch').val(),
                DateDocIn: $('#dateDocIn').val() ? $('#dateDocIn').val() : null,
                AcctngWk: $('#acctngWk').val(),
                ReasonWhyBacklog: $('#reasonWhyBacklog').val()
            };

            const url = currentEditId ? '/api/auditdept/aex42/update' : '/api/auditdept/aex42/create';
            const method = currentEditId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#taskModal').modal('hide');
                        loadData();
                        alert(response.message);
                    } else {
                        alert('Error saving record: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error saving record: ' + error);
                }
            });
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '/api/auditdept/aex42/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            loadData();
                            alert(response.message);
                        } else {
                            alert('Error deleting record: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting record: ' + error);
                    }
                });
            }
        }
    </script>
}