@{
    ViewData["Title"] = "AEX51LB";
}

<h1>AEX Logbook</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="13"></th>
                            <th colspan="8">1.Audit WIP(link to AEX 5.2)</th>
                            <th colspan="1">2. Audit Report</th>
                            <th colspan="3">3. Directors' Signing pages(AT3.4)</th>
                            <th colspan="2">Tax Dept</th>
                            <th colspan="2">Sec Dept</th>
                            <th colspan="2">Post Audit Work</th>
                            <th rowspan="3">Action</th>
                        </tr>

                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Activity</th>
                            <th rowspan="3">YE to do</th>
                            <th rowspan="3">Quarter to do</th>
                            <th rowspan="3">PIC</th>
                            <th rowspan="3">18 mths due</th>
                            <th rowspan="3">Status</th>
                            <th rowspan="3">Doc.Inward Date</th>
                            <th colspan="2">Est current year result '000</th>
                            <th colspan="2">Billing</th>

                            <th rowspan="2">Start Date</th>
                            <th rowspan="2">Day Done</th>
                            <th rowspan="2">%Done</th>
                            <th rowspan="2">Result Over/Under</th>
                            <th rowspan="2">Completed?</th>
                            <th colspan="1">KCH Review (1st)</th>
                            <th colspan="1">KK Review (2nd)</th>
                            <th rowspan="2">Review Result</th>
                            <th rowspan="2">Date receive from KK</th>
                            <th rowspan="2">Who to meet client & date</th>
                            <th rowspan="2">Date sent to client</th>
                            <th rowspan="2">Date Received Back</th>
                            <th rowspan="2">Tax Due Date</th>
                            <th rowspan="2">Pass to Tax Dept</th>
                            <th rowspan="2">SSM Due Date</th>
                            <th rowspan="2">Date pass to Sec Dept(MBRS)</th>
                            <th rowspan="2">Binded</th>
                            <th rowspan="2">Despatch Date to Client</th>
                        </tr>

                        <tr>
                            <th>Revenue</th>
                            <th>Profit/(loss)</th>
                            <th>Audit Fee</th>
                            <th>Date billed</th>
                            <th>Date sent</th>
                            <th>Date sent to KK</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AEX Logbook Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="number">No</label>
                                <input type="text" id="number" name="number" class="form-control" placeholder="Enter number" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="companyName">Company Name (Suppose Link From Client List)</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="yeToDo">YE to do</label>
                                <input type="text" id="yeToDo" name="yeToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="quarterToDo">Quarter to do</label>
                                <select id="quarterToDo" name="quarterToDo" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="eighteenMonthsDue">18 mths due</label>
                                <input type="text" id="eighteenMonthsDue" name="eighteenMonthsDue" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="docInwardDate">Doc.Inward Date</label>
                                <input type="text" id="docInwardDate" name="docInwardDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Financial Results & Billing -->
                    <div class="form-info-label col-12">
                        <label>Financial Results & Billing</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="revenue">Revenue ('000)</label>
                                <input type="text" id="revenue" name="revenue" class="form-control" placeholder="Enter revenue" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="profitLoss">Profit/(loss) ('000)</label>
                                <input type="text" id="profitLoss" name="profitLoss" class="form-control" placeholder="Enter profit/loss" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="text" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="dateBilled">Date billed</label>
                                <input type="text" id="dateBilled" name="dateBilled" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- 1. Audit WIP -->
                    <div class="form-info-label col-12">
                        <label>1. Audit WIP</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="dayDone">Day Done</label>
                                <input type="number" id="dayDone" name="dayDone" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="percentDone">%Done</label>
                                <input type="text" id="percentDone" name="percentDone" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="completed">Completed?</label>
                                <select id="completed" name="completed" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Audit Report -->
                    <div class="form-info-label col-12">
                        <label>2. Audit Report</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="kchReviewDate">KCH Review (1st) - Date sent</label>
                                <input type="text" id="kchReviewDate" name="kchReviewDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="kkReviewDate">KK Review (2nd) - Date sent to KK</label>
                                <input type="text" id="kkReviewDate" name="kkReviewDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- 3. Directors' Signing pages -->
                    <div class="form-info-label col-12">
                        <label>3. Directors' Signing pages</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="reviewResult">Review Result</label>
                                <input type="text" id="reviewResult" name="reviewResult" class="form-control" placeholder="Enter review result" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateReceiveFromKK">Date receive from KK</label>
                                <input type="text" id="dateReceiveFromKK" name="dateReceiveFromKK" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="whoToMeetClient">Who to meet client & date</label>
                                <input type="text" id="whoToMeetClient" name="whoToMeetClient" class="form-control" placeholder="Enter details" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentToClient">Date sent to client</label>
                                <input type="text" id="dateSentToClient" name="dateSentToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedBack">Date Received Back</label>
                                <input type="text" id="dateReceivedBack" name="dateReceivedBack" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Tax Dept -->
                    <div class="form-info-label col-12">
                        <label>Tax Dept</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxDueDate">Tax Due Date</label>
                                <input type="text" id="taxDueDate" name="taxDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="passToTaxDept">Pass to Tax Dept</label>
                                <input type="text" id="passToTaxDept" name="passToTaxDept" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Sec Dept -->
                    <div class="form-info-label col-12">
                        <label>Sec Dept</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssmDueDate">SSM Due Date</label>
                                <input type="text" id="ssmDueDate" name="ssmDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datePassToSecDept">Date pass to Sec Dept(MBRS)</label>
                                <input type="text" id="datePassToSecDept" name="datePassToSecDept" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Post Audit Work -->
                    <div class="form-info-label col-12">
                        <label>Post Audit Work</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="binded">Binded</label>
                                <select id="binded" name="binded" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="despatchDateToClient">Despatch Date to Client</label>
                                <input type="text" id="despatchDateToClient" name="despatchDateToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        let dataTable;
        let dataTableInitialized = false;

        // ---------- Modal alert + inline field errors ----------
        function showModalAlert(msg, type) {
            // 先创建 alert 容器如果不存在
            if ($('#modalAlert').length === 0) {
                $('#taskModal .modal-body').prepend('<div id="modalAlert" class="alert d-none"></div>');
            }

            const map = {
                success: 'alert-success',
                error: 'alert-danger',
                warning: 'alert-warning',
                info: 'alert-info'
            };
            const $box = $('#modalAlert');
            $box.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(map[type] || 'alert-info')
                .html(msg);

            const $body = $('#taskModal .modal-body');
            $body.stop(true).animate({ scrollTop: 0 }, 200, function () {
                $box.attr('tabindex', -1).focus();
            });
        }

        function hideModalAlert() {
            $('#modalAlert').addClass('d-none').empty();
        }

        function clearFieldErrors() {
            $('#taskForm .is-invalid').removeClass('is-invalid');
            $('#taskForm .invalid-feedback').remove();
        }

        function setFieldError(selector, message) {
            const $f = $(selector);
            if (!$f.length) return;
            $f.addClass('is-invalid');
            if ($f.next('.invalid-feedback').length === 0) {
                $f.after('<div class="invalid-feedback"></div>');
            }
            $f.next('.invalid-feedback').text(message);
        }

        // ---------- Page-level alert ----------
        function showAlert(message, type) {
            const cls = type === 'success' ? 'alert-success'
                : type === 'error' ? 'alert-danger'
                    : type === 'warning' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                aria-label="Close"></button>
                                  </div>`;
            $('.card-header').after(html);
            setTimeout(() => $('.alert').alert('close'), type === 'error' ? 5000 : 3000);
        }

        // ---------- Helpers ----------
        function formatDateForDisplay(s) {
            if (!s) return '';
            try {
                // 如果是日期对象或字符串，尝试格式化
                if (s instanceof Date) {
                    return s.toLocaleDateString('en-GB');
                }
                if (typeof s === 'string') {
                    const date = new Date(s);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-GB');
                    }
                }
                return s;
            } catch (e) {
                return s;
            }
        }

        function getVal(obj, name) {
            if (!obj) return '';

            if (obj[name] !== undefined && obj[name] !== null) return obj[name];

            const camel = name.charAt(0).toLowerCase() + name.slice(1);
            if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];

            const targetLower = name.toLowerCase();
            for (const key in obj) {
                if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                if (key.toLowerCase() === targetLower) return obj[key];
            }
            return '';
        }

        function clearForm() {
            $('#taskForm')[0].reset();
            $('#editIndex').val('');
            $('#modalTitle').text('Add New AEX Logbook Record');
            hideModalAlert();
            clearFieldErrors();
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '';
            try {
                return 'RM ' + parseFloat(amount).toLocaleString('en-MY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (e) {
                return amount || '';
            }
        }

        // ---------- Init ----------
        $(document).ready(function () {
            console.log('Document ready, initializing...');

            // 初始化日期选择器
            try {
                $('input[type="text"]').filter(function () {
                    const id = $(this).attr('id') || '';
                    return id.includes('Date') || id.includes('date') || id.includes('Due');
                }).datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true
                });
                console.log('Datepicker initialized');
            } catch (e) {
                console.error('Datepicker init error:', e);
            }

            // 初始化 DataTable - 简化配置
            try {
                dataTable = $('#taskDatatable').DataTable({
                    responsive: true,
                    ordering: true,
                    autoWidth: true, // 改为 true 让表格自动调整宽度
                    pageLength: 10,
                    order: [[1, 'asc']], // 以 Company Name 排序
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        emptyTable: "No records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    // 移除复杂的列配置，让 DataTable 自动处理
                    columnDefs: [
                        {
                            targets: '_all',
                            defaultContent: '' // 防止 undefined 错误
                        }
                    ]
                });
                dataTableInitialized = true;
                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('DataTable initialization error:', error);
                // 如果 DataTable 初始化失败，使用简单的表格显示
                $('#taskDatatable').addClass('table table-bordered table-striped');
                dataTableInitialized = false;
            }

            // 绑定按钮事件
            $('#saveBtn').click(saveRecord);

            // 使用事件委托绑定动态按钮
            $(document).on('click', '.edit-btn', function () {
                const id = $(this).data('id');
                console.log('Edit clicked for ID:', id);
                editRecord(id);
            });

            $(document).on('click', '.delete-btn', function () {
                const id = $(this).data('id');
                console.log('Delete clicked for ID:', id);
                deleteRecord(id);
            });

            $('#taskModal').on('hidden.bs.modal', clearForm);

            // 新建按钮点击事件
            $('[data-bs-target="#taskModal"]').on('click', function () {
                console.log('New Task button clicked');
                clearForm();
            });

            // 首次载入数据
            console.log('Loading initial data...');
            loadRecordsFromDatabase();
        });

        // ---------- Load & Render ----------
        function loadRecordsFromDatabase() {
            console.log('Loading records from database...');

            $.ajax({
                url: '/api/auditdept/aex51/get-all',
                type: 'GET',
                success: function (res) {
                    console.log('API response:', res);
                    if (res && res.success) {
                        populateTable(res.data || []);
                        showAlert('Loaded ' + (res.data?.length || 0) + ' records.', 'success');
                    } else {
                        const errorMsg = res?.message || 'Unknown error';
                        console.error('API error:', errorMsg);
                        showAlert('Failed to load: ' + errorMsg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', error);
                    showAlert('Failed to load: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        function populateTable(records) {
            console.log('Populating table with records:', records);

            if (!dataTableInitialized) {
                console.log('DataTable not initialized, using manual table population');
                // 手动填充表格的降级方案
                manualPopulateTable(records);
                return;
            }

            // 清除现有数据
            dataTable.clear();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    console.log('Processing record:', r);

                    // 构建数据行 - 确保列数匹配表格结构
                    const rowData = [
                        index + 1, // No
                        getVal(r, 'CompanyName'),                                // Company Name
                        getVal(r, 'Activity'),                                   // Activity
                        getVal(r, 'YEtodo'),                                     // YE to do
                        getVal(r, 'Quartertodo'),                                // Quarter to do
                        getVal(r, 'PIC'),                                        // PIC
                        formatDateForDisplay(getVal(r, 'First18mthDue')),        // 18 mths due
                        getVal(r, 'Status'),                                     // Status
                        formatDateForDisplay(getVal(r, 'DocInwardsDate')),       // Doc.Inward Date
                        formatCurrency(getVal(r, 'Revenue')),                    // Revenue
                        formatCurrency(getVal(r, 'Profit')),                     // Profit
                        formatCurrency(getVal(r, 'AuditFee')),                   // Audit Fee
                        formatDateForDisplay(getVal(r, 'DateBilled')),           // Date billed
                        formatDateForDisplay(getVal(r, 'StartDate')),            // Start Date
                        getVal(r, 'DayDone') || '',                              // Day Done
                        getVal(r, 'DonePercent') || '',                          // %Done
                        getVal(r, 'ResultOverUnder'),                            // Result Over/Under
                        getVal(r, 'Completed'),                                  // Completed?
                        formatDateForDisplay(getVal(r, 'DateSent')),             // KCH Review
                        formatDateForDisplay(getVal(r, 'DateSenttoKK')),         // KK Review
                        getVal(r, 'ReviewResult'),                               // Review Result
                        formatDateForDisplay(getVal(r, 'DateReceivedfrKK')),     // Date receive from KK
                        getVal(r, 'WhomeetClientDate'),                          // Who to meet client
                        formatDateForDisplay(getVal(r, 'DateSentClient')),       // Date sent to client
                        formatDateForDisplay(getVal(r, 'DateReceivedBack')),     // Date Received Back
                        formatDateForDisplay(getVal(r, 'TaxDueDate')),           // Tax Due Date
                        formatDateForDisplay(getVal(r, 'PasstoTaxDept')),        // Pass to Tax Dept
                        formatDateForDisplay(getVal(r, 'SSMdueDate')),           // SSM Due Date
                        formatDateForDisplay(getVal(r, 'DatePassToSecDept')),    // Date pass to Sec Dept
                        getVal(r, 'Binded'),                                     // Binded
                        formatDateForDisplay(getVal(r, 'DespatachDateClient')),  // Despatch Date
                        // Edit & Delete buttons
                        `<button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                            <i class="fas fa-edit"></i>
                         </button>
                         <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                            <i class="fas fa-trash"></i>
                         </button>`
                    ];

                    console.log('Adding row data:', rowData);
                    dataTable.row.add(rowData);
                });
            }

            dataTable.draw();
            console.log('Table populated successfully');
        }

        // 降级方案：手动填充表格
        function manualPopulateTable(records) {
            const tbody = $('#taskDatatable tbody');
            tbody.empty();

            if (records && records.length) {
                records.forEach(function (r, index) {
                    const id = getVal(r, 'Id');
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${getVal(r, 'CompanyName') || ''}</td>
                            <td>${getVal(r, 'Activity') || ''}</td>
                            <td>${getVal(r, 'YEtodo') || ''}</td>
                            <td>${getVal(r, 'Quartertodo') || ''}</td>
                            <td>${getVal(r, 'PIC') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'First18mthDue'))}</td>
                            <td>${getVal(r, 'Status') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DocInwardsDate'))}</td>
                            <td>${formatCurrency(getVal(r, 'Revenue'))}</td>
                            <td>${formatCurrency(getVal(r, 'Profit'))}</td>
                            <td>${formatCurrency(getVal(r, 'AuditFee'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateBilled'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'StartDate'))}</td>
                            <td>${getVal(r, 'DayDone') || ''}</td>
                            <td>${getVal(r, 'DonePercent') || ''}</td>
                            <td>${getVal(r, 'ResultOverUnder') || ''}</td>
                            <td>${getVal(r, 'Completed') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSent'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSenttoKK'))}</td>
                            <td>${getVal(r, 'ReviewResult') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateReceivedfrKK'))}</td>
                            <td>${getVal(r, 'WhomeetClientDate') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateSentClient'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DateReceivedBack'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'TaxDueDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'PasstoTaxDept'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'SSMdueDate'))}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DatePassToSecDept'))}</td>
                            <td>${getVal(r, 'Binded') || ''}</td>
                            <td>${formatDateForDisplay(getVal(r, 'DespatachDateClient'))}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-id="${id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="32" class="text-center">No records found</td></tr>');
            }
        }

        // ---------- Save (Create / Update) ----------
        function saveRecord() {
            console.log('Save button clicked');
            hideModalAlert();
            clearFieldErrors();

            const formData = {
                Id: ($('#editIndex').val() || '0').trim(),

                CompanyName: ($('#companyName').val() || '').trim(),
                Activity: ($('#activity').val() || '').trim(),
                YEtodo: ($('#yeToDo').val() || '').trim(),
                Quartertodo: ($('#quarterToDo').val() || '').trim(),
                PIC: ($('#pic').val() || '').trim(),
                First18mthDue: ($('#eighteenMonthsDue').val() || '').trim(),
                Status: ($('#status').val() || '').trim(),
                DocInwardsDate: ($('#docInwardDate').val() || '').trim(),
                Revenue: ($('#revenue').val() || '').trim(),
                Profit: ($('#profitLoss').val() || '').trim(),
                AuditFee: ($('#auditFee').val() || '').trim(),
                DateBilled: ($('#dateBilled').val() || '').trim(),
                StartDate: ($('#startDate').val() || '').trim(),
                EndDate: ($('#endDate').val() || '').trim(),
                DonePercent: ($('#percentDone').val() || '').trim(),
                ResultOverUnder: ($('#resultOverUnder').val() || '').trim(),
                Completed: ($('#completed').val() || '').trim(),
                DateSent: ($('#kchReviewDate').val() || '').trim(),
                DateSenttoKK: ($('#kkReviewDate').val() || '').trim(),
                ReviewResult: ($('#reviewResult').val() || '').trim(),
                DateReceivedfrKK: ($('#dateReceiveFromKK').val() || '').trim(),
                WhomeetClientDate: ($('#whoToMeetClient').val() || '').trim(),
                DateSentClient: ($('#dateSentToClient').val() || '').trim(),
                DateReceivedBack: ($('#dateReceivedBack').val() || '').trim(),
                TaxDueDate: ($('#taxDueDate').val() || '').trim(),
                PasstoTaxDept: ($('#passToTaxDept').val() || '').trim(),
                SSMdueDate: ($('#ssmDueDate').val() || '').trim(),
                DatePassToSecDept: ($('#datePassToSecDept').val() || '').trim(),
                Binded: ($('#binded').val() || '').trim(),
                DespatachDateClient: ($('#despatchDateToClient').val() || '').trim()
            };

            console.log('Form data:', formData);

            // 简单必填验证
            let hasError = false;
            if (!formData.CompanyName) { setFieldError('#companyName', 'Required'); hasError = true; }
            if (!formData.Activity) { setFieldError('#activity', 'Required'); hasError = true; }

            if (hasError) {
                showModalAlert('Please fix the highlighted fields.', 'error');
                $('#taskForm .is-invalid').first().focus();
                return;
            }

            const isUpdate = Number(formData.Id) > 0;
            const url = isUpdate ? '/api/auditdept/aex51/update' : '/api/auditdept/aex51/create';
            const method = isUpdate ? 'PUT' : 'POST';

            console.log('Saving via:', url, method);

            const $btn = $('#saveBtn');
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    console.log('Save response:', res);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    if (res && res.success) {
                        $('#taskModal').modal('hide');
                        showAlert('Record saved successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        const msg = res?.errors ? res.errors.join(', ') : (res?.message || 'Unknown error');
                        showModalAlert('Error saving record: ' + msg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Save error:', error);
                    $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                    showModalAlert('Error saving record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Edit ----------
        function editRecord(id) {
            console.log('Editing record ID:', id);
            $('#modalTitle').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');
            hideModalAlert();
            clearFieldErrors();

            $.ajax({
                url: '/api/auditdept/aex51/get/' + id,
                type: 'GET',
                success: function (res) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit AEX Logbook Record');
                    if (res && res.success) {
                        const d = res.data || {};
                        console.log('Edit data loaded:', d);

                        $('#editIndex').val(getVal(d, 'Id'));

                        // 填充表单字段
                        $('#companyName').val(getVal(d, 'CompanyName'));
                        $('#activity').val(getVal(d, 'Activity'));
                        $('#yeToDo').val(getVal(d, 'YEtodo'));
                        $('#quarterToDo').val(getVal(d, 'Quartertodo'));
                        $('#pic').val(getVal(d, 'PIC'));
                        $('#eighteenMonthsDue').val(formatDateForDisplay(getVal(d, 'First18mthDue')));
                        $('#status').val(getVal(d, 'Status'));
                        $('#docInwardDate').val(formatDateForDisplay(getVal(d, 'DocInwardsDate')));
                        $('#revenue').val(getVal(d, 'Revenue'));
                        $('#profitLoss').val(getVal(d, 'Profit'));
                        $('#auditFee').val(getVal(d, 'AuditFee'));
                        $('#dateBilled').val(formatDateForDisplay(getVal(d, 'DateBilled')));
                        $('#startDate').val(formatDateForDisplay(getVal(d, 'StartDate')));
                        $('#endDate').val(formatDateForDisplay(getVal(d, 'EndDate')));
                        $('#percentDone').val(getVal(d, 'DonePercent'));
                        $('#resultOverUnder').val(getVal(d, 'ResultOverUnder'));
                        $('#completed').val(getVal(d, 'Completed'));
                        $('#kchReviewDate').val(formatDateForDisplay(getVal(d, 'DateSent')));
                        $('#kkReviewDate').val(formatDateForDisplay(getVal(d, 'DateSenttoKK')));
                        $('#reviewResult').val(getVal(d, 'ReviewResult'));
                        $('#dateReceiveFromKK').val(formatDateForDisplay(getVal(d, 'DateReceivedfrKK')));
                        $('#whoToMeetClient').val(getVal(d, 'WhomeetClientDate'));
                        $('#dateSentToClient').val(formatDateForDisplay(getVal(d, 'DateSentClient')));
                        $('#dateReceivedBack').val(formatDateForDisplay(getVal(d, 'DateReceivedBack')));
                        $('#taxDueDate').val(formatDateForDisplay(getVal(d, 'TaxDueDate')));
                        $('#passToTaxDept').val(formatDateForDisplay(getVal(d, 'PasstoTaxDept')));
                        $('#ssmDueDate').val(formatDateForDisplay(getVal(d, 'SSMdueDate')));
                        $('#datePassToSecDept').val(formatDateForDisplay(getVal(d, 'DatePassToSecDept')));
                        $('#binded').val(getVal(d, 'Binded'));
                        $('#despatchDateToClient').val(formatDateForDisplay(getVal(d, 'DespatachDateClient')));

                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Error loading record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr, status, error) {
                    $('#modalTitle').html('<i class="fas fa-edit me-2"></i>Edit AEX Logbook Record');
                    showAlert('Error loading record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }

        // ---------- Delete ----------
        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;

            $.ajax({
                url: '/api/auditdept/aex51/delete/' + id,
                type: 'DELETE',
                success: function (res) {
                    if (res && res.success) {
                        showAlert('Record deleted successfully.', 'success');
                        loadRecordsFromDatabase();
                    } else {
                        showAlert('Error deleting record: ' + (res?.message || 'Unknown error'), 'error');
                    }
                },
                error: function (xhr) {
                    showAlert('Error deleting record: ' + (xhr.statusText || 'Network error'), 'error');
                }
            });
        }
    </script>
}