@{
    ViewData["Title"] = "AEX51LB";
}

<h1>AEX Logbook</h1>

<div class="row">
    <div class="col-md-12">
        <!-- /.card -->
        <div class="card">

            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tasks me-2"></i>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="fas fa-plus me-2"></i>New Task
                    </button>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body" style="overflow:auto">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="3"></th>
                            <th colspan="8">1.Audit WIP(link to AEX 5.2)</th>
                            <th colspan="1">2. Audit Report</th>
                            <th colspan="3">3. Directors' Signing pages(AT3.4)</th>
                            <th colspan="2">Tax Dept</th>
                            <th colspan="2">Sec Dept</th>
                            <th colspan="2">Post Audit Work</th>
                        </tr>

                        <tr>
                            <th rowspan="3">No</th>
                            <th rowspan="3">Company Name</th>
                            <th rowspan="3">Activity</th>
                            <th rowspan="3">YE to do</th>
                            <th rowspan="3">Quarter to do</th>
                            <th rowspan="3">PIC</th>
                            <th rowspan="3">18 mths due</th>
                            <th rowspan="3">Status</th>
                            <th rowspan="3">Doc.Inward Date</th>
                            <th colspan="2">Est current year result '000</th>
                            <th colspan="2">Billing</th>

                            <th rowspan="2">Start Date</th>
                            <th rowspan="2">Day Done</th>
                            <th rowspan="2">%Done</th>
                            <th rowspan="2">Result Over/Under</th>
                            <th rowspan="2">Completed?</th>
                            <th colspan="1">KCH Review (1st)</th>
                            <th colspan="1">KK Review (2nd)</th>
                            <th rowspan="2">Review Result</th>
                            <th rowspan="2">Date receive from KK</th>
                            <th rowspan="2">Who to meet client & date</th>
                            <th rowspan="2">Date sent to client</th>
                            <th rowspan="2">Date Received Back</th>
                            <th rowspan="2">Tax Due Date</th>
                            <th rowspan="2">Pass to Tax Dept</th>
                            <th rowspan="2">SSM Due Date</th>
                            <th rowspan="2">Date pass to Sec Dept(MBRS)</th>
                            <th rowspan="2">Binded</th>
                            <th rowspan="2">Despatch Date to Client</th>
                        </tr>

                        <tr>
                            <th>Revenue</th>
                            <th>Profit/(loss)</th>
                            <th>Audit Fee</th>
                            <th>Date billed</th>
                            <th>Date sent</th>
                            <th>Date sent to KK</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
</div>

<!-- 模态框部分 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New AEX Logbook Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="editIndex" value="">

                    <!-- Basic Information -->
                    <div class="form-info-label col-12">
                        <label>Basic Information</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="number">No</label>
                                <input type="text" id="number" name="number" class="form-control" placeholder="Enter number" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Enter company name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="activity">Activity</label>
                                <input type="text" id="activity" name="activity" class="form-control" placeholder="Enter activity" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="yeToDo">YE to do</label>
                                <input type="text" id="yeToDo" name="yeToDo" class="form-control" placeholder="Enter year" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="quarterToDo">Quarter to do</label>
                                <select id="quarterToDo" name="quarterToDo" class="form-control">
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="pic">PIC</label>
                                <input type="text" id="pic" name="pic" class="form-control" placeholder="Enter PIC name" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="eighteenMonthsDue">18 mths due</label>
                                <input type="text" id="eighteenMonthsDue" name="eighteenMonthsDue" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="docInwardDate">Doc.Inward Date</label>
                                <input type="text" id="docInwardDate" name="docInwardDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Financial Results & Billing -->
                    <div class="form-info-label col-12">
                        <label>Financial Results & Billing</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="revenue">Revenue ('000)</label>
                                <input type="text" id="revenue" name="revenue" class="form-control" placeholder="Enter revenue" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="profitLoss">Profit/(loss) ('000)</label>
                                <input type="text" id="profitLoss" name="profitLoss" class="form-control" placeholder="Enter profit/loss" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="auditFee">Audit Fee</label>
                                <input type="text" id="auditFee" name="auditFee" class="form-control" placeholder="Enter audit fee" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="dateBilled">Date billed</label>
                                <input type="text" id="dateBilled" name="dateBilled" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- 1. Audit WIP -->
                    <div class="form-info-label col-12">
                        <label>1. Audit WIP</label>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="dayDone">Day Done</label>
                                <input type="number" id="dayDone" name="dayDone" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="percentDone">%Done</label>
                                <input type="text" id="percentDone" name="percentDone" class="form-control" placeholder="Enter percentage" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="resultOverUnder">Result Over/Under</label>
                                <input type="text" id="resultOverUnder" name="resultOverUnder" class="form-control" placeholder="Enter result" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="completed">Completed?</label>
                                <select id="completed" name="completed" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Audit Report -->
                    <div class="form-info-label col-12">
                        <label>2. Audit Report</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="kchReviewDate">KCH Review (1st) - Date sent</label>
                                <input type="text" id="kchReviewDate" name="kchReviewDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="kkReviewDate">KK Review (2nd) - Date sent to KK</label>
                                <input type="text" id="kkReviewDate" name="kkReviewDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- 3. Directors' Signing pages -->
                    <div class="form-info-label col-12">
                        <label>3. Directors' Signing pages</label>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="reviewResult">Review Result</label>
                                <input type="text" id="reviewResult" name="reviewResult" class="form-control" placeholder="Enter review result" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dateReceiveFromKK">Date receive from KK</label>
                                <input type="text" id="dateReceiveFromKK" name="dateReceiveFromKK" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="whoToMeetClient">Who to meet client & date</label>
                                <input type="text" id="whoToMeetClient" name="whoToMeetClient" class="form-control" placeholder="Enter details" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateSentToClient">Date sent to client</label>
                                <input type="text" id="dateSentToClient" name="dateSentToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateReceivedBack">Date Received Back</label>
                                <input type="text" id="dateReceivedBack" name="dateReceivedBack" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Tax Dept -->
                    <div class="form-info-label col-12">
                        <label>Tax Dept</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxDueDate">Tax Due Date</label>
                                <input type="text" id="taxDueDate" name="taxDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="passToTaxDept">Pass to Tax Dept</label>
                                <input type="text" id="passToTaxDept" name="passToTaxDept" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Sec Dept -->
                    <div class="form-info-label col-12">
                        <label>Sec Dept</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="ssmDueDate">SSM Due Date</label>
                                <input type="text" id="ssmDueDate" name="ssmDueDate" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="datePassToSecDept">Date pass to Sec Dept(MBRS)</label>
                                <input type="text" id="datePassToSecDept" name="datePassToSecDept" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <!-- Post Audit Work -->
                    <div class="form-info-label col-12">
                        <label>Post Audit Work</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="binded">Binded</label>
                                <select id="binded" name="binded" class="form-control">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="despatchDateToClient">Despatch Date to Client</label>
                                <input type="text" id="despatchDateToClient" name="despatchDateToClient" class="form-control" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let currentEditId = null;
        let dataTable = null;

        $(document).ready(function() {
            // 检查 DataTable 是否可用
            if (!$.fn.DataTable) {
                console.error('DataTable is not loaded. Please check the script references.');
                alert('DataTable library is not loaded. Please refresh the page.');
                return;
            }

            // 初始化日期选择器
            initializeDatePickers();

            // 初始化 DataTable
            initializeDataTable();

            // 加载数据
            loadAEX51Data();

            // 保存按钮点击事件
            $('#saveBtn').click(function() {
                saveAEX51Record();
            });

            // 新建按钮点击事件
            $('.btn-primary').filter(function() {
                return $(this).text().includes('New Task');
            }).click(function() {
                resetForm();
                $('#taskModal').modal('show');
            });
        });

        function initializeDatePickers() {
            // 简单的日期输入处理，您可以稍后添加日期选择器
            $('input[type="text"]').filter(function() {
                return $(this).attr('id') && (
                    $(this).attr('id').includes('Date') ||
                    $(this).attr('id').includes('date') ||
                    $(this).attr('id') === 'eighteenMonthsDue'
                );
            }).attr('placeholder', 'DD/MM/YYYY');
        }

        function initializeDataTable() {
            try {
                dataTable = $('#taskDatatable').DataTable({
                    responsive: true,
                    ordering: true,
                    autoWidth: false,
                    pageLength: 10,
                    searching: true,
                    paging: true,
                    info: true,
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        emptyTable: "No data available in table",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "Showing 0 to 0 of 0 entries",
                        infoFiltered: "(filtered from _MAX_ total entries)"
                    },
                    columnDefs: [
                        { targets: [0], width: '50px' }, // No column
                        { targets: [1], width: '200px' }, // Company Name
                        { targets: [2], width: '150px' }, // Activity
                        { targets: [3], width: '80px' },  // YE to do
                        { targets: [4], width: '80px' },  // Quarter to do
                        { targets: [5], width: '100px' }, // PIC
                        { targets: [6], width: '100px' }, // 18 mths due
                        { targets: [7], width: '100px' }, // Status
                        { targets: [8], width: '100px' }, // Doc.Inward Date
                        { targets: [9], width: '100px' }, // Revenue
                        { targets: [10], width: '100px' }, // Profit
                        { targets: [11], width: '100px' }, // Audit Fee
                        { targets: [12], width: '100px' }, // Date billed
                        { targets: [13], width: '100px' }, // Start Date
                        { targets: [14], width: '80px' },  // Day Done
                        { targets: [15], width: '80px' },  // %Done
                        { targets: [16], width: '100px' }, // Result Over/Under
                        { targets: [17], width: '80px' },  // Completed?
                        { targets: [18], width: '100px' }, // KCH Review
                        { targets: [19], width: '100px' }, // KK Review
                        { targets: [20], width: '100px' }, // Review Result
                        { targets: [21], width: '120px' }, // Date receive from KK
                        { targets: [22], width: '150px' }, // Who to meet client
                        { targets: [23], width: '120px' }, // Date sent to client
                        { targets: [24], width: '120px' }, // Date Received Back
                        { targets: [25], width: '100px' }, // Tax Due Date
                        { targets: [26], width: '100px' }, // Pass to Tax Dept
                        { targets: [27], width: '100px' }, // SSM Due Date
                        { targets: [28], width: '150px' }, // Date pass to Sec Dept
                        { targets: [29], width: '80px' },  // Binded
                        { targets: [30], width: '120px' }, // Despatch Date
                        { targets: [31], width: '100px', orderable: false } // Actions
                    ]
                });

                console.log('DataTable initialized successfully');
            } catch (error) {
                console.error('Error initializing DataTable:', error);
                // 降级处理：使用简单的表格
                $('#taskDatatable').addClass('table table-bordered table-striped');
            }
        }

        function loadAEX51Data() {
            console.log('Loading AEX51 data...');

            // 显示加载状态
            if (dataTable) {
                dataTable.clear().draw();
            }

            $.ajax({
                url: '/api/auditdept/aex51/get-all',
                type: 'GET',
                beforeSend: function() {
                    // 显示加载指示器
                    $('#taskDatatable tbody').html('<tr><td colspan="32" class="text-center">Loading data...</td></tr>');
                },
                success: function(response) {
                    console.log('Data loaded:', response);
                    if (response.success) {
                        populateTable(response.data);
                    } else {
                        showError('Error loading data: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showError('Error loading data: ' + error);
                }
            });
        }

        function populateTable(data) {
            console.log('Populating table with data:', data);

            if (!data || data.length === 0) {
                if (dataTable) {
                    dataTable.clear().draw();
                }
                $('#taskDatatable tbody').html('<tr><td colspan="32" class="text-center">No records found</td></tr>');
                return;
            }

            // 清除现有数据
            if (dataTable) {
                dataTable.clear();
            } else {
                $('#taskDatatable tbody').empty();
            }

            // 添加数据行
            data.forEach(function(item, index) {
                const row = [
                    index + 1,
                    item.companyName || '-',
                    item.activity || '-',
                    item.yEtodo || '-',
                    item.quartertodo || '-',
                    item.pic || '-',
                    formatDate(item.first18mthDue),
                    item.status || '-',
                    formatDate(item.docInwardsDate),
                    formatCurrency(item.revenue),
                    formatCurrency(item.profit),
                    formatCurrency(item.auditFee),
                    formatDate(item.dateBilled),
                    formatDate(item.startDate),
                    item.dayDone || '-',
                    item.donePercent ? item.donePercent + '%' : '-',
                    item.resultOverUnder || '-',
                    item.completed || '-',
                    formatDate(item.dateSent),
                    formatDate(item.dateSenttoKK),
                    item.reviewResult || '-',
                    formatDate(item.dateReceivedfrKK),
                    item.whomeetClientDate || '-',
                    formatDate(item.dateSentClient),
                    formatDate(item.dateReceivedBack),
                    formatDate(item.taxDueDate),
                    formatDate(item.passtoTaxDept),
                    formatDate(item.ssmdueDate),
                    formatDate(item.datePassToSecDept),
                    item.binded || '-',
                    formatDate(item.despatachDateClient),
                    `<div class="btn-group btn-group-sm">
                        <button class="btn btn-warning edit-btn" data-id="${item.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger delete-btn" data-id="${item.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`
                ];

                if (dataTable) {
                    dataTable.row.add(row);
                } else {
                    // 降级处理：直接添加到表格
                    const rowHtml = `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
                    $('#taskDatatable tbody').append(rowHtml);
                }
            });

            if (dataTable) {
                dataTable.draw();
            }

            // 绑定按钮事件
            bindButtonEvents();
        }

        function bindButtonEvents() {
            // 编辑按钮
            $('.edit-btn').off('click').on('click', function() {
                const id = $(this).data('id');
                editAEX51Record(id);
            });

            // 删除按钮
            $('.delete-btn').off('click').on('click', function() {
                const id = $(this).data('id');
                deleteAEX51Record(id);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleDateString('en-GB');
            } catch (e) {
                return '-';
            }
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '-';
            try {
                return 'RM ' + parseFloat(amount).toLocaleString('en-MY', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (e) {
                return '-';
            }
        }

        function saveAEX51Record() {
            const formData = {
                Id: currentEditId,
                CompanyName: $('#companyName').val().trim(),
                Activity: $('#activity').val().trim(),
                YEtodo: $('#yeToDo').val().trim(),
                Quartertodo: $('#quarterToDo').val(),
                PIC: $('#pic').val().trim(),
                First18mthDue: parseDate($('#eighteenMonthsDue').val()),
                Status: $('#status').val(),
                DocInwardsDate: parseDate($('#docInwardDate').val()),
                Revenue: $('#revenue').val() ? parseFloat($('#revenue').val()) : null,
                Profit: $('#profitLoss').val() ? parseFloat($('#profitLoss').val()) : null,
                AuditFee: $('#auditFee').val() ? parseFloat($('#auditFee').val()) : null,
                DateBilled: parseDate($('#dateBilled').val()),
                StartDate: parseDate($('#startDate').val()),
                EndDate: parseDate($('#endDate').val()),
                DonePercent: $('#percentDone').val() ? parseFloat($('#percentDone').val()) : null,
                ResultOverUnder: $('#resultOverUnder').val().trim(),
                Completed: $('#completed').val(),
                DateSent: parseDate($('#kchReviewDate').val()),
                DateSenttoKK: parseDate($('#kkReviewDate').val()),
                ReviewResult: $('#reviewResult').val().trim(),
                DateReceivedfrKK: parseDate($('#dateReceiveFromKK').val()),
                WhomeetClientDate: $('#whoToMeetClient').val().trim(),
                DateSentClient: parseDate($('#dateSentToClient').val()),
                DateReceivedBack: parseDate($('#dateReceivedBack').val()),
                TaxDueDate: parseDate($('#taxDueDate').val()),
                PasstoTaxDept: parseDate($('#passToTaxDept').val()),
                SSMdueDate: parseDate($('#ssmDueDate').val()),
                DatePassToSecDept: parseDate($('#datePassToSecDept').val()),
                Binded: $('#binded').val(),
                DespatachDateClient: parseDate($('#despatchDateToClient').val())
            };

            // 基本验证
            if (!formData.CompanyName) {
                alert('Please enter Company Name');
                return;
            }

            const url = currentEditId ? '/api/auditdept/aex51/update' : '/api/auditdept/aex51/create';
            const method = currentEditId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                beforeSend: function() {
                    $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');
                },
                success: function(response) {
                    if (response.success) {
                        $('#taskModal').modal('hide');
                        loadAEX51Data();
                        resetForm();
                        alert(currentEditId ? 'Record updated successfully!' : 'Record created successfully!');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error saving data: ' + error);
                },
                complete: function() {
                    $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-2"></i>Save');
                }
            });
        }

        function editAEX51Record(id) {
            $.ajax({
                url: '/api/auditdept/aex51/get/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const record = response.data;
                        currentEditId = record.id;

                        // 填充表单
                        $('#companyName').val(record.companyName || '');
                        $('#activity').val(record.activity || '');
                        $('#yeToDo').val(record.yEtodo || '');
                        $('#quarterToDo').val(record.quartertodo || '');
                        $('#pic').val(record.pic || '');
                        $('#eighteenMonthsDue').val(formatDateForInput(record.first18mthDue));
                        $('#status').val(record.status || '');
                        $('#docInwardDate').val(formatDateForInput(record.docInwardsDate));
                        $('#revenue').val(record.revenue || '');
                        $('#profitLoss').val(record.profit || '');
                        $('#auditFee').val(record.auditFee || '');
                        $('#dateBilled').val(formatDateForInput(record.dateBilled));
                        $('#startDate').val(formatDateForInput(record.startDate));
                        $('#endDate').val(formatDateForInput(record.endDate));
                        $('#percentDone').val(record.donePercent || '');
                        $('#resultOverUnder').val(record.resultOverUnder || '');
                        $('#completed').val(record.completed || '');
                        $('#kchReviewDate').val(formatDateForInput(record.dateSent));
                        $('#kkReviewDate').val(formatDateForInput(record.dateSenttoKK));
                        $('#reviewResult').val(record.reviewResult || '');
                        $('#dateReceiveFromKK').val(formatDateForInput(record.dateReceivedfrKK));
                        $('#whoToMeetClient').val(record.whomeetClientDate || '');
                        $('#dateSentToClient').val(formatDateForInput(record.dateSentClient));
                        $('#dateReceivedBack').val(formatDateForInput(record.dateReceivedBack));
                        $('#taxDueDate').val(formatDateForInput(record.taxDueDate));
                        $('#passToTaxDept').val(formatDateForInput(record.passtoTaxDept));
                        $('#ssmDueDate').val(formatDateForInput(record.ssmdueDate));
                        $('#datePassToSecDept').val(formatDateForInput(record.datePassToSecDept));
                        $('#binded').val(record.binded || '');
                        $('#despatchDateToClient').val(formatDateForInput(record.despatachDateClient));

                        $('#modalTitle').text('Edit AEX Logbook Record');
                        $('#taskModal').modal('show');
                    } else {
                        alert('Error loading record: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error loading record: ' + error);
                }
            });
        }

        function deleteAEX51Record(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '/api/auditdept/aex51/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            loadAEX51Data();
                            alert('Record deleted successfully!');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting record: ' + error);
                    }
                });
            }
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            try {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day);
                }
            } catch (e) {
                console.error('Error parsing date:', e);
            }
            return null;
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return '';
            }
        }

        function resetForm() {
            $('#taskForm')[0].reset();
            currentEditId = null;
            $('#modalTitle').text('Add New AEX Logbook Record');
        }

        function showError(message) {
            console.error(message);
            alert(message);
        }
    </script>
}