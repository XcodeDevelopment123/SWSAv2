@{
    ViewData["Title"] = "BP32 - Tax Compliance Management";
}

<h1>BP32 - Tax Compliance Management</h1>

<div class="row">
    <div class="col-md-12">
        <div id="alertContainer"></div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i> BP32 Records (Sdn Bhd)
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal" id="addNewBtn">
                        <i class="fas fa-plus me-2"></i>New Record
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table id="taskDatatable" class="table table-bordered table-striped table-responsive">
                    <thead>
                        <tr>
                            <th colspan="3" class="text-center">Basic Information</th>
                            <th colspan="6" class="text-center">Company Details</th>
                            <th colspan="8" class="text-center">Scheduling & Timeline</th>
                            <th colspan="10" class="text-center">Tax Process Steps</th>
                            <th colspan="6" class="text-center">E-Filing & Billing</th>
                            <th rowspan="2" style="vertical-align: middle;">Actions</th>
                        </tr>
                        <tr>
                            <th>File No</th>
                            <th>Company Name</th>
                            <th>Year End</th>

                            <th>Job Services</th>
                            <th>Co Status</th>
                            <th>Active Co Activity Size</th>
                            <th>YE to do</th>
                            <th>Month to do</th>
                            <th>Doc Received Date</th>

                            <th>Tax AR Due Date</th>
                            <th>Staff</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Time Taken</th>
                            <th>Date Pass to Audit</th>
                            <th>Date Tax Submitted</th>
                            <th>Completed/Backlog</th>

                            <th>Single Entry</th>
                            <th>Tax Computation</th>
                            <th>Sorting Filing</th>
                            <th>Keyin To Excel</th>
                            <th>Review Working Acc</th>
                            <th>Draft Financial Statement</th>
                            <th>Draft Tax Completed</th>
                            <th>Review Tax</th>
                            <th>Final Tax</th>
                            <th>Tax Com Final Sign By Client</th>

                            <th>Amount Tax Pay</th>
                            <th>E-File Draft</th>
                            <th>E-File Final</th>
                            <th>E-File via SPC</th>
                            <th>Invoice No</th>
                            <th>Amount RM</th>
                            <th>Doc Despatch Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    <span id="modalTitle">Add New BP32 Record</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="recordId" value="">

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="companyName">Company Name (Select Sdn Bhd)</label>
                                <select id="companySelect" class="form-control">
                                    <option value="">-- Loading... --</option>
                                </select>
                                <input type="hidden" id="companyName" name="companyName" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="fileNo">File No</label>
                                <input type="text" id="fileNo" name="fileNo" class="form-control" placeholder="Auto-fill" readonly />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="yearEnd">Year End</label>
                                <input type="text" id="yearEnd" name="yearEnd" class="form-control" placeholder="Auto-fill" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 mt-3">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2"><i class="fas fa-building me-2"></i>Company Details</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="jobServices">Job Services</label>
                                <input type="text" id="jobServices" name="jobServices" class="form-control" placeholder="Enter job services" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="coStatus">Co Status</label>
                                <input type="text" id="coStatus" name="coStatus" class="form-control" placeholder="Enter company status" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="activeCoActivitySize">Active Co Activity Size</label>
                                <input type="text" id="activeCoActivitySize" name="activeCoActivitySize" class="form-control" placeholder="Enter activity size" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="yEtodo">YE to do</label>
                                <input type="text" id="yEtodo" name="yEtodo" class="form-control" placeholder="Enter YE to do" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="mthTodo">Month to do</label>
                                <input type="text" id="mthTodo" name="mthTodo" class="form-control" placeholder="Enter month" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="docReceivedDate">Doc Received Date</label>
                                <input type="text" id="docReceivedDate" name="docReceivedDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 mt-3">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2"><i class="fas fa-calendar-alt me-2"></i>Scheduling & Timeline</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="taxARdueDate">Tax AR Due Date</label>
                                <input type="text" id="taxARdueDate" name="taxARdueDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="staff">Staff</label>
                                <input type="text" id="staff" name="staff" class="form-control" placeholder="Enter staff name" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="text" id="startDate" name="startDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="text" id="endDate" name="endDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="timeTaken">Time Taken (days)</label>
                                <input type="number" id="timeTaken" name="timeTaken" class="form-control" placeholder="Enter days" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="datePassToAudit">Date Pass to Audit</label>
                                <input type="text" id="datePassToAudit" name="datePassToAudit" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateTaxSubmited">Date Tax Submitted</label>
                                <input type="text" id="dateTaxSubmited" name="dateTaxSubmited" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="completedBacklog">Completed/Backlog</label>
                                <select id="completedBacklog" name="completedBacklog" class="form-control">
                                    <option value="">Select Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Backlog">Backlog</option>
                                    <option value="In Progress">In Progress</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 mt-3">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2"><i class="fas fa-cogs me-2"></i>Tax Process Steps</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="singleEntry" name="singleEntry" class="form-check-input" /><label class="form-check-label" for="singleEntry">Single Entry</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="taxComputation" name="taxComputation" class="form-check-input" /><label class="form-check-label" for="taxComputation">Tax Computation</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="sortingFiling" name="sortingFiling" class="form-check-input" /><label class="form-check-label" for="sortingFiling">Sorting Filing</label></div></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="keyinToExcel" name="keyinToExcel" class="form-check-input" /><label class="form-check-label" for="keyinToExcel">Keyin To Excel</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="reviewWorkingAcc" name="reviewWorkingAcc" class="form-check-input" /><label class="form-check-label" for="reviewWorkingAcc">Review Working Acc</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="draftFinancialStatement" name="draftFinancialStatement" class="form-check-input" /><label class="form-check-label" for="draftFinancialStatement">Draft Financial Statement</label></div></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="draftTaxCompleted" name="draftTaxCompleted" class="form-check-input" /><label class="form-check-label" for="draftTaxCompleted">Draft Tax Completed</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="reviewTax" name="reviewTax" class="form-check-input" /><label class="form-check-label" for="reviewTax">Review Tax</label></div></div>
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="finalTax" name="finalTax" class="form-check-input" /><label class="form-check-label" for="finalTax">Final Tax</label></div></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6"><div class="form-check"><input type="checkbox" id="taxComFinalSignByClient" name="taxComFinalSignByClient" class="form-check-input" /><label class="form-check-label" for="taxComFinalSignByClient">Tax Com Final Sign By Client</label></div></div>
                    </div>

                    <div class="row mb-3 mt-3">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2"><i class="fas fa-file-export me-2"></i>E-Filing & Billing</h6>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="amountTaxPay">Amount Tax Pay (RM)</label>
                                <input type="number" step="0.01" id="amountTaxPay" name="amountTaxPay" class="form-control" placeholder="0.00" />
                            </div>
                        </div>
                        <div class="col-md-4"><div class="form-check mt-4"><input type="checkbox" id="eFileDraft" name="eFileDraft" class="form-check-input" /><label class="form-check-label" for="eFileDraft">E-File Draft</label></div></div>
                        <div class="col-md-4"><div class="form-check mt-4"><input type="checkbox" id="eFileFinal" name="eFileFinal" class="form-check-input" /><label class="form-check-label" for="eFileFinal">E-File Final</label></div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><div class="form-check"><input type="checkbox" id="eFileviaSPC" name="eFileviaSPC" class="form-check-input" /><label class="form-check-label" for="eFileviaSPC">E-File via SPC</label></div></div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="invoiceNo">Invoice No</label>
                                <input type="text" id="invoiceNo" name="invoiceNo" class="form-control" placeholder="Enter invoice number" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="amountRM">Amount RM</label>
                                <input type="number" step="0.01" id="amountRM" name="amountRM" class="form-control" placeholder="0.00" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="docDespatchDate">Doc Despatch Date</label>
                                <input type="text" id="docDespatchDate" name="docDespatchDate" class="form-control datepicker" placeholder="Select date" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn"><i class="fas fa-save me-2"></i>Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            let dataTable;
            let currentEditId = null;
            let companyOptionsMap = {}; // 存储 API 返回的公司数据

            // 🟢 1. 加载 Company Options (Sdn Bhd)
            function loadCompanyOptions() {
                $.ajax({
                    url: '/api/get/company-options', // 🟢 使用你要求的新 API
                    type: 'GET',
                    success: function (res) {
                        if (res.success && res.data) {
                            companyOptionsMap = {};
                            const $sel = $('#companySelect');
                            $sel.empty().append('<option value="">-- Select Sdn Bhd --</option>');

                            res.data.forEach(client => {
                                // 缓存数据
                                companyOptionsMap[client.id] = client;
                                
                                // 显示逻辑：Company Name (Company No)
                                const displayText = client.companyNo 
                                    ? `${client.companyName} (${client.companyNo})`
                                    : client.companyName;

                                $sel.append(`<option value="${client.id}">${displayText}</option>`);
                            });
                        }
                    },
                    error: function(xhr) { 
                        console.error("Failed to load options", xhr); 
                    }
                });
            }

            // 🟢 2. Helper: Month -> Date String
            function yearEndMonthToDateString(monthName) {
                if (!monthName) return '';
                if (monthName.includes('/') || monthName.includes('-')) return monthName;

                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                const idx = months.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
                if (idx === -1) return monthName;
                
                const today = new Date();
                let year = today.getFullYear();
                if (idx < today.getMonth()) year += 1;
                
                const dt = new Date(year, idx + 1, 0);
                return formatDdMMyyyy(dt);
            }

            function formatDdMMyyyy(d) {
                const date = (d instanceof Date) ? d : new Date(d);
                if (isNaN(date)) return "";
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yyyy = date.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }

            // 🟢 3. Dropdown Change Event (Auto-fill)
            $('#companySelect').change(function() {
                const selectedId = $(this).val();
                
                if (!selectedId || !companyOptionsMap[selectedId]) {
                    $('#companyName').val('');
                    $('#fileNo').val('');
                    $('#yearEnd').val('');
                    return;
                }

                const c = companyOptionsMap[selectedId];

                // 填入 Hidden Input (给后端保存)
                $('#companyName').val(c.companyName || '');

                // 填入 File No
                $('#fileNo').val(c.fileNo || '');
                
                // 处理 Year End
                const rawYearEnd = c.yearEndMonth || c.yearEnd || '';
                $('#yearEnd').val(yearEndMonthToDateString(rawYearEnd));

                // 自动填入其他字段 (如果 API 返回了这些)
                if(c.activeCoActivitySize) $('#activeCoActivitySize').val(c.activeCoActivitySize);
                if(c.coStatus) $('#coStatus').val(c.coStatus);
                if(c.jobServices) $('#jobServices').val(c.jobServices);
            });

            // 🟢 4. 核心：初始化 DataTable (修复 Not Defined 问题)
            function initializeDataTable() {
                // 如果已存在则销毁
                if ($.fn.DataTable.isDataTable('#taskDatatable')) {
                    dataTable.destroy();
                }

                dataTable = $('#taskDatatable').DataTable({
                    "processing": true,
                    "serverSide": false,
                    "ajax": {
                        "url": "/api/bp32/get-all", // 假设后端接口
                        "type": "GET",
                        "dataSrc": function(response) {
                            if (response.success) {
                                return response.data;
                            } else {
                                console.error('Error loading data:', response.message);
                                showAlert('Error loading data: ' + response.message, 'danger');
                                return [];
                            }
                        },
                        "error": function(xhr, error, thrown) {
                            console.error('DataTable AJAX error:', error);
                        }
                    },
                    "columns": [
                        { "data": "fileNo", "defaultContent": "" },
                        { "data": "companyName", "defaultContent": "" },
                        { "data": "yearEnd", "defaultContent": "" },
                        { "data": "jobServices", "defaultContent": "" },
                        { "data": "coStatus", "defaultContent": "" },
                        { "data": "activeCoActivitySize", "defaultContent": "" },
                        { "data": "yEtodo", "defaultContent": "" },
                        { "data": "mthTodo", "defaultContent": "" },
                        { 
                            "data": "docReceivedDate", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { 
                            "data": "taxARdueDate", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { "data": "staff", "defaultContent": "" },
                        { 
                            "data": "startDate", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { 
                            "data": "endDate", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { "data": "timeTaken", "defaultContent": "" },
                        { 
                            "data": "datePassToAudit", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { 
                            "data": "dateTaxSubmited", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        { "data": "completedBacklog", "defaultContent": "" },
                        // Boolean Fields (Render Checkmarks)
                        { "data": "singleEntry", "render": renderCheck },
                        { "data": "taxComputation", "render": renderCheck },
                        { "data": "sortingFiling", "render": renderCheck },
                        { "data": "keyinToExcel", "render": renderCheck },
                        { "data": "reviewWorkingAcc", "render": renderCheck },
                        { "data": "draftFinancialStatement", "render": renderCheck },
                        { "data": "draftTaxCompleted", "render": renderCheck },
                        { "data": "reviewTax", "render": renderCheck },
                        { "data": "finalTax", "render": renderCheck },
                        { "data": "taxComFinalSignByClient", "render": renderCheck },
                        { 
                            "data": "amountTaxPay", 
                            "render": function(data) { return data ? parseFloat(data).toFixed(2) : ''; },
                            "defaultContent": "" 
                        },
                        { "data": "eFileDraft", "render": renderCheck },
                        { "data": "eFileFinal", "render": renderCheck },
                        { "data": "eFileviaSPC", "render": renderCheck },
                        { "data": "invoiceNo", "defaultContent": "" },
                        { 
                            "data": "amountRM", 
                            "render": function(data) { return data ? parseFloat(data).toFixed(2) : ''; },
                            "defaultContent": "" 
                        },
                        { 
                            "data": "docDespatchDate", 
                            "render": function(data) { return data ? formatDate(data) : ''; },
                            "defaultContent": "" 
                        },
                        {
                            "data": "id",
                            "render": function(data, type, row) {
                                return `
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-warning edit-btn" data-id="${data}" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                `;
                            },
                            "orderable": false
                        }
                    ],
                    "order": [[0, 'desc']]
                });
            }

            // Helper: Render Checkbox Icons
            function renderCheck(data) {
                // 兼容字符串 "1" 或 boolean true
                if (data == "1" || data == 1 || data === true || data === "true") {
                    return '<i class="fas fa-check text-success"></i>';
                }
                return ''; // 空白表示未勾选
            }

            function initializeDatePickers() {
                $('.datepicker').datepicker({
                    format: 'yyyy-mm-dd',
                    autoclose: true,
                    todayHighlight: true
                });
            }

            function formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-GB');
                } catch (e) {
                    return dateString;
                }
            }

            function formatDateForInput(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return dateString;
                }
            }

            function showAlert(msg, type) {
                const html = `<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                $('#alertContainer').html(html);
                setTimeout(() => $('.alert').alert('close'), 3000);
            }

            function resetForm() {
                $('#taskForm')[0].reset();
                currentEditId = null;
                $('#recordId').val('');
                $('#companySelect').val(''); // 重置下拉
                $('#modalTitle').text('Add New BP32 Record');
                $('.datepicker').datepicker('update', '');
            }

            function saveBP32Record() {
                const formData = {
                    id: currentEditId || 0,
                    fileNo: $('#fileNo').val(),
                    companyName: $('#companyName').val(),
                    yearEnd: $('#yearEnd').val(),
                    jobServices: $('#jobServices').val(),
                    coStatus: $('#coStatus').val(),
                    activeCoActivitySize: $('#activeCoActivitySize').val(),
                    yEtodo: $('#yEtodo').val(),
                    mthTodo: $('#mthTodo').val(),
                    docReceivedDate: $('#docReceivedDate').val(),
                    taxARdueDate: $('#taxARdueDate').val(),
                    staff: $('#staff').val(),
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    timeTaken: $('#timeTaken').val(),
                    datePassToAudit: $('#datePassToAudit').val(),
                    dateTaxSubmited: $('#dateTaxSubmited').val(),
                    completedBacklog: $('#completedBacklog').val(),
                    // Boolean fields
                    singleEntry: $('#singleEntry').is(':checked') ? "1" : "0",
                    taxComputation: $('#taxComputation').is(':checked') ? "1" : "0",
                    sortingFiling: $('#sortingFiling').is(':checked') ? "1" : "0",
                    keyinToExcel: $('#keyinToExcel').is(':checked') ? "1" : "0",
                    reviewWorkingAcc: $('#reviewWorkingAcc').is(':checked') ? "1" : "0",
                    draftFinancialStatement: $('#draftFinancialStatement').is(':checked') ? "1" : "0",
                    draftTaxCompleted: $('#draftTaxCompleted').is(':checked') ? "1" : "0",
                    reviewTax: $('#reviewTax').is(':checked') ? "1" : "0",
                    finalTax: $('#finalTax').is(':checked') ? "1" : "0",
                    taxComFinalSignByClient: $('#taxComFinalSignByClient').is(':checked') ? "1" : "0",
                    amountTaxPay: $('#amountTaxPay').val(),
                    eFileDraft: $('#eFileDraft').is(':checked') ? "1" : "0",
                    eFileFinal: $('#eFileFinal').is(':checked') ? "1" : "0",
                    eFileviaSPC: $('#eFileviaSPC').is(':checked') ? "1" : "0",
                    invoiceNo: $('#invoiceNo').val(),
                    amountRM: $('#amountRM').val(),
                    docDespatchDate: $('#docDespatchDate').val()
                };

                const url = currentEditId ? '/api/bp32/update' : '/api/bp32/create';
                const method = currentEditId ? 'PUT' : 'POST';

                $('#saveBtn').prop('disabled', true).html('Saving...');

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        $('#saveBtn').prop('disabled', false).html('Save');
                        if (response.success) {
                            $('#taskModal').modal('hide');
                            if(dataTable) dataTable.ajax.reload(null, false);
                            resetForm();
                            showAlert('Saved successfully!', 'success');
                        } else {
                            showAlert('Error: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr) {
                        $('#saveBtn').prop('disabled', false).html('Save');
                        showAlert('Error saving record', 'danger');
                    }
                });
            }

            function editRecord(id) {
                $.get(`/api/bp32/get/${id}`, function(res) {
                    if (res.success) {
                        const d = res.data;
                        currentEditId = d.id;
                        $('#recordId').val(d.id);

                        // 反选 Dropdown
                        let foundId = "";
                        for (const [key, val] of Object.entries(companyOptionsMap)) {
                            if (val.companyName === d.companyName) {
                                foundId = key;
                                break;
                            }
                        }
                        $('#companySelect').val(foundId);

                        // 填充 Input
                        $('#fileNo').val(d.fileNo);
                        $('#companyName').val(d.companyName);
                        $('#yearEnd').val(d.yearEnd);
                        $('#jobServices').val(d.jobServices);
                        $('#coStatus').val(d.coStatus);
                        $('#activeCoActivitySize').val(d.activeCoActivitySize);
                        $('#yEtodo').val(d.yEtodo);
                        $('#mthTodo').val(d.mthTodo);
                        
                        // Dates
                        $('#docReceivedDate').val(formatDateForInput(d.docReceivedDate));
                        $('#taxARdueDate').val(formatDateForInput(d.taxARdueDate));
                        $('#startDate').val(formatDateForInput(d.startDate));
                        $('#endDate').val(formatDateForInput(d.endDate));
                        $('#datePassToAudit').val(formatDateForInput(d.datePassToAudit));
                        $('#dateTaxSubmited').val(formatDateForInput(d.dateTaxSubmited));
                        $('#docDespatchDate').val(formatDateForInput(d.docDespatchDate));

                        $('#staff').val(d.staff);
                        $('#timeTaken').val(d.timeTaken);
                        $('#completedBacklog').val(d.completedBacklog);
                        $('#amountTaxPay').val(d.amountTaxPay);
                        $('#invoiceNo').val(d.invoiceNo);
                        $('#amountRM').val(d.amountRM);

                        // Checks
                        const check = (val) => (val == "1" || val == 1 || val === true);
                        $('#singleEntry').prop('checked', check(d.singleEntry));
                        $('#taxComputation').prop('checked', check(d.taxComputation));
                        $('#sortingFiling').prop('checked', check(d.sortingFiling));
                        $('#keyinToExcel').prop('checked', check(d.keyinToExcel));
                        $('#reviewWorkingAcc').prop('checked', check(d.reviewWorkingAcc));
                        $('#draftFinancialStatement').prop('checked', check(d.draftFinancialStatement));
                        $('#draftTaxCompleted').prop('checked', check(d.draftTaxCompleted));
                        $('#reviewTax').prop('checked', check(d.reviewTax));
                        $('#finalTax').prop('checked', check(d.finalTax));
                        $('#taxComFinalSignByClient').prop('checked', check(d.taxComFinalSignByClient));
                        $('#eFileDraft').prop('checked', check(d.eFileDraft));
                        $('#eFileFinal').prop('checked', check(d.eFileFinal));
                        $('#eFileviaSPC').prop('checked', check(d.eFileviaSPC));

                        $('#modalTitle').text('Edit BP32 Record');
                        $('#taskModal').modal('show');
                    } else {
                        showAlert('Failed to load record', 'danger');
                    }
                });
            }

            function deleteRecord(id) {
                if (confirm('Are you sure?')) {
                    $.ajax({
                        url: `/api/bp32/delete/${id}`,
                        type: 'DELETE',
                        success: function(res) {
                            if (res.success) {
                                dataTable.ajax.reload(null, false);
                                showAlert('Deleted', 'success');
                            } else {
                                showAlert('Delete failed', 'danger');
                            }
                        }
                    });
                }
            }

            // Bindings
            $('#saveBtn').click(saveBP32Record);
            $('#addNewBtn').click(function() { resetForm(); });
            $(document).on('click', '.edit-btn', function() { editRecord($(this).data('id')); });
            $(document).on('click', '.delete-btn', function() { deleteRecord($(this).data('id')); });
            $('#taskModal').on('hidden.bs.modal', resetForm);

            // 🚀 Init Logic
            initializeDatePickers();
            loadCompanyOptions();
            initializeDataTable(); // 确保这个函数已经定义并在这里调用
        });
    </script>
}