

using Mapster;
using Microsoft.EntityFrameworkCore;
using SWSA.MvcPortal.Entities;
using SWSA.MvcPortal.Models.Companies;
using SWSA.MvcPortal.Models.CompnayWorks;
using SWSA.MvcPortal.Persistence;
using SWSA.MvcPortal.Repositories.Interfaces;
using static Microsoft.EntityFrameworkCore.DbLoggerCategory;

namespace SWSA.MvcPortal.Repositories.Repo;
// <auto-generated />
public class CompanyWorkAssignmentRepository(AppDbContext db) : RepositoryBase<CompanyWorkAssignment>(db), ICompanyWorkAssignmentRepository
{
    private IQueryable<CompanyWorkAssignment> BaseQuery(bool asNoTracking = false)
    {
        var query = db.Set<CompanyWorkAssignment>();
        return asNoTracking ? query.AsNoTracking() : query;
    }
    // Implement the method
    #region VM Method
    public async Task<List<CompanyWorkListVM>> GetWorkListVMAsync()
    {
        var dtos = await BaseQuery(true)
       .ProjectToType<CompanyWorkListVM>()
       .ToListAsync();

        return dtos!;
    }

    public async Task<List<CompanyWorkListVM>> GetWorkListVMByCompanyIdsAsync(List<int> ids)
    {

        var query = BaseQuery(true);

        if (ids.Count == 1)
        {
            var id = ids[0];
            query = query.Where(c => c.CompanyId == id);
        }
        else
        {
            query = query.Where(c => ids.Contains(c.CompanyId));
        }

        var dtos = await query
            .ProjectToType<CompanyWorkListVM>()
            .ToListAsync();

        return dtos!;
    }

    public async Task<CompanyWorkFullVM> GetWorkVMByIdAsync(int id)
    {
        var dto = await BaseQuery(true)
       .Where(x => x.Id == id)
       .ProjectToType<CompanyWorkFullVM>()
       .FirstOrDefaultAsync();

        return dto!;
    }
    #endregion

    public async Task<CompanyWorkAssignment> GetUpdateVMById(int id)
    {
        var query = db.Set<CompanyWorkAssignment>()
            .Include(c => c.Progress)
            .FirstOrDefaultAsync(c => c.Id == id);

        return await query ?? null!;
    }

    public async Task<List<CompanyWorkAssignment>> GetByCompanyIds(List<int> companyIds)
    {
        var query = await BuildQueryAsync();
        if (companyIds.Count == 1)
        {
            var id = companyIds[0];
            return await query.Where(c => c.CompanyId == id).ToListAsync();
        }

        return await query.Where(c => companyIds.Contains(c.CompanyId)).ToListAsync();
    }

    public Task<List<CompanyWorkAssignment>> GetTodayRemindAssignments()
    {
        var today = DateTime.Today;

        return db.CompanyWorkAssignments
           .Where(c => c.ReminderDate.HasValue && c.ReminderDate.Value.Date == today) 
           .Include(c => c.Company)
           .ToListAsync();
    }

    public Task<List<CompanyWorkAssignment>> GetDueSoonAssignments(int day = 7)
    {
        // Get the current date
        var today = DateTime.Today;
        var endDate = today.AddDays(day);

        // Get the assignments that are due within the next 7 days
        return db.CompanyWorkAssignments
           // .Where(c => c.DueDate >= today && c.DueDate < endDate.AddDays(1)) // 小于隔天 00:00
           .Include(c => c.Company)
           .ToListAsync();
    }

    //Rewrite the GetAllAsync method
    protected override Task<IQueryable<CompanyWorkAssignment>> BuildQueryAsync()
    {
        // Do you query here
        var query = db.CompanyWorkAssignments
                  .Include(c => c.Progress)
                  .Include(c => c.Company)
                  .Include(c => c.ARSubmission)
                  .Include(c => c.AssignedUsers).ThenInclude(c => c.User)
                  .AsNoTracking();

        return Task.FromResult(query);
    }

    //Rewrite the GetWithIncludesAsync method
    protected override Task<IQueryable<CompanyWorkAssignment>> BuildQueryWithIncludesAsync()
    {
        //Default query no action
        var query = db.CompanyWorkAssignments
                 .Include(c => c.Progress)
                 .Include(c => c.Company)
                 .Include(c => c.ARSubmission)
                 .Include(c => c.AssignedUsers).ThenInclude(c => c.User)
                 .AsNoTracking();

        return Task.FromResult(query);
    }

    //Rewrite the GetSingleAsync method
    protected override Task<IQueryable<CompanyWorkAssignment>> BuildGetByIdQueryAsync()
    {
        //Default query no action
        return Task.FromResult(db.Set<CompanyWorkAssignment>().AsQueryable());

        // Do you query here
        // var query = db.TableNames;
        // return Task.FromResult(query);    
    }

    //Add the method that want to perform before delete the entity
    protected override async Task BeforeRemove(CompanyWorkAssignment entity)
    {
        //Do you logic here
        switch (entity.WorkType)
        {
            case Commons.Enums.WorkType.AnnualReturn:
                await db.Set<AnnualReturnSubmission>()
                         .Where(c => c.WorkAssignmentId == entity.Id).ExecuteDeleteAsync();
                break;
            case Commons.Enums.WorkType.LLP:
                await db.Set<LLPSubmission>()
                .Where(c => c.WorkAssignmentId == entity.Id).ExecuteDeleteAsync();
                break;
            case Commons.Enums.WorkType.StrikeOff:
                await db.Set<CompanyStrikeOffSubmission>()
                .Where(c => c.WorkAssignmentId == entity.Id).ExecuteDeleteAsync();
                break;
            case Commons.Enums.WorkType.Audit:
                await db.Set<AuditSubmission>()
                .Where(c => c.WorkAssignmentId == entity.Id).ExecuteDeleteAsync();
                break;
                //..Other
        }

    }

    //Add the method that want to perform before add the entity
    protected override async Task BeforeAdd(CompanyWorkAssignment entity)
    {
        //Do you logic here
    }

    //Add the method that want to perform before update the entity
    protected override async Task BeforeUpdate(CompanyWorkAssignment entity)
    {
        //Do you logic here
    }
}
